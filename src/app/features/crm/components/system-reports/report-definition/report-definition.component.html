<div class="base-content-section">
  <div class="row">
    <div class="col-8">
      <app-dynamic-breadcrumb [breadCrumbItems]="[
      {
        label: 'Administration',
        url: '/home/crm'
      },
      {
        label: 'CRM Setups',
        url: '/home/crm',
      },
      {
        label: 'System Reports',
        url: '/home/crm'
      },
      {
        label: 'Define Reports',
        url: '/home/crm/define-reports'
      }
    ]">
      </app-dynamic-breadcrumb>
    </div>
    <div class="card">
      <div class="card-header bg-transparent float-start border-bottom-0 mb-0">
        <h6 class="float-start mt-3 fw-semibold text-primary">{{ 'crm.reportsDefinition' | translate}}</h6>
      </div>
      <div class="card-body">
        <div class="row mb-2">
          <div class="col-md-12">
            <h6 class="float-start fw-semibold w-100">{{ 'crm.systems' | translate }}</h6>
            <ng-container *ngIf="shouldShowSystems; else showSystemsLoading">
              <div class="form-div">
                <form>
                  <div class="row">
                    <ng-container *ngFor="let system of systems">
                      <div class="col-sm-4 my-2">
                        <div class="form-check form-check-inline">
                          <input
                            class="form-check-input select-system"
                            type="radio"
                            name="system"
                            value="{{ system.id }}"
                            (click)="selectSystem(system)"
                            [checked]="selectedSystem?.id === system.id"
                          />
                          <label class="form-check-label" for="{{ system.id }}">{{
                              system.systemName | titlecase
                            }}</label>
                        </div>
                      </div>
                    </ng-container>
                  </div>
                </form>
              </div>
            </ng-container>
            <ng-template #showSystemsLoading>
              <div class="my-5 mx-5">
                <ngx-spinner
                  type="ball-clip-rotate-multiple"
                  [fullScreen]="false"
                  color="#00529B"
                  size="medium"
                  bdColor="rgba(255, 255, 255, 0.966)"
                ></ngx-spinner>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
    <div class="card border-0 mt-3">
      <div class="card-header bg-transparent float-start border-bottom-0">
        <h6 class="float-start mt-3 fw-semibold">{{ 'crm.module' | translate}}</h6>

        <div class="row mb-3">
          <div class="col-12">
            <div class="float-end">
              <span class="icon-circle">
                <i class="fa-solid fa-plus" (click)="openDefineModuleModal()"></i>
              </span>
              <span class="icon-circle">
                <i class="pi pi-pencil" (click)="editModule()"></i>
              </span>
              <span class="icon-circle">
                <i class="fa-regular fa-trash-can" (click)="deleteModule()"></i>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="card-body p-0">

        <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B" size="medium" bdColor = "rgba(255, 255, 255, 0.966)"></ngx-spinner>
        <p-table
          #modulesTable
          [autoLayout]="true"
          [paginator]="true"
          [rowHover]="true"
          [resizableColumns]="true"
          [showCurrentPageReport]="true"
          [rows]="pageSize || 10"
          [totalRecords]="modulesData?.length"
          [value]="modulesData"
          [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]"
          responsiveLayout="stack"
          [scrollable]="true"
          [(selection)]= "selectedModule"
          selectionMode="single"
          dataKey="id"
          scrollHeight="400px"
          currentPageReportTemplate="{first} - {last} of {totalRecords}"
          [globalFilterFields]="['description, name']"
        >

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="name">{{ 'crm.moduleName' | translate }} <p-sortIcon field="name"></p-sortIcon></th>
              <th pSortableColumn="description">{{ 'crm.moduleDesc' | translate }} <p-sortIcon field="description"></p-sortIcon></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-module>
            <tr class="custom-table" [pSelectableRow]="module" (click)="onSelectModule(module)">
              <td>{{module?.name | titlecase}}</td>
              <td>{{module.description | titlecase}}</td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="3">No Module Detail(s) Found.</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <div class="card border-0 mt-3">
      <div class="card-header bg-transparent float-start border-bottom-0">
        <h6 class="float-start mt-3 fw-semibold">{{ 'crm.subModule' | translate }}</h6>
        <div class="row mb-3">
          <div class="col-12">
            <div class="float-end">
              <span class="icon-circle">
                <i class="fa-solid fa-plus" (click)="openSubModuleModal()"></i>
              </span>
              <span class="icon-circle">
                <i class="pi pi-pencil" (click)="editSubModule()"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body p-0">

        <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B" size="medium" bdColor = "rgba(255, 255, 255, 0.966)"></ngx-spinner>
        <p-table
          #subModulesTable
          [autoLayout]="true"
          [paginator]="true"
          [rowHover]="true"
          [resizableColumns]="true"
          [showCurrentPageReport]="true"
          [rows]="pageSize || 10"
          [totalRecords]="subModuleData?.length"
          [value]="subModuleData"
          [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]"
          responsiveLayout="stack"
          [scrollable]="true"
          selectionMode="single"
          [(selection)]= "selectedSubModule"
          dataKey="id"
          scrollHeight="400px"
          currentPageReportTemplate="{first} - {last} of {totalRecords}"
          [globalFilterFields]="['name, description']"
        >

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="name">{{ 'crm.name' | translate }} <p-sortIcon field="name"></p-sortIcon></th>
              <th pSortableColumn="description">{{ 'crm.description' | translate }} <p-sortIcon field="desc"></p-sortIcon></th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-subModule>
            <tr class="custom-table" [pSelectableRow]="subModule">
              <td>{{ subModule?.name | titlecase }}</td>
              <td>{{ subModule?.description | titlecase }}</td>

            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="2">No Sub Module Detail(s) Found.</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-lg-5 col-sm-12 p-0">
      <div class="card border-0 mt-3">
        <div class="card-header bg-transparent float-start border-bottom-0">
          <h6 class="float-start mt-3 fw-semibold">{{ 'crm.allReports' | translate }}</h6>
          <div class="row mb-3">
            <div class="col-12">
              <div class="float-end">
                <button class="btn btn-primary">
                  {{ 'base.save' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">

          <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B" size="medium" bdColor = "rgba(255, 255, 255, 0.966)"></ngx-spinner>
          <p-table
            #allReportsTable
            [autoLayout]="true"
            [paginator]="true"
            [rowHover]="true"
            [resizableColumns]="true"
            [showCurrentPageReport]="true"
            [rows]="pageSize || 10"
            [totalRecords]="allReportsData?.length"
            [value]="allReportsData"
            [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]"
            responsiveLayout="stack"
            [scrollable]="true"
            [(selection)]="selectedReport"
            selectionMode="single"
            dataKey="code"
            scrollHeight="400px"
            currentPageReportTemplate="{first} - {last} of {totalRecords}"
            [globalFilterFields]="['code, name, desc']"
          >

            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="code">{{ 'crm.code' | translate }} <p-sortIcon field="code"></p-sortIcon></th>
                <th pSortableColumn="name">{{ 'crm.reportName' | translate }} <p-sortIcon field="name"></p-sortIcon></th>
                <th pSortableColumn="desc">{{ 'crm.reportDesc' | translate }} <p-sortIcon field="desc"></p-sortIcon></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-report>
              <tr class="custom-table" [pSelectableRow]="report">
                <td></td>
                <td></td>
                <td>
                  <span title="{{report?.desc}}" (click)="toggleDropdown(report)">
                    {{report?.desc?.substring(0,20) | titlecase }}
                  </span>

                  <ng-container *ngIf="!report.desc || showInputForReport === report">
                    <input
                      type="text"
                      class="form-control"
                      placeholder="description"
                    />
                    <!--<p-dropdown
                      [options]="completionRemarksData"
                      optionLabel="remark"
                      optionValue="remark"
                      id="code"
                      [filter]="true"
                      filterBy="remark"
                      [showClear]="true"
                      [style]="{ 'width': '130px', 'height': '40px' }"
                      placeholder="Select remark"
                      appendTo="body"
                      (onChange)="onDropdownChange($event, report)"
                    >
                      <ng-template let-remark pTemplate="item">
                        <div title="{{remark.remark}}">{{ remark.remark.length > 10 ? remark.remark.substring(0, 28) + '...' : remark.remark }}</div>
                      </ng-template>
                    </p-dropdown>-->
                  </ng-container>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3">No Report Detail(s) Found.</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </div>
    <!--<div class="col-lg-2 col-sm-12 text-center my-auto">
      <button class="btn btn-primary mb-3" style="width: 103px" [disabled]="!selectedReport">
        {{ 'crm.add' | translate }}
        <i class="fa fa-arrow-right"></i>
      </button>
      <button class="btn btn-primary" style="width: 103px" [disabled]="!selectedAssignedReport">
        <i class="fa fa-arrow-left"></i>
        {{ 'crm.remove' | translate }}
      </button>
    </div>-->
    <!-- Laptop View -->
    <div class="col-lg-2 col-sm-12 text-center my-auto d-none d-lg-block">
      <button class="btn btn-primary mb-3" style="width: 103px" [disabled]="!selectedReport">
        {{ 'crm.add' | translate }}
        <i class="fa fa-arrow-right"></i>
      </button>
      <button class="btn btn-primary" style="width: 103px" [disabled]="!selectedAssignedReport">
        <i class="fa fa-arrow-left"></i>
        {{ 'crm.remove' | translate }}
      </button>
    </div>

    <!-- Phone View -->
    <div class="col-lg-2 col-sm-12 text-center my-3 d-block d-lg-none">
      <button class="btn btn-primary" style="width: 103px" [disabled]="!selectedReport">
        {{ 'crm.add' | translate }}
        <i class="fa fa-arrow-down"></i>
      </button>
      <button class="btn btn-primary" style="width: 103px" [disabled]="!selectedAssignedReport">
        <i class="fa fa-arrow-up"></i>
        {{ 'crm.remove' | translate }}
      </button>
    </div>

    <div class="col-lg-5 col-sm-12 p-0">
      <div class="card border-0 mt-3">
        <div class="card-header bg-transparent float-start border-bottom-0">
          <h6 class="float-start mt-3 fw-semibold">{{ 'crm.assignedReport' | translate }}</h6>
          <div class="row mb-3">
            <div class="col-12">
              <div class="float-end">
                <button class="btn btn-primary">
                  {{ 'base.save' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">

          <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B" size="medium" bdColor = "rgba(255, 255, 255, 0.966)"></ngx-spinner>
          <p-table
            #assignedReportsTable
            [autoLayout]="true"
            [paginator]="true"
            [rowHover]="true"
            [resizableColumns]="true"
            [showCurrentPageReport]="true"
            [rows]="pageSize || 10"
            [totalRecords]="assignedReportsData?.length"
            [value]="assignedReportsData"
            [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]"
            responsiveLayout="stack"
            [scrollable]="true"
            [(selection)]="selectedAssignedReport"
            selectionMode="single"
            dataKey="code"
            scrollHeight="400px"
            currentPageReportTemplate="{first} - {last} of {totalRecords}"
            [globalFilterFields]="['code, name, desc']"
          >

            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="code">{{ 'crm.code' | translate }} <p-sortIcon field="code"></p-sortIcon></th>
                <th pSortableColumn="name">{{ 'crm.reportName' | translate }} <p-sortIcon field="name"></p-sortIcon></th>
                <th pSortableColumn="desc">{{ 'crm.reportDesc' | translate }} <p-sortIcon field="desc"></p-sortIcon></th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-report>
              <tr class="custom-table" [pSelectableRow]="report">
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="3">No Report Detail(s) Found.</td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
    </div>
  </div>
</div>


<!--Module Definition Modal-->
<div
  class="modal fade"
  #moduleDefinitionModal
  id="moduleDefinitionModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
>
  <div class="modal-dialog align-items-center" style="width: 390px">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title" id="exampleModalLabel2">{{ editMode ? 'Edit' : 'Define' }} a {{ editMode ? 'module' : 'new module' }}</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeDefineModuleModal()"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="defineModuleForm">
          <div class="row my-3">
            <ng-container *ngIf="visibleStatus.system === 'Y'">
              <div class="col-md-12">
                <label for="system" class="form-label">{{ 'entities.system' | translate }}</label>
                <input
                  type="text"
                  class="form-control"
                  id="system"
                  formControlName="system"
                  [value]="selectedSystem?.systemName | titlecase"
                  [ngClass]="{ 'is-invalid': g['system']?.invalid && (g['system']?.dirty || g['system']?.touched) }"
                />
                <div *ngIf="g['system']?.invalid && (g['system']?.dirty || g['system']?.touched)" class="form-text text-danger">
                  <div *ngIf="g['system']?.errors['required']">System is required</div>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="visibleStatus.moduleName === 'Y'">
              <div class="col-md-12">
                <label for="moduleName" class="form-label">{{ 'crm.moduleName' | translate }}</label>
                <input
                  type="text"
                  class="form-control"
                  id="moduleName"
                  formControlName="moduleName"
                  [ngClass]="{ 'is-invalid': g['moduleName']?.invalid && (g['moduleName']?.dirty || g['moduleName']?.touched) }"
                />
                <div *ngIf="g['moduleName']?.invalid && (g['moduleName']?.dirty || g['moduleName']?.touched)" class="form-text text-danger">
                  <div *ngIf="g['moduleName']?.errors['required']">Module name is required</div>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="visibleStatus.moduleDescription === 'Y'">
              <div class="col-md-12">
                <label for="moduleDescription" class="form-label">{{ 'crm.description' | translate }}</label>
                <input
                  type="text"
                  class="form-control"
                  id="moduleDescription"
                  formControlName="moduleDescription"
                  [ngClass]="{ 'is-invalid': g['moduleDescription']?.invalid && (g['moduleDescription']?.dirty || g['moduleDescription']?.touched) }"
                />
                <div *ngIf="g['moduleDescription']?.invalid && (g['moduleDescription']?.dirty || g['moduleDescription']?.touched)" class="form-text text-danger">
                  <div *ngIf="g['moduleDescription']?.errors['required']">Description is required</div>
                </div>
              </div>
            </ng-container>
          </div>
        </form>

      </div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-primary" id="saveModuleBtn" (click)="saveModuleDetails()">{{ 'crm.saveDetails' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<!--Sub Module Definition Modal-->
<div
  class="modal fade"
  #subModuleDefinitionModal
  id="subModuleDefinitionModal"
  tabindex="-1"
  aria-labelledby="exampleModalLabel"
>
  <div class="modal-dialog modal-sm align-items-center">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <h5 class="modal-title" id="exampleModalLabel1">{{ editMode ? 'Edit' : 'Define' }} a {{ editMode ? 'sub module' : 'new sub module' }}</h5>
        <button
          type="button"
          class="btn-close"
          (click)="closeSubModuleModal()"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="defineSubModuleForm">
          <div class="row my-3">
            <ng-container *ngIf="visibleStatus.subModuleName === 'Y'">
              <div class="col-md-12">
                <label for="subModuleName" class="form-label">{{ 'crm.name' | translate }}</label>
                <input
                  type="text"
                  class="form-control"
                  id="subModuleName"
                  formControlName="subModuleName"
                  [ngClass]="{ 'is-invalid': g['subModuleName']?.invalid && (g['subModuleName']?.dirty || g['subModuleName']?.touched) }"
                />
                <div *ngIf="g['subModuleName']?.invalid && (g['subModuleName']?.dirty || g['subModuleName']?.touched)" class="form-text text-danger">
                  <div *ngIf="g['subModuleName']?.errors['required']">Sub module name is required</div>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="visibleStatus.subModuleDescription === 'Y'">
              <div class="col-md-12">
                <label for="subModuleDescription" class="form-label">{{ 'crm.description' | translate }}</label>
                <input
                  type="text"
                  class="form-control"
                  id="subModuleDescription"
                  formControlName="subModuleDescription"
                  [ngClass]="{ 'is-invalid': g['subModuleDescription']?.invalid && (g['subModuleDescription']?.dirty || g['subModuleDescription']?.touched) }"
                />
                <div *ngIf="g['subModuleDescription']?.invalid && (g['subModuleDescription']?.dirty || g['subModuleDescription']?.touched)" class="form-text text-danger">
                  <div *ngIf="g['subModuleDescription']?.errors['required']">Sub Module Description is required</div>
                </div>
              </div>
            </ng-container>
          </div>
        </form>

      </div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-primary" id="saveSubModuleBtn" (click)="saveSubModuleDetails()">{{ 'crm.saveDetails' | translate }}</button>
      </div>
    </div>
  </div>
</div>

<app-reusable-input
  [modalId]="'moduleConfirmationModal'"
  [title]="'Delete Confirmation'"
  [message]="'Are you sure you want to delete this module?'"
  (confirmed)="confirmModuleDelete()"
  #moduleConfirmationModal
></app-reusable-input>
