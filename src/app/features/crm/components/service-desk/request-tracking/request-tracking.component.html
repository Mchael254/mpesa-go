<div class="base-content-section">
  <div class="row">
    <div class="col-8">
      <app-dynamic-breadcrumb [breadCrumbItems]="[
      {
        label: 'Administration',
        url: '/home/crm'
      },
      {
        label: 'CRM Setups',
        url: '/home/crm',
      },
      {
        label: 'Service Desk Request',
        url: '/home/crm/service-desk'
      },
      {
        label: 'Request Tracking',
        url: '/home/crm/request-tracking'
      }
    ]">
      </app-dynamic-breadcrumb>
    </div>
    <div class="card border-0">
      <div class="card-header bg-transparent float-start border-bottom-0">

        <form [formGroup]="requestTrackingSortingForm">
          <div class="row mb-3">
            <div class="col-sm-12 d-flex justify-content-lg-start">
              <h6 class="my-3 fw-semibold">{{'serviceDesk.serviceRequestTracking' | translate}}</h6>
            </div>
            <div class="col-lg-2 col-sm-4 col-6">
              <label class="float-start">{{ 'serviceDesk.requestStatus' | translate }}:</label><br>
              <select class="form-select"  formControlName="status" (change)="requestTrackingFilters()">
                <option *ngFor="let status of mainStatusData"
                        [value]="status | titlecase">{{status | titlecase}}</option>
              </select>
            </div>

            <div class="col-lg-2 col-sm-6 col-6">
              <label class="float-start">{{ 'serviceDesk.requestOwner' | translate }}: </label>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  formControlName="owner"
                  value="{{selectedMainUser?.name}}"
                  id="owner"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="button-addon2"
                  (click)="openAllUsersModal('requestOwner')"
                >
                  <i class="fa-solid fa-angle-double-down open-all-users-modal"></i>
                </button>
              </div>
            </div>

            <div class="col-lg-2 col-sm-6 col-6">
              <label class="float-start">{{ 'serviceDesk.accType' | translate }}: </label>
              <select class="form-select" formControlName="accountType" (change)="requestTrackingFilters()">
                <option *ngFor="let accType of requestAccTypesData"
                        [value]="accType">{{accType}}</option>
              </select>
            </div>

            <div class="col-lg-2 col-sm-6 col-6" *ngIf="requestTrackingSortingForm.get('accountType').value">
              <label class="float-start">Select entity: </label>
              <div class="input-group mb-3">
                <input
                  type="text"
                  class="form-control"
                  formControlName="entity"
                  id="entity"
                />
                <button
                  class="btn btn-outline-secondary"
                  type="button"
                  id="button-addon"
                  (click)="openAllUsersModal('accType')"
                >
                  <i class="fa-solid fa-angle-double-down open-all-users-modal"></i>
                </button>
              </div>
            </div>
            <div class="col-lg-2 col-sm-6 col-6 align-content-center">
              <button
                class="btn btn-primary"
                type="button"
                id="clear"
                (click)="clearRequestTrackingSort()"
              >
                Clear
              </button>
            </div>
          </div>
        </form>

      </div>
      <div class="card-body p-0">

        <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B" size="medium" bdColor = "rgba(255, 255, 255, 0.966)"></ngx-spinner>
        <p-table
          #requestTrackingTable
          (onLazyLoad)="fetchServiceRequests($event)"
          [lazy]="true"
          [autoLayout]="true"
          [paginator]="true"
          [rowHover]="true"
          [resizableColumns]="true"
          [showCurrentPageReport]="true"
          [rows]="pageSize || 10"
          [totalRecords]="requestTrackingData?.totalElements"
          [value]="requestTrackingData.content"
          [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]"
          responsiveLayout="stack"
          [scrollable]="true"
          selectionMode="single"
          dataKey="code"
          scrollHeight="400px"
          currentPageReportTemplate="{first} - {last} of {totalRecords}"
          [globalFilterFields]="['accountDto.name', 'source', 'desc', 'policyNo', 'date', 'summary', 'dueDate', 'mainStatus',
          'assigneeDto.name', 'closedBy', 'reporter', 'communicationMode', 'refNumber', 'comments',
           'accountDto.shortDescription', 'accountDto.physicalAddress', 'accountDto.emailAddress', 'accountDto.smsNumber',
           'ownerDto.name', 'solution']"
        >

          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="accountDto.name">{{'serviceDesk.accountName'| translate }} <p-sortIcon field="accountDto.name"></p-sortIcon></th>
              <th pSortableColumn="campaign.objective">{{'serviceDesk.requestType'| translate }} <p-sortIcon field="campaign.objective"></p-sortIcon></th>
              <th pSortableColumn="source">{{'serviceDesk.source'| translate }} <p-sortIcon field="source"></p-sortIcon></th>
              <th pSortableColumn="desc">{{'serviceDesk.description'| translate }} <p-sortIcon field="desc"></p-sortIcon></th>
              <th pSortableColumn="policyNo">{{'serviceDesk.policyNumber'| translate }} <p-sortIcon field="policyNo"></p-sortIcon></th>
              <th pSortableColumn="date">{{'serviceDesk.creationDate'| translate }} <p-sortIcon field="date"></p-sortIcon></th>
              <th pSortableColumn="summary">{{'serviceDesk.summary'| translate }} <p-sortIcon field="summary"></p-sortIcon></th>
              <th pSortableColumn="dueDate">{{'serviceDesk.dueDate'| translate }} <p-sortIcon field="dueDate"></p-sortIcon></th>
              <th pSortableColumn="mainStatus">{{'serviceDesk.status'| translate }} <p-sortIcon field="mainStatus"></p-sortIcon></th>
              <th pSortableColumn="assigneeDto.name">{{'serviceDesk.assignee'| translate }} <p-sortIcon field="assigneeDto.name"></p-sortIcon></th>
              <th pSortableColumn="closedBy">{{'serviceDesk.closedByAssignee'| translate }} <p-sortIcon field="closedBy"></p-sortIcon></th>
              <th pSortableColumn="reporter">{{'serviceDesk.closedByInitiator'| translate }} <p-sortIcon field="reporter"></p-sortIcon></th>
              <th pSortableColumn="communicationMode">{{'serviceDesk.communicationMode'| translate }} <p-sortIcon field="communicationMode"></p-sortIcon></th>
              <th pSortableColumn="refNumber">{{'serviceDesk.referenceNumber'| translate }} <p-sortIcon field="refNumber"></p-sortIcon></th>
              <th pSortableColumn="comments">{{'serviceDesk.comments'| translate }} <p-sortIcon field="comments"></p-sortIcon></th>
              <th pSortableColumn="accountDto.shortDescription">{{'serviceDesk.shortDescription'| translate }} <p-sortIcon field="accountDto.shortDescription"></p-sortIcon></th>
              <th pSortableColumn="accountDto.physicalAddress">{{'serviceDesk.physicalAddress'| translate }} <p-sortIcon field="accountDto.physicalAddress"></p-sortIcon></th>
              <th pSortableColumn="accountDto.emailAddress">{{'serviceDesk.email'| translate }} <p-sortIcon field="accountDto.emailAddress"></p-sortIcon></th>
              <th pSortableColumn="accountDto.smsNumber">{{'entities.sms_number'| translate }} <p-sortIcon field="accountDto.smsNumber"></p-sortIcon></th>
              <th pSortableColumn="ownerDto.name">{{'serviceDesk.owner'| translate }} <p-sortIcon field="ownerDto.name"></p-sortIcon></th>
              <th pSortableColumn="solution">{{'serviceDesk.solution'| translate }} <p-sortIcon field="solution"></p-sortIcon></th>
              <th>Action</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-requestTracking>
            <tr class="custom-table">
              <td>
                {{requestTracking.accountDto.name | titlecase}}
              </td>
              <td>
                <span title="{{requestTracking?.incidentDto?.name}}">
                    {{requestTracking?.incidentDto?.name.substring(0,20) | titlecase}}
                </span>
              </td>
              <td>{{requestTracking?.source | titlecase}}</td>
              <td>
                <span title="{{requestTracking?.desc}}">
                    {{requestTracking?.desc.substring(0,10) | titlecase}}
                </span>
              </td>
              <td>{{requestTracking?.policyNo}}</td>
              <td>{{requestTracking?.date | date: 'dd-MM-yyyy'}}</td>
              <td>
                <span title="{{requestTracking?.summary}}">
                    {{requestTracking?.summary.substring(0,10) | titlecase}}
                </span>
              </td>
              <td>{{requestTracking?.dueDate | date: 'dd-MM-yyyy'}}</td>
              <td>{{requestTracking?.mainStatus}}</td>
              <td>{{requestTracking?.assigneeDto?.name | titlecase}}</td>
              <td>{{requestTracking?.closedBy}}</td>
              <td>{{requestTracking?.reporter}}</td>
              <td>{{requestTracking?.communicationMode}}</td>
              <td>
                <span title="{{requestTracking?.refNumber}}" *ngIf="requestTracking?.refNumber != null && requestTracking?.refNumber != ''">
                    {{requestTracking?.refNumber.substring(0,20)}}
                </span>
              </td>
              <td>
                <span title="{{requestTracking?.comments}}" *ngIf="requestTracking?.comments != null && requestTracking?.comments != ''">
                    {{requestTracking?.comments.substring(0,10) | titlecase}}
                </span>
              </td>
              <td>
                {{requestTracking?.accountDto?.shortDescription}}
              </td>
              <td>
                <span title="{{requestTracking?.accountDto?.physicalAddress}}" *ngIf="requestTracking?.accountDto?.physicalAddress != null && requestTracking?.accountDto?.physicalAddress != ''">
                    {{requestTracking?.accountDto?.physicalAddress.substring(0,15) | titlecase}}
                </span>
              </td>
              <td>
                {{requestTracking?.accountDto?.emailAddress}}
              </td>
              <td>
                {{requestTracking?.accountDto?.smsNumber}}
              </td>
              <td>{{requestTracking?.ownerDto?.name | titlecase}}</td>
              <td>
                <span title="{{requestTracking?.solution}}" *ngIf="requestTracking?.solution != null && requestTracking?.solution != ''">
                    {{requestTracking?.solution.substring(0,10) | titlecase}}
                </span>
              </td>
              <td (click)="viewRequest(requestTracking)">
                <i class="fa-regular fa-eye" style="font-size: 17px; cursor: pointer; color: #00529b"></i>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="20">No Service Request Tracking Detail(s) Found.</td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>

<!--Request tracking modal-->
<div class="modal fade" #requestTrackingModal id="requestTrackingModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <h1 class="modal-title fs-5" id="exampleModalLabel">{{'serviceDesk.serviceRequest' | translate}}</h1>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeServiceRequestTrackingModal()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="requestTrackingForm">
          <div class="row my-3">
            <div class="col-md-6 mb-3">
              <label for="categoryType" class="form-label">Request category type</label>
              <input
                type="text"
                class="form-control"
                id="categoryType"
                formControlName="categoryType"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="requestIncidence" class="form-label">Request incidence</label>
              <input
                type="text"
                class="form-control"
                id="requestIncidence"
                formControlName="requestIncidence"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="requestSource" class="form-label">Request source</label>
              <input
                type="text"
                class="form-control"
                id="requestSource"
                formControlName="requestSource"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="accType" class="form-label">Account type</label>
              <input
                type="text"
                class="form-control"
                id="accType"
                formControlName="accType"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="acc" class="form-label">Account</label>
              <input
                type="text"
                class="form-control"
                id="acc"
                formControlName="acc"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="summary" class="form-label">Summary</label>
              <input
                type="text"
                class="form-control"
                id="summary"
                formControlName="summary"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="requestDate" class="form-label">Request date</label>
              <input
                type="text"
                class="form-control"
                id="requestDate"
                formControlName="requestDate"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="dueDate" class="form-label">Due date</label>
              <input
                type="text"
                class="form-control"
                id="dueDate"
                formControlName="dueDate"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="desc" class="form-label">Description</label>
              <input
                type="text"
                class="form-control"
                id="desc"
                formControlName="desc"
              />
            </div>
            <div class="col-md-6" mb-3>
              <label for="assignee" class="form-label">Assignee</label>
              <input
                type="text"
                class="form-control"
                id="assignee"
                formControlName="assignee"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="owner" class="form-label">Owner</label>
              <input
                type="text"
                class="form-control"
                id="owner"
                formControlName="owner"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="ownerAccType" class="form-label">Owner acc type</label>
              <input
                type="text"
                class="form-control"
                id="ownerAccType"
                formControlName="ownerAccType"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="status" class="form-label">Status</label>
              <input
                type="text"
                class="form-control"
                id="status"
                formControlName="status"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="resDate" class="form-label">Resolution date</label>
              <input
                type="text"
                class="form-control"
                id="resDate"
                formControlName="resDate"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="solution" class="form-label">Solution</label>
              <input
                type="text"
                class="form-control"
                id="solution"
                formControlName="solution"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="comments" class="form-label">Comments</label>
              <input
                type="text"
                class="form-control"
                id="comments"
                formControlName="comments"
              />
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!--Modal for Listing all users !-->
<app-dynamic-simple-modal
  [modalVisible]="allUsersModalVisible"
  [modalButtonLabel]="'Okay'"
  [showModalButtons]="true"
  [useDynamicContent]="true"
  [modalTitle]="'Users'"
  [zIndex]="1"
  (actionEmitter)="processSelectedUser($event)"
  id="process-selected-user"
>
  <div modal-body-content>
    <app-staff-modal
      #staffModal
      [accountType]="selectedUserType"
      (userSelected)="getSelectedUser($event)"
      id="get-selected-user"
    >
    </app-staff-modal>
  </div>
</app-dynamic-simple-modal>
