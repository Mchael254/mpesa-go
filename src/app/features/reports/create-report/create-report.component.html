<div class="base-content-section dashboard">
  <h5 class="section-title">Create Report</h5>
  <div class="row">
    <div class="col-sm-3 left">
      <div class="card mb-3">
        <div class="card-body">
          <h6 class="text-primary fw-bold">Subject Areas</h6>
          <form [formGroup]="searchForm" class="my-3">
            <div class="form-group">
              <p-dropdown
                styleClass="dropdownStyle"
                [options]="subjectAreas"
                optionLabel="subjectAreaName"
                [filter]="true"
                filterBy="subjectAreaName"
                [showClear]="true"
                placeholder="Select Subject Area"
              >
                <ng-template let-subjectArea pTemplate="item">
                  <div class="flex align-items-center gap-2">
                    <div
                      (click)="getCategoriesBySubjectAreaId(subjectArea)">
                      {{ subjectArea.subjectAreaName }}
                    </div>
                  </div>
                </ng-template>
              </p-dropdown>
            </div>
          </form>

          <div class="text-center" *ngIf="subjectAreaCategories === null; else showSubjectAreaCategories">
            <p-progressSpinner></p-progressSpinner>
          </div>
          <ng-template #showSubjectAreaCategories>
            <ng-container *ngFor="let category of subjectAreaCategories">
              <p
                data-bs-toggle="collapse"
                [attr.data-bs-target]="'#'+category.description"
                role="button"
                aria-expanded="false" [attr.aria-controls]="category.description"
                class="dropdown-toggle"
                id="category-name"
              >
                {{ category?.name }}
              </p>
              <div class="collapse" [attr.id]="category.description">
                <ng-container *ngFor="let subCategory of category.subCategory">
                  <ul
                    class="sub-category"
                    data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#'+category.description+subCategory.description"
                    role="button"
                    aria-expanded="false"
                    aria-controls="collapseExample2"
                  >
                    <li class="dropdown-toggle" id="sub-category-name">
                      {{ subCategory.name }}
                    </li>
                  </ul>
                  <div class="collapse" [attr.id]="category.description+subCategory.description">
                    <ul *ngFor="let query of subCategory.categoryAreas">
                      <li
                        [ngClass]="{'text-primary font-weight-bold' : query.isSelected === true, 'text-secondary': query.isSelected === false}"
                        (dblclick)="selectCriteria(category, subCategory, query)"
                        class="query"
                      >
                        {{ query.name }}
                      </li>
                    </ul>
                  </div>
                </ng-container>
              </div>
            </ng-container>
          </ng-template>

        </div>
      </div>
    </div>

    <div class="col-sm-9 right">
      <div class="card mb-3">
        <div class="card-body">
          <div class="row preview-top">
            <div class="col-sm-4">
              <button
                type="button" class="btn btn-primary" id="criteria-btn"
                [ngClass]="{'active-btn': isCriteriaButtonActive, 'inactive-btn': !isCriteriaButtonActive}"
                (click)="toggleCriteriaPreview('criteria')"
              >
                Criteria
              </button>
              <button
                type="button" class="btn btn-outline-secondary" id="preview"
                [ngClass]="{'active-btn': !isCriteriaButtonActive, 'inactive-btn': isCriteriaButtonActive}"
                (click)="toggleCriteriaPreview('preview')"
              >
                Preview Results
              </button>
            </div>
            <div class="col-sm-4 offset-sm-4 criteria-preview">
              <button type="button" class="btn btn-primary" (click)="addReportToDashboard()">Add to Dashboard</button>
              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveReportModal">Save</button>
            </div>
          </div>

          <ng-container *ngIf="isCriteriaButtonActive">
            <div class="row">
              <ng-container *ngFor="let criteriaItem of criteria">
                <div class="col-sm-3">
                  <app-criteria-pill
                    [queryObject]="criteriaItem"
                    (deleteCriteriaDetails)="deleteCriteria($event)"
                  ></app-criteria-pill>
                </div>
              </ng-container>
            </div>
          </ng-container>

          <ng-container *ngIf="!isCriteriaButtonActive">
            <div class="preview-nav">
              <div class="row position-relative">
                <div class="col-sm-4">
                  <span class="icons" (click)="showVisualizationList()">
                    <i class="pi pi-chart-bar"></i>
                    <i class="pi pi-caret-down"></i>
                  </span>
                  <span class="icons">
                    <i class="pi pi-undo"></i>
                  </span>
                  <ng-container *ngIf="shouldShowVisualization">
                    <div class="position-absolute visualizations">
                      <ul>
                        <ng-container *ngFor="let chartType of chartTypes" >
                          <li class="chart-type" (click)="selectChartType(chartType)">
                            <i [class]="chartType.iconClass"></i>
                            <span class="ml-2">{{ chartType.name }}</span>
                          </li>
                        </ng-container>
                      </ul>
                    </div>
                  </ng-container>
                </div>
                <div class="col-sm-2 offset-sm-6">
                  <span class="icons">
                    <i class="pi pi-file"></i>
                  </span>
                  <span class="icons">
                    <i class="pi pi-print"></i>
                  </span>
                </div>
              </div>
            </div>
            <div class="row preview-div">

              <div class="col-sm-10 offset-sm-1">

                <div class="text-center" *ngIf="!isPreviewResultAvailable">
                  <p-progressSpinner></p-progressSpinner>
                </div>

                <h6 class="mainHead text-center" *ngIf="reportTitle != ''">{{ reportTitle | titlecase }}</h6>

                <div class="mt-4"
                     *ngIf="shouldShowTable && isPreviewResultAvailable;
                     else showChart"
                >
                  <app-dynamic-table
                    [tableDetails]="tableDetails"
                  ></app-dynamic-table>
                </div>

                <ng-template #showChart>
                  <div
                    *ngIf="isPreviewResultAvailable"
                    style="max-height: 600px"
                    class="py-2"
                  >
                    <app-dynamic-chart
                      [chartType]="chartType"
                      [basicData]="chartData"
                    ></app-dynamic-chart>
                  </div>
                </ng-template>

              </div>
            </div>
          </ng-container>

        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal -->
<div class="modal fade" id="saveReportModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form [formGroup]="saveReportForm">
        <div class="modal-header">
          <div class="row" style="width: 100%">
            <div class="col-sm-3">
              <p class="modal-title fw-bold">File Uploads</p>
            </div>
            <div class="col-sm-8">
              <div class="form-group">
                <input
                  (keyup)="searchReport()"
                  formControlName="reportSearch"
                  class="form-control"
                  aria-describedby="saveReportSearch"
                  placeholder="Search report"
                  id="saveReportSearch"
                >
              </div>
            </div>
            <div class="col-sm-1" style="float: right; text-align: right">
              <span class="btn-close" data-bs-dismiss="modal" aria-label="Close"></span>
            </div>
          </div>
        </div>

        <div class="modal-body">
          <div class="row">
            <div class="col-sm-3 left">
              <ul *ngFor="let folder of folders">
                <li
                  [ngStyle]="{'backgroundColor': folder.active ? '#D0DAE3' : '#ffffff' }"
                  (click)="selectFolder(folder)"
                >
                  <i class="pi pi-folder"></i>{{ folder.name }}
                </li>
              </ul>
            </div>
            <div class="col-sm-9">
              <div class="row report-row">
                <ng-container *ngFor="let report of reports$ | async">
                  <div class="col-sm-4 report-item">
                    <i class="pi pi-folder"></i>
                    <span>{{ report.reportName }}</span>
                  </div>
                </ng-container>
              </div>

              <div class="row">
                <div class="col-sm-12">
                  <div class="form-group">
                    <label for="description">File name</label>
                    <input
                      formControlName="reportName"
                      class="form-control"
                      aria-describedby="reportName"
                      placeholder="File name"
                      id="reportName"
                    >
                  </div>
                  <div class="form-group">
                    <label for="description">Description</label>
                    <textarea
                      formControlName="reportDescription"
                      class="form-control"
                      id="description"
                      rows="3"
                    >
                </textarea>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </form>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="saveReport()">Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- Save Modal-->

<!--
<div class="modal fade" id="saveReportModal2" tabindex="-1" role="dialog" aria-labelledby="saveReportModal" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content mb-2">
      <form [formGroup]="saveReportForm">
        <div class="modal-header">
          <div class="row" style="width: 100%">
            <div class="col-sm-3">
              <h6>File uploads</h6>
            </div>
            <div class="col-sm-6">
              <div class="form-group">
                <input
                  (keyup)="searchReport()"
                  formControlName="reportSearch"
                  class="form-control"
                  aria-describedby="saveReportSearch"
                  placeholder="Search report"
                  id="saveReportSearch"
                >
              </div>
            </div>
            <div class="col-sm-3">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          </div>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-3 left">
              <ul *ngFor="let folder of folders">
                <li
                  [ngStyle]="{'backgroundColor': folder.active ? '#D0DAE3' : '#ffffff' }"
                  (click)="selectFolder(folder)"
                >
                  <i class="pi pi-folder"></i>{{ folder.name }}
                </li>
                &lt;!&ndash;<li><i class="pi pi-folder-open"></i>Shared Reports</li>&ndash;&gt;
              </ul>
            </div>
            <div class="col-sm-9">
              <div class="row report-row">
                <ng-container *ngFor="let report of reports$ | async">
                  <div class="col-sm-4 report-item">
                    <i class="pi pi-folder"></i>
                    <span>{{ report.reportName }}</span>
                  </div>
                </ng-container>
              </div>

              <div class="row">
                <div class="col-sm-12">
                  <div class="form-group">
                    <label for="description">File name</label>
                    <input
                      formControlName="reportName"
                      class="form-control"
                      aria-describedby="reportName"
                      placeholder="File name"
                      id="reportName"
                    >
                  </div>
                  <div class="form-group">
                    <label for="description">Description</label>
                    <textarea
                      formControlName="reportDescription"
                      class="form-control"
                      id="description"
                      rows="3"
                    >
                    </textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
      <div class="modal-footer">
        <button type="button" class="btn active-btn" data-dismiss="modal" (click)="saveReport()">Proceed</button>
      </div>
    </div>
  </div>
</div>
-->

<!-- Save modal ends-->
