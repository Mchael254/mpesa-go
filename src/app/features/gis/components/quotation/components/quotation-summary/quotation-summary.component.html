<div class="mx-4 mt-3">
  <p class="title">Quotations:Quotation Summary</p>

  <app-stepper [currentStep]="3" [stepperData]="steps" [disableNavigation]="true"
    [disabled]="viewQuoteFlag"></app-stepper>
  <p *ngIf="ticketStatus" class="text-primary ps-5" style="font-weight: 500;">Ticket status:<span
      style="color: black;">{{ticketStatus
      |sentenceCase}}
    </span>
  </p>
  <div class="card mb-3">
    <div class="header mx-4 mt-2 mb-2">
      <ul class="nav">
        <li class="nav-item">
          <!-- <a class="nav-link sub-title active" data-bs-toggle="tab" id="nav-summary-tab" aria-controls="nav-summary"
            data-bs-target="#nav-summary">Quotation Summary</a> -->
          <a class="nav-link sub-title active" (click)="activeQuoteTab='summary'" id="nav-summary-tab"
            data-bs-toggle="tab" aria-controls="nav-summary" data-bs-target="#nav-summary">Quotation summary</a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link sub-title" data-bs-toggle="tab" id="nav-quotation-other-details-tab"
            aria-controls="nav-quotation-other-details" data-bs-target="#nav-quotation-other-details">Quotation Other
            Details</a>
        </li>
        <li class="nav-item">
          <a class="nav-link sub-title" data-bs-toggle="tab" id="nav-reports-tab" aria-controls="nav-authorization"
            data-bs-target="#nav-reports">Reports and documents</a>
        </li> -->
        <li class="nav-item">
          <a class="nav-link sub-title" (click)="activeQuoteTab='otherDetails'" id="nav-quotation-other-details-tab"
            data-bs-toggle="tab" aria-controls="nav-quotation-other-details"
            data-bs-target="#nav-quotation-other-details">
            Quotation other details
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link sub-title" (click)="activeQuoteTab='reports'" id="nav-reports-tab" data-bs-toggle="tab"
            aria-controls="nav-authorization" data-bs-target="#nav-reports">
            Reports and documents
          </a>
        </li>
      </ul>
    </div>
  </div>

  <div class="tab-content" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-summary" role="tabpanel" aria-labelledby="nav-summary-tab"
      tabindex="0">
      <div class="spinner" style="position: relative">
        <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="true" color="#00529B" size="large"
          bdColor="rgba(255, 255, 255, 0.966)"></ngx-spinner>
      </div>

      <!-- Quotation details card  -->
      <div class="card mb-4">
        <div class="card-body">
          <p class="card-titles mb-4">Quotation details</p>

          <div class="row mb-3">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Quotation Number</p>
              <p class="content w-50">{{ fetchedQuoteNum }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Branch</p>
              <p class="content w-50">{{ branch }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Currency</p>
              <p class="content w-50">{{ quotationView?.currency }}</p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Expiry Date</p>
              <p class="content w-50">{{ expiryDate }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Cover From</p>
              <p class="content w-50">{{ coverFrom }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Cover To</p>
              <p class="content w-50">{{ coverTo }}</p>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Status</p>
              <p class="content w-50">{{ quotationView?.status }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Frequency of Payment</p>
              <p class="content w-50">
                {{ getPaymentFrequencyLabel(quotationView?.frequencyOfPayment) }}
              </p>
            </div>
            <div class="col-md-4 d-flex align-items-center position-relative">
              <p class="label w-50 mb-0 me-2">Notes</p>

              <div class="d-flex align-items-center w-50">
                <p class="content mb-0 me-2">
                  {{
                  quotationView?.comments? quotationView.comments.split(" ").slice(0, 3).join(" ") +
                  (quotationView.comments.split(" ").length > 3? "...": ""): ""
                  }}
                </p>

                <i class="fas fa-edit text-primary" style="cursor: pointer" (click)="openCommentModal()"></i>
              </div>
            </div>
          </div>

          <p class="card-titles mb-4">Client information</p>

          <div class="row mb-3">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Client</p>
              <p class="content w-50">{{clientName || quotationView?.clientName }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Proposer</p>
              <p class="content w-50">{{ clientDetails?.proposer }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Introducer</p>
              <p class="content w-50">{{ introducerName }}</p>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Source</p>
              <p class="content w-50">
                {{ quotationView?.source?.description }}
              </p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Likelihood</p>
              <p class="content w-50">{{ quotationView?.likelihood }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Agent</p>
              <p class="content w-50">{{ quotationView?.agentName }}</p>
            </div>
          </div>

          <p class="card-titles mb-4">Financial overview</p>

          <div class="row mb-3">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Premium</p>
              <p class="content w-50">
                {{ quotationView?.premium | currency: currencyObj?.prefix :
                'symbol' : '1.2-2'}}
              </p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Sum Insured</p>
              <p class="content w-50">
                {{ quotationView?.sumInsured | currency: currencyObj?.prefix :
                'symbol' : '1.2-2'}}
              </p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Marketer Comm.</p>
              <p class="content w-50">
                {{ quotationView?.marketerCommissionAmount | currency: currencyObj?.prefix :
                'symbol' : '1.2-2' }}
              </p>
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-md-4 d-flex">
              <p class="label w-50">Comm amt.</p>
              <p class="content w-50">{{ quotationView?.commissionAmount | currency: currencyObj?.prefix :
                'symbol' : '1.2-2' }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Comments</p>
              <p class="content w-50">{{ quotationView?.comments }}</p>
            </div>
            <div class="col-md-4 d-flex">
              <p class="label w-50">Internal Comments</p>
              <p class="content w-50">{{ quotationView?.internalComments }}</p>
            </div>
          </div>

          <div class="d-flex justify-content-end align-items-center mt-4">
            <!-- (click)="viewClientProfile()" -->
            <a href="#" class="text-muted text-decoration-underline" pTooltip="Feature under development"
              tooltipPosition="top" (click)="$event.preventDefault()">
              View Client Profile
            </a>

            <!-- <button class="btn btn-outline-primary custom-outline-btn" style="margin-right: 10px; margin-left: 20px"
              (click)="editQuotationDetails()" [disabled]="isEditDisabled()">
              Edit details
            </button> -->
            <span [pTooltip]="isEditDisabled() ? 'No further action — quotation already authorized.' : null"
              tooltipPosition="top">
              <button class="btn custom-outline-btn"
                [ngClass]="isEditDisabled() ? 'btn-secondary' : 'btn-outline-primary'"
                style="margin-right: 10px; margin-left: 20px" (click)="editQuotationDetails()"
                [disabled]="isEditDisabled()">
                Edit details
              </button>
            </span>



          </div>
        </div>
      </div>
      <!-- edit notes Modal -->
      <div *ngIf="showCommentModal" class="modal-backdrop-custom">
        <div class="modal d-block" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
              <div class="modal-header border-0">
                <h5 class="modal-title">Edit Notes</h5>
                <button type="button" class="btn-close" aria-label="Close" (click)="closeCommentModal()"></button>
              </div>
              <div class="modal-body">
                <textarea [(ngModel)]="editableComment" class="form-control w-90%" rows="3"></textarea>
              </div>
              <div class="modal-footer border-0">
                <button class="btn btn-secondary btn-lightblue" (click)="closeCommentModal()">
                  Cancel
                </button>
                <button class="btn btn-primary" (click)="saveComment()">
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Details Card -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-4">
              <p class="card-title mt-2">Products</p>
            </div>
            <div class="col-8 d-flex justify-content-end">
              <div class="row">
                <div class="col-4">
                  <button type="button" id="icon" class="btn btn-primary" data-bs-toggle="collapse"
                    data-bs-target="#productDetails" (click)="toggleProductDetails()"
                    [attr.aria-expanded]="!isCollapsibleOpen">
                    <i class="fa-solid" [ngClass]="
                        isCollapsibleOpen ? 'fa-chevron-up' : 'fa-chevron-down'
                      "></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="isCollapsibleOpen" class="mt-4" id="productDetails">

            <div class="row mb-1">
              <div class="col-12 d-flex justify-content-end" style="margin-bottom: 0;">

                <div class="d-flex justify-content-center align-items-center">

                  <i #iconTrigger class="pi border border-black p-1 rounded-1 text-black"
                    [ngClass]="{ 'pi-caret-up': showProducts, 'pi-caret-down': !showProducts }"
                    style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                    (click)="toggleProducts(iconTrigger)">
                  </i>
                </div>

              </div>
            </div>

            <!-- Floating Column Selector -->
            <div *ngIf="showProductColumnModal" class="card shadow rounded p-2 position-absolute bg-white border"
              [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
              (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
              (document:mouseup)="onDragEnd()">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong class="text-primary">Select Columns</strong>
                <button class="btn-close btn-sm" (click)="showProductColumnModal = false"></button>
              </div>
              <div style="max-height: 200px;max-width:250px; overflow-y: auto;">
                <div *ngFor="let col of columns">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" style="color: #00529B;" [(ngModel)]="col.visible"
                      [id]="col.field">
                    <label class="form-check-label" [for]="col.field">
                      {{ col.header }}
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Product table -->
            <div class="mt-3" id="">
              <p-table [value]="productDetails" dataKey="productCode?.code" editMode="row"
                [tableStyle]="{'min-width': '50rem'}" [scrollable]="true" scrollDirection="horizontal"
                [paginator]="productDetails?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3"
                [resizableColumns]="true" scrollHeight="400px">

                <!-- Table Header -->
                <ng-template pTemplate="header">
                  <tr>
                    <th *ngFor="let col of columns" [hidden]="!col.visible" class="flexible-header1"
                      [pSortableColumn]="col.field">
                      {{ col.header }}
                      <p-sortIcon [field]="col.field"></p-sortIcon>
                    </th>
                  </tr>
                </ng-template>

                <!-- Table Body -->
                <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex">
                  <tr (click)="handleProductClick(product)" [ngClass]="{ 'selected-row': selectedProduct === product }"
                    [pEditableRow]="product" class="hover:!bg-gray-50 !cursor-pointer transition-colors">

                    <td *ngFor="let col of columns" [hidden]="!col.visible" class="flexible-header"
                      [ngClass]="{ 'text-end': col.field === 'premium' || col.field === 'totalSumInsured' }">

                      <ng-container [ngSwitch]="col.field">
                        <ng-container *ngSwitchDefault>
                          <ng-container *ngSwitchDefault>
                            <ng-container
                              *ngIf="col.field === 'premium' || col.field === 'totalSumInsured'; else defaultField">
                              {{ product[col.field] | currency: currencyObj?.prefix : 'symbol' : '1.2-2'
                              }}
                            </ng-container>
                            <ng-template #defaultField>
                              {{ product[col.field] }}
                            </ng-template>
                          </ng-container>

                        </ng-container>
                      </ng-container>
                    </td>
                  </tr>
                </ng-template>

                <!-- Empty Message -->
                <ng-template pTemplate="emptymessage">
                  <tr>
                    <td [attr.colspan]="columns.length" style="text-align:center; padding: 20px;">
                      No data to display
                    </td>
                  </tr>
                </ng-template>
              </p-table>

              <!-- Delete Product Modal -->
              <div class="modal fade" id="deleteProduct" tabindex="-1" role="dialog" aria-labelledby="deleteProduct"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content" id="deleteProduct">
                    <div class="modal-body">
                      <p class="deleteMessage mt-4 mb-4">
                        {{
                        "gis.policy.are_you_sure_you_want_to_delete"
                        | translate
                        }}
                      </p>
                      <div class="d-flex justify-content-center mb-3">
                        <button type="button" class="btn btn-primary px-5" id="delete" data-bs-dismiss="modal"
                          (click)="deleteProduct()">
                          {{ "gis.policy.yes_delete" | translate }}
                        </button>
                      </div>
                      <div class="d-flex justify-content-center mb-2">
                        <button type="button" class="btn btn-outline-primary px-5" data-bs-dismiss="modal">
                          {{ "gis.policy.no_im_not" | translate }}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- TABS  -->
              <div class="row mt-5 mb-3">
                <div class="col-7">
                  <ul class="nav nav-underline">
                    <li class="nav-item">
                      <a class="nav-link active" [class.active]="activeTab === 'clauses'"
                        (click)="setActiveTab('clauses')" aria-current="page" data-bs-toggle="tab"
                        data-bs-target="#nav-clauses">Clauses</a>
                    </li>
                    <br />
                    <li class="nav-item">
                      <a class="nav-link" [class.active]="activeTab === 'taxes'" (click)="setActiveTab('taxes')"
                        data-bs-toggle="tab" data-bs-target="#nav-taxes">Taxes</a>
                    </li>
                  </ul>
                </div>

                <div class="col-5 d-flex justify-content-end" id="navigationIcons">
                  <div class="row" *ngIf="
                      activeTab === 'clauses' ||
                      activeTab === 'taxes' ||
                      activeTab === 'limits'
                    ">
                    <div class="col-sm-3"></div>
                    <div class="d-flex justify-content-end align-items-center">

                      <i *ngIf="activeTab === 'clauses'" #iconTrigger
                        class="pi border border-black p-1 rounded-1 text-black"
                        [ngClass]="{ 'pi-caret-up': showClauses, 'pi-caret-down': !showClauses }"
                        style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                        (click)="toggleClauses(iconTrigger)">
                      </i>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-content mb-4" id="nav-tabContent">
                <!-- CLAUSES -->
                <!-- Floating Clauses Column Selector -->
                <div *ngIf="showClausesColumnModal" class="card shadow rounded p-2 position-absolute bg-white border"
                  [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                  (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                  (document:mouseup)="onDragEnd()">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong class="text-primary">Select Clauses Columns</strong>
                    <button class="btn-close btn-sm" (click)="showClausesColumnModal = false"></button>
                  </div>

                  <div style="max-height: 250px; overflow-y: auto;">
                    <div *ngFor="let col of productClauseColumns">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                          (change)="toggleProductClauseColumnVisibility(col.field)" [id]="col.field">
                        <label class="form-check-label" [for]="col.field">
                          {{ col.header }}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- product clauses table -->
                <div class="tab-pane fade show active" id="nav-clauses" role="tabpanel" aria-labelledby="nav-clauses"
                  tabindex="0">
                  <p-table [value]="sessionClauses" #productClauseTable [paginator]="sessionClauses?.length > 10"
                    [rowsPerPageOptions]="[3, 5, 10]" [rows]="3" [showCurrentPageReport]="true"
                    currentPageReportTemplate="{first} - {last} of {totalRecords}" class="ui-datatable"
                    responsiveLayout="scroll" [autoLayout]="true" [scrollable]="true" scrollHeight="200px">

                    <!-- Table Header -->
                    <ng-template pTemplate="header">
                      <tr>
                        <th *ngFor="let col of productClauseColumns" [hidden]="!col.visible" class="flexible-header"
                          [pSortableColumn]="col.field">
                          {{ col.header }}
                          <p-sortIcon [field]="col.field"></p-sortIcon>
                        </th>
                      </tr>
                    </ng-template>

                    <!-- Table Body -->
                    <ng-template pTemplate="body" let-clause let-rowIndex="rowIndex">
                      <!-- Filters Row -->
                      <ng-container *ngIf="rowIndex === 0">
                        <tr>
                          <td *ngFor="let col of productClauseColumns" [hidden]="!col.visible">
                            <input type="text" pInputText class="form-control w-70"
                              (input)="filterTable($event, col.field, productClauseTable)" />
                          </td>
                        </tr>
                      </ng-container>

                      <!-- Data Row -->
                      <tr>
                        <td *ngFor="let col of productClauseColumns" [hidden]="!col.visible">
                          <ng-container [ngSwitch]="col.field">

                            <!-- Truncated fields -->
                            <ng-container *ngSwitchCase="'clauseWording'">
                              <div class="clause-wrapper">
                                {{ clause[col.field] | sentenceCase }}
                                <div class="hover-card">
                                  {{ clause[col.field] | sentenceCase }}
                                </div>
                              </div>

                            </ng-container>

                            <span *ngSwitchCase="'clauseHeading'">
                              {{ clause[col.field] | sentenceCase }}
                            </span>
                            <span *ngSwitchCase="'clauseShortDescription'">
                              {{ clause[col.field] | sentenceCase }}
                            </span>

                            <!-- All other fields -->
                            <span *ngSwitchDefault>
                              {{ clause[col.field] }}
                            </span>

                          </ng-container>
                        </td>

                      </tr>
                    </ng-template>

                    <!-- Empty Message -->
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td [attr.colspan]="productClauseColumns.length" class="text-center text-muted py-3">
                          “No product clauses available.”
                        </td>
                      </tr>
                    </ng-template>

                  </p-table>
                </div>

                <!-- TAXES -->
                <div class="d-flex justify-content-end align-items-center">
                  <i *ngIf="activeTab === 'taxes'" #iconTaxes class="pi border border-black p-1 rounded-1 text-black"
                    [ngClass]="{ 'pi-caret-down': showTaxesColumnModal, 'pi-caret-up': !showTaxesColumnModal }"
                    style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                    (click)="toggleTaxes(iconTaxes)">
                  </i>
                </div>


                <!-- Floating Column Selector for Taxes -->
                <div *ngIf="showTaxesColumnModal" class="card shadow rounded p-2 position-absolute bg-white border"
                  [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                  (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                  (document:mouseup)="onDragEnd()">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <strong class="text-primary">Select Tax Columns</strong>
                    <button class="btn-close btn-sm" (click)="showTaxesColumnModal = false"></button>
                  </div>
                  <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                    <div *ngFor="let col of taxesColumns">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible" [id]="col.field">
                        <label class="form-check-label" [for]="col.field">
                          {{ col.header }}
                        </label>
                      </div>
                    </div>
                  </div>
                </div>


                <!-- TAXES -->
                <div class="tab-pane fade" id="nav-taxes" role="tabpanel" aria-labelledby="nav-taxes" tabindex="0">
                  <p-table [value]="taxDetails" #taxTable [tableStyle]="{ 'min-width': '50rem' }"
                    [paginator]="taxDetails?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3">

                    <!-- Table Header -->
                    <ng-template pTemplate="header">
                      <tr>
                        <th *ngFor="let col of taxesColumns" [hidden]="!col.visible" class="flexible-header"
                          [pSortableColumn]="col.field">
                          {{ col.header }}
                          <p-sortIcon [field]="col.field"></p-sortIcon>
                        </th>
                      </tr>
                    </ng-template>

                    <!-- Table Body -->
                    <ng-template pTemplate="body" let-tax let-rowIndex="rowIndex">
                      <ng-container *ngIf="rowIndex === 0">
                        <tr>
                          <td *ngFor="let col of taxesColumns" [hidden]="!col.visible">
                            <input type="text" pInputText class="form-control w-70"
                              (input)="filterTable($event, col.field, taxTable)" />
                          </td>
                        </tr>
                      </ng-container>

                      <tr>
                        <td *ngFor="let col of taxesColumns" [hidden]="!col.visible">

                          <ng-container *ngIf="col.field === 'taxAmount'; else defaultField">
                            <div class="text-end"> {{ tax[col.field] | currency: currencyObj?.prefix :
                              'symbol' : '1.2-2' }}
                            </div>
                          </ng-container>
                          <ng-template #defaultField>
                            {{ tax[col.field] }}
                          </ng-template>
                        </td>
                      </tr>
                    </ng-template>

                    <!-- Empty Message -->
                    <ng-template pTemplate="emptymessage">
                      <tr>
                        <td [attr.colspan]="taxesColumns.length" class="text-center text-muted py-3">
                          No taxes available.
                        </td>
                      </tr>
                    </ng-template>

                  </p-table>

                </div>
                <!-- LIMITS -->
                <div class="tab-pane fade" id="nav-limits" role="tabpanel" aria-labelledby="nav-limits" tabindex="0">
                  <div class="row">
                    <div class="col-3">
                      <div>
                        <div class="listing">
                          <p class="subclass-title">
                            {{ "gis.quotation.subclass" | translate }}
                          </p>
                          <ul class="scrollable-list">
                            <li *ngFor="let data of productSubclass" (click)="onSubclassClick(data.code)">
                              {{ data.description | sentenceCase }}
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                    <div class="col-9">
                      <p-table [value]="limitsOfLiabilityList" [tableStyle]="{ 'min-width': '50rem' }"
                        class="ui-datatable" responsiveLayout="scroll" [autoLayout]="true" [scrollable]="true"
                        scrollHeight="200px">
                        <ng-template pTemplate="header">
                          <tr>
                            <th class="flexible-header">
                              {{ "gis.quotation.narration" | translate }}
                            </th>
                            <th class="flexible-header">Scl Desc</th>
                            <th class="flexible-header">
                              {{ "gis.quotation.value" | translate }}
                            </th>
                          </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-data>
                          <tr>
                            <td style="
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                                max-width: 300px;
                                overflow-y: auto;
                              ">
                              {{ data.narration | sentenceCase }}
                            </td>
                            <td>{{ data.subclassCode }}</td>
                            <td>{{ data.value }}</td>
                          </tr>
                        </ng-template>
                      </p-table>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Risk Details Card -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-4">
              <p class="card-title mt-2" style="cursor: pointer;" (click)="toggleRiskDetails()">
                Risks
              </p>

            </div>
            <div class="col-8 d-flex justify-content-end">
              <div class="row">
                <div class="col-4">
                  <button type="button" id="icon" class="btn btn-primary p-0.5 px-2.5" (click)="toggleRiskDetails()"
                    [attr.aria-expanded]="isRiskCollapsibleOpen">
                    <i class="fa-solid" [ngClass]="{
                        'fa-chevron-down': !isRiskCollapsibleOpen,
                        'fa-chevron-up': isRiskCollapsibleOpen}">
                    </i>
                  </button>



                </div>
              </div>
            </div>
          </div>

          <div class="mt-4" [ngClass]="{ 'collapse': true, 'show': isRiskCollapsibleOpen }" id="riskDetails">
            <div class="row mb-3">
              <div class="col-4">
                <!-- <p class="mt-2 fw-semibold" data-bs-toggle="collapse" data-bs-target="#riskDetails">
                  Risk Details
                </p> -->
              </div>

              <div class="col-12">
                <div class="">

                  <ul class="nav nav-tabs me-auto" id="taxTabs" role="tablist">
                    <li class="nav-item" role="presentation" *ngFor="let product of products">
                      <button class="nav-link" [class.active]="activeRiskTab === product.code"
                        (click)="activeRiskTab = product.code; handleProductClick(product);" type="button">
                        {{ product.productName |sentenceCase }}
                      </button>
                    </li>
                  </ul>
                  <div class="tab-content mb-4" id="nav-tabContent">
                    <div class="tab-pane fade" [class.active]="activeRiskTab === product.code"
                      [class.show]="activeRiskTab === product.code" *ngFor="let product of products">
                      <div class="d-flex justify-content-end align-items-center">
                        <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                          [ngClass]="{ 'pi-caret-up': !showRiskColumnModal, 'pi-caret-down': showRiskColumnModal }"
                          style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                          (click)="toggleRisk(iconRisk)">
                        </i>
                      </div>
                      <!-- Floating Column Selector for Risk -->
                      <div *ngIf="showRiskColumnModal" class="card shadow rounded p-2 position-absolute bg-white border"
                        [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                        (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                        (document:mouseup)="onDragEnd()">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <strong class="text-primary">Select Risk Columns</strong>
                          <button class="btn-close btn-sm" (click)="showRiskColumnModal = false"></button>
                        </div>
                        <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                          <div *ngFor="let col of riskColumns">
                            <div class="form-check">
                              <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                [id]="col.field">
                              <label class="form-check-label" [for]="col.field">
                                {{ col.header }}
                              </label>
                            </div>
                          </div>
                        </div>
                      </div>
                      <p-table [value]="riskDetails" #riskTable [tableStyle]="{ 'min-width': '50rem' }"
                        [paginator]="riskDetails?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3"
                        [scrollable]="true" responsiveLayout="scroll" styleClass="p-datatable-striped">

                        <!-- Table Header -->
                        <ng-template pTemplate="header">
                          <tr>
                            <th *ngFor="let col of riskColumns" [hidden]="!col.visible" class="flexible-header"
                              [pSortableColumn]="col.field">
                              {{ col.header }}
                              <p-sortIcon [field]="col.field"></p-sortIcon>
                            </th>
                          </tr>
                        </ng-template>

                        <!-- Table Body -->
                        <ng-template pTemplate="body" let-risk>
                          <tr [class.p-highlight]="risk === selectedRisk" [pSelectableRow]="risk" class="point"
                            (click)="handleRowClick(risk)" [class.disabled]="!risk?.code">
                            <td *ngFor="let col of riskColumns" [hidden]="!col.visible">
                              <ng-container *ngIf="isDateField(col.field); else notDateField">
                                {{ formatDate(getCellValue(risk, col.field)) }}
                              </ng-container>
                              <ng-template #notDateField>
                                {{ getCellValue(risk, col.field) }}
                              </ng-template>
                            </td>
                          </tr>
                        </ng-template>

                        <!-- Empty Message -->
                        <ng-template pTemplate="emptymessage">
                          <tr>
                            <td [attr.colspan]="riskColumns.length" class="text-center text-muted py-3">
                              No risks available for this product.
                            </td>
                          </tr>
                        </ng-template>

                      </p-table>

                      <br />
                      <ul class="nav nav-underline mt-2 mb-4">
                        <li class="nav-item">
                          <a class="nav-link active" [class.active]="activeRiskDetailsTab === 'sections'"
                            (click)="activeRiskDetailsTab = 'sections'">Sections</a>
                        </li>
                        <br />
                        <li class="nav-item">
                          <a class="nav-link" [class.active]="activeRiskDetailsTab === 'riskClauses'"
                            (click)="activeRiskDetailsTab = 'riskClauses'">Clauses</a>
                        </li>
                        <br />
                        <li class="nav-item">
                          <a class="nav-link" [class.active]="activeRiskDetailsTab === 'schedules'"
                            (click)="activeRiskDetailsTab = 'schedules'">Schedules</a>
                        </li>
                        <br />
                        <li class="nav-item">
                          <a class="nav-link" [class.active]="activeRiskDetailsTab === 'peril'"
                            (click)="activeRiskDetailsTab = 'peril'">Risk
                            peril</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link" [class.active]="activeRiskDetailsTab === 'excesses'"
                            (click)="activeRiskDetailsTab = 'excesses'">Excess</a>
                        </li>
                        <!-- <li class="nav-item">
                          <a class="nav-link text-muted" [class.active]="activeRiskDetailsTab === 'comments'"
                            pTooltip="Feature under development" tooltipPosition="top">
                            Comments
                          </a>
                        </li> -->
                        <li class="nav-item">
                          <a class="nav-link" [class.active]="activeRiskDetailsTab === 'limits-liability'"
                            (click)="activeRiskDetailsTab = 'limits-liability'">Limits of liability</a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link " [class.active]="activeRiskDetailsTab === 'commissions'"
                            (click)="activeRiskDetailsTab = 'commissions'">
                            Commissions
                          </a>
                        </li>
                        <li class="nav-item">
                          <a class="nav-link " [class.active]="activeRiskDetailsTab === 'documents'"
                            (click)="activeRiskDetailsTab = 'documents'; onDocumetTabSelect(selectedRisk)">
                            Documents
                          </a>
                        </li>

                      </ul>
                      <div class="tab-content mb-4" id="nav-tabContent">
                        <!-- SECTIONS -->
                        <div class="tab-pane show active" id="nav-sections" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'sections'"
                          [class.active]="activeRiskDetailsTab === 'sections'" aria-labelledby="nav-sections"
                          tabindex="0">
                          <div class="d-flex justify-content-end align-items-center"
                            [hidden]="activeRiskDetailsTab !== 'sections'">
                            <i #iconSection class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showSectionColumnModal, 'pi-caret-up': showSectionColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleSection(iconSection)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for section -->
                          <div *ngIf="showSectionColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select Section Columns</strong>
                              <button class="btn-close btn-sm" (click)="showSectionColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of sectionColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>

                          </div>
                          <p-table [value]="sections" #sectionsTable *ngIf="sections?.length && sectionColumns?.length"
                            [tableStyle]="{ 'min-width': '50rem' }" [paginator]="sections?.length > 10"
                            [rowsPerPageOptions]="[3, 5, 10]" [rows]="3" [scrollable]="true" responsiveLayout="scroll"
                            styleClass="p-datatable-striped">

                            <!-- Dynamic Table Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of sectionColumns" [hidden]="!col.visible" class="flexible-header"
                                  [pSortableColumn]="col.field">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Dynamic Table Body -->
                            <ng-template pTemplate="body" let-section>
                              <tr [pSelectableRow]="section" class="point" [class.disabled]="!section?.sectionCode">

                                <td *ngFor="let col of sectionColumns" [hidden]="!col.visible">
                                  <ng-container [ngSwitch]="col.field">

                                    <!-- Default branch checks internally -->
                                    <ng-container *ngSwitchDefault>
                                      <ng-container *ngIf="isDateField(col.field); else checkCurrencyField">
                                        {{ formatDate(section[col.field]) }}
                                      </ng-container>
                                      
                                      <ng-template #checkCurrencyField>
                                        <ng-container *ngIf="col.field === 'limitAmount' || col.field === 'premiumAmount'
                                                        || col.field === 'freeLimit'; else defaultField">
                                          <div class="text-end">
                                            {{ section[col.field] | currency: currencyObj?.prefix : 'symbol' : '1.2-2' }}
                                          </div>
                                        </ng-container>

                                        <ng-template #defaultField>
                                          {{ section[col.field] }}
                                        </ng-template>
                                      </ng-template>
                                    </ng-container>

                                  </ng-container>
                                </td>


                              </tr>
                            </ng-template>

                            <!-- Empty Message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="sectionColumns.length" class="text-center text-muted py-3">
                                  No sections available for this product.
                                </td>
                              </tr>
                            </ng-template>

                          </p-table>

                        </div>
                        <!-- RISK CLAUSES -->
                        <div class="tab-pane" id="nav-riskClauses" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'riskClauses'"
                          [class.active]="activeRiskDetailsTab === 'riskClauses'" aria-labelledby="nav-riskClauses"
                          tabindex="0">
                          <div class="d-flex justify-content-end align-items-center">
                            <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showRiskClauseColumnModal, 'pi-caret-up': showRiskClauseColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleRiskClauses(iconRisk)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for Risk -->
                          <div *ngIf="showRiskClauseColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select RiskClauses Columns</strong>
                              <button class="btn-close btn-sm" (click)="showRiskClauseColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of riskClausesColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                          <p-table [value]="riskClauses" #riskClausesTable dataKey="code" editMode="row"
                            [tableStyle]="{ 'width': '100%' }" [paginator]="riskClauses?.length > 10"
                            [rowsPerPageOptions]="[3, 5, 10]" [rows]="3" [scrollable]="true" responsiveLayout="scroll"
                            class="ui-datatable" [autoLayout]="true">

                            <!-- Dynamic Table Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of riskClausesColumns" [hidden]="!col.visible"
                                  [pSortableColumn]="col.field">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Body -->
                            <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">

                              <!-- Filter Row -->
                              <tr *ngIf="rowIndex === 0">
                                <td *ngFor="let col of riskClausesColumns" [hidden]="!col.visible">
                                  <input type="text" pInputText class="form-control w-100"
                                    (input)="filterTable($event, col.field, riskClausesTable)" />
                                </td>
                              </tr>

                              <!-- Data Rows -->
                              <tr [pEditableRow]="rowData">
                                <!-- <td *ngFor="let col of riskClausesColumns" [hidden]="!col.visible">
                                  {{ getCellValue(rowData, col.field) | sentenceCase }}
                                </td> -->
                                <td *ngFor="let col of riskClausesColumns" [hidden]="!col.visible">
                                  <ng-container [ngSwitch]="col.field">

                                    <!-- Short Description -->
                                    <ng-container *ngSwitchCase="'clauseShortDescription'">
                                      {{ rowData.clauseShortDescription }}
                                    </ng-container>



                                    <!-- Wording -->
                                    <ng-container *ngSwitchCase="'clause'">
                                      <div class="clause-wrapper">
                                        {{ rowData.clause | sentenceCase }}
                                        <div class="hover-card">
                                          {{ rowData.clause | sentenceCase }}
                                        </div>
                                      </div>
                                    </ng-container>
                                    <!-- Default -->
                                    <ng-container *ngSwitchDefault>
                                      {{ rowData[col.field] }}
                                    </ng-container>

                                  </ng-container>
                                </td>
                              </tr>

                            </ng-template>

                            <!-- Empty Message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="riskClausesColumns.length" class="text-center text-muted py-3">
                                  No Clauses available for this product.
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>


                        </div>
                        <!-- SCHEDULES -->
                        <div class="tab-pane " id="nav-schedules" role="tabpanel" aria-labelledby="nav-schedules"
                          tabindex="0" [class.show]="activeRiskDetailsTab === 'schedules'"
                          [class.active]="activeRiskDetailsTab === 'schedules'">

                          <!-- Dynamic Tabs -->
                          <ul class="nav nav-tabs mb-3">
                            <li class="nav-item" *ngFor="let tab of availableScheduleLevels">
                              <button class="nav-link" [ngClass]="{ active: activeScheduleTab === tab }"
                                (click)="selectScheduleTab(tab)">
                                {{ tab.replace('level', 'Level ') }}
                              </button>
                            </li>
                          </ul>
                          <div class="d-flex justify-content-end align-items-center">
                            <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showScheduleColumnModal, 'pi-caret-up': showScheduleColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleSchedule(iconRisk)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for Risk -->
                          <div *ngIf="showScheduleColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select Schedules Columns</strong>
                              <button class="btn-close btn-sm" (click)="showScheduleColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of scheduleColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>

                          <p-table [value]="getCurrentSchedule()" [tableStyle]="{ 'width': '100%' }"
                            [paginator]="getCurrentSchedule()?.length > 10" [rowsPerPageOptions]="[3, 5, 10]"
                            [rows]="3">
                            <!-- Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of scheduleColumns" class="flexible-header"
                                  pSortableColumn="{{ col.field }}" [hidden]="!col.visible">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Body -->
                            <ng-template pTemplate="body" let-rowData>
                              <tr>
                                <td *ngFor="let col of scheduleColumns" [hidden]="!col.visible" class="flexible-header">
                                  <ng-container [ngSwitch]="col.field">

                                    <!-- Currency fields -->
                                    <ng-container *ngSwitchDefault>
                                      <ng-container *ngIf="col.field === 'value'; else defaultField">
                                        <div class="text-end">
                                          {{ rowData[col.field] | currency: currencyObj?.prefix : 'symbol' : '1.2-2' }}
                                        </div>
                                      </ng-container>

                                      <!-- Default (non-currency fields) -->
                                      <ng-template #defaultField>
                                        {{ rowData[col.field] }}
                                      </ng-template>
                                    </ng-container>

                                  </ng-container>
                                </td>
                              </tr>
                            </ng-template>


                            <!-- Empty message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="scheduleColumns.length" class="text-center text-muted py-3">
                                  “No schedules for this risk.”
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>

                        </div>
                        <!--RISK PERILS-->
                        <div class="tab-pane fade" id="nav-peril" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'peril'"
                          [class.active]="activeRiskDetailsTab === 'peril'" aria-labelledby="nav-schedules"
                          tabindex="0">


                          <div class="d-flex justify-content-end align-items-center">
                            <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showPerilColumnModal, 'pi-caret-up': showPerilColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="togglePeril(iconRisk)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for peril -->
                          <div *ngIf="showPerilColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select Perils Columns</strong>
                              <button class="btn-close btn-sm" (click)="showPerilColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of perilColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>


                          <!-- Dynamic peril table -->
                          <p-table [value]="summaryPerils" [tableStyle]="{ 'width': '100%' }"
                            [paginator]="summaryPerils?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3">
                            <!-- Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of perilColumns" class="flexible-header"
                                  pSortableColumn="{{ col.field }}" [hidden]="!col.visible">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Body -->
                            <ng-template pTemplate="body" let-rowData>
                              <tr>
                                <td *ngFor="let col of perilColumns" [hidden]="!col.visible">
                                  {{ getCellValue(rowData,col.field) }}
                                </td>
                              </tr>
                            </ng-template>

                            <!-- Empty message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="perilColumns.length" class="text-center text-muted py-3">
                                  “No perils for this risk.”
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>
                        </div>
                        <!-- EXCESSES-->
                        <div class="tab-pane fade" id="nav-excesses" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'excesses'"
                          [class.active]="activeRiskDetailsTab === 'excesses'" aria-labelledby="nav-limits"
                          tabindex="0">


                          <div class="d-flex justify-content-end align-items-center">
                            <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showExcessColumnModal, 'pi-caret-up': showExcessColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleExcess(iconRisk)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for Risk -->
                          <div *ngIf="showExcessColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select Excess Columns</strong>
                              <button class="btn-close btn-sm" (click)="showExcessColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of excessColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Dynamic Excess Table -->
                          <p-table [value]="excesses" #excessesTable [tableStyle]="{ 'width': '100%' }"
                            [paginator]="excesses?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3">
                            <!-- Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of excessColumns" class="flexible-header"
                                  pSortableColumn="{{ col.field }}" [hidden]="!col.visible">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Body -->
                            <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
                              <!-- Filter Row -->
                              <tr *ngIf="rowIndex === 0">
                                <td *ngFor="let col of excessColumns" [hidden]="!col.visible">
                                  <input *ngIf="col.field === 'description'" type="text" pInputText
                                    placeholder="Filter {{ col.header }}"
                                    (input)="filterTable($event, col.field, excessesTable)"
                                    style="width: 150px; height: 40px;" />
                                </td>
                              </tr>

                              <!-- Data Rows -->
                              <tr>
                                <td *ngFor="let col of excessColumns" [hidden]="!col.visible">
                                  <ng-container [ngSwitch]="col.field">

                                    <!-- Currency + numeric fields -->
                                    <ng-container *ngSwitchDefault>
                                      <ng-container *ngIf="isDateField(col.field); else checkCurrencyField">
                                        {{ formatDate(getCellValue(rowData, col.field)) }}
                                      </ng-container>
                                      
                                      <ng-template #checkCurrencyField>
                                        <ng-container *ngIf="col.field === 'value'; else defaultField">
                                          <div class="text-end">
                                            {{ getCellValue(rowData, col.field) | currency: currencyObj?.prefix : 'symbol'
                                            : '1.2-2'
                                            }}
                                          </div>
                                        </ng-container>

                                        <!-- Default (non-currency fields) -->
                                        <ng-template #defaultField>
                                          {{ getCellValue(rowData, col.field) }}
                                        </ng-template>
                                      </ng-template>
                                    </ng-container>

                                  </ng-container>
                                </td>

                              </tr>
                            </ng-template>

                            <!-- Empty Message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="excessColumns.length" class="text-center text-muted py-3">
                                  “No excesses available for this risk.”
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>
                        </div>
                        <!-- COMMENTS -->
                        <div class="tab-pane fade" id="nav-comments" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'comments'"
                          [class.active]="activeRiskDetailsTab === 'comments'" aria-labelledby="nav-riskClauses"
                          tabindex="0">
                          <p-table [value]="comments" [tableStyle]="{ 'width': '100%' }" [scrollable]="true"
                            [paginator]="comments?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3"
                            responsiveLayout="scroll" class="ui-datatable" [autoLayout]="true">

                            <!-- HEADER -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th class="flexible-header1" pSortableColumn="description">
                                  Description <p-sortIcon field="description"></p-sortIcon>
                                </th>
                                <th class="flexible-header1" pSortableColumn="details">
                                  Details <p-sortIcon field="details"></p-sortIcon>
                                </th>

                                <th></th>
                                <th></th>
                              </tr>
                            </ng-template>

                            <!-- BODY -->
                            <ng-template pTemplate="body" let-data let-rowIndex="rowIndex">

                              <!-- DATA ROWS -->
                              <tr [pEditableRow]="data">
                                <td>{{ data.description }}</td>
                                <td>{{ data.details | sentenceCase }}</td>
                              </tr>

                            </ng-template>

                            <!-- EMPTY MESSAGE -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                  “No comments available for this risk.”
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>
                          <div class="d-flex justify-content-end align-items-center">
                            <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showExcessColumnModal, 'pi-caret-up': showExcessColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleExcess(iconRisk)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for Risk -->
                          <div *ngIf="showExcessColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select Excess Columns</strong>
                              <button class="btn-close btn-sm" (click)="showExcessColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of excessColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                          <p-table [value]="excesses" #excessesTable *ngIf="excessColumns?.length"
                            [tableStyle]="{ 'min-width': '50rem' }" [paginator]="excesses?.length > 10"
                            [rowsPerPageOptions]="[3, 5, 10]" [rows]="3" [scrollable]="true" responsiveLayout="scroll"
                            styleClass="p-datatable-striped">

                            <!-- Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of excessColumns" [hidden]="!col.visible" class="flexible-header"
                                  [pSortableColumn]="col.field">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Body -->
                            <ng-template pTemplate="body" let-rowData>
                              <tr>
                                <td *ngFor="let col of excessColumns" [hidden]="!col.visible">
                                  <ng-container *ngIf="isDateField(col.field); else notDateField">
                                    {{ formatDate(getCellValue(rowData, col.field)) }}
                                  </ng-container>
                                  <ng-template #notDateField>
                                    {{ getCellValue(rowData, col.field) }}
                                  </ng-template>
                                </td>
                              </tr>
                            </ng-template>

                            <!-- Empty Message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="excessColumns.length" class="text-center text-muted py-3">
                                  No excesses available for this risk.
                                </td>
                              </tr>
                            </ng-template>
                          </p-table>


                        </div>
                        <!-- LIMITS OF LIABILITY-->
                        <div class="tab-pane fade" id="nav-limits-liability" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'limits-liability'"
                          [class.active]="activeRiskDetailsTab === 'limits-liability'" aria-labelledby="nav-limits"
                          tabindex="0">

                          <div class="d-flex justify-content-end align-items-center">
                            <i #iconRisk class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showLimitsOfLiabilityColumnModal, 'pi-caret-up': showLimitsOfLiabilityColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleLimitsOfLiability(iconRisk)">
                            </i>
                          </div>
                          <!-- Floating Column Selector for limits -->
                          <div *ngIf="showLimitsOfLiabilityColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select liability Columns</strong>
                              <button class="btn-close btn-sm"
                                (click)="showLimitsOfLiabilityColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of limitsColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Dynamic Limits of Liability Table -->
                          <p-table [value]="limitsRiskofLiability" #limitsRiskofLiabilityTable
                            [tableStyle]="{ 'width': '100%' }" [paginator]="limitsRiskofLiability?.length > 10"
                            [rowsPerPageOptions]="[3, 5, 10]" [rows]="3">

                            <!-- Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of limitsColumns" class="flexible-header"
                                  pSortableColumn="{{ col.field }}" [hidden]="!col.visible">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Body -->
                            <ng-template pTemplate="body" let-rowData let-rowIndex="rowIndex">
                              <!-- Filter Row -->
                              <tr *ngIf="rowIndex === 0">
                                <td *ngFor="let col of limitsColumns" [hidden]="!col.visible">
                                  <input *ngIf="col.field === 'narration'" type="text" pInputText
                                    placeholder="Filter {{ col.header }}"
                                    (input)="filterTable($event, col.field, limitsRiskofLiabilityTable)"
                                    style="width: 150px; height: 40px;" />
                                </td>
                              </tr>

                              <!-- Data Rows -->
                              <tr>
                                <td *ngFor="let col of limitsColumns" [hidden]="!col.visible">
                                  <ng-container [ngSwitch]="col.field">

                                    <!-- Currency + numeric fields -->
                                    <ng-container *ngSwitchDefault>
                                      <ng-container *ngIf="isDateField(col.field); else checkCurrencyField">
                                        {{ formatDate(getCellValue(rowData, col.field)) }}
                                      </ng-container>
                                      
                                      <ng-template #checkCurrencyField>
                                        <ng-container *ngIf="col.field === 'value'; else defaultField">
                                          <div class="text-end">
                                            {{ sanitizeCurrency(getCellValue(rowData, col.field))
                                            | currency: currencyObj?.prefix : 'symbol' : '1.2-2' }}
                                          </div>
                                        </ng-container>

                                        <ng-template #defaultField>
                                          {{ getCellValue(rowData, col.field) }}
                                        </ng-template>
                                      </ng-template>
                                    </ng-container>


                                  </ng-container>
                                </td>
                              </tr>
                            </ng-template>

                            <!-- Empty Message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="limitsColumns.length" class="text-center text-muted py-3">
                                  “No limit of liability available for this risk.”
                                </td>
                              </tr>
                            </ng-template>

                          </p-table>

                        </div>
                        <!-- COMMISSIONS -->
                        <div *ngIf="quotationView?.source?.description === 'Agent' && quotationView?.clientType === 'I'"
                          class="tab-pane" id="nav-commissions" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'commissions'"
                          [class.active]="activeRiskDetailsTab === 'commissions'" aria-labelledby="nav-commissions"
                          tabindex="0">

                          <!-- Column Selector Toggle -->
                          <div class="d-flex justify-content-end align-items-center"
                            [hidden]="activeRiskDetailsTab !== 'commissions'">
                            <i #iconCommission class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': !showCommissionColumnModal, 'pi-caret-up': showCommissionColumnModal }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                              (click)="toggleCommission(iconCommission)">
                            </i>
                          </div>

                          <!-- Floating Column Selector Modal -->
                          <div *ngIf="showCommissionColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">

                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary">Select Commission Columns</strong>
                              <button class="btn-close btn-sm" (click)="showCommissionColumnModal = false"></button>
                            </div>

                            <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of commissionColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                                    [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">{{ col.header }}</label>
                                </div>
                              </div>
                            </div>

                          </div>

                          <!-- Dynamic Table -->
                          <p-table [value]="riskCommissions" #commissionsTable
                            *ngIf="riskCommissions?.length && commissionColumns?.length"
                            [tableStyle]="{ 'width': '100%' }" [paginator]="riskCommissions?.length > 10"
                            [rowsPerPageOptions]="[3, 5, 10]" [rows]="3" [scrollable]="true" responsiveLayout="scroll"
                            class="ui-datatable" [autoLayout]="true">

                            <!-- Table Header -->
                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of commissionColumns" [hidden]="!col.visible"
                                  [pSortableColumn]="col.field">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>

                            <!-- Table Body -->
                            <ng-template pTemplate="body" let-commission>
                              <tr [pSelectableRow]="commission" class="point">

                                <td *ngFor="let col of commissionColumns" [hidden]="!col.visible">
                                  <ng-container [ngSwitch]="col.field">

                                    <!-- Default branch -->
                                    <ng-container *ngSwitchDefault>
                                      <ng-container *ngIf="isDateField(col.field); else checkCurrencyField">
                                        {{ formatDate(commission[col.field]) }}
                                      </ng-container>
                                      
                                      <ng-template #checkCurrencyField>
                                        <ng-container
                                          *ngIf="col.field === 'amount' || col.field === 'discAmount'; else defaultField">
                                          <div class="text-end">
                                            {{ commission[col.field] | currency: currencyObj?.prefix : 'symbol' : '1.2-2'
                                            }}
                                          </div>
                                        </ng-container>

                                        <ng-template #defaultField>
                                          {{ col.field === 'agentDto' ? commission.agentDto?.name : commission[col.field]
                                          }}
                                        </ng-template>
                                      </ng-template>

                                    </ng-container>

                                  </ng-container>
                                </td>

                              </tr>
                            </ng-template>

                            <!-- Empty Message -->
                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="commissionColumns.length" class="text-center text-muted py-3">
                                  No commissions available for this quotation.
                                </td>
                              </tr>
                            </ng-template>

                          </p-table>

                        </div>
                        <!-- RISK DOCUMENTS -->
                        <div class="tab-pane fade" id="nav-documents" role="tabpanel"
                          [class.show]="activeRiskDetailsTab === 'documents'"
                          [class.active]="activeRiskDetailsTab === 'documents'" aria-labelledby="nav-limits"
                          tabindex="0">
                          <!-- ADD Document BUTTON ROW -->
                          <div class="col-12 d-flex justify-content-end">
                            <button id="openModalButtonAdd" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                              data-bs-target="#addRiskDocumentModal">
                              Add document
                            </button>

                            <i #iconTrigger class="pi border border-black p-1 rounded-1 text-black"
                              [ngClass]="{ 'pi-caret-down': showRiskDoc, 'pi-caret-up': !showRiskDoc }"
                              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;">
                            </i>

                          </div>

                          <!-- Floating risk document Column Selector -->
                          <div *ngIf="showRiskDocColumnModal"
                            class="card shadow rounded p-2 position-absolute bg-white border"
                            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
                            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
                            (document:mouseup)="onDragEnd()">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                              <strong class="text-primary"> {{'gis.quotation.select_columns' | translate}}</strong>
                              <button class="btn-close btn-sm" (click)="showRiskDocColumnModal = false"></button>
                            </div>
                            <div style="max-height: 200px;max-width:250px; overflow-y: auto;">
                              <div *ngFor="let col of riskDocColumns">
                                <div class="form-check">
                                  <input class="form-check-input" type="checkbox" style="color: #00529B;"
                                    [(ngModel)]="col.visible" [id]="col.field">
                                  <label class="form-check-label" [for]="col.field">
                                    {{ col.header }}
                                  </label>
                                </div>
                              </div>
                            </div>
                          </div>

                          <p-table [value]="riskDocuments" [tableStyle]="{ 'min-width': '300px' }"
                            selectionMode="single" [(selection)]="selectedRiskDoc" dataKey="id"
                            [paginator]="riskDocuments?.length > 10" [rowsPerPageOptions]="[5, 4, 6]" [rows]="5">


                            <ng-template pTemplate="header">
                              <tr>
                                <th *ngFor="let col of riskDocColumns" [hidden]="!col.visible" class="flexible-header"
                                  [pSortableColumn]="col.field">
                                  {{ col.header }}
                                  <p-sortIcon [field]="col.field"></p-sortIcon>
                                </th>
                              </tr>
                            </ng-template>


                            <ng-template pTemplate="body" let-riskDoc let-rowIndex="rowIndex">
                              <tr>
                                <td *ngFor="let col of riskDocColumns" [hidden]="!col.visible" class="flexible-header">
                                  <ng-container [ngSwitch]="col.field">
                                    <ng-container *ngSwitchCase="'actions'">

                                      <button type="button" class="btn btn-link btn-sm fw-bold text-primary px-2"
                                        (click)="onPreviewRiskDoc(riskDoc)">
                                        Preview
                                      </button>

                                      <button type="button" class="btn btn-link btn-sm fw-bold text-primary px-2"
                                        (click)="onDownloadRiskDoc(riskDoc)">
                                        Download
                                      </button>

                                      <button type="button" class="btn btn-link btn-sm fw-bold text-primary px-2"
                                        data-bs-toggle="modal" data-bs-target="#deleteRiskDocModal"
                                        (click)="onDeleteRiskDoc(riskDoc)">
                                        {{ 'gis.quotation.delete' | translate }}
                                      </button>

                                    </ng-container>
                                    <ng-container *ngSwitchDefault>
                                      <ng-container *ngIf="isDateField(col.field); else notDateField">
                                        {{ formatDate(riskDoc[col.field]) }}
                                      </ng-container>
                                      <ng-template #notDateField>
                                        {{ col.field === 'name' && !riskDoc['name'] ? riskDoc['actualName'] :
                                        riskDoc[col.field] }}
                                      </ng-template>
                                    </ng-container>

                                  </ng-container>
                                </td>
                              </tr>
                            </ng-template>


                            <ng-template pTemplate="emptymessage">
                              <tr>
                                <td [attr.colspan]="riskDocColumns.length" style="padding: 20px; text-align:center">

                                  No risk documents. Click <span class="fw-bold">Add documents</span> to add documents
                                </td>
                              </tr>
                            </ng-template>

                          </p-table>
                          <!-- Add Risk Doc  Modal -->
                          <div class="modal fade" #addRiskDocumentModal id="addRiskDocumentModal" tabindex="-1"
                            role="dialog" aria-labelledby="addSectionLabel">
                            <div class="modal-dialog modal-dialog-centered" style="min-width: 708px;" role="document">
                              <div class="modal-content" id="addRiskDocumentModal">
                                <div class="modal-body">
                                  <h5 class="modal-title mt-2" id="addDocumentsLabel">
                                    Add document
                                    <button type="button" class="btn-close red-close float-end" data-bs-dismiss="modal"
                                      aria-label="Close"></button>
                                  </h5>
                                  <div class="upload-area mt-2 mb-1" (click)="fileInput.click()"
                                    [class.dragover]="isDragging" (drop)="onDrop($event)"
                                    (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)">

                                    <div class="upload-content">
                                      <i class="pi pi-upload upload-icon"></i>

                                      <p class="upload-text">Click this area to upload file</p>


                                    </div>

                                    <input #fileInput type="file" (change)="onFileSelected($event)"
                                      accept=".pdf,.doc,.docx,.txt,.log,.jpg,.jpeg,.png" style="display: none;">
                                    <div class="selected-file" *ngIf="selectedFile">
                                      <i [ngClass]="getFileIcon(selectedFile.name)" class="file-icon"></i>
                                      <span class="file-name">{{ selectedFile.name }}</span>

                                      <button class="remove-btn" (click)="removeFile()" aria-label="Remove">
                                        <i class="pi pi-trash"></i>
                                      </button>
                                    </div>


                                  </div>
                                  <div class="mt-3 d-flex flex-column">
                                    <label for="documentType" class="mb-1 ">Document type</label>
                                    <p-dropdown [options]="" optionLabel="" optionValue="" class="form-control-sm"
                                      [style]="{ width: 'auto', minWidth: '180px' }"></p-dropdown>
                                  </div>



                                  <div class="mt-4 d-flex justify-content-end ">
                                    <button type="button" class="btn btn-outline-primary me-2"
                                      data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary " id="saveDetails"
                                      (click)="saveRiskDoc()">{{'gis.quotation.save' |
                                      translate}}</button>
                                  </div>
                                </div>

                              </div>
                            </div>
                          </div>
                          <!-- Delete Client Doc   Modal -->
                          <div class="modal fade" id="deleteRiskDocModal" tabindex="-1"
                            aria-labelledby="deleteRiskDocLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered ">
                              <div class="modal-content">
                                <div class="modal-header" style="border-bottom: none;">
                                  <h5 class="delete-title" id="exampleModalLabel">
                                    Delete document
                                  </h5>
                                  <button type="button" class="btn-close red-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                  <p class="d-flex justify-content-center" id="deleteLabel">
                                    Are you sure you want to delete document?
                                  <div class="d-flex justify-content-center gap-3">


                                    <button type="button" class="btn btn-outline-primary" id="deleteNo"
                                      data-bs-dismiss="modal">
                                      {{ 'gis.quotation.cancel' | translate }}
                                    </button>

                                    <button type="button" class="btn btn-primary" id="deleteYes" data-bs-dismiss="modal"
                                      (click)="deleteRiskDoc()">
                                      {{ 'gis.quotation.delete' | translate }}
                                    </button>

                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          <!-- Preview Client Doc Modal -->
                          <div class="modal fade" id="previewDocModal" tabindex="-1"
                            aria-labelledby="previewDocModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg modal-dialog-centered">
                              <div class="modal-content">
                                <div
                                  class="modal-header d-flex justify-content-center align-items-center position-relative"
                                  style="border-bottom: none;">
                                  <!-- Centered Title -->
                                  <h5 class="modal-title text-center m-0" id="previewDocModalLabel"
                                    style="position: absolute; left: 50%; transform: translateX(-50%);">
                                    {{ previewRiskDoc?.name }}
                                  </h5>

                                  <!-- Close Button -->
                                  <button type="button" class="btn-close ms-auto position-relative"
                                    data-bs-dismiss="modal" aria-label="Close" style="z-index: 10;">
                                  </button>
                                </div>

                                <div class="d-flex justify-content-center align-items-center gap-3 mt-2 mb-2">

                                  <!-- Zoom Out -->

                                  <i class="pi pi-minus text-primary"
                                    (click)="zoomRiskDocLevel = zoomRiskDocLevel - 0.2" pTooltip="Zoom out"
                                    style="cursor: pointer; font-size: 16px;">
                                  </i>

                                  <!-- Current Zoom Percentage -->
                                  <span class=" px-2 py-1 border rounded" style="color: black;border-color: black;">
                                    {{ (zoomRiskDocLevel * 100) | number:'1.0-0' }}%
                                  </span>
                                  <!-- Zoom In -->
                                  <i class="pi pi-plus cursor-pointer"
                                    (click)="zoomRiskDocLevel = zoomRiskDocLevel + 0.2" pTooltip="Zoom in"
                                    style="cursor: pointer !important; font-size: 16px;">
                                  </i>
                                  <!-- Reset -->
                                  <button class="btn btn-sm btn-primary ms-2" (click)="zoomRiskDocLevel = 1"
                                    style="cursor: pointer !important; font-size: 16px;">
                                    Reset
                                  </button>

                                </div>
                                <div class="modal-body text-center">
                                  <!-- Image preview -->
                                  <img *ngIf="previewRiskDoc?.mimeType?.startsWith('image/')"
                                    [src]="previewRiskDoc.dataUrl" alt="Preview" class="img-fluid rounded shadow">

                                  <!-- PDF preview using ng2-pdf-viewer -->
                                  <pdf-viewer *ngIf="previewRiskDoc?.mimeType === 'application/pdf'"
                                    [src]="previewRiskDoc.dataUrl" [render-text]="true" [original-size]="false"
                                    style="display: block; height: 70vh;" [zoom]="zoomRiskDocLevel">
                                  </pdf-viewer>

                                  <!--  Unsupported formats -->
                                  <div
                                    *ngIf="previewRiskDoc && !previewRiskDoc.mimeType.startsWith('image/') && previewRiskDoc.mimeType !== 'application/pdf'">
                                    <p>Preview not available for this file type.</p>
                                    <a [href]="previewRiskDoc.dataUrl" download="{{ previewRiskDoc.name }}"
                                      class="btn btn-primary btn-sm mt-2">
                                      Download File
                                    </a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>





                        </div>


                      </div>

                    </div>
                  </div>


                </div>
              </div>
            </div>




          </div>
        </div>
      </div>

      <!-- Exceptions Card -->
      <div class="card mb-4" *ngIf="exceptionsData?.length > 0">
        <div class="card-body">

          <!-- Title & Toggle -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="card-title mt-2 mb-0">Exceptions</p>

            <!-- Collapse/Expand Button -->
            <button type="button" id="icon" class="btn btn-primary " [attr.aria-expanded]="!exceptionsCollapsed"
              (click)="exceptionsCollapsed = !exceptionsCollapsed">
              <i class="fa-solid" [ngClass]="exceptionsCollapsed ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
            </button>

          </div>

          <!-- Authorize Button (Shown when open) -->
          <div *ngIf="!exceptionsCollapsed" class="mb-3 d-flex justify-content-end">
            <button class="btn btn-primary btn-sm" (click)="authorizeSelectedExceptions()">Authorize exceptions</button>
          </div>

          <!-- Exceptions Table -->
          <div *ngIf="!exceptionsCollapsed">
            <!-- <p-table [value]="exceptionsData" [scrollable]="true" scrollHeight="200px" responsiveLayout="scroll"
              [paginator]="exceptionsData?.length > 10" [rowsPerPageOptions]="[3, 5, 10]" [rows]="3"
              [tableStyle]="{ 'width': '100%' }">
              <ng-template pTemplate="header">
                <tr>
                  <th class="flexible-header1"><p-checkbox name="selectAll" [(ngModel)]="selectAll"
                      (onChange)="toggleAll()" [binary]="true"></p-checkbox></th>
                  <th class="flexible-header1" pSortableColumn="id">
                    ID
                    <p-sortIcon field="id"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="description">
                    Description
                    <p-sortIcon field="description"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="remark">
                    Remarks
                    <p-sortIcon field="remark"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="authorized">
                    Authorized
                    <p-sortIcon field="authorized"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="setStandard">
                    Set standard
                    <p-sortIcon field="setStandard"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="usedStandard">
                    Used standard
                    <p-sortIcon field="usedStandard"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="authorizedBy">
                    Authorized by
                    <p-sortIcon field="authorizedBy"></p-sortIcon>
                  </th>

                  <th class="flexible-header1" pSortableColumn="authorizedDate">
                    <span style="white-space: nowrap;">
                      Authorized date
                      <p-sortIcon field="authorizedDate"></p-sortIcon>
                    </span>
                  </th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row>
                <tr>
                  <td><p-checkbox name="row_{{ row.id }}" [(ngModel)]="row.selected" [binary]="true">
                    </p-checkbox>
                  </td>
                  <td>{{ row.id }}</td>
                  <td>{{ row.description }}</td>
                  <td>
                    <p-dropdown [options]="" [(ngModel)]="row.remark" placeholder="Select remark"
                      [style]="{width: '180px'}"></p-dropdown>
                  </td>
                  <td>{{ row.authorized }}</td>
                  <td>{{ row.setStandard }}</td>
                  <td>{{ row.usedStandard }}</td>
                  <td>{{ row.authorizedBy || '—' }}</td>
                  <td>{{ formatDate(row.authorizedDate) }}</td>
                </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                <tr>
                  <td colspan="9" class="text-center text-muted py-3">
                    "No exceptions available."
                  </td>
                </tr>
              </ng-template>
            </p-table> -->
            <p-table [value]="exceptionsData" [(selection)]="selectedExceptions" dataKey="code"
              [paginator]="exceptionsData?.length > 10" [rows]="5" [scrollable]="true" responsiveLayout="scroll"
              styleClass="p-datatable-striped" [rowHover]="true" [rowsPerPageOptions]="[5, 10,20]">

              <!-- Table Header -->
              <ng-template pTemplate="header">
                <tr>
                  <th>
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                  </th>
                  <th *ngFor="let col of exceptionsColumns" [hidden]="!col.visible" [pSortableColumn]="col.field"
                    class="flexible-header1">
                    {{ col.header }}
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                  </th>
                </tr>
              </ng-template>

              <!-- Table Body -->
              <ng-template pTemplate="body" let-exception>
                <tr [pSelectableRow]="exception">
                  <td>
                    <p-tableCheckbox [value]="exception" [disabled]="exception.isAuthorized === 'Y'"
                      [pTooltip]="exception.isAuthorized === 'Y' ? 'This exception has already been authorized' : null"
                      tooltipPosition="top">
                    </p-tableCheckbox>

                  </td>
                  <td *ngFor="let col of exceptionsColumns" [hidden]="!col.visible" class="flexible-header1">
                    {{ getCellValue(exception, col.field) }}
                  </td>
                </tr>
              </ng-template>

              <!-- Empty Message -->
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="exceptionsColumns.length + 1" class="text-center text-muted py-3">
                    No exceptions available for this product.
                  </td>
                </tr>
              </ng-template>
            </p-table>


          </div>

        </div>
      </div>


      <!-- Reassign quotation Modal 1 -->
      <div class="modal fade " id="reassignQuotation" #reassignQuotationModal tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
          <div class="modal-content ps-4 pt-2 pb-5 pe-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                Reassign tasks
              </p>
              <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div *ngIf="departmentSelected" class="w-75 mb-2 mt-2">
              <p class="quote-label">Group User</p>
              <input pInputText type="select" class="form-control form-control-sm" id="quote-input"
                [(ngModel)]="clientToReassignQuotation">
            </div>

            <div class="w-75 mb-2 mt-2">
              <p class="quote-label">{{ clientToReassignQuotation ? 'Default User' : 'User' }}</p>


              <div *ngIf="!departmentSelected"
                class="form-control form-control-sm d-flex align-items-center justify-content-between" id="quote-input"
                style="cursor: pointer;" (click)="openChooseClientReassignModal()">
                <span cl>{{ clientToReassignQuotation}}</span>
                <i class="pi pi-chevron-down me-2" style="color: #00529B;font-size: 14px;"></i>
              </div>

              <p-dropdown *ngIf="departmentSelected" [options]="groupUsers" optionLabel="userDetails.name"
                optionValue="id" [(ngModel)]="selectedGroupUserId" placeholder="" class=" form-control-sm ">
              </p-dropdown>


            </div>

            <div class="w-75 mb-3">
              <p class="quote-label">Comments</p>
              <textarea name="reassignProduct" class="form-control" style="height: 70px"
                [(ngModel)]="reassignQuotationComment"></textarea>
            </div>

            <small class="text-danger block" [class.invisible]="!noCommentleft">
              Please leave a comment before reassigning
            </small>

            <small class="text-danger block" [class.invisible]="!noUserChosen">
              Please select a person to reassign before continuing
            </small>

            <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="reassignQuotation()">{{
                'gis.quotation.reassign' | translate }}
              </button>
              <button type="button" (click)="closeReassignQuotationModal()" class="btn btn-outline-primary"
                style="text-decoration: none;">{{'gis.quotation.cancel' | translate}}
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Reassign quotation Modal 2 -->
      <div class="modal fade " id="chooseClientReassingModal" #chooseClientReassignModal tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
          <div class="modal-content ps-4 pt-2 pb-5 pe-4">

            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                Reassign task
              </p>
              <button type="button" (click)="closeChooseClientReassignModal()" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div class="row mt-2">
              <p-table #reassignTable [value]="users" [rows]="3" [paginator]="true"
                [rowsPerPageOptions]="[5, 10, 20, 50]" [globalFilterFields]="['id', 'name']" selectionMode="single"
                [(selection)]="selectedUser" styleClass="p-datatable-striped" (onRowSelect)="onUserSelect()"
                (onRowUnselect)="onUserUnselect()">
                <ng-template pTemplate="header">
                  <tr>
                    <th>User ID</th>
                    <th>Full Name</th>
                  </tr>
                  <tr styleClass="p-striped">
                    <th>
                      <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)"
                        class="form-control form-control-sm"
                        style="border-radius: 4px; border: 1px solid #ced4da; padding: 0.375rem 0.75rem;">
                    </th>
                    <th>
                      <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)"
                        class="form-control form-control-sm"
                        style="border-radius: 4px; border: 1px solid #ced4da; padding: 0.375rem 0.75rem;">
                    </th>
                  </tr>

                </ng-template>
                <ng-template pTemplate="body" let-user>
                  <tr [pSelectableRow]="user">
                    <td>{{ user.id }}</td>
                    <td>{{ user.name }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            <small class="text-danger block" [class.invisible]="!noUserChosen">
              Please select a person to reassign before continuing
            </small>

            <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="selectClient()">{{
                'gis.quotation.save' | translate }}
              </button>
              <button type="button" (click)="closeChooseClientReassignModal()" class="btn btn-outline-primary"
                style="text-decoration: none;">{{
                'gis.quotation.cancel' | translate
                }}
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- reject quote modal -->
      <div class="modal fade" id="rejectQuote" #rejectQuotationModal tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:400px">
          <div class="modal-content ps-4 pt-2 pe-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-1">
              <p class="modal-title fw-bold ms-0">{{ 'gis.quotation.reject_quote' | translate }}</p>
              <button type="button" data-bs-dismiss="modal" class="btn p-1 text-danger fw-bold" style="border: none;">X
              </button>
            </div>
            <p class="text-dark mb-3">Are you sure you want to reject this quote? </p>

            <p [class.invisible]="!noComment" class="text-danger">Comment is required</p>

            <label class="text-dark mt-0" for="comment">Comment</label>
            <textarea rows="3" cols="25" pInputTextarea [(ngModel)]="rejectComment">

            </textarea>

            <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 my-3 p-0">
              <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
                style="text-decoration: none;">{{
                'gis.quotation.cancel' | translate
                }}
              </button>
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="rejectQuotation(quotationDetails.code)">{{
                'gis.quotation.save_changes' |
                translate
                }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="mb-5 d-flex align-items-center justify-content-between flex-wrap gap-2">

        <!-- Left-side buttons -->
        <div class="d-flex gap-2 flex-wrap">

          <!-- <button
            style="border: none; background: transparent; text-decoration: underline; cursor: pointer;color:#00529B"
            (click)="navigateToRiskCenter()" [disabled]="viewQuoteFlag">
            {{ 'gis.quotation.back' | translate }}
          </button>

          <button type="button" class="btn btn-outline-primary" (click)="openReassignQuotationModal()"
            [disabled]="afterRejectQuote||viewQuoteFlag">
            {{ "gis.quotation.reassign" | translate }}
          </button> -->

          <!-- <button type="button" class="btn btn-outline-primary" (click)="openRejectQuotationModal()"
            [disabled]="afterRejectQuote||viewQuoteFlag">
            {{ 'gis.quotation.reject' | translate }}
          </button> -->
          <!-- Back Button -->
          <!-- Back Button -->
          <span class="mt-2"
            [pTooltip]="afterRejectQuote || viewQuoteFlag ? 'No further action — quotation already authorized.' : null"
            tooltipPosition="top">
            <button (click)="navigateToRiskCenter()" [disabled]="viewQuoteFlag"
              [ngStyle]="viewQuoteFlag ? { color: '#6c757d', cursor: 'not-allowed', 'text-decoration': 'none' } : { color: '#00529B', cursor: 'pointer', 'text-decoration': 'underline' }"
              style="border: none; background: transparent;">
              {{ 'gis.quotation.back' | translate }}
            </button>
          </span>

          <!-- Reassign Button -->
          <span
            [pTooltip]="afterRejectQuote || viewQuoteFlag ? 'No further action — quotation already authorized.' : null"
            tooltipPosition="top">
            <button type="button "
              [ngClass]="afterRejectQuote || viewQuoteFlag ? 'btn btn-secondary' : 'btn btn-outline-primary'"
              [disabled]="afterRejectQuote || viewQuoteFlag" (click)="openReassignQuotationModal()">
              {{ "gis.quotation.reassign" | translate }}
            </button>
          </span>

          <!-- Reject Button -->
          <span
            [pTooltip]="afterRejectQuote || viewQuoteFlag ? 'No further action — quotation already authorized.' : null"
            tooltipPosition="top">
            <button type="button"
              [ngClass]="afterRejectQuote || viewQuoteFlag ? 'btn btn-secondary' : 'btn btn-outline-primary'"
              [disabled]="afterRejectQuote || viewQuoteFlag" (click)="openRejectQuotationModal()">
              {{ 'gis.quotation.reject' | translate }}
            </button>
          </span>


        </div>


        <div class="action-buttons">
          <div class="d-inline-block" pTooltip="{{ authorizeButtonTooltip }}" tooltipPosition="top"
            [tooltipDisabled]="!authorizeButtonDisabled" style="cursor: pointer;">
            <button *ngIf="showAuthorizeButton" type="button" class="btn"
              [ngClass]="{'btn-outline-primary': !authorizeButtonDisabled, 'btn-secondary': authorizeButtonDisabled}"
              [disabled]="authorizeButtonDisabled||viewQuoteFlag" (click)="authorizeQuote()">
              Authorize quote
            </button>
          </div>

          <div>
            <button class="btn btn-outline-primary me-2" *ngIf="showViewDocumentsButton" (click)="fetchReports()">
              View documents
            </button>
            <button class="btn btn-primary" *ngIf="showVerifyButton" data-bs-toggle="modal"
              data-bs-target="#clientConsentModal">
              Provide consent
            </button>
          </div>

        </div>
        <div *ngIf="changeToPolicyButtons" class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-primary" [disabled]="afterRejectQuote">
            Convert to policy
          </button>

          <button type="button" class="btn btn-primary" [disabled]="afterRejectQuote">
            Merge to Policy
          </button>


        </div>
        <div *ngIf="showConfirmButton" class="d-flex gap-2 flex-wrap">
          <button type="button" class="btn btn-primary" [disabled]="afterRejectQuote" (click)="confirmQuote()">
            Confirm
          </button>
        </div>
      </div>

    </div>

    <!-- Consent Modal -->
    <div class="modal fade" id="clientConsentModal" #clientConsentModal tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm" style="min-width:609px">
        <div class="modal-content px-4 pt-2 pb-4 ">


          <div class="d-flex justify-content-between align-items-center rounded-3 mb-1">
            <p class="modal-title fw-bold ms-0">Privacy policy and consent</p>
            <button type="button" data-bs-dismiss="modal" class="btn p-1 text-danger fw-bold"
              style="border: none;">X</button>
          </div>

          <!-- Tabs -->
          <ul class="nav nav-tabs me-auto mt-4" id="taxTabs" role="tablist">
            <!-- OTP tab -->
            <li class="nav-item" role="presentation">
              <button class="nav-link" [class.active]="activeConsentTab === 'otp'" (click)="activeConsentTab = 'otp'"
                type="button">
                Share OTP
              </button>
            </li>

            <!-- Upload tab (disabled for now) -->
            <li class="nav-item" role="presentation">
              <span data-bs-toggle="tooltip" data-bs-placement="top" title="Functionality to be worked on"
                data-bs-custom-class="tooltip-strong">
                <button class="nav-link" type="button" disabled tabindex="-1">
                  Upload Signed Document
                </button>
              </span>


            </li>
          </ul>

          <!-- Tab content -->
          <div class="tab-content mt-3 mb-4">
            <!-- OTP content -->
            <div class="tab-pane fade show active" *ngIf="activeConsentTab === 'otp'">

              <!-- Share method selection -->
              <div class="method-options mt-2">
                <div class="method-option" *ngFor="let method of shareMethods"
                  (click)="!method.disabled && onShareMethodChange(method.value)"
                  [class.selected]="shareQuoteData.selectedMethod  === method.value" [class.disabled]="method.disabled">
                  <i class="far fa-circle" *ngIf="shareQuoteData.selectedMethod  !== method.value"></i>
                  <i class="fas fa-dot-circle" *ngIf="shareQuoteData.selectedMethod   === method.value"></i>
                  <span class="ps-2">{{ method.label }}</span>
                  <span class="custom-tooltip" *ngIf="method.disabled">{{ method.tooltip }}</span>
                </div>
              </div>
              <form [formGroup]="shareForm">
                <!-- Email input (shown when email is selected) -->
                <div *ngIf="shareQuoteData.selectedMethod  === 'email'" class="row mt-2">
                  <label for="email" class="label quote-label">Email address<span class="required"></span></label>
                  <div class="row">
                    <div class="col-sm-9">
                      <input id="email" type="email" formControlName="email" class="form-control form-control-sm"
                        placeholder="Enter email address" (blur)="shareForm.get('email')?.markAsTouched()" />
                      <div *ngIf="shareForm.get('email')?.touched && shareForm.get('email')?.invalid"
                        class="text-danger mt-1">
                        <small *ngIf="shareForm.get('email')?.errors?.['required']">Email is required.</small>
                        <small *ngIf="shareForm.get('email')?.errors?.['email']">Please enter a valid email
                          address.</small>
                      </div>
                    </div>
                    <div class="col-sm-3">
                      <button type="button" class="btn btn-outline-primary btn-sm fw-bold" (click)="generateOTP()">Send
                        OTP</button>
                    </div>
                  </div>
                </div>

                <!-- SMS input (shown when SMS is selected) -->
                <div *ngIf="shareQuoteData.selectedMethod  === 'sms'" class="row mt-2">
                  <label for="smsNumber" class="label quote-label">Phone Number<span class="required"></span></label>
                  <div class="row">
                    <div class="col-sm-9">
                      <input id="smsNumber" type="tel" formControlName="smsNumber" class="form-control form-control-sm"
                        placeholder="0712345678 or +254712345678"
                        (blur)="shareForm.get('smsNumber')?.markAsTouched()" />
                      <div *ngIf="shareForm.get('smsNumber')?.touched && shareForm.get('smsNumber')?.invalid"
                        class="text-danger mt-1">
                        <small *ngIf="shareForm.get('smsNumber')?.errors?.['required']">Phone number is
                          required.</small>
                        <small *ngIf="shareForm.get('smsNumber')?.errors?.['pattern']">Please enter a phone
                          number.</small>
                      </div>
                    </div>
                    <div class="col-sm-3">
                      <button type="button" class="btn btn-outline-primary btn-sm fw-bold" (click)="generateOTP()">Send
                        OTP</button>
                    </div>
                  </div>
                </div>

                <!-- OTP input (shown after OTP is generated) -->
                <div *ngIf="otpGenerated" class="row mt-3">
                  <div class="col-sm-9">
                    <label for="otp" class="label quote-label">Enter OTP<span class="required"></span></label>
                    <input id="otp" type="text" formControlName="otp" class="form-control form-control-sm"
                      maxlength="6" />
                    <div *ngIf="shareForm.get('otp')?.touched && shareForm.get('otp')?.invalid"
                      class="text-danger mt-1">
                      <small *ngIf="shareForm.get('otp')?.errors?.['required']">OTP is required.</small>
                      <small
                        *ngIf="shareForm.get('otp')?.errors?.['minlength'] || shareForm.get('otp')?.errors?.['maxlength']">OTP
                        must be 6 digits.</small>
                    </div>
                  </div>
                  <div class="col-sm-3"></div>
                </div>
              </form>
            </div>

            <!-- Upload tab placeholder -->
            <div class="tab-pane fade" *ngIf="activeConsentTab === 'upload'">
              <p class="text-muted mt-3">Functionality to be worked on</p>
            </div>
          </div>
          <div *ngIf="otpGenerated" class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 my-3 p-0">
            <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary fw-bold">Cancel</button>
            <button type="button" class="btn btn-primary fw-bold" (click)="verifyOTP()">Verify</button>
          </div>

        </div>
      </div>
    </div>

    <!-- View documents Modal -->
    <div class="modal fade" id="viewDocumentsModal" #viewDocumentsModal tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content px-4 pt-2 pb-4">

          <!-- Header -->
          <div class="d-flex justify-content-between align-items-center rounded-3 mb-1">
            <p class="modal-title fw-bold ms-0">Generated Documents</p>
            <button type="button" data-bs-dismiss="modal" class="btn p-1 text-danger fw-bold"
              style="border: none;">X</button>
          </div>

          <div class="row mt-4 mb-3" style="max-height: 300px;">
            <!-- Left side: reports list -->
            <div class="col-4 border-end overflow-auto" style="max-height: 300px; padding-right: 1rem;">
              <div *ngFor="let report of fetchedReports; let i = index" class="d-flex align-items-center mb-2">
                <!-- PrimeNG checkbox (multiple selection) -->
                <p-checkbox [(ngModel)]="selectedReports" [value]="report" inputId="{{'chk-' + report.code}}"
                  (onChange)="onReportToggle($event, report)">
                </p-checkbox>

                <label [for]="'chk-' + report.code" class="ms-2 flex-grow-1 report-label" style="cursor: pointer;">
                  {{ report.description }}
                </label>

                <!-- Download / Print icons -->
                <i class="pi pi-download ms-3 text-primary" (click)="downloadReports(selectedReports)"
                  pTooltip="Download" tooltipPosition="top" style="cursor: pointer !important; font-size: 13px;"></i>

                <i class="pi pi-print ms-2 text-primary" (click)=" printReport(report)" pTooltip="Print"
                  tooltipPosition="top" style="cursor: pointer !important; font-size: 13px;"></i>
              </div>
            </div>

            <!-- Right side: preview + nav -->
            <div class="col-8" style="max-height: 300px;">

              <div class="d-flex justify-content-center align-items-center gap-3 mt-2 mb-2">

                <!-- Zoom Out -->

                <i class="pi pi-minus text-primary" (click)="zoomLevel = zoomLevel - 0.2" pTooltip="Zoom out"
                  style="cursor: pointer; font-size: 16px;">
                </i>

                <!-- Current Zoom Percentage -->
                <span class=" px-2 py-1 border rounded" style="color: black;border-color: black;">
                  {{ (zoomLevel * 100) | number:'1.0-0' }}%
                </span>
                <!-- Zoom In -->
                <i class="pi pi-plus cursor-pointer" (click)="zoomLevel = zoomLevel + 0.2" pTooltip="Zoom in"
                  style="cursor: pointer !important; font-size: 16px;">
                </i>
                <!-- Reset -->
                <button class="btn btn-sm btn-primary ms-2" (click)="zoomLevel = 1"
                  style="cursor: pointer !important; font-size: 16px;">
                  Reset
                </button>

              </div>

              <div style="height: 280px; background: #fff; margin: 0; padding: 0; position: relative;">

                <!-- LEFT NAV ICON (centered vertically on left side) -->
                <button class="btn position-absolute p-0 border-0 bg-transparent"
                  style="top: 50%; left: 8px; transform: translateY(-50%);" [attr.aria-label]="'Previous report'"
                  (click)="toggleReport('prev')">
                  <i class="pi pi-chevron-left fs-5"></i>
                </button>

                <!-- PDF Viewer -->
                <div style="width:100%; height:100%; overflow:auto;" class="px-4">

                  <!-- PDF Viewer -->
                  <pdf-viewer *ngIf="filePath" [src]="filePath" [render-text]="true" [show-all]="true"
                    [original-size]="false" [fit-to-page]="true" [zoom]="zoomLevel"
                    style="width:100%; height:100%; display:block;">
                  </pdf-viewer>

                  <!-- Placeholder if no file loaded -->
                  <div *ngIf="!filePath" class="d-flex align-items-center justify-content-center" style="height:100%;">
                    <div class="text-muted">No document selected. Check a report on the left to load the PDF.</div>
                  </div>

                </div>

                <!-- RIGHT NAV ICON (centered vertically on right side) -->
                <button class="btn position-absolute p-0 border-0 bg-transparent"
                  style="top: 50%; right: 8px; transform: translateY(-50%);" [attr.aria-label]="'Next report'"
                  (click)="toggleReport('next')">
                  <i class="pi pi-chevron-right fs-5"></i>
                </button>
              </div>


            </div>
          </div>

          <!-- quotation sending options -->
          <h6 class="share_via_title text-primary ms-2">Share via</h6>
          <p-tabView [(activeIndex)]="activeIndex" class="custom-tabs" (onChange)="onTabChange($event)">
            <!-- SMS Tab -->
            <p-tabPanel header="SMS">
              <ng-template pTemplate="header">
                <span>SMS</span>
              </ng-template>
              <form [formGroup]="viewDocForm">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="quote-label">Phone Number <span class="text-danger">*</span></label>
                    <input pInputText type="tel" class="form-control" formControlName="phoneNumber"
                      placeholder="e.g., 0712345678" maxlength="10" />
                    <div *ngIf="viewDocForm.get('phoneNumber')?.invalid && viewDocForm.get('phoneNumber')?.touched"
                      class="text-danger small">
                      Please enter exactly 10 digits (e.g., 0712345678)
                    </div>
                  </div>
                </div>
              </form>
            </p-tabPanel>

            <!-- Email Tab -->
            <p-tabPanel header="Email">
              <ng-template pTemplate="header">
                <span>Email</span>
              </ng-template>
              <form [formGroup]="viewDocForm">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="quote-label">Email address <span class="text-danger">*</span></label>
                    <input pInputText type="text" class="form-control" formControlName="to" 
                           placeholder="Enter email addresses separated by comma, semicolon, or space" />
                    <div *ngIf="viewDocForm.get('to')?.invalid && viewDocForm.get('to')?.touched"
                      class="text-danger small">
                      <span *ngIf="viewDocForm.get('to')?.errors?.['required']">Email address is required</span>
                      <span *ngIf="viewDocForm.get('to')?.errors?.['invalidEmails']">One or more email addresses are invalid</span>
                    </div>
                    <div class="text-muted small mt-1">
                      You can enter multiple emails separated by comma, semicolon, or space
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="quote-label">CC</label>
                    <input pInputText type="text" class="form-control" formControlName="cc" 
                           placeholder="Enter CC email addresses (optional)" />
                    <div *ngIf="viewDocForm.get('cc')?.invalid && viewDocForm.get('cc')?.touched"
                      class="text-danger small">
                      <span *ngIf="viewDocForm.get('cc')?.errors?.['invalidEmails']">One or more email addresses are invalid</span>
                    </div>
                    <div class="text-muted small mt-1">
                      Multiple emails supported (comma, semicolon, or space separated)
                    </div>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <label class="quote-label">BCC</label>
                    <input pInputText type="text" class="form-control" formControlName="bcc" 
                           placeholder="Enter BCC email addresses (optional)" />
                    <div *ngIf="viewDocForm.get('bcc')?.invalid && viewDocForm.get('bcc')?.touched"
                      class="text-danger small">
                      <span *ngIf="viewDocForm.get('bcc')?.errors?.['invalidEmails']">One or more email addresses are invalid</span>
                    </div>
                    <div class="text-muted small mt-1">
                      Multiple emails supported (comma, semicolon, or space separated)
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="quote-label required">Subject</label>
                    <input pInputText type="text" class="form-control" formControlName="subject" />
                  </div>
                </div>

                <div class="mb-3">
                  <label class="quote-label">Wording</label>
                  <textarea pInputTextarea class="form-control" rows="3" formControlName="wording"></textarea>
                </div>
              </form>
            </p-tabPanel>
          </p-tabView>


          <div class="d-flex justify-content-between align-items-center">
            <!-- Left buttons -->
            <div class="d-flex">
              <button type="button" class="btn btn-outline-primary btn-sm me-3  btn-greyed-out"
                pTooltip="Feature under development">
                Print
              </button>

              <button type="button" class="btn btn-outline-primary btn-sm " (click)="downloadReports(selectedReports)">
                Download
              </button>
            </div>

            <!-- Right buttons -->
            <div class="d-flex">
              <button type="button" class="btn btn-outline-primary btn-sm me-3" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="button" class="btn btn-primary btn-sm" (click)="sendReportViaEmail()"
                [disabled]="activeIndex === 0 ? viewDocForm.get('phoneNumber')?.invalid : viewDocForm.get('to')?.invalid">
                {{ activeIndex === 0 ? 'Send SMS' : 'Send Email' }}
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- quotation other details -->
    <div class="tab-pane fade" id="nav-quotation-other-details" role="tabpanel" aria-labelledby="nav-authorization-tab"
      tabindex="0">

      <app-quotation-other-details></app-quotation-other-details>

    </div>

    <!-- quotation report  -->
    <!-- <div class="tab-pane fade" id="nav-reports" role="tabpanel" aria-labelledby="nav-authorization-tab" tabindex="0">
      <app-quotation-report></app-quotation-report>

    </div> -->
    <div class="tab-pane fade" id="nav-reports" role="tabpanel" aria-labelledby="nav-authorization-tab" tabindex="0">
      <app-quotation-report *ngIf="activeQuoteTab === 'reports'"></app-quotation-report>
    </div>





  </div>
</div>