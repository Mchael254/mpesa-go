<p class="titleMain mt-3 ms-4">{{ 'gis.quotation.quotation_management' | translate }}</p>
<div class=" mx-4 mt-n1" (click)="immediateHideTooltip()">
  <div class="card mb-3" style=" position: relative;">
    <div class="card-body">
      <div class="row mb-2">
        <div class="col-7">
          <!-- <div>
                  <div class="row">
                    <div class="col-8">
                      <div class="input-group mb-3" style="font-size: 15px">
                        <span class="input-group-text" id="basic-addon1">
                          <i class="fa-solid fa-magnifying-glass"></i>
                        </span>
                        <input style="font-size: 12px !important" type="text" class="form-control" placeholder="Search"
                          aria-label="Username" aria-describedby="basic-addon1" />
                      </div>
                    </div>
                    <div class="col-4">
                      <div class="input-group mb-3">
                        <label class="input-group-text" for="inputGroupSelect01" style="font-size: 11px !important">Sort
                          by:</label>
                        <select style="font-size: 11px;" class="form-select" id="inputGroupSelect01">
                          <option selected>
                            Status
                          </option>
                          <option></option>
        
                        </select>
                      </div>
                    </div>
                  </div>
                </div> -->
        </div>

        <div class="col-5">
          <div class="d-flex justify-content-end">
            <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
              (click)="createQuote('QUICK')">Quick Quotation</button>
            <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
              (click)="createQuote('NORMAL')"> Normal Quotation </button>

          </div>
        </div>
      </div>
      <p-table #quotationTable [value]="gisQuotationList" [paginator]="true" [rows]="10" [scrollable]="true"
        scrollDirection="horizontal" [showCurrentPageReport]="true" [tableStyle]="{'min-width': '100rem'}"
        currentPageReportTemplate=" {first} - {last} of {totalRecords}" [responsiveLayout]="'scroll'"
        [reorderableColumns]="true" [rowsPerPageOptions]="[5, 10, 20]"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [globalFilterFields]="['quotationNumber','clientName', 'premium','agentShortDescription']">
        <ng-template pTemplate="header">
          <tr>
            <th style="background-color: #f0f0f0;" pSortableColumn="quotationNumber" class="flexible-header">
              {{ 'gis.quotation.quotation_number' | translate }}
              <p-sortIcon field="quotationNumber"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="client" class="flexible-header">
              {{ 'gis.quotation.client' | translate }}
              <p-sortIcon field="client"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="agent" class="flexible-header">
              {{ 'gis.quotation.agent' | translate }}
              <p-sortIcon field="agent"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="premium" class="flexible-header text-end">
              {{ 'gis.quotation.premium' | translate }}
              <p-sortIcon field="premium"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="fromDate" class="flexible-header">
              {{ 'gis.quotation.cover_from' | translate }}
              <p-sortIcon field="fromDate"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="toDate" class="flexible-header">
              {{ 'gis.quotation.cover_to' | translate }}
              <p-sortIcon field="toDate"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" class="flexible-header text-end">
              Actions
            </th>
          </tr>

          <tr class=" filter-row mb-5 mt-5">
            <td class="me-1" style="background-color: #ffffff;">
              <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                #quotationNumberTypeFilter (input)="inputQuotationNo($event)"
                (input)="quotationTable.filterGlobal(quotationNumberTypeFilter.value, 'contains')">
            </td>

            <!-- client search -->
            <td class="me-1" style="background-color: #ffffff;">
              <div class="position-relative">
                <input type="text" id="quote-input" class="form-select form-control custom-select" style="width: 100%;"
                  [value]="displayClientName" (click)="openClientSearchModal()" readonly
                  (keyup.enter)="fetchGISQuotations();" />

                <!-- Clear button with X icon - only shows when there's a value -->
                <button *ngIf="displayClientName" class="btn btn-sm position-absolute clear-btn"
                  style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                  (click)="clearClientName()">
                  <i class="pi pi-times"></i>
                </button>

                <!-- Client Search Modal Component -->
                <!-- <app-client-search-modal (onClickSaveClient)="onClientSelected($event)"
                *ngIf="isClientSearchModalVisible"></app-client-search-modal> -->
                <app-client-search-modal *ngIf="isClientSearchModalVisible"
                  (onClickSaveClient)="onClientSelected($event)" (modalClosed)="isClientSearchModalVisible = false">
                </app-client-search-modal>
              </div>
            </td>

            <!-- agent filter -->
            <td style="background-color: #ffffff;">
              <div class="position-relative">
                <input type="text" id="quote-input" class="form-select form-control custom-select" style="width: 100%;"
                  [value]="displayAgentName" data-bs-toggle="modal" data-bs-target="#agentSearchModal" readonly
                  (keyup.enter)="fetchGISQuotations();" (click)="openAgentSearchModal()" />

                <!-- Clear button with X icon - only shows when there's a value -->
                <button *ngIf="displayAgentName" class="btn btn-sm position-absolute clear-btn"
                  style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                  (click)="clearAgentName()">
                  <i class="pi pi-times"></i>
                </button>

                <!-- Agent Search Modal Component -->
                <app-agent-search-modal (agentSelected)="onAgentSelected($event)"></app-agent-search-modal>
              </div>
            </td>

            <!-- premium filter -->
            <td class="me-1" style="background-color: #ffffff;">
              <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                #premiumTypeFilter (input)="inputQuotationNo($event)"
                (input)="quotationTable.filterGlobal(premiumTypeFilter.value, 'contains')">
            </td>

            <!-- date filters -->
            <td style="background-color: #ffffff;">
              <p-calendar name="withEffectiveFromDate" [(ngModel)]="fromDate" [dateFormat]="dateFormat"
                [showIcon]="true" [showButtonBar]="true" [minDate]="minDate" (onSelect)="onDateFromInputChange($event)"
                (onClear)="onDateFromInputChange(null)" appendTo="body" (keyup.enter)="fetchGISQuotations()"
                styleClass="calendar-input w-100">
              </p-calendar>

            </td>
            <td style="background-color: #ffffff;">
              <p-calendar name="withEffectiveToDate" [(ngModel)]="toDate" [dateFormat]="dateFormat" [showIcon]="true"
                [showButtonBar]="true" [minDate]="minToDate" (onSelect)="onDateToInputChange($event)"
                (onClear)="onDateToInputChange(null)" appendTo="body" (keyup.enter)="fetchGISQuotations()"
                styleClass="calendar-input w-100">
              </p-calendar>
            </td>

            <!-- clear -->
            <td style="background-color: #ffffff;" class="text-end">
              <button type="button" class="btn btn-sm  btn-outline-primary" (click)="clearFilters();">{{
                'gis.quotation.clear' | translate }}</button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-quotation>
          <tr>
            <td>{{quotation.quotationNumber}}</td>
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
              {{quotation.clientName |sentenceCase}}</td>
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
              {{quotation.agentShortDescription |sentenceCase}}</td>
            <td class="text-end">{{quotation.currency}} {{quotation.premium || 0}}</td>
            <td>{{quotation.fromDate}}</td>
            <td>{{quotation.toDate}}</td>

            <td class="text-end" style="padding-top: 0; padding-bottom: 0;">
              <div class="action-buttons-container d-flex align-items-center justify-content-end gap-2"
                   (mouseleave)="hideTooltip()">
                <!-- Display first 3 actions as text links -->
                <ng-container *ngFor="let item of getFirstThreeActions(quotation); let i = index">
                  <a href="javascript:void(0)" 
                     class="text-decoration-none text-primary small fw-medium action-link"
                     (click)="executeAction(item, quotation); immediateHideTooltip()" 
                     (mouseenter)="showTooltip(item.label, $event)"
                     (mouseleave)="hideTooltip()"
                     (mousemove)="updateTooltipPosition($event)">
                    {{ item.label }}
                  </a>
                  <span *ngIf="i < getFirstThreeActions(quotation).length - 1" class="text-muted"></span>
                </ng-container>

                <!-- Show ellipsis if there are more than 3 actions -->
                <ng-container *ngIf="hasMoreThanThreeActions(quotation)">
                  <span class="text-muted"></span>
                  <button type="button" class="btn btn-sm p-0 text-primary" (click)="showMoreActions($event, quotation)"
                    style="background: none; border: none; font-size: 0.875rem;">
                    <i class="pi pi-ellipsis-h"></i>
                  </button>
                </ng-container>

                <!-- Popup menu for additional actions -->
                <p-menu #moreActionsMenu [popup]="true" [model]="remainingMenuItems" appendTo="body"
                  styleClass="additional-actions-menu">
                  <ng-template pTemplate="item" let-item>
                    <a class="p-menuitem-link d-flex align-items-center text-decoration-none"
                       (click)="executeAction(item, selectedQuotation, $event); immediateHideTooltip()"
                       (mouseenter)="showMenuTooltip(item.label, $event)"
                       (mouseleave)="hideMenuTooltip()"
                       (mousemove)="updateTooltipPosition($event)"
                       style="padding: 0.5rem 1rem; color: #495057;">
                      <span>{{ item.label }}</span>
                    </a>
                  </ng-template>
                </p-menu>
              </div>
            </td>
          </tr>
        </ng-template>
        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center p-4 text-muted">
              <ng-container>
                {{'gis.quotation.no_matching_quotation' | translate}}
              </ng-container>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Custom Tooltip -->
  <div *ngIf="hoveredAction" 
       class="custom-tooltip"
       [class.show]="hoveredAction"
       [style.left.px]="tooltipPosition.x"
       [style.top.px]="tooltipPosition.y">
    <i [class]="getActionIcon(hoveredAction)" class="tooltip-icon"></i>
    <span class="tooltip-text">{{ getTooltipDescription(hoveredAction) }}</span>
  </div>

  <br>
  <br><br><br><br>