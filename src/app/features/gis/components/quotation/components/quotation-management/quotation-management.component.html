
<p class="titleMain mt-3 ms-4">{{ 'gis.quotation.quotation_management' | translate }}</p>
<div class=" mx-4 mt-n1" (click)="immediateHideTooltip()">
  <div class="card mb-3" style=" position: relative;">
    <div class="card-body">
      <div class="row mb-2">
        <div class="col-7">
         
        </div>

        <div class="col-5">
          <div class="d-flex justify-content-end">
            <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
              (click)="createQuote('QUICK')">Quick Quotation</button>
            <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
              (click)="createQuote('NORMAL')"> Normal Quotation </button>

          </div>
        </div>
      </div>
      <p-table #quotationTable [value]="gisQuotationList" [paginator]="true" [rows]="10" [scrollable]="true"
        scrollDirection="horizontal" [showCurrentPageReport]="true" [tableStyle]="{'min-width': '100rem'}"
        currentPageReportTemplate=" {first} - {last} of {totalRecords}" [responsiveLayout]="'scroll'"
        [reorderableColumns]="true" [rowsPerPageOptions]="[5, 10, 20]"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        [globalFilterFields]="['quotationNumber','clientName', 'premium','agentShortDescription']">
        <ng-template pTemplate="header">
          <tr>
            <th style="background-color: #f0f0f0;" pSortableColumn="quotationNumber" class="flexible-header">
              {{ 'gis.quotation.quotation_number' | translate }}
              <p-sortIcon field="quotationNumber"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="client" class="flexible-header">
              {{ 'gis.quotation.client' | translate }}
              <p-sortIcon field="client"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="agent" class="flexible-header">
              {{ 'gis.quotation.agent' | translate }}
              <p-sortIcon field="agent"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="premium" class="flexible-header text-end">
              {{ 'gis.quotation.premium' | translate }}
              <p-sortIcon field="premium"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="fromDate" class="flexible-header">
              {{ 'gis.quotation.cover_from' | translate }}
              <p-sortIcon field="fromDate"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" pSortableColumn="toDate" class="flexible-header">
              {{ 'gis.quotation.cover_to' | translate }}
              <p-sortIcon field="toDate"></p-sortIcon>
            </th>
            <th style="background-color: #f0f0f0;" class="flexible-header text-end">
              Actions
            </th>
          </tr>

          <tr class=" filter-row mb-5 mt-5">
            <td class="me-1" style="background-color: #ffffff;">
              <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                #quotationNumberTypeFilter (input)="inputQuotationNo($event)"
                (input)="quotationTable.filterGlobal(quotationNumberTypeFilter.value, 'contains')">
            </td>

            <!-- client search -->
            <td class="me-1" style="background-color: #ffffff;">
              <div class="position-relative">
                <input type="text" id="quote-input" class="form-select form-control custom-select" style="width: 100%;"
                  [value]="displayClientName" (click)="openClientSearchModal()" readonly
                  (keyup.enter)="fetchGISQuotations();" />

                <!-- Clear button with X icon - only shows when there's a value -->
                <button *ngIf="displayClientName" class="btn btn-sm position-absolute clear-btn"
                  style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                  (click)="clearClientName()">
                  <i class="pi pi-times"></i>
                </button>

                <!-- Client Search Modal Component -->
                <!-- <app-client-search-modal (onClickSaveClient)="onClientSelected($event)"
                *ngIf="isClientSearchModalVisible"></app-client-search-modal> -->
                <app-client-search-modal *ngIf="isClientSearchModalVisible"
                  (onClickSaveClient)="onClientSelected($event)" (modalClosed)="isClientSearchModalVisible = false">
                </app-client-search-modal>
              </div>
            </td>

            <!-- agent filter -->
            <td style="background-color: #ffffff;">
              <div class="position-relative">
                <input type="text" id="quote-input" class="form-select form-control custom-select" style="width: 100%;"
                  [value]="displayAgentName" data-bs-toggle="modal" data-bs-target="#agentSearchModal" readonly
                  (keyup.enter)="fetchGISQuotations();" (click)="openAgentSearchModal()" />

                <!-- Clear button with X icon - only shows when there's a value -->
                <button *ngIf="displayAgentName" class="btn btn-sm position-absolute clear-btn"
                  style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                  (click)="clearAgentName()">
                  <i class="pi pi-times"></i>
                </button>

                <!-- Agent Search Modal Component -->
                <app-agent-search-modal (agentSelected)="onAgentSelected($event)"></app-agent-search-modal>
              </div>
            </td>

            <!-- premium filter -->
            <td class="me-1" style="background-color: #ffffff;">
              <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                #premiumTypeFilter (input)="inputQuotationNo($event)"
                (input)="quotationTable.filterGlobal(premiumTypeFilter.value, 'contains')">
            </td>

            <!-- date filters -->
            <td style="background-color: #ffffff;">
              <p-calendar name="withEffectiveFromDate" [(ngModel)]="fromDate" [dateFormat]="dateFormat"
                [showIcon]="true" [showButtonBar]="true" [minDate]="minDate" (onSelect)="onDateFromInputChange($event)"
                (onClear)="onDateFromInputChange(null)" appendTo="body" (keyup.enter)="fetchGISQuotations()"
                styleClass="calendar-input w-100">
              </p-calendar>

            </td>
            <td style="background-color: #ffffff;">
              <p-calendar name="withEffectiveToDate" [(ngModel)]="toDate" [dateFormat]="dateFormat" [showIcon]="true"
                [showButtonBar]="true" [minDate]="minToDate" (onSelect)="onDateToInputChange($event)"
                (onClear)="onDateToInputChange(null)" appendTo="body" (keyup.enter)="fetchGISQuotations()"
                styleClass="calendar-input w-100">
              </p-calendar>
            </td>

            <!-- clear -->
            <td style="background-color: #ffffff;" class="text-end">
              <button type="button" class="btn btn-sm  btn-outline-primary" (click)="clearFilters();">{{
                'gis.quotation.clear' | translate }}</button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-quotation>
          <tr>
            <td>{{quotation.quotationNumber}}</td>
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
              {{quotation.clientName |sentenceCase}}</td>
            <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
              {{quotation.agentShortDescription |sentenceCase}}</td>
            <td class="text-end">{{quotation.currency}} {{quotation.premium || 0}}</td>
            <td>{{quotation.fromDate}}</td>
            <td>{{quotation.toDate}}</td>

            <td class="text-end" style="padding-top: 0; padding-bottom: 0;">
              <!-- DEBUG: Direct test button (remove after testing) -->
              <!-- <button class="btn btn-xs btn-outline-success me-2" (click)="viewQuote(quotation)" style="font-size: 10px; padding: 2px 4px;">DEBUG VIEW</button> -->

              <div class="action-buttons-container d-flex align-items-center justify-content-end gap-1"
                (mouseleave)="hideTooltip()">
                <!-- Display first 3 actions as text links -->
                <!-- View Action -->
                <button type="button"
                  class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                  (click)="immediateHideTooltip(); viewQuote(quotation)" (mouseenter)="showTooltip('View', $event)"
                  (mouseleave)="hideTooltip()" (mousemove)="updateTooltipPosition($event)">
                  View
                </button>
          
                <!-- Revise Action -->
                <button type="button"
                  class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                  (click)="immediateHideTooltip(); reviseQuotation(quotation)" (mouseenter)="showTooltip('Revise', $event)"
                  (mouseleave)="hideTooltip()" (mousemove)="updateTooltipPosition($event)">
                  Revise
                </button>

                <!-- Reuse Action -->
                <button type="button"
                  class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                  (click)="immediateHideTooltip(); reuseQuotation(quotation)" (mouseenter)="showTooltip('Reuse', $event)"
                  (mouseleave)="hideTooltip()" (mousemove)="updateTooltipPosition($event)">
                  Reuse
                </button>

                <!-- Show ellipsis for more actions -->
                <span class="text-muted mx-2" style="font-size: 0.75rem;"></span>
                <a href="javascript:void(0)" class="text-primary action-link"
                  (click)="showMoreActions($event, quotation)"
                  style="font-size: 0.875rem; text-decoration: none; padding: 2px 4px;">
                  <i class="pi pi-ellipsis-h"></i>
                </a>

                <!-- Popup menu for additional actions -->
                <p-menu #moreActionsMenu [popup]="true" [model]="remainingMenuItems" appendTo="body"
                  styleClass="additional-actions-menu">
                  <ng-template pTemplate="item" let-item>
                    <a class="p-menuitem-link d-flex align-items-center text-decoration-none"
                      (click)="immediateHideTooltip(); item.command(); moreActionsMenu.hide()"
                      (mouseenter)="showMenuTooltip(item.label, $event)" (mouseleave)="hideMenuTooltip()"
                      (mousemove)="updateTooltipPosition($event)" style="padding: 0.5rem 1rem; color: #495057;">
                      <span>{{ item.label }}</span>
                    </a>
                  </ng-template>
                </p-menu>
              </div>
            </td>
          </tr>
        </ng-template>
        <!-- Empty Message -->
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center p-4 text-muted">
              <ng-container>
                {{'gis.quotation.no_matching_quotation' | translate}}
              </ng-container>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Custom Tooltip -->
  <div *ngIf="hoveredAction" class="custom-tooltip" [class.show]="hoveredAction" [style.left.px]="tooltipPosition.x"
    [style.top.px]="tooltipPosition.y">
    <i [class]="getActionIcon(hoveredAction)" class="tooltip-icon"></i>
    <span class="tooltip-text">{{ getTooltipDescription(hoveredAction) }}</span>
  </div>

  <br>
  <br><br><br><br>