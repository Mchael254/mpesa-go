<div class="container">
  <div class="mt-4" style="display: flex; justify-content: start">
    <app-dynamic-breadcrumb [breadCrumbItems]="breadCrumbItems">
    </app-dynamic-breadcrumb>
  </div>
  <app-stepper [currentStep]="2" [stepperData]="steps"></app-stepper>
  <!-- Subcard: Quotation Details & Table -->
  <div class="card mb-4" style=" position: relative; border: none; border-radius: 5px;">

    <div class="card-body mx-4">
      <p class="subtitle ">{{ 'gis.quotation.quotation_summmary' | translate }}</p>

      <!-- Quotation Details -->
      <div class="row mb-1">
        <div class="col-sm-5 col-12 ">
          <p id="quote-label">{{ 'gis.quotation.quotation_number' | translate }}: <strong id="quote-input">{{
              quotationDetails?.quotationNo
              }}</strong>
          </p>

        </div>
        <div class="col-sm-3 col-12 ">
          <p id="quote-label">{{ 'gis.quotation.quotation_status' | translate }}:<strong id="quote-input">{{
              quotationDetails?.status
              }}</strong></p>

        </div>
        <div class="col-sm-4 col-12 ">
          <p id="quote-label">{{ 'gis.quotation.ticket_number' | translate }}:<strong id="quote-input"></strong></p>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-sm-5 col-12 ">
          <p id="quote-label">{{ 'gis.quotation.ipay_reference' | translate }}: <strong id="quote-input">{{
              quotationDetails?.ipayReferenceNumber }}</strong></p>

        </div>
        <div class="col-sm-3 col-12 ">
          <p id="quote-label">{{ 'gis.quotation.currency' | translate }}: <strong id="quote-input">{{
              quotationDetails?.currency }}</strong></p>

        </div>
        <div class="col-sm-4 col-12 ">
          <p id="quote-label">
            {{ 'gis.quotation.notes' | translate }}: <span class="notes-preview" id="quote-input">{{
              quotationDetails?.comments
              }}</span>

            <i class="fa fa-pencil edit-icon" data-bs-toggle="modal" data-bs-target="#notesModal"
              (click)="storeCurrentComment()"></i>
          </p>


        </div>
      </div>
      <!-- NOTES MODAL -->
      <div class="modal fade pb-4" id="notesModal" tabindex="-1" aria-labelledby="notesLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content ps-4 pt-4 pe-4 pb-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-4 p-1">
              <p class="modal-title mb-0" id="acceptQuoteLabel">
                {{ 'gis.quotation.notes' | translate }}</p>
              <button type="button" data-bs-dismiss="modal"
                class="btn p-0 border-0 bg-transparent text-danger fs-5 fw-bold"
                style="text-decoration: none;color: #EE3945;">X
              </button>
            </div>
            <textarea rows="5" [(ngModel)]="comments"></textarea>

            <div class="justify-content-end mb-4 mt-4">
              <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary me-1 ">
                {{ 'gis.quotation.cancel' | translate }}
              </button>
              <button type="button" class="btn btn-primary " (click)="saveNotes()">
                {{ 'gis.policy.save_details' | translate }}
              </button>

            </div>
          </div>
        </div>
      </div>


      <!-- Product Table -->
      <p-table [value]="productDetails" [sortField]="'productName'" [sortOrder]="1" rowGroupMode="rowspan"
        groupField="productName" class="mt-4 ui-datatable" >
        <!-- Table Header -->
        <ng-template pTemplate="header">
          <tr>
            <th class="flexible-header"> {{ 'gis.quotation.product' | translate }}</th>
            <th class="flexible-header"> {{ 'gis.quotation.risk' | translate }}</th>
            <th class="flexible-header"> {{ 'gis.quotation.cover_type' | translate }}</th>
            <th class="flexible-header"> {{ 'gis.quotation.effective_date' | translate }}</th>
            <th class="flexible-header"> {{ 'gis.quotation.sum_insured' | translate }}</th>
            <th class="flexible-header"> {{ 'gis.quotation.premium' | translate }}</th>
          </tr>
        </ng-template>

        <!-- Table Body -->
        <ng-template pTemplate="body" let-quote let-rowIndex="rowIndex">
          <tr>
            <td *ngIf="shouldShowProductName(rowIndex)">
              {{ quote.productName |sentenceCase }}
            </td>
            <td *ngIf="!shouldShowProductName(rowIndex)">
              <!-- empty cell to align with rowspan -->
            </td>
            <td>{{ quote.riskId |sentenceCase }}</td>
            <td>{{ quote.coverType |sentenceCase }}</td>
            <td>{{ quote.wef }}</td>
            <td>{{ quote.sumInsured | number: '1.0-2' }}</td>
            <td>{{ quote.premium | number: '1.0-2' }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td colspan="4"></td>
            <td class="text-right  label">
              {{ 'gis.quotation.sub_total' | translate }}
            </td>
            <td class="text-right  value">
              {{ totalSumInsured | number: '1.0-2' }}
            </td>
          </tr>
        </ng-template>


      </p-table>

    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-4  col-12 mt-2 d-flex justify-content-start gap-2">
      <button type="button" class="btn btn-text me-2 " style="border: none;" (click)="navigateToQuoteDetails()">
        {{ 'gis.quotation.back' | translate }}
      </button>
      <button *ngIf="!afterRejectQuote" type="button" class="btn btn-outline-primary mx-2"
        (click)="getUsers(); $event.preventDefault()" data-bs-target="#reassignQuotation" data-bs-toggle="modal">{{
        'gis.quotation.reassign' | translate }}
      </button>
      <button *ngIf="!afterRejectQuote" type="button" class="btn btn-outline-primary" data-bs-target="#rejectQuote"
        data-bs-toggle="modal">{{
        'gis.quotation.reject' |
        translate
        }}
      </button>
    </div>
    <div class="col-md-8  col-12 mt-2 d-flex justify-content-end">

      <button *ngIf="!afterRejectQuote" type="button" class="btn btn-outline-primary me-2" data-bs-toggle="modal"
        data-bs-target="#shareQuoteModal">
        {{ 'gis.quotation.share_quotation' | translate }}
      </button>

      <button *ngIf="!afterRejectQuote" type="button" class="btn btn-primary " (click)="convertQuoteToNormalQuote()">
        {{ 'gis.quotation.convert_to_normal_quote' | translate }}
      </button>
      <button *ngIf="!afterRejectQuote" type="button" class="btn btn-primary " data-bs-toggle="modal"
        data-bs-target="#clientSearchModal">
        {{ 'gis.quotation.convert_to_policy' | translate }}
      </button>
      <button #closeButton type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
        style="display: none;"></button>
      <app-client-search-modal [convertToPolicy]="true"
        (onClickSaveClient)="handleSaveClient($event)"></app-client-search-modal>
    </div>
  </div>


  <!-- SHARE QUOTE MODAL -->
  <div #shareQuoteModal class="modal fade" id="shareQuoteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content w-[40vw] h-[40vh] p-3">
        <div class="modal-body">

          <!-- <div class="d-flex justify-content-end align-items-center mb-1">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <h3 class="page-title mt-0">{{'gis.quotation.share_quotation' | translate }}</h3> -->
          <button type="button" class="float-end btn-close" data-bs-dismiss="modal" aria-label="Close"
            style="border:none; color: red;"></button>
          <p class="text-start" id="shareQuote"> {{'gis.quotation.share_quotation' | translate }}</p>
          <!-- <ng-container>
          <app-quote-report [quotationDetails]="quotationDetails" [selectedCovers]="selectedCovers" #quoteReport
            style="display: none;">
          </app-quote-report>
        </ng-container> -->
          <ng-container>
            <app-quote-report [quotationDetails]="quotationDetails" #quoteReport [selectedCovers]="selectedCovers"
              style="display: none;">
            </app-quote-report>
          </ng-container>

          <app-share-quotes (sendEvent)="listenToSendEvent($event)"
            (downloadRequested)="onDownloadRequested()"></app-share-quotes>


        </div>
      </div>

    </div>

  </div>

  <!-- reject quote modal -->
  <div class="modal fade" id="rejectQuote">
    <div class="modal-dialog modal-dialog-centered" style="min-width:400px">
      <div class="modal-content ps-4 pt-2 pe-4">
        <div class="d-flex justify-content-between align-items-center rounded-3 mb-1 p-1">
          <p class="modal-title fw-bold">{{ 'gis.quotation.reject_quote' | translate }}</p>
          <button type="button" data-bs-dismiss="modal" class="btn p-1 text-danger fw-bold" style="border: none;">X
          </button>
        </div>
        <p class="text-dark mb-5">Are you sure you want to reject this quote? </p>
        <label class="text-dark mt-0" for="comment">Comment</label>
        <textarea [(ngModel)]="rejectComment" name="rejectComment" #commentInput="ngModel"></textarea>
        <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 my-3 p-0">
          <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
            style="text-decoration: none;">{{
            'gis.quotation.cancel' | translate
            }}
          </button>
          <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
            data-bs-dismiss="modal" (click)="rejectQuotation(quotationDetails.code)">{{
            'gis.quotation.save_changes' |
            translate
            }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- reassign quote modal -->
  <div class="modal fade" id="reassignQuotation">
    <div class="modal-dialog modal-dialog-centered" style="min-width:500px">
      <div class="modal-content ps-4 pt-2 pe-4">
        <div class="d-flex justify-content-between align-items-center rounded-3 mb-1 p-1">
          <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
            {{ 'gis.quotation.reassign_quote' | translate }}</p>
          <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold" style="border: none;">X
          </button>
        </div>
        <div class="row mt-2">
          <p-table #dt [value]="users" [rows]="3" [paginator]="true" [globalFilterFields]="['id', 'name']"
            selectionMode="single" [(selection)]="selectedUser" styleClass="p-datatable-striped"
            (onRowSelect)="onUserSelect()" (onRowUnselect)="onUserUnselect()">
            <ng-template pTemplate="header">
              <tr>
                <th>User ID</th>
                <th>Full Name</th>
              </tr>
              <tr styleClass="p-striped">
                <th>
                  <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)">
                </th>
                <th>
                  <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)">
                </th>
              </tr>

            </ng-template>
            <ng-template pTemplate="body" let-user>
              <tr [pSelectableRow]="user">
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div>

        <hr class="mt-1" style="border: none; border-top: 2.5px solid #0000004D;">
        <small class="text-danger block" [class.invisible]="!noUserChosen">
          Please select a person to reassign before continuing
        </small>

        <div>
          <label class="text-dark block" for="comment">Comment</label>
          <textarea [(ngModel)]="reassignComment" name="reassignComment"
            class="w-full mt-0 p-2 border rounded"></textarea>
        </div>

        <small class="text-danger block" [class.invisible]="!comment">
          Please leave a comment before continuing
        </small>
        <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 mb-2 mt-2 p-0">
          <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
            style="text-decoration: none;">{{
            'gis.quotation.cancel' | translate
            }}
          </button>
           <button #closeReassignButton type="button" data-bs-dismiss="modal" style="display: none;" ></button>
          <button  type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
            (click)="reassignQuotation()">{{ 'gis.quotation.reassign' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>