<div class="container">
  <div class="page-wrapper">
    <p-card class="summary-card">
      <!-- Breadcrumb -->
      <p-breadcrumb class="custom-breadcrumb" [model]="[
          { label: 'Dashboard' },
          { label: 'Quotation' },
          { label: 'New quote' }
        ]"></p-breadcrumb>

      <div class="custom-stepper">
        <label class="step">
          <input type="radio" name="step" [checked]="activeIndex === 0" (click)="setStep(0)">
          <span class="circle">1</span>
          <span class="label" style="color: #00529b;">Quote Information</span>
        </label>

        <!-- Perfectly aligned connecting line -->
        <div class="step-line"></div>

        <label class="step">
          <input type="radio" name="step" [checked]="activeIndex === 1" (click)="setStep(1)">
          <span class="circle">2</span>
          <span class="label" style="color: #00529b;">Quotation Summary</span>
        </label>
      </div>



      <!-- Subcard: Quotation Details & Table -->
      <p-card class="subcard">
        <ng-template pTemplate="header">
          <h3 style="font-weight:600; font-size:1.5rem; color:#1565c0; margin-bottom:0.2rem;">
            Quotation summary
          </h3>
        </ng-template>
        <!-- Quotation Details -->
        <div class="details-grid">
          <div class="column">
            <p><strong>Quotation number:</strong> {{ quotation.number }}</p>
            <p><strong>IPAY reference:</strong> {{ quotation.reference }}</p>
          </div>

          <div class="column">
            <p><strong>Quotation status:</strong> {{ quotation.status }}</p>
            <p><strong>Ticket number:</strong> {{ quotation.ticket }}</p>

          </div>

          <div class="column notes-column">
            <p>
              <strong>Notes:</strong> {{getShortNotes(quotation.notes) }}
              <!-- Trigger Button -->
              <button pButton type="button" label="" icon="pi pi-pencil" (click)="overlayPanel.toggle($event)"></button>
              <p-overlayPanel #overlayPanel [showCloseIcon]="true" [dismissable]="true" [style]="{ width: '350px' }">
                <p-card styleClass="notes-card">
                  <ng-template pTemplate="title" style="color: #00529B;"> Notes </ng-template>

                  <div class="notes-content" style="display: flex; flex-direction: column; ">
                    <!-- Textarea -->
                    <textarea [(ngModel)]="quotation.notes" rows="5" class="p-inputtextarea"
                      placeholder="Type your notes here..." style="width: 100%; resize: none;"></textarea>

                    <!-- Button Row (Bottom Right) -->
                    <div style="display: flex; justify-content: flex-end;">
                      <button pButton label="Cancel" class="p-button-text" (click)="overlayPanel.hide()"
                        style="color: #00529B; font-weight: 600;"></button>
                      <button pButton label="Save Details" class="p-button-primary" (click)="saveNotes()"
                        style="font-weight: 600;"></button>
                    </div>
                  </div>
                </p-card>
              </p-overlayPanel>




            <p><strong>Currency:</strong> {{ quotation.currency}}</p>
          </div>

        </div>

        <!-- Product Table -->
        <p-table [value]="quotation.products" class="mt-4">
          <ng-template pTemplate="header">
            <tr>
              <th>Product</th>
              <th>Risk</th>
              <th>Cover Type</th>
              <th>Effective Date</th>
              <th>Sum Insured</th>
              <th>Premium</th>

            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-quote>
            <tr>
              <td>{{ quote.product }}</td>
              <td>{{ quote.risk }}</td>
              <td>{{ quote.coverType }}</td>
              <td>{{ quote.effectiveDate }}</td>
              <td>{{ quote.sumInsured }}</td>
              <td>{{ quote.premium }}</td>


            </tr>
          </ng-template>


        </p-table>
        <!-- Total Premium Row (outside table but aligned) -->
        <div class="total-row">
          <div class="label">Sub Total</div>
          <div class="value">{{ getTotalPremium() }}</div>
        </div>

      </p-card>

      <div class="button-group mt-4">
        <div class="left-buttons">
          <button pButton label="Back" class="p-button-text me-2"></button>
          <button type="button" class="btn btn-outline-primary" (click)="reassignQuotation()"
            data-bs-target="#reassignQuotation" data-bs-toggle="modal">{{'gis.quotation.reassign' | translate}}</button>

          <button type="button" class="btn btn-outline-primary" (click)="rejectQuotation()"
            data-bs-target="#rejectQuote" data-bs-toggle="modal">{{'gis.quotation.reject' |
            translate}} </button>
        </div>
        <div class="right-buttons">
          <button pButton label="Share quotation" class="p-button-outlined me-2"></button>
          <button pButton label="Accept quote" class="p-button-success"></button>
        </div>
      </div>

    </p-card>
  </div>
</div>

<!-- reject quote modal -->
<div class="modal fade" id="rejectQuote">
  <div class="modal-dialog modal-dialog-centered" style="min-width:400px">
    <div class="modal-content ps-4 pt-2 pe-4">
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-1 p-1">
        <p class="modal-title fw-bold">{{'gis.quotation.reject_quote' | translate}}</p>
        <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold">X</button>
      </div>
      <p class="text-dark mb-5">Are you sure you want to reject this quote?</p>
      <label class="text-dark" for="comment">Comment</label>
      <textarea [(ngModel)]="rejectComment" name="rejectComment"></textarea>
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-4 mt-5 p-0">
        <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary" style="text-decoration: none;">{{
          'gis.quotation.cancel' | translate }}
        </button>
        <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
          data-bs-dismiss="modal" (click)="rejectQuotation()">{{ 'gis.quotation.save_changes' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- reassign quote modal -->
<div class="modal fade" id="reassignQuotation">
  <div class="modal-dialog modal-dialog-centered" style="min-width:500px">
    <div class="modal-content ps-4 pt-2 pe-4">
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-1 p-1">
        <p class="modal-title fw-bold">{{'gis.quotation.reassign_quote' | translate}}</p>
        <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold">X</button>
      </div>
      <div class="row mb-4 mt-2">
        <p-table #dt [value]="users" [rows]="3" [paginator]="true" [globalFilterFields]="['userId', 'fullName']"
          selectionMode="single" [(selection)]="selectedUser" styleClass="p-datatable-striped" 
          (onRowSelect)="onUserSelect()"
          (onRowUnselect)="onUserUnselect()">
          <ng-template pTemplate="header">
            <tr>
              <th>User ID</th>
              <th>Full Name</th>
            </tr>
            <tr>
              <th>
                <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)">
              </th>
              <th>
                <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)">
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-user>
            <tr [pSelectableRow]="user">
              <td>{{ user.userId }}</td>
              <td>{{ user.fullName }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <label class="text-dark" for="comment">Comment</label>
      <textarea [(ngModel)]="reassignComment" name="reassignComment"></textarea>
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-3 mt-3 p-0">
        <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary" style="text-decoration: none;">{{
          'gis.quotation.cancel' | translate }}
        </button>
        <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
          data-bs-dismiss="modal" (click)="reassignQuotation()">{{ 'gis.quotation.reassign' | translate }}
        </button>
      </div>
    </div>
  </div>
</div>