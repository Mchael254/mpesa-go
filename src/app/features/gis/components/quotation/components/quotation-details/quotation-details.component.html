<div class="mx-4 mt-3">
  <p class="title">{{ 'gis.quotation.quote_details_title' | translate }} </p>
  <app-stepper [currentStep]="1" [stepperData]="steps"></app-stepper>

  <!-- quotation section -->
  <div class="card mb-4">
    <div class="card-body my-4 mx-4">
      <h6 class="subheading mt-2 mb-3">{{ 'gis.quotation.quote_detailed_details' | translate }}</h6>

      <div class="d-flex gap-4 mb-3">
        <div class="method-option" (click)="setClientType('new')" [class.selected]="selectedClientType === 'new'">
          <i class="far fa-circle" *ngIf="selectedClientType !== 'new'"></i>
          <i class="fas fa-dot-circle" *ngIf="selectedClientType === 'new'"></i>
          <span> {{ 'gis.quotation.new_client' | translate }}</span>
        </div>

        <div class="method-option" (click)="setClientType('existing')"
          [class.selected]="selectedClientType === 'existing'">
          <i class="far fa-circle" *ngIf="selectedClientType !== 'existing'"></i>
          <i class="fas fa-dot-circle" *ngIf="selectedClientType === 'existing'"></i>
          <span>{{ 'gis.quotation.existing_client' | translate }}</span>
        </div>
      </div>

      <form [formGroup]="quotationForm">
        <!-- New Client Form -->
        <div *ngIf="newClient" class="row mb-3">
          <!-- Client Name -->
          <div class="col-sm-4 col-6 mb-2">
            <label class="quote-label">{{ 'gis.quotation.client_name' | translate }}</label>
            <input type="text" class="form-control form-control-sm" formControlName="client" id="quote-input" />
          </div>

          <!-- Email Address -->
          <div class="col-sm-4 col-6 mb-2">
            <div class="form-group">
              <label class="quote-label"> {{ 'gis.quotation.email_address' | translate }}</label>
              <input type="email" id="email" class="form-control form-control-sm" formControlName="email"
                id="quote-input" placeholder="" />
              <div *ngIf="quotationForm.get('email')?.touched && quotationForm.get('email')?.invalid"
                class="text-danger form-text">
                <div *ngIf="quotationForm.get('email')?.errors?.['required']">
                  {{ 'gis.quotation.email_is_required' | translate }}.
                </div>
                <div *ngIf="quotationForm.get('email')?.errors?.['pattern']">
                  {{ 'gis.quotation.enter_valid_email_address' | translate }}
                </div>
              </div>
            </div>
          </div>

          <!-- Phone Number -->
          <div class="col-sm-4 col-6 mb-2">
            <label class="quote-label"> {{ 'gis.quotation.phone_number' | translate }}</label>
            <ngx-intl-tel-input id="phoneNumber" [cssClass]="'form-control form-control-sm mb-1'"
              [preferredCountries]="preferredCountries" [enableAutoCountrySelect]="true" [enablePlaceholder]="true"
              [searchCountryFlag]="true" [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
              [selectFirstCountry]="false" [style]="{ width: '100%' }" [selectedCountryISO]="CountryISO.Kenya"
              [phoneValidation]="true" [separateDialCode]="true" [numberFormat]="PhoneNumberFormat.National"
              formControlName="phone">
            </ngx-intl-tel-input>

            <div *ngIf="quotationForm.get('phone')?.invalid && quotationForm.get('phone')?.touched"
              class="form-text text-danger">
              {{ 'gis.quotation.invalid_phone_number' | translate }}
            </div>
          </div>
        </div>

        <div class="row ">
          <ng-container *ngFor="let field of detailedQuotationFormData">
            <ng-container *ngIf="field.isPriority === 'Y' && !(newClient && field.name === 'client')">
              <div class="col-sm-4 col-6 mb-3" *ngIf="shouldShowField(field.name)">
                <div class="form-group form-group-sm h-100">
                  <!-- Label -->
                  <label class="quote-label" [ngClass]="{ 'required': field.isMandatory === 'Y' }">
                    {{ field.label | translate }}
                  </label>

                  <!-- Input field based on type -->
                  <ng-container [ngSwitch]="field.type">
                    <!-- SELECT -->
                    <ng-container *ngSwitchCase="'select'">
                      <!-- CLIENT SEARCH -->
                      <ng-container *ngIf="field.name === 'client' && !newClient">
                        <div class="position-relative" style="cursor: pointer;">
                          <input type="text" class="form-control form-control-sm pe-5" id="quote-input"
                            [value]="selectedClientName" formControlName="client" readonly (click)="!isRevision && (showClientSearchModal = true)"

                            style="cursor: pointer;" />
                          <i class="pi pi-search position-absolute"
                            style="top: 50%; right: 12px; transform: translateY(-50%); color: #00529B; pointer-events: none;"></i>
                        </div>
                        <app-client-search-modal *ngIf="showClientSearchModal"
                          (onClickSaveClient)="handleSaveClient($event)"></app-client-search-modal>
                      </ng-container>
                      <div
                        *ngIf="quotationForm.get('client')?.hasError('required') && quotationForm.get('client')?.touched"
                        class="form-text text-danger"> {{ 'gis.quotation.client_name_is_required' | translate }}</div>
                      <!-- SOURCE -->
                      <ng-container *ngIf="field.name === 'source'">
                        <p-dropdown formControlName="source" [options]="quotationSources" optionLabel="description"
                          placeholder=" " [filter]="true" [filterBy]="'description'" (onChange)="onSourceChange($event)"
                          styleClass="w-100"></p-dropdown>
                        <div
                          *ngIf="quotationForm.get('source')?.hasError('required') && quotationForm.get('source')?.touched"
                          class="form-text text-danger">{{ 'gis.quotation.source_is_required' | translate }}</div>
                      </ng-container>

                      <!-- QUOTATION TYPE -->
                      <ng-container *ngIf="field.name === 'quotationType'">
                        <p-dropdown formControlName="quotationType" [options]="quotationType" optionLabel="label"
                          optionValue="value" placeholder=" " [filter]="true" [filterBy]="'label'"
                          styleClass="w-100"></p-dropdown>
                        <div
                          *ngIf="quotationForm.get('quotationType')?.hasError('required') && quotationForm.get('quotationType')?.touched"
                          class="form-text text-danger"> {{ 'gis.quotation.quotation_type_is_required' | translate }}
                        </div>
                      </ng-container>

                      <!-- BRANCH -->
                      <ng-container *ngIf="field.name === 'branch'">
                        <p-dropdown formControlName="branch" [options]="branch" optionLabel="name" placeholder=" "
                          value="id" [filter]="true" [filterBy]="'name'" styleClass="w-100"></p-dropdown>
                        <div
                          *ngIf="quotationForm.get('branch')?.hasError('required') && quotationForm.get('branch')?.touched"
                          class="form-text text-danger"> {{ 'gis.quotation.branch_is_required' | translate }}</div>
                      </ng-container>

                      <!-- CURRENCY -->
                      <ng-container *ngIf="field.name === 'currency'">
                        <p-dropdown formControlName="currency" [options]="currency" optionLabel="name" value="id"
                          placeholder=" " [filter]="true" [filterBy]="'name'" (onChange)="fetchUserOrgId()"
                          styleClass="w-100"></p-dropdown>
                        <div
                          *ngIf="quotationForm.get('currencyCode')?.hasError('required') && quotationForm.get('currencyCode')?.touched"
                          class="form-text text-danger">{{ 'gis.quotation.currency_is_required' | translate }}</div>
                      </ng-container>

                      <ng-container *ngIf="field.name === 'introducer' ">
                        <div class="position-relative" style="cursor: pointer;">
                          <input type="text" class="form-control form-control-sm pe-5" id="quote-input"
                            [value]="selectedIntroducerName" readonly (click)="showIntroducerSearchModal = true"
                            style="cursor: pointer;" formControlName="introducer" />
                          <i class="pi pi-search position-absolute"
                            style="top: 50%; right: 12px; transform: translateY(-50%); color: #00529B; pointer-events: none;"></i>
                        </div>
                        <button *ngIf="showIntroducerSearchModal" data-bs-toggle="modal"
                          data-bs-target="#searchIntroducer" style="display: none;"></button>
                      </ng-container>
                    </ng-container>

                    <!-- DATE -->
                    <p-calendar *ngSwitchCase="'date'" [formControlName]="field.name" [dateFormat]="dateFormat"
                      inputStyleClass="form-control form-control-sm" [showButtonBar]="true" [dataType]="'string'"
                      [showIcon]="true" styleClass="w-100"></p-calendar>

                    <!-- TEXT -->
                    <ng-container *ngSwitchCase="'text'">
                      <div *ngIf="field.name === 'multiUserEntry'">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" formControlName="multiUserEntry"
                            id="multiUserYes" value="Y">
                          <label class="form-check-label quote-label" for="multiUserYes"> {{ 'gis.quotation.yes' |
                            translate }}</label>
                        </div>
                        <div class="form-check form-check-inline ms-4">
                          <input class="form-check-input" type="radio" formControlName="multiUserEntry" id="multiUserNo"
                            value="N">
                          <label class="form-check-label quote-label" for="multiUserNo"> {{
                            'gis.quotation.no' |
                            translate }}</label>
                        </div>
                      </div>

                      <input *ngIf="field.name !== 'multiUserEntry'" type="text" id="quote-input"
                        class="form-control form-control-sm" [formControlName]="field.name">
                    </ng-container>

                    <div
                      *ngIf="quotationForm.get('client')?.hasError('required') && quotationForm.get('client')?.touched"
                      class="form-text text-danger">{{ 'gis.quotation.client_name_is_required' | translate }}</div>

                    <!-- Agent Field -->
                    <ng-container *ngIf="field.name === 'agent' && quotationForm.get('quotationType')?.value === 'I'">
                      <div class="position-relative" style="cursor: pointer;">
                        <input type="text" class="form-control form-control-sm pe-5" id="quote-input"
                          [value]="displayAgentName || ''" readonly (click)="!isRevision && (showAgentSearchModal = true)"
                          style="cursor: pointer;" />
                        <i class="pi pi-search position-absolute"
                          style="top: 50%; right: 12px; transform: translateY(-50%); color: #00529B; pointer-events: none;"></i>
                      </div>
                      <button *ngIf="showAgentSearchModal" data-bs-toggle="modal" data-bs-target="#searchAgent"
                        style="display: none;"></button>
                      <div
                        *ngIf="quotationForm.get('agent')?.hasError('required') && quotationForm.get('agent')?.touched"
                        class="form-text text-danger">
                        {{ 'gis.quotation.agent_is_required' | translate }}
                      </div>
                    </ng-container>

                    <!-- campaign field -->
                    <ng-container *ngIf="field.name === 'campaign' && showCampaignField">
                      <p-dropdown formControlName="campaign" [options]="campaignList" optionLabel="label"
                        optionValue="value" placeholder="" [filter]="true" [filterBy]="'label'"
                        styleClass="w-100"></p-dropdown>
                      <div
                        *ngIf="quotationForm.get('campaign')?.hasError('required') && quotationForm.get('campaign')?.touched"
                        class="form-text text-danger">
                        {{ 'gis.quotation.campaign_source_is_required' | translate }}
                      </div>
                    </ng-container>
                  </ng-container>
                </div>
              </div>
            </ng-container>

            <!-- NON-PRIORITY FIELDS (toggle with show) -->
            <div class="col-sm-4 col-6 mb-3" *ngIf="show && field.isPriority === 'N'">
              <div class="form-group form-group-sm h-100">
                <label *ngIf="field.name && !(newClient && field.name === 'client')" class="quote-label"
                  [ngClass]="{ 'required': field.isMandatory === 'Y' }">
                  {{ field.label | translate }}
                </label>

                <ng-container [ngSwitch]="field.type">
                  <ng-container *ngSwitchCase="'select'">
                    <!-- PAYMENT FREQUENCY -->
                    <ng-container *ngIf="field.name === 'paymentFrequency'">
                      <p-dropdown formControlName="paymentFrequency" [options]="paymentFrequencies" optionLabel="label"
                        optionValue="value" placeholder=" " [filter]="true" [filterBy]="'label'"
                        styleClass="w-100"></p-dropdown>
                      <div
                        *ngIf="quotationForm.get('paymentFrequency')?.hasError('required') && quotationForm.get('paymentFrequency')?.touched"
                        class="form-text text-danger">
                        {{'gis.quotation.payment_frequency_is_required' | translate }}</div>
                    </ng-container>

                    <!-- Marketer field -->
                    <ng-container *ngIf="field.name === 'marketer'">
                      <div class="position-relative" style="cursor: pointer;">
                        <input type="text" class="form-control form-control-sm pe-5" id="quote-input" readonly
                          (click)="showMarketerSearchModal = true" style="cursor: pointer;"
                          [value]="displayMarketerName" />
                        <i class="pi pi-search position-absolute"
                          style="top: 50%; right: 12px; transform: translateY(-50%); color: #00529B; pointer-events: none;"></i>
                      </div>
                      <button *ngIf="showMarketerSearchModal" data-bs-toggle="modal" data-bs-target="#searchMarketer"
                        style="display: none;"></button>
                      <div
                        *ngIf="quotationForm.get('marketer')?.hasError('required') && quotationForm.get('marketer')?.touched"
                        class="form-text text-danger">
                        {{ 'gis.quotation.market_source_is_required' | translate }}
                      </div>
                    </ng-container>
                  </ng-container>

                  <ng-container *ngSwitchCase="'text'">
                    <textarea *ngIf="field.name === 'internalComments'" rows="3" class="form-control"
                      [formControlName]="field.name"
                      style="overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word;">
                      </textarea>
                    <textarea *ngIf="field.name === 'externalComments'" rows="3" class="form-control"
                      [formControlName]="field.name"
                      style="overflow-y:auto; overflow-x:hidden; white-space:pre-wrap; word-wrap:break-word;">

                      </textarea>
                    <input *ngIf="field.name !== 'internalComments' && field.name !== 'externalComments'" type="text"
                      id="quote-input" class="form-control form-control-sm" [formControlName]="field.name">
                  </ng-container>
                </ng-container>
              </div>
            </div>
          </ng-container>
        </div>
      </form>
      <p class="more mt-4" (click)="toggleDetails()" style="cursor: pointer">
        {{ show ? 'Less Details' : 'More Details' }}
        <span class="ml-1">
          <i [ngClass]="{
        'pi': true,
        'pi-angle-double-down': !show,
        'pi-angle-double-up': show
      }" style="font-size:13px"></i>
        </span>
      </p>

    </div>
  </div>



  <!-- product section -->
  <div class="card mb-2">
    <div class="card-body  my-4 mx-4">
      <div class="row ">
        <div class="col-4">
          <h6 style="color: #00529B; font-size: 20px; font-weight: 500; font-family: Roboto; margin-bottom: 0;">
            {{ 'gis.quotation.product_details' | translate }}
          </h6>
        </div>
      </div>

      <div class="row mb-1">
        <div class="col-12 d-flex justify-content-end" style="margin-bottom: 0;">

          <div class="d-flex justify-content-center align-items-center">
            <button type="button" class="btn btn-primary btn-sm no-hover" data-bs-toggle="modal"
              data-bs-target="#addProduct" title="Add Product"> {{
              'gis.quotation.add_product' | translate }}
            </button>
            <i #iconTrigger class="pi border border-black p-1 rounded-1 text-black"
              [ngClass]="{ 'pi-caret-up': showProducts, 'pi-caret-down': !showProducts }"
              style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
              (click)="toggleProducts(iconTrigger)">
            </i>
          </div>

        </div>
      </div>
      <div class="position-relative">

        <div *ngIf="showProductColumnModal" class="card shadow rounded p-2 position-absolute bg-white border"
          [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
          (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)" (document:mouseup)="onDragEnd()">

          <div class="d-flex justify-content-between align-items-center mb-2 cursor-move">
            <strong class="text-primary">{{ 'gis.quotation.select_columns' | translate }}</strong>
            <button class="btn-close btn-sm" (click)="showProductColumnModal = false"></button>
          </div>

          <div style="max-height: 200px; max-width:250px; overflow-y: auto;">
            <div *ngFor="let col of columns">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible" [id]="col.field">
                <label class="form-check-label" [for]="col.field">
                  {{ col.header }}
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- product table  -->
        <div class="collapse" [ngClass]="{'show': showProducts}" id="collapseProduct">
          <p-table [value]="productDetails" dataKey="productCode.code" editMode="row"
            [paginator]="productDetails?.length > 10" [rowsPerPageOptions]="[5, 10, 20]" [rows]="5"
            [tableStyle]="{'min-width': '50rem','table-layout': 'fixed'}">

            <!-- Table Header -->
            <ng-template pTemplate="header">
              <tr>
                <th *ngFor="let col of columns" [hidden]="!col.visible" class="flexible-header1"
                  [ngClass]="{'actions-column': col.field === 'actions'}" [pSortableColumn]="col.field">
                  {{ col.header }}
                  <p-sortIcon [field]="col.field"></p-sortIcon>
                </th>
              </tr>
            </ng-template>

            <!-- Table Body -->
            <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex">
              <tr [pEditableRow]="product" [pEditableRowDisabled]="selectedEditRowIndex !== ri"
                [class.p-highlight]="product === selectedRow" (click)="onRowSelect(product)"
                class="hover:!bg-gray-50 !cursor-pointer transition-colors" title="Click to select row">

                <td *ngFor="let col of columns" [hidden]="!col.visible" class="flexible-header1"
                  [ngClass]="{'actions-column': col.field === 'actions'}">

                  <ng-container [ngSwitch]="col.field">

                    <!-- Only handle actions separately -->
                    <ng-container *ngSwitchCase="'actions'">
                      <div class="d-flex justify-content-center" style=" text-align: center;">
                        <button *ngIf="!editing" type="button" class="p-button-sm p-button-text p-button-info no-border"
                          data-bs-toggle="modal" data-bs-target="#editProduct"
                          (click)="openEditProductModal(product, ri)">
                          {{ 'gis.quotation.edit' | translate }}
                        </button>

                        <button type="button" (click)="openProductDeleteModal(product)"
                          class="p-button-sm p-button-text p-button-danger no-border" data-bs-toggle="modal"
                          data-bs-target="#deleteProductModal">
                          {{ 'gis.quotation.delete' | translate }}
                        </button>
                        <button *ngIf="reassignButton" type="button" (click)="openReassignProductModal(product)"
                          class="p-button-sm p-button-text p-button-danger no-border">
                          {{ 'gis.quotation.reassign' | translate }}
                        </button>
                      </div>
                    </ng-container>

                    <ng-container *ngSwitchCase="'productName'">
                      <p-cellEditor>
                        <ng-template pTemplate="input">
                          <span>{{ product[col.field] }}</span>
                        </ng-template>
                        <ng-template pTemplate="output">
                          {{ getCellValue(product, col.field) }}
                        </ng-template>
                      </p-cellEditor>
                    </ng-container>

                    <ng-container *ngSwitchCase="'coverFrom'">
                      <p-cellEditor>
                        <ng-template pTemplate="input">
                          <p-calendar [(ngModel)]="product[col.field]" [dateFormat]="dateFormat" [showIcon]="true"
                            appendTo="body">
                          </p-calendar>

                        </ng-template>
                        <ng-template pTemplate="output">
                          {{ product[col.field] | date:'dd/MM/yyyy' }}
                        </ng-template>
                      </p-cellEditor>
                    </ng-container>

                    <ng-container *ngSwitchCase="'coverTo'">
                      <p-cellEditor>
                        <ng-template pTemplate="input">
                          <p-calendar [(ngModel)]="product[col.field]" [dateFormat]="dateFormat" [showIcon]="true"
                            appendTo="body">
                          </p-calendar>
                        </ng-template>
                        <ng-template pTemplate="output">
                          {{ product[col.field] | date:'dd/MM/yyyy' }}
                        </ng-template>
                      </p-cellEditor>
                    </ng-container>

                    <!-- Default case: display value dynamically -->
                    <ng-container *ngSwitchDefault>
                      <p-cellEditor>
                        <ng-template pTemplate="input">
                          <input type="text" pInputText [(ngModel)]="product[col.field]" />
                        </ng-template>
                        <ng-template pTemplate="output">
                          {{ getCellValue(product, col.field) }}
                        </ng-template>
                      </p-cellEditor>
                    </ng-container>



                  </ng-container>
                </td>
              </tr>
            </ng-template>

            <!-- Empty Message -->
            <ng-template pTemplate="emptymessage">
              <tr>
                <td [attr.colspan]="columns.length" style="text-align:center; padding: 20px;">
                  {{ 'gis.quotation.no_data_to_display' | translate }}
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>

      <!-- Add Product Modal -->
      <div class="modal fade" id="addProduct" tabindex="-1" role="dialog" aria-labelledby="addSectionLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm " style="min-width: 518px;" role="document">
          <div class="modal-content" id="addSectionModal">
            <div class="modal-body">
              <h5 class="modal-title mt-2" id="editOtherDetailsLabel"> {{ 'gis.quotation.add_product'
                | translate }}
                <button type="button" class="btn-close float-end custom-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </h5>
              <div class="row mb-4" [formGroup]='quotationProductForm'>
                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="" class="quote-label"> {{ 'gis.quotation.product'
                      | translate }}</label>
                    <p-dropdown [options]="ProductDescriptionArray" formControlName="productCodes"
                      optionLabel="filterText" filterBy="filterText" [filter]="true" [showClear]="true" placeholder=""
                      class="custom-multiselect" (onChange)="onProductSelected($event.value)">


                      <ng-template let-product pTemplate="item">
                        <div>{{ product?.description }}</div>
                      </ng-template>


                      <ng-template let-product pTemplate="selectedItem">
                        <div>{{ product?.description }}</div>
                      </ng-template>

                      <ng-template pTemplate="empty">
                        <div class="text-danger px-2 py-1">

                          {{ 'gis.quotation.no_products_match_your_search'| translate }}
                        </div>
                      </ng-template>
                    </p-dropdown>

                    <div
                      *ngIf="quotationProductForm.get('productCodes')?.hasError('required') && quotationProductForm.get('productCodes')?.touched"
                      class="form-text text-danger">
                      {{ 'gis.quotation.product_is_required'| translate }}
                    </div>

                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverFromDate" class="quote-label">{{ 'gis.quotation.cover_from'|
                      translate }}</label><br>
                    <p-calendar formControlName="wef" name="wefDate" id="coverFromDate" inputId="coverFromDate"
                      [dateFormat]="dateFormat" inputStyleClass='form-control' (onSelect)="updateCoverToDate($event)"
                      [minDate]="minDate" [showIcon]="true">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wef').hasError('required') && quotationProductForm.get('wef').touched"
                      class="form-text text-danger">

                      {{ 'gis.quotation.cover_from_is_required'| translate }}
                    </div>
                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverToDate" class="quote-label"> {{ 'gis.quotation.cover_to'| translate
                      }}</label><br>
                    <p-calendar formControlName="wet" name="wetDate" id="coverToDate" inputId="coverToDate"
                      [dateFormat]="dateFormat" inputStyleClass='form-control' [minDate]="minDate" [showIcon]="true">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wet').hasError('required') && quotationProductForm.get('wet').touched"
                      class="form-text text-danger">

                      {{ 'gis.quotation.cover_to_is_required'| translate }}
                    </div>
                  </div>
                </div>

                <div class="mt-4 d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-secondary btn-lightblue" data-bs-dismiss="modal"
                    id="cancelDetails">
                    {{ 'gis.quotation.cancel' | translate }}
                  </button>
                  <button type="button" class="btn btn-primary" id="saveDetails" (click)="submitAddProductForm();">
                    {{ 'gis.quotation.save_details' | translate }}
                  </button>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- edit product modal -->
      <div class="modal fade" id="editProduct" tabindex="-1" role="dialog" aria-labelledby="addSectionLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm " style="min-width: 518px;" role="document">
          <div class="modal-content" id="addSectionModal">
            <div class="modal-body">
              <h5 class="modal-title mt-2" id="editOtherDetailsLabel"> {{ 'gis.quotation.edit_product'
                | translate }}
                <button type="button" class="btn-close float-end custom-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </h5>
              <div class="row mb-4" [formGroup]='quotationProductForm'>
                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="" class="quote-label"> {{ 'gis.quotation.product'
                      | translate }}</label>
                    <p-dropdown [options]="ProductDescriptionArray" formControlName="productCodes"
                      optionLabel="filterText" filterBy="filterText" [filter]="true" [showClear]="true" placeholder=""
                      class="custom-multiselect" (onChange)="onProductSelected($event.value)">


                      <ng-template let-product pTemplate="item">
                        <div>{{ product?.description }}</div>
                      </ng-template>


                      <ng-template let-product pTemplate="selectedItem">
                        <div>{{ product?.description }}</div>
                      </ng-template>

                      <ng-template pTemplate="empty">
                        <div class="text-danger px-2 py-1">

                          {{ 'gis.quotation.no_products_match_your_search'| translate }}
                        </div>
                      </ng-template>
                    </p-dropdown>

                    <div
                      *ngIf="quotationProductForm.get('productCodes')?.hasError('required') && quotationProductForm.get('productCodes')?.touched"
                      class="form-text text-danger">
                      {{ 'gis.quotation.product_is_required'| translate }}
                    </div>

                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverFromDate" class="quote-label">{{ 'gis.quotation.cover_from'|
                      translate }}</label><br>
                    <p-calendar formControlName="wef" name="wefDate" id="coverFromDate" inputId="coverFromDate"
                      [dateFormat]="dateFormat" inputStyleClass='form-control' (onSelect)="updateCoverToDate($event)"
                      [minDate]="minDate" [showIcon]="true">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wef').hasError('required') && quotationProductForm.get('wef').touched"
                      class="form-text text-danger">

                      {{ 'gis.quotation.cover_from_is_required'| translate }}
                    </div>
                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverToDate" class="quote-label"> {{ 'gis.quotation.cover_to'| translate
                      }}</label><br>
                    <p-calendar formControlName="wet" name="wetDate" id="coverToDate" inputId="coverToDate"
                      [dateFormat]="dateFormat" inputStyleClass='form-control' [minDate]="minDate" [showIcon]="true">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wet').hasError('required') && quotationProductForm.get('wet').touched"
                      class="form-text text-danger">

                      {{ 'gis.quotation.cover_to_is_required'| translate }}
                    </div>
                  </div>
                </div>

                <div class="mt-4 d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-secondary btn-lightblue" data-bs-dismiss="modal"
                    id="cancelDetails">
                    {{ 'gis.quotation.cancel' | translate }}
                  </button>
                  <button type="button" class="btn btn-primary" id="saveDetails" (click)="editProduct()">
                    {{ 'gis.quotation.save_details' | translate }}
                  </button>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Delete Product Modal -->
      <div class="modal fade" id="deleteProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
          <div class="modal-content ps-4 pt-2 pe-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-1">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                {{ 'gis.quotation.delete_product' | translate }}
              </p>
              <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div class="d-flex justify-content-between text-black">
              <p>
                {{ 'gis.quotation.are_you_sure_you_want_to_delete_product' | translate }}?
              </p>
            </div>

            <div class="d-flex justify-content-center mb-3">
              <button type="button" class="btn btn-primary px-5" id="delete" data-bs-dismiss="modal"
                (click)="deleteProduct()">
                {{'gis.policy.yes_delete'| translate}}
              </button>
            </div>
            <div class="d-flex justify-content-center mb-2">
              <button type="button" class="btn btn-outline-primary px-5" data-bs-dismiss="modal">{{
                'gis.policy.no_im_not' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reassign Product Modal 1 -->
      <div class="modal fade " id="reassignProductModal" #reassignProductModal tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
          <div class="modal-content ps-4 pt-2 pb-5 pe-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                {{'gis.quotation.reassign_task'| translate}}
              </p>
              <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div *ngIf="departmentSelected" class="w-75 mb-2 mt-2">
              <p class="quote-label"> {{ 'gis.quotation.group_user'
                | translate }}</p>
              <!-- <p-dropdown [options]="clientOptions" [(ngModel)]="clientToReassignQuotation" [showClear]="true"
                styleClass="w-full">
              </p-dropdown> -->
              <input pInputText type="select" class="form-control form-control-sm" id="quote-input"
                [(ngModel)]="clientToReassignProduct">
            </div>

            <div class="w-75 mb-2 mt-2">
              <p class="quote-label">{{ clientToReassignProduct ? 'Default User' : 'User' }}</p>


              <div *ngIf="!departmentSelected"
                class="form-control form-control-sm d-flex align-items-center justify-content-between" id="quote-input"
                style="cursor: pointer;" (click)="openChooseClientReassignModal()">
                <span cl>{{ clientToReassignProduct}}</span>
                <i class="pi pi-chevron-down me-2" style="color: #00529B;font-size: 14px;"></i>
              </div>

              <p-dropdown *ngIf="departmentSelected" [options]="groupUsers" optionLabel="userDetails.name"
                optionValue="id" [(ngModel)]="selectedGroupUserId" placeholder="" class=" form-control-sm ">
              </p-dropdown>



            </div>

            <div class="w-75 mb-3">
              <p>{{'gis.quotation.comments'| translate}}</p>
              <textarea name="reassignProduct" class="form-control" style="height: 70px"
                [(ngModel)]="reassignProductComment"></textarea>
            </div>

            <small class="text-danger block" [class.invisible]="!noCommentleft">

              {{'gis.policy.please_leave_a_comment_before_reassigning'| translate}}
            </small>

            <small class="text-danger block" [class.invisible]="!noUserChosen">

              {{'gis.policy.please_select_a_user_to_reassign_before_continuing'| translate}}
            </small>

            <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="reassignProduct()">{{
                'gis.quotation.reassign' | translate }}
              </button>
              <button type="button" (click)="closeReassignProductModal()" class="btn btn-outline-primary"
                style="text-decoration: none;">{{'gis.quotation.cancel' | translate}}
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Reassign Product Modal 2 -->
      <div class="modal fade " id="chooseClientReassingModal" #chooseClientReassignModal tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
          <div class="modal-content ps-4 pt-2 pb-5 pe-4">

            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                {{'gis.quotation.reassign_task'| translate}}
              </p>
              <button type="button" (click)="closeChooseClientReassignModal()" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div class="row mt-2">
              <p-table #reassignTable [value]="users" [rows]="3" [paginator]="true"
                [rowsPerPageOptions]="[5, 10, 20, 50]" [globalFilterFields]="['id', 'name']" selectionMode="single"
                [(selection)]="selectedUser" styleClass="p-datatable-striped" (onRowSelect)="onUserSelect()"
                (onRowUnselect)="onUserUnselect()">
                <ng-template pTemplate="header">
                  <tr>
                    <th> {{'gis.quotation.user_id'| translate}}</th>
                    <th> {{'gis.quotation.full_name'| translate}}</th>
                  </tr>
                  <tr styleClass="p-striped">
                    <th>
                      <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)">
                    </th>
                    <th>
                      <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)">
                    </th>
                  </tr>

                </ng-template>
                <ng-template pTemplate="body" let-user>
                  <tr [pSelectableRow]="user">
                    <td>{{ user.id }}</td>
                    <td>{{ user.name }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            <small class="text-danger block" [class.invisible]="!noUserChosen">
              {{'gis.policy.please_select_a_person_to_reassign_before_continuing'| translate}}
            </small>

            <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="selectClient()">{{
                'gis.quotation.save' | translate }}
              </button>
              <button type="button" (click)="closeChooseClientReassignModal()" class="btn btn-outline-primary"
                style="text-decoration: none;">{{
                'gis.quotation.cancel' | translate
                }}
              </button>
            </div>

          </div>
        </div>
      </div>

      <div class="row mb-4" [formGroup]='quotationForm'>
      </div>


    </div>
  </div>

  <!-- Clauses section -->
  <div class="card mb-3" *ngIf="productDetails && productDetails.length > 0">
    <div class="card-body my-4 mx-4 ">

      <div class="row mb-3">
        <div class="col-4">
          <h6 style="color: #00529B; font-size: 20px; font-weight: 500; font-family: Roboto; margin-bottom: 0;">
            {{'gis.quotation.product_clauses' | translate}}</h6>
        </div>

        <div class="col-8 d-flex justify-content-end">
          <button type="button" id="icon" class="btn btn-primary" data-bs-toggle="collapse"
            data-bs-target="#productClauses" aria-expanded="false" (click)="toggleProductClausesopen()">
            <i class="fa-solid fa-chevron-down"></i>
          </button>
        </div>
      </div>

      <div *ngIf="isProductClauseOpen">
        <div class="col-12 d-flex justify-content-end mb-1 me-5">

          <div class="col-12 d-flex justify-content-end mb-1 me-3">
            <div class="d-flex justify-content-center align-items-center">
              <button type="button" class="btn btn-primary btn-sm no-hover" (click)="openClauseModal()"
                title="Add Product clause">

                {{'gis.quotation.add_clauses' | translate}}
              </button>
              <i #iconTrigger class="pi border border-black p-1 rounded-1 text-black"
                [ngClass]="{ 'pi-caret-up': showClauses, 'pi-caret-down': !showClauses }"
                style="font-size: 15px; cursor: pointer; margin-left: 8px; padding: 4px 6px;"
                (click)="toggleProductClauseColumns(iconTrigger)">
              </i>
            </div>
          </div>

        </div>

        <!-- clauses table -->
        <div class="position-relative">

          <!-- Floating Column Selector -->
          <div *ngIf="showProductClauseColumnModal" class="card shadow rounded p-2 position-absolute bg-white border"
            [ngStyle]="{ top: columnModalPosition.top, left: columnModalPosition.left, zIndex: 1000 }"
            (mousedown)="onDragStart($event)" (document:mousemove)="onDragMove($event)"
            (document:mouseup)="onDragEnd()">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong class="text-primary">
                {{ 'gis.quotation.select_columns' | translate }}
              </strong>
              <button class="btn-close btn-sm" (click)="showProductClauseColumnModal = false"></button>
            </div>

            <div style="max-height: 250px; overflow-y: auto;">
              <div *ngFor="let col of productClauseColumns">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" [(ngModel)]="col.visible"
                    (change)="toggleProductClauseColumnVisibility(col.field)" [id]="col.field">
                  <label class="form-check-label" [for]="col.field">
                    {{ col.header }}
                  </label>
                </div>
              </div>
            </div>
          </div>


          <div class="collapse mb-4" [ngClass]="{'show': showClauses}" id="collapseProductClauses">
            <!-- clause table -->
            <p-table #productClauseTable [value]="sessionClauses " [paginator]="sessionClauses?.length > 5"
              [rowsPerPageOptions]="[5, 10, 20]" [rows]="5" [scrollable]="true" scrollHeight="500px"
              [tableStyle]="{'min-width': '50rem'}" [paginatorPosition]="'bottom'" [paginatorDropdownAppendTo]="'body'">

              <!-- Table Header -->
              <ng-template pTemplate="header">
                <tr>
                  <th *ngFor="let col of productClauseColumns" [hidden]="!col.visible" class="flexible-header1"
                    [ngClass]="{'actions-column': col.field === 'actions'}" [pSortableColumn]="col.field">
                    {{ col.header }}
                    <p-sortIcon [field]="col.field"></p-sortIcon>
                  </th>
                </tr>

                <tr class="filter-row mt-1">
                  <td *ngFor="let col of productClauseColumns" [hidden]="!col.visible">
                    <input *ngIf="col.filterable !== false" class="form-control form-control-sm" pInputText type="text"
                      (input)="productClauseTable.filter($event.target['value'], col.field, 'contains')" />
                  </td>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-productClause>
                <tr>
                  <td *ngFor="let col of productClauseColumns" [hidden]="!col.visible" class="flexible-header1"
                    [ngClass]="{'actions-column': col.field === 'actions'}">
                    <ng-container [ngSwitch]="col.field">
                      <!-- Default (for future columns added dynamically) -->
                      <ng-container *ngSwitchDefault>
                        {{ productClause[col.field] }}
                      </ng-container>
                      <!-- Wording (with hover card) -->
                      <ng-container *ngSwitchCase="'wording'">
                        <div class="clause-wrapper">
                          {{ productClause.wording | sentenceCase }}
                          <div class="hover-card">
                            {{ productClause.wording | sentenceCase }}
                          </div>
                        </div>
                      </ng-container>

                      <ng-container *ngSwitchCase="'heading'">
                        <div class="clause-wrapper" [title]="productClause.heading | sentenceCase">
                          {{ productClause.heading | sentenceCase }}
                          <div class="hover-card">
                            {{ productClause.heading | sentenceCase }}
                          </div>
                        </div>
                      </ng-container>
                      <!-- Actions -->
                      <ng-container *ngSwitchCase="'actions'">
                        <div class="flex justify-content-center " style="text-align: center;">
                          <!-- Edit -->
                          <span class="p-button-label p-text-bold me-4 " [ngStyle]="{
                            color: '#00529B',
                            cursor: 'pointer'
                            }" [attr.data-bs-toggle]="productClause.isEditable === 'Y' ? 'modal' : null"
                            [attr.data-bs-target]="productClause.isEditable === 'Y' ? '#editClause' : null"
                            (click)="productClause.isEditable === 'Y' && populateEditClauseModal(productClause)">
                            {{ productClause.isEditable === 'Y' ? ('gis.quotation.edit' | translate) : '--' }}
                          </span>
                          <!-- <button type="button"
                            (click)="productClause.isEditable === 'Y' && populateEditClauseModal(productClause)"
                            class="p-button-sm p-button-text p-button-info no-border">
                            {{ 'gis.quotation.edit' | translate }}
                          </button> -->
                          <!-- Delete -->
                          <span *ngIf="productClause.isMandatory === 'N'" class="p-button-label p-text-bold text-center"
                            [ngStyle]="{
                            color: '#00529B',
                            cursor: 'pointer'
                            }" data-bs-toggle="modal" data-bs-target="#deleteClause"
                            (click)="prepareDeleteClause(productClause)">
                            {{ 'gis.quotation.delete' | translate }}
                          </span>
                          <span *ngIf="productClause.isMandatory === 'Y'"
                            class="p-button-label p-text-bold text-center text-muted"
                            pTooltip="You cant delete mandatory clauses.">
                            Delete
                          </span>
                        </div>
                      </ng-container>



                    </ng-container>
                  </td>
                </tr>
              </ng-template>

              <!-- empty/search states -->
              <ng-template pTemplate="emptymessage">
                <tr>
                  <td [attr.colspan]="productClauseColumns.length">
                    <div  class="d-flex align-items-center justify-content-center"
                    style="color: #6c757d; font-size: 15px; text-align:centre;">
                      <ng-container *ngIf="productClause.length === 0">

                        {{'gis.quotation.no_clause_available_click_on_add' | translate}}
                      </ng-container>
                      <ng-container *ngIf="productClause.length > 0">
                        {{'gis.quotation.no_clauses_found_matching_your_search' | translate}}

                      </ng-container>
                    </div>
                  </td>
                </tr>
              </ng-template>
            </p-table>

            <!-- add clause modal -->
            <div class="modal fade" id="addClause" tabindex="-1" aria-labelledby="addClauseLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
                <div class="modal-content ps-4 pt-2 pe-4">
                  <div class="d-flex justify-content-between align-items-center rounded-3 mb-1 p-1">
                    <p class="modal-title" id="addClauseLabel" style="color: #00529B; font-weight:600; font-size:20px;">
                      {{ 'gis.quotation.add_product_cluase' | translate }}
                    </p>
                    <button type="button" class="btn-close custom-close" data-bs-dismiss="modal"
                      aria-label="Close"></button>
                  </div>

                  <div class="row mt-3">
                    <div *ngIf="nonMandatoryProductClause && nonMandatoryProductClause.length === 0"
                      class="text-center p-4">
                      <div style="color: #6c757d; font-size: 16px;">
                        <i class="pi pi-info-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>
                          {{ 'gis.quotation.no_additional_clauses_are_available_to_add' | translate }}
                        </p>
                      </div>
                    </div>

                    <p-table *ngIf="nonMandatoryProductClause && nonMandatoryProductClause.length > 0"
                      #addProductClausesTable [value]="nonMandatoryProductClause" [rows]="5"
                      [paginator]="nonMandatoryProductClause?.length > 10" selectionMode="multiple"
                      [(selection)]="selectedClauses" stripedRows styleClass="p-datatable-striped"
                      [rowsPerPageOptions]="[5, 10, 20]">

                      <ng-template pTemplate="header">
                        <tr>
                          <th class="flexible-header1" style="width: 3%"><p-tableHeaderCheckbox /></th>
                          <th class="flexible-header1" style="width: 30%" pSortableColumn="id">

                            {{ 'gis.quotation.id' | translate }}
                            <p-sortIcon field="code" />
                          </th>
                          <th class="flexible-header1" style="width: 40%" pSortableColumn="heading">

                            {{ 'gis.quotation.description' | translate }}
                            <p-sortIcon field="code" />
                          </th>
                          <th></th>
                        </tr>
                        <tr class="filter-row">
                          <td></td>
                          <td>
                            <input type="text" class="form-control form-control-sm"
                              (input)="filterByAddshortDescription($event)">
                          </td>
                          <td>
                            <input type="text" class="form-control form-control-sm"
                              (input)="filterByAddHeading($event)">
                          </td>
                        </tr>

                      </ng-template>

                      <ng-template pTemplate="body" let-clause let-columns="columns" let-rowIndex="rowIndex">

                        <tr>
                          <td style="max-width: 10px; min-width: 10px;">
                            <p-tableCheckbox [value]="clause" />
                          </td>
                          <td>{{ clause.shortDescription }}</td>
                          <td>{{ clause.heading }}</td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>

                  <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 mb-3 mt-5 p-0">
                    <button type="button" class="btn" data-bs-dismiss="modal" [disabled]="!selectedClauses?.length"
                      style="background-color: #00529B;color:white;text-decoration: none;"
                      (click)="addProductClauses()">
                      {{ 'gis.quotation.save' | translate }}
                    </button>
                    <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
                      style="text-decoration: none;" (click)="closeClauseModal()">
                      {{ 'gis.quotation.cancel' | translate }}
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- edit clause modal -->
            <div class="modal fade" id="editClause">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content p-4">

                  <!-- Header -->
                  <div class="d-flex justify-content-between align-items-center rounded-3 mb-2">
                    <p class="modal-title text-primary fw-semibold fs-5 mb-0">
                      {{ 'gis.quotation.edit_clause' | translate }}
                    </p>
                    <button type="button" data-bs-dismiss="modal"
                      class="btn p-0 text-danger fw-bold border-0">X</button>
                  </div>

                  <!-- ID + Heading -->
                  <div class="row g-3 text-black">
                    <div class="col-md-4 d-flex flex-column">
                      <label for="id">ID</label>
                      <input type="text" class="form-control bg-light" [value]="selectedProductClause.shortDescription"
                        readonly>
                    </div>

                    <div class="col-md-8 d-flex flex-column">
                      <label for="heading">Heading</label>
                      <input class="form-control bg-light text-truncate" [value]="selectedProductClause.heading"
                        pTooltip="{{ selectedProductClause.heading }}" readonly>
                    </div>
                  </div>

                  <!-- Wording -->
                  <div class="mt-4">
                    <label class="text-dark" for="comment">Wording</label>
                    <textarea rows="5" pTextarea [(ngModel)]="selectedProductClause.wording" class="form-control"
                      style="min-height:130px;"></textarea>
                  </div>

                  <!-- Footer buttons -->
                  <div class="d-flex justify-content-end gap-3 mt-4">
                    <button #closeReassignButton type="button" data-bs-dismiss="modal" style="display:none;"></button>



                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">
                      {{ 'gis.quotation.cancel' | translate }}
                    </button>

                    <button type="button" class="btn btn-primary" (click)="editClause()" [disabled]="!wasModified()"
                      data-bs-dismiss="modal">
                      {{ 'gis.quotation.save_changes' | translate }}
                    </button>
                  </div>

                </div>
              </div>
            </div>

            <!-- delete clause modal -->
            <div class="modal fade" id="deleteClause">
              <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
                <div class="modal-content ps-4 pt-2 pe-4">
                  <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-1">
                    <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                      {{ 'gis.quotation.delete_clause' | translate }}</p>
                    <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                      style="border: none;">X
                    </button>
                  </div>

                  <div class="d-flex justify-content-between text-black">
                    <p>
                      {{ 'gis.quotation.are_you_sure_you_want_to_delete_this_clause' | translate }}?
                    </p>

                  </div>

                  <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 mb-3 mt-5 p-0">
                    <button type="button" class="btn" data-bs-dismiss="modal"
                      style="background-color: #00529B;color:white;text-decoration: none;"
                      (click)="deleteProductClause()">
                      {{ 'gis.quotation.delete' | translate }}
                    </button>
                    <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
                      style="text-decoration: none;">{{
                      'gis.quotation.cancel' | translate
                      }}
                    </button>
                  </div>

                </div>
              </div>

            </div>


          </div>
        </div>
      </div>



    </div>
  </div>
  <!-- Introducer Modal -->
  <div id="searchIntroducer" *ngIf="showIntroducerSearchModal" class="modal fade show" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width:700px">
      <div class="modal-content">

        <!-- Modal Body -->
        <div class="modal-body">
          <h5 class="modal-title mt-2 mb-2" id="editOtherDetailsLabel">
            {{ 'gis.quotation.select_introducer' | translate }}
            <button type="button" class="btn-close float-end red-close" aria-label="Close"
              (click)="showIntroducerSearchModal = false"></button>
          </h5>

          <p-table #selectIntroducerTable [value]="introducers" [tableStyle]="{'min-width': '300px'}" [rows]="5"
            [paginator]="true" selectionMode="single" dataKey="code" [rowsPerPageOptions]="[5, 10, 20]"
            [(selection)]="selectedIntroducer">

            <ng-template pTemplate="header">
              <tr>
                <th class="flexible-header1" style="width: 30%" pSortableColumn="id">

                  {{ 'gis.quotation.name' | translate }}
                  <p-sortIcon field="name" />
                </th>
                <th class="flexible-header1" style="width: 40%" pSortableColumn="heading">
                  {{ 'gis.quotation.staff_no' | translate }} <p-sortIcon field="staffNo" />
                </th>
                <th class="flexible-header1" style="width: 40%" pSortableColumn="heading">
                  {{ 'gis.quotation.company' | translate }}<p-sortIcon field="Company" />
                </th>
              </tr>

            </ng-template>

            <ng-template pTemplate="body" let-introducer let-columns="columns" let-rowIndex="rowIndex">
              <ng-container *ngIf="rowIndex === 0">
                <tr>
                  <td>
                    <input type="text" class="form-control form-control-sm" (input)="filterByName($event)">
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm" (input)="filterByStaffNo($event)">
                  </td>
                  <td>
                    <input type="text" class="form-control form-control-sm" (input)="filterByCompany($event)">
                  </td>

                </tr>
              </ng-container>
              <tr [class.p-highlight]="introducer === selectedIntroducer" [pSelectableRow]="introducer" class="point">

                <td>{{ introducer.surName }}</td>
                <td>{{ introducer.staffNo }}</td>
                <td>{{ introducer.groupCompany }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div> <!-- Modal Footer -->
        <div class="mt-4 mb-4 d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-primary" (click)="showIntroducerSearchModal = false"
            id="cancelDetails">
            {{ 'gis.quotation.cancel' | translate }}
          </button>
          <button type="button" class="btn btn-primary" id="saveDetails" (click)="saveIntroducer(selectedIntroducer)">
            {{ 'gis.quotation.save' | translate }}
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Agent Modal -->
  <div id="searchAgent" *ngIf="showAgentSearchModal" class="modal fade show" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width:700px">
      <div class="modal-content">

        <!-- Modal Body -->
        <div class="modal-body">
          <h5 class="modal-title mt-2 mb-2" id="editOtherDetailsLabel">
            Select agent
            <button type="button" class="btn-close float-end red-close" aria-label="Close"
              (click)="showAgentSearchModal = false"></button>
          </h5>

          <p-table #selectAgentTable [value]="agents" [tableStyle]="{'min-width': '300px'}" [rows]="5"
            [paginator]="agents?.length > 10" selectionMode="single" dataKey="id" [rowsPerPageOptions]="[5, 10, 20]"
            [(selection)]="selectedAgent">

            <ng-template pTemplate="header">
              <tr>
                <th class="flexible-header1" style="width: 30%" pSortableColumn="id">

                  Id
                  <p-sortIcon field="id" />
                </th>
                <th class="flexible-header1" style="width: 40%" pSortableColumn="name">
                  Name <p-sortIcon field="name" />
                </th>
                <th class="flexible-header1" style="width: 40%" pSortableColumn="accountType">
                  Intermediary type<p-sortIcon field="accountType" />
                </th>
              </tr>
              <tr class=" filter-row mb-5 mt-5">
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterById($event)">
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByAgentName($event)">
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByIntermediaryType($event)">
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-agent let-rowIndex="rowIndex">

              <tr [class.p-highlight]="agent === selectedAgent" [pSelectableRow]="agent" class="point">

                <td>{{ agent.id }}</td>
                <td>{{ agent.name |sentenceCase }}</td>
                <td>{{ agent.accountType |sentenceCase }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div> <!-- Modal Footer -->
        <div class="mt-4 mb-4 d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-primary" (click)="showAgentSearchModal = false"
            id="cancelDetails">
            {{ 'gis.quotation.cancel' | translate }}
          </button>
          <button type="button" class="btn btn-primary" id="saveDetails" (click)="saveAgent(selectedAgent)">
            {{ 'gis.quotation.save' | translate }}
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Marketer modal -->
  <div id="searchMarketer" *ngIf="showMarketerSearchModal" class="modal fade show" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document" style="width:700px">
      <div class="modal-content">

        <!-- Modal Body -->
        <div class="modal-body">
          <h5 class="modal-title mt-2 mb-2" id="editOtherDetailsLabel">
            Select marketer
            <button type="button" class="btn-close float-end red-close" aria-label="Close"
              (click)="showMarketerSearchModal = false"></button>
          </h5>

          <p-table #selectMarketerTable [value]="marketerList" [tableStyle]="{'min-width': '300px'}" [rows]="5"
            [paginator]="marketerList?.length > 10" selectionMode="single" dataKey="id"
            [rowsPerPageOptions]="[5, 10, 20]" [(selection)]="selectedMarketer">

            <ng-template pTemplate="header">
              <tr>
                <th class="flexible-header1" style="width: 30%" pSortableColumn="id">
                  Code
                  <p-sortIcon field="id" />
                </th>
                <th class="flexible-header1" style="width: 40%" pSortableColumn="name">
                  Name <p-sortIcon field="name" />
                </th>

              </tr>
              <tr class=" filter-row mb-5 mt-5">
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByMarketerId($event)">
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByMarketerName($event)">
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-marketer let-rowIndex="rowIndex">

              <tr [class.p-highlight]="marketer === selectedMarketer" [pSelectableRow]="marketer" class="point">
                <td>{{ marketer.id }}</td>
                <td>{{ marketer.name |sentenceCase }}</td>
              </tr>
            </ng-template>
          </p-table>
        </div> <!-- Modal Footer -->
        <div class="mt-4 mb-4 d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-primary" (click)="showMarketerSearchModal = false"
            id="cancelDetails">
            {{ 'gis.quotation.cancel' | translate }}
          </button>
          <button type="button" class="btn btn-primary" id="saveDetails" (click)="saveMarketer(selectedMarketer)">
            {{ 'gis.quotation.save' | translate }}
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="float-end mb-4">

    <!-- <button *ngIf="!quickQuoteConverted" class="btn btn-primary" (click)="saveQuotationDetails()">
      {{ 'gis.quotation.next' | translate }}
    </button> -->

    <div class="d-inline-block" pTooltip="{{ validationStatus.tooltipMessage }}" tooltipPosition="top"
      [tooltipDisabled]="validationStatus.isValid" style="cursor: pointer">
      <button *ngIf="!quickQuoteConverted" class="btn" [ngClass]="{ 'btn-primary': validationStatus.isValid,
        'btn-secondary': !validationStatus.isValid
        }" [disabled]="!validationStatus.isValid" (click)="saveQuotationDetails()">
        {{ 'gis.quotation.next' | translate }}
      </button>
    </div>

    <!-- <button *ngIf="quickQuoteConverted" class="btn btn-primary" (click)="updateQuickQuoteDetails()">
      {{ 'gis.quotation.next' | translate }}
    </button> -->
    <div class="d-inline-block" pTooltip="{{ validationStatus.tooltipMessage }}" tooltipPosition="top"
      [tooltipDisabled]="validationStatus.isValid">
      <button *ngIf="quickQuoteConverted" class="btn" [ngClass]="{'btn-primary': validationStatus.isValid,
        'btn-secondary': !validationStatus.isValid
        }" [disabled]="!validationStatus.isValid" (click)="updateQuickQuoteDetails()">
        {{ 'gis.quotation.next' | translate }}
      </button>
    </div>

  </div>
</div>