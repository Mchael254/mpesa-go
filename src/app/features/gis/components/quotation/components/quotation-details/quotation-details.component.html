<div class="mx-4 mt-3">
  <p class="title">Quotations:Quotation Details </p>
  <app-stepper [currentStep]="2" [stepperData]="steps"></app-stepper>


  <div class="card mb-4">
    <div class="card-body">
      <h6>Quotation details </h6>
      <p *ngIf="quickQuotationDetails">Quotation number :<strong> {{ quotationNumber }}</strong></p>
      <div class="row mb-4" [formGroup]='quotationForm'>
        <div class="col-sm-4 col-6">
          <div class="form-group form-group-sm">
            <br>
            <label for="source" class="quote-label">Source<span class="required"></span></label>
            <p-dropdown id="source" formControlName="source" [options]="quotationSources"
                        optionLabel="description" placeholder=" " [filterBy]="'description'" [filter]="true"
                        (onChange)="onSourceChange($event)"></p-dropdown>
            <div *ngIf="quotationForm.get('source').hasError('required') && quotationForm.get('source').touched"
                 class="form-text text-danger">
              Source is required.
            </div>
          </div>
        </div>
        <div class="col-sm-4 col-6">
          <div class="form-group form-group-sm">
            <br>
            <label for="quotationType" class="quote-label">Quotation type</label>
            <p-dropdown id="quotationType" [options]="quotationType" optionLabel="label"
                        optionValue="value"
                        placeholder=" "
                        [filterBy]="'label'"
                        [filter]="true">
            </p-dropdown>
          </div>
        </div>
        <div class="col-sm-4 col-6" *ngIf="showIntermediaryField">
          <div class="form-group form-group-sm">
            <br>
            <label for="agent" class="quote-label">Intermediary<span class="required"></span></label>
            <input type="text" id="agent" class="form-control form-control-sm mb-1"
                   formControlName="agent" data-bs-toggle="modal" data-bs-target="#selectIntermediary"
                   autocomplete="off" [value]="agentName">
            <div *ngIf="quotationForm.get('agent').hasError('required') && quotationForm.get('agent').touched"
                 class="form-text text-danger">
              Intermediary is required.
            </div>
          </div>
        </div>
        <div class="col-sm-4 col-6">
          <div class="form-group form-group-sm">
            <br>
            <label for="branch" class="quote-label">Branch<span class="required"></span></label>
            <p-dropdown id="branch" formControlName="branch" [options]="branch"
                        optionLabel="name" placeholder=" " value="id" [filterBy]="'name'"
                        [filter]="true"></p-dropdown>
            <div *ngIf="quotationForm.get('branch').hasError('required') && quotationForm.get('branch').touched"
                 class="form-text text-danger">
              Branch is required.
            </div>
          </div>
        </div>

        <div class="col-sm-4 col-6">
          <div class="form-group form-group-sm">
            <br>
            <label for="currencyCode" class="quote-label">Currency<span class="required"></span></label><br>
            <p-dropdown id="currencyCode" formControlName="currencyCode" [options]="currency"
                        optionLabel="name" value="id" [filterBy]="'name'" [filter]="true"
                        (onChange)="fetchUserOrgId()"></p-dropdown>
            <div
              *ngIf="quotationForm.get('currencyCode').hasError('required') && quotationForm.get('currencyCode').touched"
              class="form-text text-danger">
              Currency is required.
            </div>
          </div>
        </div>
        <div class="col-sm-4 col-6">
          <div class="form-group form-group-sm">
            <br>
            <label for="rfqDate" class="quote-label">Request for quote date</label>
            <p-calendar id="rfqDate" inputId="rfqDate" [dateFormat]="dateFormat"
                        formControlName="RFQDate" [minDate]="minDate"
                        (onSelect)="updateQuotationExpiryDate($event)">
            </p-calendar>
            <div *ngIf="quotationForm.get('RFQDate').hasError('required') && quotationForm.get('RFQDate').touched"
                 class="form-text text-danger">
              Request for quote date is required.
            </div>
          </div>
        </div>
        <div class="col-sm-4 col-6">
          <div class="form-group form-group-sm">
            <br>
            <label for="expiryDate" class="quote-label">Quotation expiry date</label>
            <p-calendar id="expiryDate" inputId="expiryDate" [dateFormat]="dateFormat"
                        formControlName="expiryDate" [minDate]="minDate">
            </p-calendar>
            <div *ngIf="quotationForm.get('expiryDate').hasError('required') && quotationForm.get('expiryDate').touched"
                 class="form-text text-danger">
              Quotation expiry date is required.
            </div>
          </div>
        </div>
        <ng-container *ngIf="show" class="row mb-4 collapse" id="collapseExample">
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="introducerCode" class="quote-label">Introducer</label>
              <p-dropdown id="introducerCode" formControlName="introducerCode" [options]="introducers"
                          optionValue="code" optionLabel="surName" [filterBy]="'surName'"
                          [filter]="true">
              </p-dropdown>
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="fromCampaign" class="quote-label">Results from campaign</label>
              <p-dropdown id="fromCampaign" formControlName="fromCampaign" [options]="fromCampaign"
                          optionValue="value" optionLabel="label" [filterBy]="'label'"
                          [filter]="true"></p-dropdown>
            </div>
          </div>
          <div class="col-sm-4 col-6" *ngIf="showCampaignField">
            <div class="form-group form-group-sm">
              <br>
              <label for="campaignName" class="quote-label">Campaign</label>
              <p-dropdown id="campaignName" [options]="campaignList" optionLabel="campaignName"
                          placeholder=" " [filterBy]="'campaignName'" [filter]="true"></p-dropdown>
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="multiUser" class="quote-label">Multi-user entry</label>
              <br>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="multiUser" formControlName="multiUser"
                       id="multiUser" value="Y">
                <label class="form-check-label" for="multiUser">Yes</label>
              </div>
              <div class="form-check form-check-inline ms-4">
                <input class="form-check-input" type="radio" name="multiUser" formControlName="multiUser"
                       id="multiUser" value="N">
                <label class="form-check-label" for="multiUser">No</label>
              </div>
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="internalComments" class="quote-label">Internal comments </label>
              <input type="text" id="internalComments" class="form-control form-control-sm mb-1"
                     formControlName="internalComments">
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="comments" class="quote-label">External comments </label>
              <input type="text" id="comments" class="form-control form-control-sm mb-1"
                     formControlName="comments">
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="paymentFrequencies" class="quote-label">Payment Frequencies</label><br>
              <p-dropdown formControlName="frequencyOfPayment" id="paymentFrequencies"
                          [options]="paymentFrequencies" optionLabel="label"
                          [filterBy]="'label'" [filter]="true">
              </p-dropdown>

            </div>
          </div>
        </ng-container>
      </div>

      <p class="more " (click)="toggleDetails()" style="cursor: pointer">
        More Details
        <span class="ml-1">
                    <i class="pi" [ngClass]="{'pi-angle-double-up': show, 'pi-angle-double-down': !show}"
                       style="font-size: 13px"></i>
                </span>
      </p>
    </div>
  </div>

  <div class="card mb-2">
    <div class="card-body">
      <div class="row mb-3">
        <div class="col-4">
          <h6> {{ 'gis.quotation.product_details' | translate }}</h6>
        </div>
        <div class="col-8 d-flex justify-content-end">
          <div class="row">
            <div class="col-3">

            </div>
            <div class="col-4">
              <button type="button" id="icon" class="btn btn-primary" data-bs-toggle="modal"
                      data-bs-target="#addProduct" title="Edit">
                <i class="fa-solid fa-plus"></i>
              </button>

            </div>
            <div class="col-4">

              <button type="button" id="icon" class="btn btn-danger me-2" title="Delete"
                      id="openProductButtonDelete" [hidden]="true" data-bs-toggle="modal"
                      data-bs-target="#deleteProduct">
                <i class="fa-solid fa-trash-can"></i>
              </button>
              <button type="button" id="icon" class="btn btn-primary" title="Delete">
                <i class="fa-solid fa-trash-can" (click)="openProductDeleteModal()"></i>
              </button>
            </div>
            <div class="col-1"></div>
          </div>
        </div>
      </div>

      <p-table [value]="productDetails" dataKey="productCode.code" editMode="row" [tableStyle]="{'min-width': '50rem'}">
        <ng-template pTemplate="header">
          <tr>
            <th class="flexible-header">Product</th>
            <th class="flexible-header">Cover from</th>
            <th class="flexible-header">Cover to</th>
            <th class="flexible-header"></th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex">
          <tr [pEditableRow]="product"
              [pEditableRowDisabled]="selectedEditRowIndex !== ri"
              [class.p-highlight]="product === selectedRow"
              (click)="onRowSelect(product)">

            <!-- Product Dropdown Column -->
            <td class="flexible-header">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <div class="form-group form-group-sm">
                    <p-dropdown
                      [options]="ProductDescriptionArray"
                      appendTo="body"
                      [(ngModel)]="product.productCode"
                      optionLabel="description"
                      [style]="{'width':'100%'}"
                      (onChange)="onProductChange($event.value, ri, product)">
                    </p-dropdown>
                  </div>

                </ng-template>
                <ng-template pTemplate="output">
                  {{ product.productCode?.description }}
                </ng-template>
              </p-cellEditor>
            </td>

            <!-- Cover From Date -->
            <td class="flexible-header">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-calendar
                    [(ngModel)]="product.coverFrom"
                    appendTo="body"
                    [dateFormat]="dateFormat"
                    [style]="{'width':'100%'}"
                    (ngModelChange)="updateCoverTo(product)">
                  </p-calendar>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ product.coverFrom | date: dateFormat }}
                </ng-template>
              </p-cellEditor>
            </td>

            <!-- Cover To Date -->
            <td class="flexible-header">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <p-calendar
                    [(ngModel)]="product.coverTo"
                    appendTo="body"
                    [dateFormat]="dateFormat"
                    [style]="{'width':'100%'}">
                  </p-calendar>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ product.coverTo | date: dateFormat }}
                </ng-template>
              </p-cellEditor>
            </td>

            <!-- Action Buttons -->
            <td class="flexible-header">
              <div class="flex items-center justify-center gap-2">
                <button
                  *ngIf="!editing"
                  pButton
                  pRipple
                  type="button"
                  pInitEditableRow
                  icon="pi pi-pencil"
                  (click)="onRowEditInits(product)"
                  text
                  rounded
                  severity="secondary">
                </button>

                <button
                  *ngIf="editing"
                  pButton
                  pRipple
                  type="button"
                  pSaveEditableRow
                  icon="pi pi-check"
                  (click)="onRowEditSaves(product)"
                  text
                  rounded
                  severity="secondary">
                </button>

                <button
                  *ngIf="editing"
                  pButton
                  pRipple
                  type="button"
                  pCancelEditableRow
                  icon="pi pi-times"
                  (click)="onRowEditCancels(product, ri)"
                  text
                  rounded
                  severity="secondary">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="4" style="text-align:center; padding: 20px;">
              {{ 'gis.quotation.no_data_to_display' | translate }}
            </td>
          </tr>
        </ng-template>
      </p-table>


      <!-- Add Product Details  Modal -->
      <div class="modal fade" id="addProduct" tabindex="-1" role="dialog" aria-labelledby="addSectionLabel"
           aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm " style="min-width: 518px;" role="document">
          <div class="modal-content" id="addSectionModal">
            <div class="modal-body">
              <h5 class="modal-title mt-2" id="editOtherDetailsLabel">{{
                  'gis.quotation.product_details' |
                    translate
                }}
                <button type="button" class="btn-close float-end" data-bs-dismiss="modal"
                        aria-label="Close"></button>
              </h5>

              <div class="row mb-4" [formGroup]='quotationProductForm'>
                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="" class="quote-label">Product</label>
                    <p-dropdown id="quote-input-pdropdown" formControlName="productCode"
                                value="code" [options]="ProductDescriptionArray" optionLabel="description"
                                [filterBy]="'description'"
                                (onChange)="getProductClause(); checkMotorClass()" placeholder=" "
                                [filter]="true"></p-dropdown>

                    <div
                      *ngIf="quotationProductForm.get('productCode').hasError('required') && quotationProductForm.get('productCode').touched"
                      class="form-text text-danger">
                      Product is required.
                    </div>
                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverFromDate" class="quote-label">Cover From</label><br>

                    <p-calendar formControlName="wef" name="wefDate" id="coverFromDate"
                                inputId="coverFromDate" [dateFormat]="dateFormat"
                                inputStyleClass='form-control'
                                (onSelect)="updateCoverToDate($event)" [minDate]="minDate">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wef').hasError('required') && quotationProductForm.get('wef').touched"
                      class="form-text text-danger">
                      Cover From is required.
                    </div>
                  </div>
                </div>
                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverToDate" class="quote-label">Cover to</label><br>
                    <p-calendar formControlName="wet" name="wetDate" id="coverToDate"
                                inputId="coverToDate" [dateFormat]="dateFormat"
                                inputStyleClass='form-control' [minDate]="minDate">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wet').hasError('required') && quotationProductForm.get('wet').touched"
                      class="form-text text-danger">
                      Cover to is required.
                    </div>
                  </div>
                </div>

              </div>

              <div class="mt-4 d-flex justify-content-end">
                <button type="button" class="btn btn-primary " id="saveDetails" data-bs-dismiss="modal"
                        (click)="submitForm()">{{ 'gis.quotation.save_details' | translate }}
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>
      <!-- Delete Product Modal -->

      <div class="modal fade" id="deleteProduct" tabindex="-1" role="dialog"
           aria-labelledby="deleteProduct" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content" id="deleteProduct">
            <div class="modal-body ">
              <p class="deleteMessage mt-4 mb-4">{{
                  'gis.policy.are_you_sure_you_want_to_delete' |
                    translate
                }}</p>
              <div class="d-flex justify-content-center mb-3">
                <button type="button" class="btn btn-primary px-5" id="delete"
                        data-bs-dismiss="modal" (click)="deleteProduct()">{{
                    'gis.policy.yes_delete'
                      | translate
                  }}
                </button>
              </div>
              <div class="d-flex justify-content-center mb-2">
                <button type="button" class="btn btn-outline-primary px-5"
                        data-bs-dismiss="modal">{{ 'gis.policy.no_im_not' | translate }}
                </button>
              </div>


            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4" [formGroup]='quotationForm'>
      </div>

      <p class="more" (click)="toggleProduct()" style="cursor: pointer">
        Product Clauses
        <span class="ml-1">
                    <i class="pi" [ngClass]="{'pi-angle-double-up': showProduct, 'pi-angle-double-down': !showProduct}"
                       style="font-size: 13px"></i>
                </span>
      </p>
      <div class="collapse" [ngClass]="{'show': showProduct}" id="collapseProductClauses">

        <p-table [value]="clauses" dataKey="code" editMode="row" [tableStyle]="{'min-width': '50rem'}"
                 styleClass="p-datatable-sm" responsiveLayout="scroll" [(selection)]="selectedClause"
                 class='ui-datatable' selectionMode="multiple" [autoLayout]="true" [paginator]="true" [rows]="5"
                 [showCurrentPageReport]="true"
                 currentPageReportTemplate="{first} to {last} of {totalRecords} entries">
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 5%;padding-right: 50px;">
                select
              </th>
              <th style="width: 25%;padding-right: 50px;">Heading</th>
              <th style="width: 40%;">Wording</th>
              <th style="width: 5%;"></th>
              <th style="width: 5%;">Editable</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-selectedClauseList let-editing="editing" let-ri="rowIndex">
            <tr [pEditableRow]="selectedClauseList">
              <td>
                <p-checkbox [(ngModel)]="selectedClauseList.checked" [binary]="true"
                            [disabled]="selectedClauseList.isMandatory === 'Y'"
                            (onChange)="onClauseSelectionChange(selectedClauseList)">
                </p-checkbox>
              </td>

              <td style=" white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    overflow-y: auto;
                    max-width: 250px;" pTooltip="{{selectedClauseList.heading }}" tooltipPosition="top">
                <p-cellEditor>
                  <ng-template pTemplate="input" *ngIf="selectedClauseList.isEditable  === 'Y'">
                    <input pInputText type="text" [(ngModel)]="selectedClauseList.heading"
                           class="form-control form-control-sm" [ngModelOptions]="{standalone: true}">
                  </ng-template>
                  <ng-template pTemplate="output">
                    {{ selectedClauseList.heading }}
                  </ng-template>
                </p-cellEditor>
              </td>
              <td
                style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width:300px; overflow-y: auto;">
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <input pInputText type="text" [(ngModel)]="selectedClauseList.wording"
                           class="form-control form-control-sm" [ngModelOptions]="{standalone: true}">
                  </ng-template>
                  <ng-template pTemplate="output">
                    {{ selectedClauseList.wording }}
                  </ng-template>
                  <!-- Helper icon added next to the wording column -->
                </p-cellEditor>
              </td>
              <td>
                <button pButton pRipple type="button" (click)="openHelperModal(selectedClauseList)"
                        icon="pi pi-info-circle" class="p-button-rounded p-button-text"></button>
              </td>
              <td *ngIf="selectedClauseList.isEditable  !== 'Y'" style="padding-left: 24px;"> --</td>
              <td *ngIf="selectedClauseList.isEditable  === 'Y'">
                <div class="flex align-items-center justify-content-center gap-2">
                  <button *ngIf="!editing" pButton pRipple type="button" pInitEditableRow
                          icon="pi pi-pencil" class="p-button-rounded p-button-text"></button>
                  <button *ngIf="editing" pButton pRipple type="button" pSaveEditableRow
                          icon="pi pi-check"
                          class="p-button-rounded p-button-text p-button-success mr-2"></button>
                  <button *ngIf="editing" pButton pRipple type="button" pCancelEditableRow
                          icon="pi pi-times"
                          class="p-button-rounded p-button-text p-button-danger"></button>
                </div>
              </td>
            </tr>
            <!-- Modal for each row -->
            <p-dialog [(visible)]="selectedClauseList.showHelperModal" [modal]="false"
                      [style]="{ 'width': '700px'}">
              <ng-container *ngIf="selectedClauseList">
                <div pResizable [ngStyle]="{'min-width.px': 200, 'min-height.px': 150}"
                     (onResize)="onResize($event)">
                  <p>{{ selectedClauseList.wording }}</p>
                </div>
              </ng-container>
            </p-dialog>
          </ng-template>
        </p-table>
      </div>

    </div>
  </div>


  <div class="float-end mb-4">
    <button class="btn btn-primary" #openModal data-bs-toggle="modal" data-bs-target="#exampleModal"
            hidden></button>

    <button class="btn btn-primary" (click)="getExistingQuotations()">Next</button>
  </div>
  <!--INTERMEDIARY MODAL -->
  <div class="modal fade" id="selectIntermediary" tabindex="-1" aria-labelledby="selectIntermediaryLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-body">
          <div class="float-start"></div>
          <button type="button" class="btn-close float-end" data-bs-dismiss="modal"
                  aria-label="Close"></button>
          <h5 class="text-start mt-2 mb-4">Select intermediary</h5>
          <div class="input-group mb-4" id="search-input">

                        <span class="input-group-append" style="background-color: #F5F6F8;">
                            <button class="btn border-end-0 " type="button">
                                <i class="fa fa-search"></i>
                            </button>
                        </span>
            <!-- <input class="form-control py-2 border-start-0" pInputText  (input)="applyFilterGlobal($event, 'contains')"  style="background-color: #F5F6F8;border: 0px;" type="search" placeholder="search...">             -->
          </div>


          <p-table #dt1 [value]="agents" [tableStyle]="{ 'max-width': '100rem' }" [resizableColumns]="true"
                   styleClass="p-datatable-sm" class='ui-datatable'
                   [globalFilterFields]="['shortDesc', 'name', 'accountType']" [paginator]="true" [rows]="5"
                   [showCurrentPageReport]="true"
                   currentPageReportTemplate="{first} to {last} of {totalRecords} entries" selectionMode="single"
                   [(selection)]="selectedAgent" dataKey="shortDesc">
            <ng-template pTemplate="header">
              <tr>
                <th field="shortDesc">Code</th>
                <th field="name">Name</th>
                <th field="accountType">Intermediary type</th>

              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-data>
              <tr [pSelectableRow]="data" style="cursor:pointer" (click)="getAgentById(data)">
                <td>{{ data.shortDesc }}</td>
                <td>{{ data.name | sentenceCase }}</td>
                <td>{{ data.accountType | sentenceCase }}</td>
              </tr>
            </ng-template>
          </p-table>

          <div class="float-start"></div>
          <button class="btn btn-primary float-end mt-4" data-bs-dismiss="modal">OK</button>
        </div>

      </div>
    </div>
  </div>


  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="min-width:700px">
        <div class="modal-body">
          <p class="title1 mb-4">Client's already existing quotations</p>
          <p-table [value]="clientExistingQuotations" [resizableColumns]="true" styleClass="p-datatable-sm"
                   styleClass="p-datatable-striped" class='ui-datatable' [tableStyle]="{ 'min-width': '50rem' }"
                   [scrollable]="true" scrollHeight="400px">
            <ng-template pTemplate="header">
              <tr>
                <th>Quotation number</th>
                <th>Status</th>
                <th>Cover from</th>
                <th>Cover to</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-data>
              <tr>
                <td>{{ data.quotationNo }}</td>
                <td>{{ data.status }}</td>
                <td>{{ data.coverFrom }}</td>
                <td>{{ data.coverTo }}</td>
              </tr>
            </ng-template>
          </p-table>

          <p class="title1 mt-4 float-start">Do you wish to continue creating the quotation?</p>
          <div class="mt-3 float-end">
            <button class="btn btn-outline-primary" data-bs-dismiss="modal">No,I don't</button>
            <button class="btn btn-primary" style="margin-left: 10px;" data-bs-dismiss="modal"
                    (click)="saveQuotationDetails()">Yes, continue
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
