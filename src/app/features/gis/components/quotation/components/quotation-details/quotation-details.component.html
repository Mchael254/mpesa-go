<div class="mx-4 mt-3">
  <p class="title">Quotations:Quotation Details </p>
  <app-stepper [currentStep]="1" [stepperData]="steps"></app-stepper>

  <!-- quotation section -->
  <div class="card mb-4">
    <div class="card-body  my-4 mx-4 ">
      <h6 class="subheading mt-2 mb-3">Quotation details </h6>
      <p *ngIf="quickQuotationDetails">Quotation number :<strong> {{ quotationNumber }}</strong></p>
      <div class="d-flex gap-4 mb-3">
        <div class="method-option" (click)="setClientType('new')" [class.selected]="selectedClientType === 'new'">
          <i class="far fa-circle" *ngIf="selectedClientType !== 'new'"></i>
          <i class="fas fa-dot-circle" *ngIf="selectedClientType === 'new'"></i>
          <span>New client</span>
        </div>

        <div class="method-option" (click)="setClientType('existing')"
          [class.selected]="selectedClientType === 'existing'">
          <i class="far fa-circle" *ngIf="selectedClientType !== 'existing'"></i>
          <i class="fas fa-dot-circle" *ngIf="selectedClientType === 'existing'"></i>
          <span>Existing client</span>
        </div>
      </div>

      <form [formGroup]="quotationForm">

        <!-- New Client Form -->
        <div *ngIf="newClient" class="row">
          <!-- Client Name -->
          <div class="col-sm-4 col-6 mb-3">
            <label class="quote-label">Client name</label>
            <input type="text" class="form-control" formControlName="client" />
          </div>

          <!-- Email Address -->
          <div class="col-sm-4 col-6 mb-3">
            <div class="form-group">
              <label class="quote-label">Email address</label>
              <input type="email" id="email" class="form-control" formControlName="email" placeholder="" />
              <div *ngIf="quotationForm.get('email')?.touched && quotationForm.get('email')?.invalid"
                class="text-danger form-text">
                <div *ngIf="quotationForm.get('email')?.errors?.['required']">
                  Email is required.
                </div>
                <div *ngIf="quotationForm.get('email')?.errors?.['pattern']">
                  Enter a valid email address.
                </div>
              </div>
            </div>
          </div>

          <!-- Phone Number -->
          <div class="col-sm-4 col-6 mb-3">
            <label class="quote-label">Phone number</label>
            <ngx-intl-tel-input id="phoneNumber" [cssClass]="'form-control form-control-sm mb-1'"
              [preferredCountries]="preferredCountries" [enableAutoCountrySelect]="true" [enablePlaceholder]="true"
              [searchCountryFlag]="true" [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
              [selectFirstCountry]="false" [style]="{ width: '100%' }" [selectedCountryISO]="CountryISO.Kenya"
              [phoneValidation]="true" [separateDialCode]="true" [numberFormat]="PhoneNumberFormat.National"
              formControlName="phone">
            </ngx-intl-tel-input>


            <div *ngIf="quotationForm.get('phone')?.invalid && quotationForm.get('phone')?.touched"
              class="form-text text-danger">
              Invalid phone number
            </div>

          </div>
        </div>

        <div class="row g-3">
          <ng-container *ngFor="let field of detailedQuotationFormData">
            <ng-container *ngIf="field.isPriority === 'Y' && !(newClient && field.name === 'client')">
              <div class="col-sm-4 col-6" *ngIf="shouldShowField(field.name)">
                <div class="form-group form-group-sm">
                  <!-- Label -->
                  <label class="quote-label" [ngClass]="{ 'required': field.isMandatory === 'Y' }">
                    {{ field.label | translate }}
                  </label>

                  <!-- Input field based on type -->
                  <ng-container [ngSwitch]="field.type">
                    <!-- SELECT -->
                    <ng-container *ngSwitchCase="'select'">
                      <!-- CLIENT SEARCH -->
                      <ng-container *ngIf="field.name === 'client' && !newClient">
                        <div class="position-relative" style="cursor: pointer;">
                          <input type="text" class="form-control form-control-sm pe-5" [value]="selectedClientName"
                            readonly (click)="showClientSearchModal = true" style="cursor: pointer;" />
                          <i class="pi pi-search position-absolute"
                            style="top: 50%; right: 12px; transform: translateY(-50%); color: #00529B; pointer-events: none;"></i>
                        </div>
                        <app-client-search-modal *ngIf="showClientSearchModal"
                          (onClickSaveClient)="handleSaveClient($event)"></app-client-search-modal>
                      </ng-container>
                      <div
                        *ngIf="quotationForm.get('client')?.hasError('required') && quotationForm.get('client')?.touched"
                        class="form-text text-danger">Client name is required.</div>
                      <!-- SOURCE -->
                      <ng-container *ngIf="field.name === 'source'">
                        <p-dropdown formControlName="source" [options]="quotationSources" optionLabel="description"
                          placeholder=" " [filter]="true" [filterBy]="'description'"
                          (onChange)="onSourceChange($event)">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('source')?.hasError('required') && quotationForm.get('source')?.touched"
                          class="form-text text-danger">Source is required.</div>
                      </ng-container>

                      <!-- QUOTATION TYPE -->
                      <ng-container *ngIf="field.name === 'quotationType'">
                        <p-dropdown formControlName="quotationType" [options]="quotationType" optionLabel="label"
                          optionValue="value" placeholder=" " [filter]="true" [filterBy]="'label'">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('quotationType')?.hasError('required') && quotationForm.get('quotationType')?.touched"
                          class="form-text text-danger">Quotation type is required.</div>
                      </ng-container>



                      <!-- BRANCH -->
                      <ng-container *ngIf="field.name === 'branch'">
                        <p-dropdown formControlName="branch" [options]="branch" optionLabel="name" placeholder=" "
                          value="id" [filter]="true" [filterBy]="'name'">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('branch')?.hasError('required') && quotationForm.get('branch')?.touched"
                          class="form-text text-danger">Branch is required.</div>
                      </ng-container>

                      <!-- CURRENCY -->
                      <ng-container *ngIf="field.name === 'currency'">
                        <p-dropdown formControlName="currency" [options]="currency" optionLabel="name" value="id"
                          placeholder=" " [filter]="true" [filterBy]="'name'" (onChange)="fetchUserOrgId()">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('currencyCode')?.hasError('required') && quotationForm.get('currencyCode')?.touched"
                          class="form-text text-danger">Currency is required.</div>
                      </ng-container>

                      <!-- INTRODUCER -->
                      <ng-container *ngIf="field.name === 'introducer'">
                        <p-dropdown formControlName="introducer" [options]="introducers" optionLabel="surName"
                          optionValue="code" placeholder=" " [filter]="true" [filterBy]="'surName'">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('introducer')?.hasError('required') && quotationForm.get('introducer')?.touched"
                          class="form-text text-danger">Introducer is required.</div>
                      </ng-container>
                    </ng-container>

                    <!-- DATE -->
                    <p-calendar *ngSwitchCase="'date'" [formControlName]="field.name" [dateFormat]="dateFormat"
                      inputStyleClass="form-control" [showButtonBar]="true" [dataType]="'string'" [showIcon]="true">
                    </p-calendar>

                    <!-- TEXT -->
                    <ng-container *ngSwitchCase="'text'">
                      <div *ngIf="field.name === 'multiUserEntry'">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="radio" name="multiUser" formControlName="multiUserEntry"
                            id="multiUserYes" value="Y">
                          <label class="form-check-label quote-label" for="multiUserYes">Yes</label>
                        </div>
                        <div class="form-check form-check-inline ms-4">
                          <input class="form-check-input" type="radio" name="multiUser" formControlName="multiUserEntry"
                            id="multiUserNo" value="N">
                          <label class="form-check-label quote-label" for="multiUserNo">No</label>
                        </div>
                      </div>

                      <input *ngIf="field.name !== 'multiUserEntry'" type="text" id="quote-input"
                        class="form-control form-control-sm" [formControlName]="field.name">
                    </ng-container>
                    <div
                      *ngIf="quotationForm.get('client')?.hasError('required') && quotationForm.get('client')?.touched"
                      class="form-text text-danger">Client name is required.</div>


                    <!-- Agent Field -->
                    <ng-container *ngIf="field.name === 'agent' && quotationForm.get('quotationType')?.value === 'I'">
                      <p-dropdown formControlName="agents" [options]="agents" optionLabel="label" optionValue="value"
                        placeholder="" [filter]="true" [filterBy]="'label'">
                      </p-dropdown>
                      <div
                        *ngIf="quotationForm.get('agents')?.hasError('required') && quotationForm.get('agents')?.touched"
                        class="form-text text-danger">
                        Agent is required.
                      </div>
                    </ng-container>

                    <!-- campaign field -->
                    <ng-container *ngIf="field.name === 'campaign' && showCampaignField">
                      <p-dropdown formControlName="campaign" [options]="campaignList" optionLabel="label"
                        optionValue="value" placeholder="" [filter]="true" [filterBy]="'label'">
                      </p-dropdown>
                      <div
                        *ngIf="quotationForm.get('campaign')?.hasError('required') && quotationForm.get('campaign')?.touched"
                        class="form-text text-danger">
                        Campaign source is required.
                      </div>
                    </ng-container>






                  </ng-container>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>

        <!-- NON-PRIORITY FIELDS (toggle with show) -->
        <div class="row mt-2" *ngIf="show">
          <ng-container *ngFor="let field of detailedQuotationFormData">
            <ng-container *ngIf="field.isPriority === 'N'">
              <div class="col-sm-4 col-6 mb-4">
                <div class="form-group form-group-sm">
                  <label *ngIf="field.name && !(newClient && field.name === 'client')" class="quote-label"
                    [ngClass]="{ 'required': field.isMandatory === 'Y' }">
                    {{ field.label | translate }}
                  </label>

                  <ng-container [ngSwitch]="field.type">
                    <ng-container *ngSwitchCase="'select'">
                      <!-- INTRODUCER -->
                      <ng-container *ngIf="field.name === 'introducer'">
                        <p-dropdown formControlName="introducer" [options]="introducers" optionLabel="surName"
                          optionValue="code" placeholder=" " [filter]="true" [filterBy]="'surName'">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('introducer')?.hasError('required') && quotationForm.get('introducer')?.touched"
                          class="form-text text-danger">Introducer is required.</div>
                      </ng-container>

                      <!-- PAYMENT FREQUENCY -->
                      <ng-container *ngIf="field.name === 'paymentFrequency'">
                        <p-dropdown formControlName="paymentFrequency" [options]="paymentFrequencies"
                          optionLabel="label" optionValue="value" placeholder=" " [filter]="true" [filterBy]="'label'">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('paymentFrequency')?.hasError('required') && quotationForm.get('paymentFrequency')?.touched"
                          class="form-text text-danger">Payment frequency is required.</div>
                      </ng-container>
                      <!-- Marketer field -->
                      <ng-container *ngIf="field.name === 'marketer'">
                        <p-dropdown formControlName="marketer" [options]="marketerList" optionLabel="name"
                          optionValue="id" placeholder="" [filter]="true" [filterBy]="'name'">
                        </p-dropdown>
                        <div
                          *ngIf="quotationForm.get('marketer')?.hasError('required') && quotationForm.get('marketer')?.touched"
                          class="form-text text-danger">
                          Marketer source is required.
                        </div>
                      </ng-container>
                    </ng-container>
                    <ng-container *ngSwitchCase="'text'">


                      <input type="text" id="quote-input" class="form-control form-control-sm"
                        [formControlName]="field.name">

                    </ng-container>
                  </ng-container>
                </div>
              </div>
            </ng-container>
          </ng-container>
        </div>


      </form>



      <p class="more " (click)="toggleDetails()" style="cursor: pointer">
        More Details
        <span class="ml-1">
          <i class="pi" [ngClass]="{'pi-angle-double-up': show, 'pi-angle-double-down': !show}"
            style="font-size: 13px"></i>
        </span>
      </p>
    </div>
  </div>


  <!-- product section -->
  <div class="card mb-2">
    <div class="card-body  my-4 mx-4">
      <div class="row ">
        <div class="col-4">
          <h6 style="color: #00529B; font-size: 20px; font-weight: 500; font-family: Roboto; margin-bottom: 0;">
            {{ 'gis.quotation.product_details' | translate }}
          </h6>
        </div>
      </div>

      <div class="row mb-1">
        <div class="col-12 d-flex justify-content-end" style="margin-bottom: 0;">

          <div class="d-flex justify-content-center align-items-center">
            <button type="button" class="btn btn-primary btn-sm no-hover" data-bs-toggle="modal"
              data-bs-target="#addProduct" title="Add Product"> Add Product
            </button>
            <i class="pi border border-black p-1 rounded-1 text-black"
              [ngClass]="{'pi-caret-up': showProducts, 'pi-caret-down': !showProducts}"
              style="font-size: 13px;cursor: pointer; margin-left:18px;" (click)="toggleProducts()"></i>
          </div>

        </div>
      </div>

      <!-- product table -->
      <div class="collapse" [ngClass]="{'show': showProducts}" id="collapseProduct">
        <p-table [value]="productDetails" dataKey="productCode.code" editMode="row"
          [tableStyle]="{'min-width': '50rem'}">
          <ng-template pTemplate="header" style="height: 40px;">
            <tr>
              <th class="flexible-header1" pSortableColumn="productCode.description">
                Product <p-sortIcon field="productCode.description" />
              </th>

              <th class="flexible-header1" pSortableColumn="coverFrom">
                Cover from <p-sortIcon field="productCode.coverFrom" />
              </th>

              <th class="flexible-header1" pSortableColumn="productCode.description">
                Cover to <p-sortIcon field="productCode.coverTo" />
              </th>

              <th class="flexible-header1"></th>
            </tr>
          </ng-template>


          <ng-template pTemplate="body" let-product let-editing="editing" let-ri="rowIndex">
            <tr [pEditableRow]="product" [pEditableRowDisabled]="selectedEditRowIndex !== ri"
              [class.p-highlight]="product === selectedRow" (click)="onRowSelect(product)"
              class="hover:!bg-gray-50 !cursor-pointer transition-colors" title="Click to select row">

              <!-- Product Dropdown Column (now with icon) -->
              <td class="flexible-header">
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <div class="form-group form-group-sm">
                      <p-dropdown [options]="ProductDescriptionArray" appendTo="body" [ngModel]="product.productCode"
                        optionLabel="description" [style]="{'width':'100%'}"
                        (onChange)="onProductChange($event.value, ri, product)">
                      </p-dropdown>
                    </div>
                  </ng-template>
                  <ng-template pTemplate="output">
                    <div class="flex items-center gap-2">
                      <i class="pi pi-hand-pointer text-gray-400"></i>
                      {{ product.productCode?.description }}
                    </div>
                  </ng-template>
                </p-cellEditor>
              </td>

              <!-- Cover From Date -->
              <td class="flexible-header">
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-calendar [(ngModel)]="product.coverFrom" appendTo="body" [dateFormat]="dateFormat"
                      [style]="{'width':'100%'}" (ngModelChange)="updateCoverTo(product)" [showIcon]="true">
                    </p-calendar>
                  </ng-template>
                  <ng-template pTemplate="output">
                    {{ product.coverFrom | date: dateFormat }}
                  </ng-template>
                </p-cellEditor>
              </td>

              <!-- Cover To Date -->
              <td class="flexible-header">
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-calendar [(ngModel)]="product.coverTo" appendTo="body" [dateFormat]="dateFormat"
                      [style]="{'width':'100%'}" [showIcon]="true">
                    </p-calendar>
                  </ng-template>
                  <ng-template pTemplate="output">
                    {{ product.coverTo | date: dateFormat }}
                  </ng-template>
                </p-cellEditor>
              </td>

              <!-- Action Buttons -->
              <td class="flexible-header">
                <div class="d-flex justify-content-end gap-2">
                  <button *ngIf="!editing" type="button" pInitEditableRow (click)="  onRowEditInits(product,ri)"
                    class="p-button-sm p-button-text p-button-info no-border">
                    Edit
                  </button>
                  <button *ngIf="editing" type="button" pSaveEditableRow (click)="onRowEditSaves(product)"
                    class="p-button-sm p-button-text p-button-success no-border">
                    Save
                  </button>
                  <button *ngIf="editing" type="button" pCancelEditableRow (click)="onRowEditCancels(product, ri)"
                    class="p-button-sm p-button-text p-button-secondary no-border">
                    Cancel
                  </button>
                  <button type="button" (click)="openProductDeleteModal(product)"
                    class="p-button-sm p-button-text p-button-danger no-border" data-bs-toggle="modal"
                    data-bs-target="#deleteProductModal">
                    Delete
                  </button>
                  <button *ngIf="reassignButton" type="button" (click)="openReassignProductModal(product)"
                    class="p-button-sm p-button-text p-button-danger no-border">
                    Reassign
                  </button>

                </div>
              </td>
            </tr>
          </ng-template>


          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" style="text-align:center; padding: 20px;">
                {{ 'gis.quotation.no_data_to_display' | translate }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <!-- Add Product Modal -->
      <div class="modal fade" id="addProduct" tabindex="-1" role="dialog" aria-labelledby="addSectionLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm " style="min-width: 518px;" role="document">
          <div class="modal-content" id="addSectionModal">
            <div class="modal-body">
              <h5 class="modal-title mt-2" id="editOtherDetailsLabel">Add product
                <button type="button" class="btn-close float-end custom-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </h5>
              <div class="row mb-4" [formGroup]='quotationProductForm'>
                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="" class="quote-label">Product</label>
                    <p-dropdown [options]="ProductDescriptionArray" formControlName="productCodes"
                      optionLabel="filterText" filterBy="filterText" [filter]="true" [showClear]="true" placeholder=""
                      class="custom-multiselect">


                      <ng-template let-product pTemplate="item">
                        <div>{{ product?.description }}</div>
                      </ng-template>


                      <ng-template let-product pTemplate="selectedItem">
                        <div>{{ product?.description }}</div>
                      </ng-template>

                      <ng-template pTemplate="empty">
                        <div class="text-danger px-2 py-1">
                          No products match your search.
                        </div>
                      </ng-template>
                    </p-dropdown>

                    <div
                      *ngIf="quotationProductForm.get('productCodes')?.hasError('required') && quotationProductForm.get('productCodes')?.touched"
                      class="form-text text-danger">
                      Product is required.
                    </div>

                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverFromDate" class="quote-label">Cover From</label><br>
                    <p-calendar formControlName="wef" name="wefDate" id="coverFromDate" inputId="coverFromDate"
                      [dateFormat]="dateFormat" inputStyleClass='form-control' (onSelect)="updateCoverToDate($event)"
                      [minDate]="minDate" [showIcon]="true">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wef').hasError('required') && quotationProductForm.get('wef').touched"
                      class="form-text text-danger">
                      Cover From is required.
                    </div>
                  </div>
                </div>

                <div class="col-sm-6 col-12">
                  <div class="form-group form-group-sm">
                    <br>
                    <label for="coverToDate" class="quote-label">Cover to</label><br>
                    <p-calendar formControlName="wet" name="wetDate" id="coverToDate" inputId="coverToDate"
                      [dateFormat]="dateFormat" inputStyleClass='form-control' [minDate]="minDate" [showIcon]="true">
                    </p-calendar>
                    <div
                      *ngIf="quotationProductForm.get('wet').hasError('required') && quotationProductForm.get('wet').touched"
                      class="form-text text-danger">
                      Cover to is required.
                    </div>
                  </div>
                </div>

                <div class="mt-4 d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-secondary btn-lightblue" data-bs-dismiss="modal"
                    id="cancelDetails">
                    Cancel
                  </button>
                  <button type="button" class="btn btn-primary" id="saveDetails" (click)="submitAddProductForm()">
                    {{ 'gis.quotation.save_details' | translate }}
                  </button>
                </div>

              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Delete Product Modal -->
      <div class="modal fade" id="deleteProductModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
          <div class="modal-content ps-4 pt-2 pe-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-1">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                Delete product
              </p>
              <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div class="d-flex justify-content-between text-black">
              <p>Are you sure you want to delete product
                <strong>{{ productToDelete?.productName }}</strong>?
              </p>
            </div>

            <div class="d-flex justify-content-center mb-3">
              <button type="button" class="btn btn-primary px-5" id="delete" data-bs-dismiss="modal"
                (click)="deleteProduct()">{{
                'gis.policy.yes_delete'
                | translate
                }}
              </button>
            </div>
            <div class="d-flex justify-content-center mb-2">
              <button type="button" class="btn btn-outline-primary px-5" data-bs-dismiss="modal">{{
                'gis.policy.no_im_not' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reassign Product Modal 1 -->
      <div class="modal fade " id="reassignProductModal" #reassignProductModal tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
          <div class="modal-content ps-4 pt-2 pb-5 pe-4">
            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                Reassign task
              </p>
              <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div *ngIf="departmentSelected" class="w-75 mb-2 mt-2">
              <p class="quote-label">Group User</p>
              <!-- <p-dropdown [options]="clientOptions" [(ngModel)]="clientToReassignQuotation" [showClear]="true"
                styleClass="w-full">
              </p-dropdown> -->
              <input pInputText type="select" class="form-control form-control-sm" id="quote-input"
                [(ngModel)]="clientToReassignProduct">
            </div>

            <div class="w-75 mb-2 mt-2">
              <p class="quote-label">{{ clientToReassignProduct ? 'Default User' : 'User' }}</p>

              <!-- <input pInputText type="select" class="form-control form-control-sm" id="quote-input"
                (click)="openChooseClientReassignModal()" [(ngModel)]="clientToReassignProduct"> -->
              <div class="form-control form-control-sm d-flex align-items-center justify-content-between"
                id="quote-input" style="cursor: pointer;" (click)="openChooseClientReassignModal()">
                <span cl>{{ clientToReassignProduct}}</span>
                <i class="pi pi-chevron-down me-2" style="color: #00529B;font-size: 14px;"></i>
              </div>

            </div>

            <div class="w-75 mb-3">
              <p>Comments</p>
              <textarea name="reassignProduct" class="form-control" style="height: 70px"
                [(ngModel)]="reassignProductComment"></textarea>
            </div>

            <small class="text-danger block" [class.invisible]="!noCommentleft">
              Please leave a comment before reassigning
            </small>

            <small class="text-danger block" [class.invisible]="!noUserChosen">
              Please select a person to reassign before continuing
            </small>

            <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="reassignProduct()">{{
                'gis.quotation.reassign' | translate }}
              </button>
              <button type="button" (click)="closeReassignProductModal()" class="btn btn-outline-primary"
                style="text-decoration: none;">{{'gis.quotation.cancel' | translate}}
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Reassign Product Modal 2 -->
      <div class="modal fade " id="chooseClientReassingModal" #chooseClientReassignModal tabindex="-1"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
          <div class="modal-content ps-4 pt-2 pb-5 pe-4">

            <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
              <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                Reassign task
              </p>
              <button type="button" (click)="closeChooseClientReassignModal()" class="btn p-0 text-danger fw-bold"
                style="border: none;">X</button>
            </div>

            <div class="row mt-2">
              <p-table #reassignTable [value]="users" [rows]="3" [paginator]="true"
                [rowsPerPageOptions]="[5, 10, 20, 50]" [globalFilterFields]="['id', 'name']" selectionMode="single"
                [(selection)]="selectedUser" styleClass="p-datatable-striped" (onRowSelect)="onUserSelect()"
                (onRowUnselect)="onUserUnselect()">
                <ng-template pTemplate="header">
                  <tr>
                    <th>User ID</th>
                    <th>Full Name</th>
                  </tr>
                  <tr styleClass="p-striped">
                    <th>
                      <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)">
                    </th>
                    <th>
                      <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)">
                    </th>
                  </tr>

                </ng-template>
                <ng-template pTemplate="body" let-user>
                  <tr [pSelectableRow]="user">
                    <td>{{ user.id }}</td>
                    <td>{{ user.name }}</td>
                  </tr>
                </ng-template>
              </p-table>
            </div>

            <small class="text-danger block" [class.invisible]="!noUserChosen">
              Please select a person to reassign before continuing
            </small>

            <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
              <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
                (click)="selectClient()">{{
                'gis.quotation.save' | translate }}
              </button>
              <button type="button" (click)="closeChooseClientReassignModal()" class="btn btn-outline-primary"
                style="text-decoration: none;">{{
                'gis.quotation.cancel' | translate
                }}
              </button>
            </div>

          </div>
        </div>
      </div>

      <div class="row mb-4" [formGroup]='quotationForm'>
      </div>


    </div>
  </div>

  <!-- Clauses section -->
  <div class="card mb-3 " *ngIf="productDetails && productDetails.length > 0">
    <div class="card-body my-4 mx-4">
      <div class="row ">
        <div class="col-4">
          <h6 style="color: #00529B; font-size: 20px; font-weight: 500; font-family: Roboto; margin-bottom: 0; ">
            Product clauses
          </h6>
        </div>
      </div>

      <div class="col-12 d-flex justify-content-end mb-1">

        <div class="col-12 d-flex justify-content-end mb-1">
          <div class="d-flex justify-content-center align-items-center">
            <button type="button" class="btn btn-primary btn-sm no-hover" (click)="openClauseModal()"
              title="Add Product clause"> Add
              clauses
            </button>
            <i class="pi border border-black p-1 rounded-1 text-black"
              [ngClass]="{'pi-caret-up': showClauses, 'pi-caret-down': !showClauses}"
              style="font-size: 13px;cursor: pointer; margin-left:18px;" (click)="toggleClauses()"></i>
          </div>
        </div>

      </div>

      <!-- clauses table -->
      <div class="collapse mb-4" [ngClass]="{'show': showClauses}" id="collapseProductClauses">
        <p-table #productClauseTable [value]="sessionClauses " [rows]="3" [rowsPerPageOptions]="[3, 10, 20]"
          [paginator]="true" styleClass="p-datatable-striped">

          <ng-template pTemplate="header">
            <tr>
              <th class="flexible-header1" style="width: 18%" pSortableColumn="id">
                ID <p-sortIcon field="id" />
              </th>
              <th class="flexible-header1" style="width: 18%" pSortableColumn="heading">
                Heading <p-sortIcon field="heading" />
              </th>
              <th class="flexible-header1" style="width: 45%" pSortableColumn="wording">
                Wording <p-sortIcon field="wording" />
              </th>
              <th class="flexible-header1" style="width: 15%">Actions</th>
            </tr>

          </ng-template>

          <ng-template pTemplate="body" let-clause let-columns="columns" let-rowIndex="rowIndex">
            <ng-container *ngIf="rowIndex === 0">
              <tr>
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByshortDescription($event)">
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByHeading($event)">
                </td>
                <td>
                  <input type="text" class="form-control form-control-sm" (input)="filterByWording($event)">
                </td>
                <td></td>
              </tr>
            </ng-container>
            <tr [pSelectableRow]="clause">
              <td class="flexible-header1">{{ clause.shortDescription }}</td>
              <td class="flexible-header1">{{ clause.heading | truncate:5 | sentenceCase}}</td>
              <td class="position-relative ">
                <div class="clause-wrapper">
                  {{ clause.wording | truncate:10 |sentenceCase}}

                  <div class="hover-card">
                    {{ clause.wording|sentenceCase }}
                  </div>
                </div>
              </td>


              <td class="flexible-header1" style="text-align: left">
                <div class="flex justify-start items-center gap-2">
                  <!-- Edit -->
                  <span class="p-button-label p-text-bold " [ngStyle]="{
                    color: clause.isEditable === 'Y' ? '#00529B' : '#6B7280', 
                    marginRight: '16px',
                    marginLeft: '10px',
                    cursor: clause.isEditable === 'Y' ? 'pointer' : 'default',
                    display: 'inline-block',
                    width: '60px'  
                    }" [attr.data-bs-toggle]="clause.isEditable === 'Y' ? 'modal' : null"
                    [attr.data-bs-target]="clause.isEditable === 'Y' ? '#editClause' : null"
                    (click)="clause.isEditable === 'Y' && populateEditClauseModal(clause)">
                    {{ clause.isEditable === 'Y' ? ('gis.quotation.edit' | translate) : '--' }}
                  </span>

                  <!-- Delete -->
                  <span *ngIf="clause.isMandatory === 'N'" class="p-button-label p-text-bold text-center" [ngStyle]="{
                        color: '#00529B',
                        cursor: 'pointer'
                      }" data-bs-toggle="modal" data-bs-target="#deleteClause" (click)="prepareDeleteClause(clause)">
                    {{ 'gis.quotation.delete' | translate }}
                  </span>

                </div>

              </td>
            </tr>
          </ng-template>

          <!-- empty/search states -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4" style="text-align: center; padding: 20px;">
                <div style="color: #6c757d; font-size: 15px;">
                  <ng-container *ngIf="productClause.length === 0">
                    No clause available. Click on “Add clauses” to add a new clause.
                  </ng-container>
                  <ng-container *ngIf="productClause.length > 0">
                    No clauses found matching your search
                  </ng-container>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>

        <!-- add clause modal -->
        <div class="modal fade" id="addClause" tabindex="-1" aria-labelledby="addClauseLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
            <div class="modal-content ps-4 pt-2 pe-4">
              <div class="d-flex justify-content-between align-items-center rounded-3 mb-1 p-1">
                <p class="modal-title" id="addClauseLabel" style="color: #00529B; font-weight:600; font-size:20px;">
                  {{ 'gis.quotation.add_product_cluase' | translate }}
                </p>
                <button type="button" class="btn-close custom-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
              </div>

              <div class="row mt-3">
                <div *ngIf="nonMandatoryProductClause && nonMandatoryProductClause.length === 0"
                  class="text-center p-4">
                  <div style="color: #6c757d; font-size: 16px;">
                    <i class="pi pi-info-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>No additional clauses are available to add.</p>
                  </div>
                </div>

                <p-table *ngIf="nonMandatoryProductClause && nonMandatoryProductClause.length > 0"
                  #addProductClausesTable [value]="nonMandatoryProductClause" [rows]="5" [paginator]="true"
                  selectionMode="multiple" [(selection)]="selectedClauses" stripedRows styleClass="p-datatable-striped"
                  [rowsPerPageOptions]="[5, 10, 20]">

                  <ng-template pTemplate="header">
                    <tr>
                      <th class="flexible-header1" style="width: 3%"><p-tableHeaderCheckbox /></th>
                      <th class="flexible-header1" style="width: 30%" pSortableColumn="id">
                        ID <p-sortIcon field="code" />
                      </th>
                      <th class="flexible-header1" style="width: 40%" pSortableColumn="heading">
                        Description <p-sortIcon field="code" />
                      </th>
                      <th></th>
                    </tr>

                  </ng-template>

                  <ng-template pTemplate="body" let-clause let-columns="columns" let-rowIndex="rowIndex">
                    <ng-container *ngIf="rowIndex === 0">
                      <tr>
                        <td></td>
                        <td>
                          <input type="text" class="form-control form-control-sm"
                            (input)="filterByAddshortDescription($event)">
                        </td>
                        <td>
                          <input type="text" class="form-control form-control-sm" (input)="filterByAddHeading($event)">
                        </td>

                        <td></td>
                      </tr>
                    </ng-container>
                    <tr>
                      <td style="max-width: 10px; min-width: 10px;">
                        <p-tableCheckbox [value]="clause" />
                      </td>
                      <td>{{ clause.shortDescription }}</td>
                      <td>{{ clause.heading }}</td>
                    </tr>
                  </ng-template>
                </p-table>
              </div>

              <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 mb-3 mt-5 p-0">
                <button type="button" class="btn" data-bs-dismiss="modal" [disabled]="!selectedClauses?.length"
                  style="background-color: #00529B;color:white;text-decoration: none;" (click)="addProductClauses()">
                  {{ 'gis.quotation.save' | translate }}
                </button>
                <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
                  style="text-decoration: none;" (click)="closeClauseModal()">
                  {{ 'gis.quotation.cancel' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- edit clause modal -->
        <div class="modal fade" id="editClause">
          <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
            <div class="modal-content ps-4 pt-2 pe-4">
              <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-1">
                <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                  {{ 'gis.quotation.edit_clause' | translate }}</p>
                <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                  style="border: none;">X
                </button>
              </div>

              <div class="d-flex justify-content-between text-black">
                <div class="d-flex flex-column bg-gray-300 w-25">
                  <label for="id">ID</label>
                  <input type="text" [value]=" selectedProductClause.shortDescription" pInputText
                    style="background-color:rgb(215, 212, 212); width:18vw" readonly>

                </div>
                <div class="d-flex flex-column w-50 ">
                  <label for="heading">Heading</label>
                  <input class="bg-gray-300" pInputText [value]=" selectedProductClause.heading | truncate:4"
                    pTooltip="{{  selectedProductClause.heading }}"
                    style="background-color:rgb(215, 212, 212); width:20vw; z-index:auto" readonly>
                </div>
              </div>

              <div class="d-flex flex-column mt-5">
                <label class="text-dark mt-0" for="comment">Wording</label>
                <textarea rows="5" pTextarea [(ngModel)]=" selectedProductClause.wording" class="p-inputtextarea w-full"
                  style="border: 1px solid #ced4da;min-height: 130px">
              </textarea>
              </div>

              <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 mb-3 mt-5 p-0">
                <button #closeReassignButton type="button" data-bs-dismiss="modal" style="display: none;"></button>
                <button type="button" class="btn" data-bs-dismiss="modal"
                  style="background-color: #00529B;color:white;text-decoration: none;" (click)="editClause()"
                  [disabled]="!wasModified()">{{ 'gis.quotation.save_changes' | translate }}
                </button>
                <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
                  style="text-decoration: none;">{{
                  'gis.quotation.cancel' | translate
                  }}
                </button>
              </div>

            </div>
          </div>

        </div>

        <!-- delete clause modal -->
        <div class="modal fade" id="deleteClause">
          <div class="modal-dialog modal-dialog-centered" style="min-width:600px">
            <div class="modal-content ps-4 pt-2 pe-4">
              <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-1">
                <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
                  {{ 'gis.quotation.delete_clause' | translate }}</p>
                <button type="button" data-bs-dismiss="modal" class="btn p-0 text-danger fw-bold"
                  style="border: none;">X
                </button>
              </div>

              <div class="d-flex justify-content-between text-black">
                <p>Are you sure you want to delete this clause?</p>
              </div>

              <div class="d-flex flex-row-reverse gap-3 align-items-center rounded-3 mb-3 mt-5 p-0">
                <button type="button" class="btn" data-bs-dismiss="modal"
                  style="background-color: #00529B;color:white;text-decoration: none;" (click)="deleteProductClause()">
                  {{ 'gis.quotation.delete' | translate }}
                </button>
                <button type="button" data-bs-dismiss="modal" class="btn btn-outline-primary"
                  style="text-decoration: none;">{{
                  'gis.quotation.cancel' | translate
                  }}
                </button>
              </div>

            </div>
          </div>

        </div>


      </div>
    </div>
  </div>



  <div class="float-end mb-4">

    <button class="btn btn-primary" (click)="saveQuotationDetails()">Next</button>
  </div>
</div>