<div class="container">
    <p class="titleMain mt-3">{{'gis.quotation.quotation_data_entry' | translate}}</p>
    <app-stepper [currentStep]="1" [stepperData]="steps"></app-stepper>
    <div class="container mx-2 mt-n1">
        <div class="card mb-3" style=" position: relative;">
            <ngx-spinner name="quickQuoteScreen" type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B"
                size="medium" bdColor="rgba(255, 255, 255, 0.9)"></ngx-spinner>
            <div class="card-body">
                <div class="d-inline me-4">
                    <input class="form-check-input me-2 mt-2" (click)="toggleNewClient()" type="radio"
                        name="flexRadioDefault" id="flexRadioDefault2" [checked]="isNewClient">
                    <label class="form-check-label mb-4 mt-2" for="flexRadioDefault2">
                        {{'gis.quotation.new_client' | translate}}
                    </label>
                </div>
                <div class="d-inline ms-4">
                    <input class="form-check-input me-2 ms-4 mt-2" (click)="toggleButton()" type="radio"
                        name="flexRadioDefault" id="flexRadioDefault1" [checked]="!isNewClient">
                    <label class="form-check-label mb-4 mt-2" for="flexRadioDefault1">
                        {{'gis.quotation.existing_client' | translate}}
                    </label>
                </div>




                <!-- ROW 1 -->
                <div class="row mb-4">
                    <div class="col-sm-4 col-6" *ngIf="!new">
                        <label for="name" class=" quote-label" id="name">{{'gis.quotation.name' |
                            translate}}</label>

                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="newClientData.inputClientName" (blur)="onInputChange()">

                    </div>
                    <div class=" col-sm-4 col-6" *ngIf="new">
                        <label for="Client" class="required quote-label" id="Client"> {{'gis.quotation.client' |
                            translate}}</label>


                        <input type="text" id="quote-input" class="form-select form-control form-control-sm mb-1"
                            [(ngModel)]="clientName" data-bs-toggle="modal" data-bs-target="#clientModal" readonly>

                    </div>
                    <div class=" col-sm-4 col-6 " *ngIf="!new">
                        <label for="Email" class="quote-label" id="Email"> {{'gis.quotation.email_address' |
                            translate}}</label>

                        <!-- <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="newClientData.inputClientEmail" (blur)="onInputChange()"> -->

                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="newClientData.inputClientEmail" #emailInput="ngModel" [pattern]="emailPattern"
                            required>
                        <div *ngIf="emailInput.invalid && emailInput.dirty" class="error-message">
                            <span *ngIf="emailInput.errors?.['required']">Email is required.</span>
                            <span *ngIf="emailInput.errors?.['pattern']">Invalid email format.</span>
                        </div>

                    </div>


                    <div class="col-sm-4 col-6 " *ngIf="new">
                        <label for=">Email" class="quote-label" id=">Email"> {{'gis.quotation.email_address' |
                            translate}}</label>
                        <!-- <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="clientEmail" disabled> -->

                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="clientEmail" #clientEmailInput="ngModel" disabled>
                        <div *ngIf="clientEmailInput.invalid && clientEmailInput.dirty" class="error-message">
                            <span *ngIf="clientEmailInput.errors?.['required']">Email is required.</span>
                            <span *ngIf="!validateEmail(clientEmail)">Invalid email format.</span>
                        </div>
                    </div>
                    <div class="col-sm-4 col-6" *ngIf="!new">
                        <label for="Phone" class="quote-label" id="Phone"> {{'gis.quotation.phone_number' |
                            translate}}</label>

                        <div class="input-group">
                            <div class="input-group">
                                <ngx-intl-tel-input [cssClass]="'form-control form-control-sm mb-1'"
                                    [preferredCountries]="preferredCountries" [enableAutoCountrySelect]="true"
                                    [enablePlaceholder]="true" [searchCountryFlag]="true" [selectFirstCountry]="true"
                                    [selectedCountryISO]="CountryISO.Kenya"
                                    [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
                                    [phoneValidation]="true" [(ngModel)]="newClientData.inputClientPhone"
                                    [numberFormat]="PhoneNumberFormat.National" #newClientPhoneInput="ngModel"
                                    (ngModelChange)="onPhoneInputChange()">
                                </ngx-intl-tel-input>
                                <div *ngIf="newClientPhoneInput.errors?.['validatePhoneNumber']?.['valid'] === false"
                                    class="form-text text-danger">
                                    {{'gis.quotation.invalid_phone_format' | translate}}
                                </div>
                            </div>
                        </div>




                    </div>
                    <div class="col-sm-4 col-6" *ngIf="new">
                        <label for="Phone" class="quote-label" id="Phone"> {{'gis.quotation.phone_number' |
                            translate}}</label>
                        <div class="input-group">
                            <ngx-intl-tel-input [cssClass]="'form-control form-control-sm mb-1'"
                                [preferredCountries]="preferredCountries" [enableAutoCountrySelect]="true"
                                [enablePlaceholder]="true" [searchCountryFlag]="true" [selectFirstCountry]="true"
                                [selectedCountryISO]="CountryISO.Kenya"
                                [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
                                [phoneValidation]="true" [(ngModel)]="clientPhone" #clientPhoneInput="ngModel"
                                [numberFormat]="PhoneNumberFormat.National"
                                (ngModelChange)="onPhoneInputChange()">
                            </ngx-intl-tel-input>
                            <div *ngIf="clientPhoneInput.errors?.['validatePhoneNumber']?.['valid'] === false"
                                class="form-text text-danger">
                                {{'gis.quotation.invalid_phone_format' | translate}}
                            </div>
                        </div>




                    </div>


                </div>


                <form [formGroup]="personalDetailsForm" class="mb-3">

                    <!-- ROW 2 -->
                    <div class="row mb-4">
                        <div class="col-sm-4 col-6">
                            <label for="product" class="quote-label required" id="product">{{'gis.quotation.product' |
                                translate}}</label><br>
                            <p-dropdown formControlName="productCode" name="productCode" [options]="ProductDescriptionArray"
                                optionLabel="description" dataKey="code" (onChange)="onProductSelected($event.value)"
                                placeholder=" " [filterBy]="'description'" [placeholder]="parsedProductDesc"
                                [filter]="true"></p-dropdown>


                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('productCode').hasError('required') && personalDetailsForm.get('productCode').touched"
                                class="form-text text-danger">
                                {{'gis.quotation.product_is_required' | translate}}
                            </div>
                        </div>
                        <div class="col-sm-4 col-6">
                            <label for="use-of-property" class="quote-label required" id="use-of-property">
                                {{'gis.quotation.use_of_property' | translate}}</label>
                            <select class="form-select form-control-sm " id="quote-select"
                                (change)="onSubclassSelected($event)" formControlName="subclassCode" name="subclassCode"
                                placeholder="parsedSubclassDesc">
                                <option value=""></option>
                                <option *ngFor="let subclass of allMatchingSubclasses" [value]="subclass.code">
                                    {{subclass.description | sentenceCase}}</option>
                            </select>
                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('subclassCode').hasError('required') && personalDetailsForm.get('subclassCode').touched"
                                class="form-text text-danger">
                                {{'gis.policy.subclass_is_required' | translate}}
                            </div>
                        </div>
                        <div class="col-sm-4 col-6">
                            <label for="cover-From" class="quote-label required" id="cover-From">
                                {{'gis.quotation.effective_date' | translate}}</label>
                            <!-- <input type="date" id="quote-input" class="form-control form-control-sm mb-1" formControlName="withEffectiveFromDate"> -->
                            <!-- <input type="date" id="cover-from" class="form-control form-control-sm mb-1 "
                                formControlName="withEffectiveFromDate" [(ngModel)]="coverFromDate"
                                (ngModelChange)="getCoverToDate()"> -->


                            <p-calendar formControlName="withEffectiveFromDate" name="withEffectiveFromDate" [dateFormat]="dateFormat"
                                [showIcon]="true" [showButtonBar]="true"
                                [placeholder]="coverFrom ? coverFrom : todaysDate" [minDate]="minDate"
                                [(ngModel)]="selectedEffectiveDate"
                                (ngModelChange)="onDateInputChange(selectedEffectiveDate);getCoverToDate()">
                            </p-calendar>


                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('withEffectiveFromDate').hasError('required') && personalDetailsForm.get('withEffectiveFromDate').touched"
                                class="form-text text-danger">
                                {{'gis.quotation.cover_from_is_required' | translate}}
                            </div>
                        </div>
                    </div>
                    <!-- ROW 3 -->
                    <div class="row mb-4">
                        <div class="col-sm-4 col-6">
                            <label for="currency" class="required quote-label" id="currency">{{'gis.quotation.currency'
                                | translate}}</label>


                            <p-dropdown formControlName="currencyCode" name="currencyCode" [options]="currencyList" optionLabel="name"
                                dataKey="id" (onChange)="onCurrencySelected($event.value)" [filterBy]="'name'"
                                [filter]="true" [placeholder]="defaultCurrencyName"></p-dropdown>
                            <!-- Display error message under the field -->
                            <!-- <div *ngIf="personalDetailsForm.get('currencyCode').hasError('required') && personalDetailsForm.get('currencyCode').touched"
                                class="form-text text-danger">
                                Currency is required.
                            </div> -->
                        </div>
                    </div>


                    <!-- ROW 5 -->
                    <div *ngIf="formData && selectedProductCode" class="row">
                        <div class="col-12 ">
                            <div class="row">
                                <div class="col-sm-4 col-6" *ngFor="let field of formData">
                                    <form [formGroup]="dynamicForm">
                                        <div
                                            *ngIf="field.name !== 'yearOfManufacture' && field.name !== 'selfDeclaredValue' && field.name !== 'carRegNo'">
                                            <label class="quote-label" [for]="field.name">{{ field.label }}</label>
                                            <input [type]="field.type" [formControlName]="field.name" id="quote-input"
                                                class="form-control form-control-sm mb-1 col-md-8">
                                        </div>
                                        <div *ngIf="field.name == 'yearOfManufacture'">
                                            <label class="quote-label required" [for]="field.name">{{ field.label
                                                }}</label>
                                            <select id="yearOfManufacture" id="quote-input"
                                                class="form-select form-control-sm mb-1" [formControlName]="field.name"
                                                [ngModel]="parsedYearOfManufacture">
                                                <option></option>
                                                <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                                            </select>
                                        </div>
                                        <div *ngIf="field.name == 'selfDeclaredValue'">
                                            <label class="quote-label required" [for]="field.name">{{ field.label
                                                }}</label>
                                            <!-- <input type="text" id="quote-input"
                                                class="form-control form-control-sm mb-1" [formControlName]="field.name"
                                                appCommaFormat [ngModel]="parsedSumInsured"> -->
                                            <input type="text" id="quote-input"
                                                class="form-control form-control-sm mb-1" [formControlName]="field.name"
                                                [ngModel]="parsedSumInsured" currencyMask [options]='currencyObj'>

                                            <!-- <input type="text" id="quote-input"
                                                class="form-control form-control-sm mb-1" [formControlName]="field.name"
                                                currencyMask [options]='currencyObj' (input)="handleInput($event)"> -->

                                        </div>
                                        <div *ngIf="field.name == 'carRegNo'">
                                            <label class="quote-label " [for]="field.name">{{ field.label }}</label>
                                            <input type="text" id="carRegNo" class="form-control form-control-sm mb-1"
                                                [formControlName]="field.name"
                                                (input)="updateCarRegNoValue($event); validateCarRegNo(); transformToUpperCase($event)"
                                                placeholder="e.g KCA 345R" [ngModel]="parsedCarRegNo">

                                            
                                            <div *ngIf="carRegNoHasError" class="form-text text-danger">
                                                <div *ngIf="!carRegNoValue.match(dynamicRegexPattern)">
                                                    {{'gis.quotation.please_enter_valid_reg_no' | translate}}
                                                </div>
                                                <!-- <div *ngIf="existingPropertyIds.includes(carRegNoValue)">
                                                    THIS PROPERTY ID IS DUPLICATED
                                                </div> -->
                                                <div
                                                    *ngIf="existingPropertyIds && existingPropertyIds.includes(carRegNoValue)">
                                                    This property Id is duplicated
                                                </div>

                                            </div>




                                        </div>


                                    </form>
                                </div>
                            </div>


                        </div>
                    </div>

                    <!-- Client Modal -->
                    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">

                                <div class="modal-body">
                                    <button type="button" #closebutton class="float-end btn-close"
                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                    <p class="text-start" id="selectClient"> {{'gis.quotation.select_a_client' |
                                        translate}}</p>

                                    <p-table #dt1 [value]="clientData" [tableStyle]="{'max-width': '465px'}"
                                        selectionMode="single" [resizableColumns]="true" styleClass="p-datatable-sm"
                                        responsiveLayout="scroll" class='ui-datatable' [autoLayout]="true"
                                        [paginator]="true" [rows]="5" [scrollable]="true" scrollDirection="horizontal"
                                        [showCurrentPageReport]="true"
                                        currentPageReportTemplate=" {first} - {last} of {totalRecords}"
                                        [globalFilterFields]="['idNumber', 'emailAddress','lastName','emailAddress']">
                                        <ng-template pTemplate="caption">

                                            <div class="flex">
                                                <span class="p-input-icon-left ml-auto">
                                                    <i class="pi pi-search search-icon"></i>
                                                    <input class="search-input" pInputText type="text"
                                                        (input)="applyFilterGlobal($event, 'contains')"
                                                        placeholder="Search" />
                                                </span>
                                            </div>


                                        </ng-template>
                                        <ng-template pTemplate="header">

                                            <tr id="product">
                                                <th> {{'gis.quotation.id_no' | translate}}</th>
                                                <th> {{'gis.quotation.name' | translate}}</th>
                                                <th> {{'gis.quotation.email' | translate}}</th>

                                            </tr>
                                        </ng-template>

                                        <ng-template let-clientData pTemplate="body">
                                            <tr id="productData" [pSelectableRow]=""
                                                (click)="loadClientDetails(clientData.id);">

                                                <td>
                                                    {{clientData.idNumber}}
                                                </td>
                                                <td>
                                                    {{clientData.firstName+" "+clientData.lastName}}
                                                </td>
                                                <td>
                                                    {{clientData.emailAddress}}
                                                </td>
                                            </tr>
                                        </ng-template>

                                    </p-table>
                                    <br>
                                </div>



                            </div>
                        </div>
                    </div>

                </form>

            </div>
        </div>
        <div class="row ">
            <div class="col-6"></div>
            <div class="col-6 d-flex justify-content-end">
                <button type="button" class="btn btn-outline-primary btn-lg" id="compute"
                    (click)="computePremiumV2();saveFormState()">
                    {{'gis.quotation.compute' | translate}}</button>
            </div>
        </div>
    </div>
</div>
<br>
<br><br><br><br>
