<div class="container">
  <p class="titleMain mt-3">{{ 'gis.quotation.quotation_data_entry' | translate }}</p>
  <app-stepper [currentStep]="1" [stepperData]="steps"></app-stepper>
  <div class="container mx-2 mt-n1">
    <div class="card mb-3" style=" position: relative;">
      <ngx-spinner name="quickQuoteScreen" type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B"
                   size="medium" bdColor="rgba(255, 255, 255, 0.9)"></ngx-spinner>
      <div class="card-body">
        <div class="d-inline me-4">
          <input class="form-check-input me-2 mt-2"
                 (click)="toggleButton()"
                 type="radio"
                 name="flexRadioDefault"
                 id="newClient"
                 [checked]="isNewClient"
                 [disabled]="isFieldDisabled('radio')">
          <label class="form-check-label mb-4 mt-2" for="newClient">
            {{ 'gis.quotation.new_client' | translate }}
          </label>
        </div>
        <div class="d-inline ms-4">
          <input class="form-check-input me-2 ms-4 mt-2"
                 (click)="toggleButton()"
                 type="radio"
                 name="flexRadioDefault"
                 id="existingClient"
                 [disabled]="isFieldDisabled('radio')">
          <label class="form-check-label mb-4 mt-2" for="existingClient">
            {{ 'gis.quotation.existing_client' | translate }}
          </label>
        </div>

        <div class="row mb-4" [formGroup]='quickQuoteForm'>
          <div class="col-sm-4 col-6" *ngIf="newClient;else existingClient">
            <label for="name" class=" quote-label" id="name">{{
                'gis.quotation.name' |
                  translate
              }}</label>
            <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                   formControlName="clientName"
                   [disabled]="isFieldDisabled('other')"
                   (blur)="onInputChange()"
            >
          </div>
          <ng-template #existingClient>
            <div class=" col-sm-4 col-6">
              <label for="Client" class="required quote-label" id="Client"> {{'gis.quotation.client' |
                translate}}</label>
              <input type="text" id="quote-input" class="form-select form-control form-control-sm mb-1"
                     [(ngModel)]="clientName"
                     [disabled]="isFieldDisabled('other')"
                     data-bs-toggle="modal"
                     data-bs-target="#clientModal"
                     readonly
              >

            </div>
          </ng-template>
          <div class=" col-sm-4 col-6">
            <label for="Email" class="quote-label" id="Email"> {{
                'gis.quotation.email_address' |
                  translate
              }}</label>
            <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                   [disabled]="isFieldDisabled('email')"
                   formControlName="emailAddress"
            >
          </div>
          <div class="col-sm-4 col-6">
            <label for="Phone" class="quote-label" id="Phone"> {{
                'gis.quotation.phone_number' |
                  translate
              }}</label>
            <div class="input-group">
              <ngx-intl-tel-input [cssClass]="'form-control form-control-sm mb-1'"
                                  [preferredCountries]="preferredCountries"
                                  [enableAutoCountrySelect]="true"
                                  [enablePlaceholder]="true"
                                  [searchCountryFlag]="true"
                                  [selectFirstCountry]="true"
                                  formControlName="phoneNumber"
                                  [selectedCountryISO]="CountryISO.Kenya"
                                  [searchCountryField]="[SearchCountryField.Iso2, SearchCountryField.Name]"
                                  [phoneValidation]="true" [(ngModel)]="newClientPhone"
                                  [numberFormat]="PhoneNumberFormat.National"
                                  (ngModelChange)="onPhoneInputChange()"
              >
              </ngx-intl-tel-input>
              <div *ngIf="newClientPhoneInput?.errors?.['validatePhoneNumber']?.['valid'] === false"
                   class="form-text text-danger">
                {{ 'gis.quotation.invalid_phone_format' | translate }}
              </div>
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="product" class="quote-label required" id="product">{{
                  'gis.quotation.product' |
                    translate
                }}</label><br>
              <p-dropdown formControlName="product" name="product"
                          [options]="ProductDescriptionArray" optionLabel="description" dataKey="code"
                           placeholder=" " [filterBy]="'description'"
                          [placeholder]="parsedProductDesc" [filter]="true"></p-dropdown>
              <div
                *ngIf="quickQuoteForm.get('product').hasError('required') && quickQuoteForm.get('product').touched"
                class="form-text text-danger">
                {{ 'gis.quotation.product_is_required' | translate }}
              </div>
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="use-of-property" class="quote-label required" id="use-of-property">{{
                  'gis.quotation.use_of_property' | translate
                }}</label><br>
              <p-dropdown formControlName="subClass" name="subclassCode"
                          [options]="allMatchingSubclasses" optionLabel="description" dataKey="code"
                          (onChange)="onSubclassSelected($event)" placeholder=" " [filterBy]="'description'"
                          [placeholder]="parsedProductDesc" [filter]="true"></p-dropdown>
              <div
                *ngIf="quickQuoteForm.get('subClass').hasError('required') && quickQuoteForm.get('subClass').touched"
                class="form-text text-danger">
                {{ 'gis.policy.subclass_is_required' | translate }}
              </div>
            </div>
          </div>

          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm">
              <br>
              <label for="currency" class="required quote-label" id="currency">{{
                  'gis.quotation.currency'
                    | translate
                }}</label><br>
              <p-dropdown formControlName="currency" name="currency" [options]="currencyList"
                          optionLabel="name" dataKey="id" (onChange)="onCurrencySelected($event.value)"
                          [filterBy]="'name'" [filter]="true" [placeholder]="defaultCurrencyName"></p-dropdown>
            </div>
          </div>
          <div class="col-sm-4 col-6">
            <div class="form-group form-group-sm form-control-sm">
              <br>
              <label for="cover-From" class="quote-label required" id="cover-From">
                {{ 'gis.quotation.effective_date' | translate }}</label><br>
              <p-calendar formControlName="effectiveDate" name="effectiveDate"
                          [dateFormat]="dateFormat"
                          inputStyleClass='form-control'
                          [showButtonBar]='true'
                          [style]="{ width: '100%' }"
                          [dataType]="'string'"
                          [placeholder]="coverFrom ? coverFrom : todaysDate" [minDate]="minDate"
                          (ngModelChange)="onDateInputChange(selectedEffectiveDate);getCoverToDate()">
              </p-calendar>
              <div
                *ngIf="quickQuoteForm.get('effectiveDate').hasError('required') && quickQuoteForm.get('effectiveDate').touched"
                class="form-text text-danger">
                {{ 'gis.quotation.effective_date_is_required' | translate }}
              </div>
            </div>
          </div>

          <ng-container *ngIf="formData && selectedProductCode">
            <ng-container *ngFor="let field of formData; let i = index">
              <div class="col-sm-4 col-6 dynamic-field">
                <div class="form-group form-group-sm">
                  <br>
                  <label for="{{i}}{{field.name}}" class="quote-label">{{ field.label | translate }}</label>
                  <br>
                  <ng-container [ngSwitch]="field.type">
                    <input *ngSwitchCase="'text'" type="text" id="quote-input" class="form-control form-control-sm"
                           [formControlName]="field.name" [disabled]="field.disabled">
                    <input *ngSwitchCase="'currency'" type="text" id="quote-input" class="form-control form-control-sm"
                           [formControlName]="field.name" [disabled]="field.disabled" currencyMask [options]='currencyObj'>
                    <p-calendar *ngSwitchCase="'date'" [formControlName]="field.name" [name]="field.name"
                                [dateFormat]="dateFormat" inputStyleClass='form-control' [showButtonBar]='true'
                                [dataType]="'string'" [style]="{ width: '100%' }"
                                [placeholder]="field.placeholder"></p-calendar>
                    <ng-container *ngSwitchCase="'select'">
                      <ng-container *ngIf="field.name === 'yearOfManufacture'">
                        <p-dropdown [formControlName]="field.name" [name]="field.name" [options]="years"
                                      [filter]="true"></p-dropdown>
                      </ng-container>
                      <ng-container *ngIf="field.name === 'vesselType'">
                        <p-dropdown [formControlName]="field.name" [name]="field.name" [options]="vesselTypeList"
                                    optionLabel="name" dataKey="code"
                                    [filter]="true"></p-dropdown>
                      </ng-container>
                      <ng-container *ngIf="field.name === 'modeOfTransport'">
                        <p-dropdown [formControlName]="field.name" [name]="field.name" [options]="modeOfTransport"
                                    optionLabel="description" dataKey="code"
                                    [filterBy]="'description'"
                                    [filter]="true"></p-dropdown>
                      </ng-container>
                      <ng-container *ngIf="field.name === 'occupation'">
                        <p-dropdown [formControlName]="field.name" [name]="field.name" [options]="occupationData"
                                    optionLabel="name" dataKey="id"
                                    [filterBy]="'name'"
                                    [filter]="true"></p-dropdown>
                      </ng-container>
                    </ng-container>
                  </ng-container>
                </div>
              </div>
            </ng-container>
          </ng-container>

        </div>
        <div class="row ">
          <div class="col-6"></div>
          <div class="col-6 d-flex justify-content-end">
            <button type="button" class="btn btn-outline-primary btn-lg" id="compute"
                    (click)="computePremiumV2();saveFormState()">
              {{ 'gis.quotation.compute' | translate }}
            </button>
          </div>
        </div>
        <br>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg  modal-fade">
    <div class="modal-content">

      <div class="modal-body">
        <button type="button" #closebutton class="float-end btn-close"
                data-bs-dismiss="modal" aria-label="Close"></button>
        <p class="text-start" id="selectClient"> {{
            'gis.quotation.select_a_client' |
              translate
          }}</p>
        <p-table
          #dt1
          (onLazyLoad)="lazyLoadClients($event)"
          [autoLayout]="true"
          [lazy]="true"
          [paginator]="true"
          [rowHover]="true"
          [resizableColumns]="true"
          [showCurrentPageReport]="true"
          [rows]="pageSize || 5"
          [totalRecords]="clientsData?.totalElements"
          [value]="clientsData?.content"
          [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]"
          responsiveLayout="stack"
          [scrollable]="true"
          scrollHeight="400px"
          currentPageReportTemplate="{first} - {last} of {totalRecords}"
          [globalFilterFields]=globalFilterFields
          styleClass="p-datatable-sm">


          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="name" class="flexible-header">{{ 'gis.quotation.name' | translate }}</th>
              <th pSortableColumn="emailAddress"
                  class="flexible-header">{{ 'gis.quotation.email' | translate }}
              </th>
              <th pSortableColumn="phoneNumber"
                  class="flexible-header">{{ 'gis.quotation.phone_number' | translate }}
              </th>
              <th pSortableColumn="idNumber" class="flexible-header">{{ 'gis.quotation.id_no' | translate }}
              </th>
              <th pSortableColumn="pinNumber" class="flexible-header">{{ 'gis.quotation.pin' | translate }}
              </th>
              <th pSortableColumn="id" class="flexible-header">{{ 'gis.quotation.internal_id' | translate }}
              </th>

            </tr>
            <tr>
              <th><input type="text" class="form-control" (keyup.enter)="filter($event);"
                         (input)="inputName($event)"></th>
              <th><input type="text" class="form-control" (keyup.enter)="filter($event);"
                         (input)="inputEmail($event)"></th>
              <th><input type="text" class="form-control " (keyup.enter)="filter($event);"
                         (input)="inputPhone($event)"></th>
              <th><input type="text" class="form-control" (keyup.enter)="filter($event);"
                         (input)="inputIdNumber($event)"></th>
              <th><input type="text" class="form-control " (keyup.enter)="filter($event);"
                         (input)="inputPin($event)"></th>
              <th><input type="text" class="form-control" (keyup.enter)="filter($event);"
                         (input)="inputInternalId($event)"></th>

            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-clientData>
            <tr [pSelectableRow]="true" (click)="loadClientDetails(clientData)">
              <td>{{ utilService.getFullName(clientData)  }}</td>
              <td>{{ clientData.emailAddress }}</td>
              <td>{{ clientData.phoneNumber }}</td>
              <td>{{ clientData.idNumber }}</td>
              <td>{{ clientData.pinNumber }}</td>
              <td>{{ clientData.id }}</td>


            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="4">{{ 'gis.quotation.no_client_found' | translate }}</td>
            </tr>
          </ng-template>
        </p-table>


        <br>
      </div>


    </div>
  </div>
</div>

