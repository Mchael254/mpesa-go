<div class="container">
    <p class="titleMain mt-3">Quotations: Quotation Data Entry</p>
    <app-stepper [currentStep]="1" [stepperData]="steps"></app-stepper>
    <div class="container mx-2 mt-n1">
        <div class="card mb-3" style=" position: relative;">
            <ngx-spinner name="quickQuoteScreen" type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B"
                size="medium" bdColor="rgba(255, 255, 255, 0.9)"></ngx-spinner>
            <div class="card-body">
                <div class="d-inline me-4">
                    <input class="form-check-input me-2 mt-2" (click)="toggleNewClient()" type="radio"
                        name="flexRadioDefault" id="flexRadioDefault2" [checked]="isNewClient">
                    <label class="form-check-label mb-4 mt-2" for="flexRadioDefault2">
                        New Client
                    </label>
                </div>
                <div class="d-inline ms-4">
                    <input class="form-check-input me-2 ms-4 mt-2" (click)="toggleButton()" type="radio"
                        name="flexRadioDefault" id="flexRadioDefault1" [checked]="!isNewClient">
                    <label class="form-check-label mb-4 mt-2" for="flexRadioDefault1">
                        Existing Client
                    </label>
                </div>
                



                <!-- ROW 1 -->
                <div class="row mb-4">
                    <div class="col-sm-4 col-6" *ngIf="!new">
                        <label for="name" class="required quote-label" id="name">Name</label>
                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1 "
                            [(ngModel)]="clientName">
                    </div>
                    <div class=" col-sm-4 col-6" *ngIf="new">
                        <label for="Client" class="required quote-label" id="Client">Client</label>
                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            data-bs-toggle="modal" data-bs-target="#clientModal" [(ngModel)]="clientName"
                            autocomplete="off" [attr.disabled]="clientName ? true : null">

                    </div>
                    <div class=" col-sm-4 col-6 " *ngIf="!new">
                        <label for="Email" class="quote-label" id="Email">Email Address</label>
                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="clientEmail">
                    </div>


                    <div class="col-sm-4 col-6 " *ngIf="new">
                        <label for=">Email" class="quote-label" id=">Email">Email Address</label>
                        <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                            [(ngModel)]="clientEmail" disabled>
                    </div>
                    <div class="col-sm-4 col-6" *ngIf="!new">
                        <label for="Phone" class="quote-label" id="Phone">Phone Number</label>
                        <!-- <input type="text" id="quote-input" class="form-control form-control-sm mb-1" [(ngModel)]="clientPhone">      -->
                        <div class="input-group">
                            <select id="zipDropdown">
                                <option *ngFor="let country of countryList" [value]="country.id" readonly>{{
                                    country.zipCodeString }}</option>
                            </select>
                            <input type="tel" id="zip-quote-input" class="form-control form-control-sm mb-1"
                                [(ngModel)]="clientPhone">
                        </div>




                    </div>
                    <div class="col-sm-4 col-6" *ngIf="new">
                        <label for="Phone" class="quote-label" id="Phone">Phone Number</label>
                        <!-- <input type="text" id="quote-input" class="form-control form-control-sm mb-1" [(ngModel)]="clientPhone">      -->
                        <div class="input-group">
                            <!-- <select id="zipDropdown" >
                                    <option *ngFor="let mobile of filteredCountry" [value]="mobile.code" >{{ mobile.mobilePrefix }}</option>
                                </select> -->
                            <!-- <select id="zipDropdown" [(ngModel)]="mobilePrefix">
                                    <option *ngFor="let mobile of filteredCountry" [value]="mobile.code">{{ mobile.zipCode }}</option>
                                </select> -->
                            <input type="text" id="zip-quote-input"
                                class="form-control form-control-sm mb-1 custom-width-20" [(ngModel)]="mobilePrefix"
                                disabled>

                            <input type="number" id="zip-quote-input"
                                class="form-control form-control-sm mb-1 custom-width-80" [(ngModel)]="clientPhone"
                                disabled>
                        </div>




                    </div>


                </div>


                <form [formGroup]="personalDetailsForm" class="mb-3">

                    <!-- ROW 2 -->
                    <div class="row mb-4">
                        <div class="col-sm-4 col-6 ">
                            <label class="required quote-label" for="Source" id="Source">Source</label>
                            <select class="form-select form-control-sm mb-1 ms-n4" id="quote-input"
                                formControlName="source" (change)="onSourceSelected($event)">
                                <option value=""></option>
                                <option *ngFor="let source of sourceDetail" [value]="source.code">{{ source.description
                                    | sentenceCase}}</option>
                            </select>
                            <!-- Display error message under the "Source" field -->
                            <div *ngIf="personalDetailsForm.get('source').hasError('required') && personalDetailsForm.get('source').touched"
                                class="form-text text-danger">
                                Source is required.
                            </div>
                        </div>
                        <div class="col-sm-4 col-6" *ngIf="!new">
                            <label for="Branch" class="quote-label" id="Branch">Branch</label>
                            <!-- <input type="text" id="quote-input" class="form-control form-control-sm mb-1" formControlName="branchCode"  [(ngModel)]="userBranchId"  >      -->

                            <select class="form-select form-control-sm mb-1 ms-n4" id="quote-input"
                                formControlName="branchCode">
                                <option *ngFor="let branch of branchList" [value]="branch.id">{{branch.name   | sentenceCase}}</option>
                                <option></option>
                            </select>

                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('branchCode').hasError('required') && personalDetailsForm.get('branchCode').touched"
                                class="form-text text-danger">
                                Branch is required.
                            </div>
                        </div>
                        <div class="col-sm-4 col-6" *ngIf="new">
                            <label for="Branch" class="quote-label" id="Branch">Branch</label>
                            <!-- <input type="text" id="quote-input" class="form-control form-control-sm mb-1"  formControlName="branchCode"[(ngModel)]="userBranchId "  >      -->
                            <input type="text" id="quote-input" class="form-control form-control-sm mb-1"
                                formControlName="branchCode" [value]="userBranchId " [(ngModel)]="userBranchName"
                                readonly>

                        </div>
                        <div class="col-sm-4 col-6">
                            <label for="product" class="quote-label" id="product">Product</label><br>
                            <p-dropdown formControlName="productCode" [options]="ProductDescriptionArray"
                                optionLabel="description" (onChange)="onProductSelected($event.value)" placeholder=" " 
                                [filterBy]="'description'" [filter]="true"></p-dropdown>

                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('productCode').hasError('required') && personalDetailsForm.get('productCode').touched"
                                class="form-text text-danger">
                                Product is required.
                            </div>
                        </div>

                    </div>
                    <!-- ROW 3 -->
                    <div class="row mb-4">
                        <div class="col-sm-4 col-6">
                            <label for="use-of-property" class="quote-label" id="use-of-property">Use of
                                property</label>
                            <select class="form-select form-control-sm" id="quote-input"
                                (change)="onSubclassSelected($event)">
                                <option value=""></option>
                                <option *ngFor="let subclass of allMatchingSubclasses" [value]="subclass.code">
                                    {{subclass.description | sentenceCase}}</option>
                            </select>
                        </div>
                        <div class="col-sm-4 col-6">
                            <label for="binder" class="quote-label" id="binder">Binder</label>
                            <select class="form-select form-control-sm mb-1 ms-n4" id="quote-input"
                                formControlName="bindCode" (change)="onSelectBinder($event)">
                                <option></option>
                                <option *ngFor="let binder of binderListDetails" [value]="binder.code">{{
                                    binder.binder_short_description | sentenceCase }}</option>
                            </select>
                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('bindCode').hasError('required') && personalDetailsForm.get('bindCode').touched"
                                class="form-text text-danger">
                                Binder is required.
                            </div>
                        </div>
                        <div class="col-sm-4 col-6">
                            <label for="cover-From" class="quote-label" id="cover-From">Cover From</label>
                            <!-- <input type="date" id="quote-input" class="form-control form-control-sm mb-1" formControlName="withEffectiveFromDate"> -->
                            <input type="date" id="cover-from" class="form-control form-control-sm mb-1"
                                formControlName="withEffectiveFromDate" [(ngModel)]="coverFromDate"
                                (ngModelChange)="getCoverToDate()">
                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('withEffectiveFromDate').hasError('required') && personalDetailsForm.get('withEffectiveFromDate').touched"
                                class="form-text text-danger">
                                Cover From is required.
                            </div>
                        </div>


                    </div>
                    <!-- ROW 4 -->
                    <div class="row mb-4">
                        <div class="col-sm-4 col-6">
                            <label for="cover-To" class="quote-label" id="cover-To">Cover To</label>
                            <!-- <input type="date" id="quote-input" class="form-control form-control-sm mb-1" formControlName="withEffectiveToDate">     -->
                            <input type="date" id="cover-to" class="form-control form-control-sm mb-1"
                                formControlName="withEffectiveToDate" [(ngModel)]="passedCoverToDate">
                            <!-- Display error message under the field -->
                            <div *ngIf="personalDetailsForm.get('withEffectiveToDate').hasError('required') && personalDetailsForm.get('withEffectiveToDate').touched"
                                class="form-text text-danger">
                                Cover To is required.
                            </div>
                        </div>
                        <div class="col-sm-4 col-6">
                            <label for="currency" class="required quote-label" id="currency">Currency</label>

                            <input class="form-control form-control-sm mb-1 ms-n4" id="quote-input"
                                formControlName="currencyCode" [value]="selectedCurrency | sentenceCase" readonly>
                            <!-- Display error message under the field -->
                            <!-- <div *ngIf="personalDetailsForm.get('currencyCode').hasError('required') && personalDetailsForm.get('currencyCode').touched"
                                class="form-text text-danger">
                                Currency is required.
                            </div> -->
                        </div>

                    </div>

                    <!-- ROW 5 -->
                    <div *ngIf="formData && selectedProductCode" class="row">
                        <div class="col-12 ">
                            <!-- <p id="productSpecificLabel">Product Specific Form Fields</p> -->
                            <div class="row">
                                <div class="col-sm-4 col-6" *ngFor="let field of formData">
                                    <form [formGroup]="dynamicForm">
                                        <div
                                            *ngIf="field.name !== 'yearOfManufacture' && field.name !== 'selfDeclaredValue' && field.name !== 'carRegNo'">
                                            <label class="quote-label" [for]="field.name">{{ field.label }}</label>
                                            <input [type]="field.type" [formControlName]="field.name" id="quote-input"
                                                class="form-control form-control-sm mb-1 col-md-8">
                                        </div>
                                        <div *ngIf="field.name == 'yearOfManufacture'">
                                            <label class="quote-label" [for]="field.name">{{ field.label }}</label>
                                            <select id="yearOfManufacture" id="quote-input"
                                                class="form-select form-control-sm mb-1">
                                                <option *ngFor="let year of years" [value]="year">{{ year }}</option>
                                            </select>
                                        </div>
                                        <div *ngIf="field.name == 'selfDeclaredValue'">
                                            <label class="quote-label" [for]="field.name">{{ field.label }}</label>
                                            <input type="text" id="quote-input"
                                                class="form-control form-control-sm mb-1" [formControlName]="field.name"
                                                appCommaFormat>
                                        </div>
                                        <div *ngIf="field.name == 'carRegNo'">
                                            <label class="quote-label" [for]="field.name">{{ field.label }}</label>
                                            <input type="text" id="carRegNo" class="form-control form-control-sm mb-1"
                                                [formControlName]="field.name" [(ngModel)]="carRegNoValue"
                                                (blur)="validateCarRegNo()" placeholder="e.g KCA 345R">

                                            <div *ngIf="carRegNoHasError" class="form-text text-danger">
                                                Please enter a valid car registration number.
                                            </div>
                                            <!-- <div *ngIf="field.name == 'carRegNo'">
                                                <div *ngIf="dynamicForm.get(field.name)?.invalid && (dynamicForm.get(field.name)?.dirty || dynamicForm.get(field.name)?.touched)" class="form-text text-danger">
                                                  <div *ngIf="dynamicForm.get(field.name)?.hasError('patternError')">Input the valid pattern</div>
                                                </div>
                                              </div> -->





                                        </div>


                                    </form>
                                </div>
                            </div>


                        </div>
                    </div>

                    <!-- Client Modal -->
                    <div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">

                                <div class="modal-body">
                                    <button type="button" #closebutton class="float-end btn-close"
                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                    <p class="text-start" id="selectClient">Select Client</p>

                                    <p-table #dt1 [value]="clientData" [tableStyle]="{'max-width': '465px'}"
                                        selectionMode="single" [resizableColumns]="true" styleClass="p-datatable-sm"
                                        responsiveLayout="scroll" class='ui-datatable' [autoLayout]="true"
                                        [paginator]="true" [rows]="5" [scrollable]="true" scrollDirection="horizontal"
                                        [showCurrentPageReport]="true"
                                        currentPageReportTemplate=" {first} - {last} of {totalRecords}"
                                        [globalFilterFields]="['idNumber', 'emailAddress','lastName','emailAddress']">
                                        <ng-template pTemplate="caption">

                                            <div class="flex">
                                                <span class="p-input-icon-left ml-auto">
                                                    <i class="pi pi-search search-icon"></i>
                                                    <input class="search-input" pInputText type="text"
                                                        (input)="applyFilterGlobal($event, 'contains')"
                                                        placeholder="Search" />
                                                </span>
                                            </div>


                                        </ng-template>
                                        <ng-template pTemplate="header">

                                            <tr id="product">
                                                <th>Id no</th>
                                                <th>Name</th>
                                                <th>Email</th>

                                            </tr>
                                        </ng-template>

                                        <ng-template let-clientData pTemplate="body">
                                            <tr id="productData" [pSelectableRow]=""
                                                (click)="loadClientDetails(clientData.id);">

                                                <td>
                                                    {{clientData.idNumber}}
                                                </td>
                                                <td>
                                                    {{clientData.firstName+" "+clientData.lastName}}
                                                </td>
                                                <td>
                                                    {{clientData.emailAddress}}
                                                </td>
                                            </tr>
                                        </ng-template>
                                        <ng-template pTemplate="paginatorleft">
                                            <p-button type="button" styleClass="p-button-text"></p-button>
                                        </ng-template>
                                        <ng-template pTemplate="paginatorright">
                                            <p-button type="button" styleClass="p-button-text"></p-button>
                                        </ng-template>
                                    </p-table>
                                    <br>
                                    <!-- <button class="btn btn-primary float-end" data-bs-dismiss="modal" (click)="saveclient()">Save Details</button> -->
                                </div>



                            </div>
                        </div>
                    </div>

                </form>

            </div>
        </div>
        <div class="row ">
            <div class="col-6"></div>
            <div class="col-6 d-flex justify-content-end">
                <button type="button" class="btn btn-outline-primary btn-lg" id="compute"
                    (click)="computePremiumV2();">Compute</button>
            </div>
        </div>
    </div>
</div>
<br>
<br><br><br><br>