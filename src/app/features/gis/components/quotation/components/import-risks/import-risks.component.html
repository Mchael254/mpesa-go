<div class="">

  <div class="card">
    <div class="card-body">

      <div class="row mb-4">
        <div class="col-md-4">
          <label for="" class="quote-label required mb-2">Subclass</label>
          <p-dropdown [options]="allMatchingSubclasses" optionLabel="description" optionValue="code"
            formControlName="subclass" [style]="{'width':'100%', 'height':'30px'}"
            [panelStyle]="{'width':'400px', 'max-height':'100%'}" styleClass="form-control form-control-sm "
            id="quote-input" [filter]="true" [filterBy]="'description'" (onChange)="onSubclassChange($event)">
          </p-dropdown>
        </div>

        <div class="col-md-5 mt-1">
          <!-- <label for="inputProfileImg" style="margin-right: 15px;margin-left: 20px;">Download template</label>
          <input type="file" id="inputProfileImg" (change)="onFileChange($event)" formControlName="uploadFile" hidden />
          <label for="inputProfileImg" class="img_upload" style="margin-right: 15px;margin-top: 5px;">Choose
            File</label> -->

          <!-- <button *ngIf="subclassSelected" class="btn btn--primary" (click)="exportTemplate()">Download
            template</button> -->
          <span pTooltip="Select a subclass to continue" tooltipPosition="top" [tooltipDisabled]="subclassSelected">
            <!-- only disable tooltip when button is active -->

            <button class="btn btn-primary btn-sm btn-greyed-out mt-4" [class.disabled]="!subclassSelected"
              [disabled]="!subclassSelected" (click)="exportTemplate()">
              Download template
            </button>
          </span>



        </div>
        <div class="col-md-3">
        </div>
      </div>
      <!-- <div class="upload-area mt-2 mb-1" (click)="fileInput.click()" [class.dragover]="isDragging"
        (drop)="onDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"> -->
      <div class="upload-area mt-2 mb-1" (click)="!selectedSubclassCode ? null : fileInput.click()"
        [class.dragover]="isDragging" (drop)="selectedSubclassCode ? onDrop($event) : $event.preventDefault()"
        (dragover)="selectedSubclassCode ? onDragOver($event) : $event.preventDefault()"
        (dragleave)="selectedSubclassCode ? onDragLeave($event) : null" [class.disabled]="!selectedSubclassCode">

        <div class="upload-content">
          <i class="pi pi-upload upload-icon"></i>

          <p class="upload-text">Click this area to upload Log
            book</p>

          <p class="upload-subtext">Maximum file size 10MB</p>
        </div>

        <input #fileInput type="file" (change)="onFileChange($event)"
          accept=".pdf,.doc,.docx,.txt,.log,.jpg,.jpeg,.png" style="display: none;" [disabled]="!selectedSubclassCode">
        <div class="selected-file" *ngIf="selectedFile">
          <i [ngClass]="getFileIcon(selectedFile.name)" class="file-icon"></i>
          <span class="file-name">{{ selectedFile.name }}</span>

          <button class="remove-btn" (click)="removeFile()" aria-label="Remove">
            <i class="pi pi-trash"></i>
          </button>
        </div>


      </div>
      <p class="title">Imported risks</p>
      <p-table [value]="data" [resizableColumns]="true" styleClass="p-datatable-sm" class='ui-datatable'
        [(selection)]="selectedRisks" (selectionChange)="onSelectionChange($event)"
        [tableStyle]="{ 'min-width': '50rem' }">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem">
              <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
            </th>
            <th>Client Id</th>
            <th>Client names</th>
            <th>WEF</th>
            <th>WET</th>
            <th>Premium Band</th>
            <th>Risk Id</th>
            <th>Risk description</th>
            <th>Cover</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-row>
          <tr>
            <td>
              <p-tableCheckbox [value]="row"></p-tableCheckbox>
            </td>
            <td>{{ row.ClientCode }}</td>
            <td>{{ row.ClientName }}</td>
            <td>{{ row.WEF }}</td>
            <td>{{ row.WET }}</td>
            <td>{{ row.PremiumBind }}</td>
            <td>{{ row.PropertyId }}</td>
            <td>{{ row.ItemDesc }}</td>
            <td>{{ row.CoverTypeShortDesc }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9" style="padding:50px; text-align: center;" id="empty">No records found</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="summary" *ngIf="data && data.length > 0">
          <div class="d-flex justify-content-end">
            <span>{{selectedCount}} of {{data.length}} risks selected</span>
          </div>
        </ng-template>
      </p-table>





      <!-- Mapping Modal -->
      <div *ngIf="showMappingModal" class="modal-overlay">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Map Your Columns</h3>
            <p>Please match your file columns to the system fields.</p>
          </div>

          <div class="modal-body">
            <table class="mapping-table">
              <thead>
                <tr>
                  <th>System Field</th>
                  <th>Your File Column</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let field of systemFields">
                  <td>
                    {{ field.label }}
                    <span class="required-asterisk" *ngIf="field.required">*</span>
                  </td>
                  <td>
                    <select [value]="mapping[field.key]" #selectEl (change)="updateMapping(field.key, selectEl.value)">
                      <option [value]="''">-- Don't Map --</option>
                      <option *ngFor="let header of userFileHeaders" [value]="header">
                        {{ header }}
                      </option>
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Data Preview -->
            <div *ngIf="userFileData.length > 0" class="data-preview">
              <h4>Data Preview (First 3 rows):</h4>
              <table>
                <thead>
                  <tr>
                    <th *ngFor="let header of userFileHeaders">{{ header }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of userFileData.slice(0, 3)">
                    <td *ngFor="let header of userFileHeaders">{{ row[header] }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="onMappingCancelled()">
              Cancel
            </button>
            <button type="button" class="btn btn-primary" (click)="onMappingConfirmed()">
              Confirm Mapping
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
  <button class="btn btn-primary float-end mt-4" (click)="finish()">Finish</button>
</div>