<div class="">

  <div class="card">
    <div class="card-body">

      <div class="row mb-4">
        <div class="col-md-4">
          <label for="" class="quote-label required mb-2">Subclass</label>
          <p-dropdown [options]="allMatchingSubclasses" optionLabel="description" optionValue="code"
            formControlName="subclass" [style]="{'width':'100%', 'height':'30px'}"
            [panelStyle]="{'width':'400px', 'max-height':'100%'}" styleClass="form-control form-control-sm "
            id="quote-input" [filter]="true" [filterBy]="'description'" (onChange)="onSubclassChange($event)">
          </p-dropdown>
        </div>

        <div class="col-md-5 mt-1">
          <!-- <label for="inputProfileImg" style="margin-right: 15px;margin-left: 20px;">Download template</label>
          <input type="file" id="inputProfileImg" (change)="onFileChange($event)" formControlName="uploadFile" hidden />
          <label for="inputProfileImg" class="img_upload" style="margin-right: 15px;margin-top: 5px;">Choose
            File</label> -->

          <!-- <button *ngIf="subclassSelected" class="btn btn--primary" (click)="exportTemplate()">Download
            template</button> -->
          <span pTooltip="Select a subclass to continue" tooltipPosition="top" [tooltipDisabled]="subclassSelected">
            <!-- only disable tooltip when button is active -->

            <button class="btn btn-primary btn-sm btn-greyed-out mt-4" [class.disabled]="!subclassSelected"
              [disabled]="!subclassSelected" (click)="exportTemplate()">
              Download template
            </button>
          </span>



        </div>
        <div class="col-md-3">
        </div>
      </div>
      <!-- <div class="upload-area mt-2 mb-1" (click)="fileInput.click()" [class.dragover]="isDragging"
        (drop)="onDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"> -->

      <div class="upload-area mt-2 mb-4" (click)="!selectedSubclassCode ? null : fileInput.click()"
        [class.dragover]="isDragging" (drop)="selectedSubclassCode ? onDrop($event) : $event.preventDefault()"
        (dragover)="selectedSubclassCode ? onDragOver($event) : $event.preventDefault()"
        (dragleave)="selectedSubclassCode ? onDragLeave($event) : null" [class.disabled]="!selectedSubclassCode">

        <div class="upload-content">
          <i class="pi pi-upload upload-icon"></i>

          <p class="upload-text">Click this area to upload file</p>

          <p class="upload-subtext">Maximum file size 10MB</p>
        </div>

        <input #fileInput type="file" (change)="onFileSelected($event)" accept=".csv,.xls,.xlsx" style="display: none;">
        <div class="selected-file" *ngIf="selectedFile">
          <i [ngClass]="getFileIcon(selectedFile.name)" class="file-icon"></i>
          <span class="file-name">{{ selectedFile.name }}</span>

          <button class="remove-btn" (click)="removeFile()" aria-label="Remove">
            <i class="pi pi-trash"></i>
          </button>
        </div>

      </div>
      <div *ngIf="showImportedRiskTable">
        <div class="d-flex justify-content-between align-items-center ">

          <!-- LEFT: Tabs -->
          <ul class="nav nav-tabs" id="riskTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#allRisksTab" type="button"
                (click)="activeTab = 'ALL'">
                All risks
              </button>
            </li>

            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#validTab" type="button"
                (click)="activeTab = 'VALID'">
                Valid
              </button>
            </li>

            <li class="nav-item" role="presentation">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reviewTab" type="button"
                (click)="activeTab = 'REVIEW'">
                Needs review
              </button>
            </li>
          </ul>

          <!-- RIGHT: Buttons -->
          <div>
            <button *ngIf="activeTab === 'ALL'" class="btn btn-primary me-2" (click)="validateImportedRisk()">
              Validate
            </button>

         <button class="btn btn-primary" 
        [disabled]="isBulkDeleting"
        (click)="deleteSelectedRisks()">
  <i *ngIf="isBulkDeleting" class="pi pi-spin pi-spinner me-2"></i>
  {{ isBulkDeleting ? 'Deleting...' : 'Delete' }}
</button>

          </div>

        </div>

        <div class="tab-content ">

          <!-- ALL risks  TAB -->
          <div class="tab-pane fade show active" id="allRisksTab" role="tabpanel">
            <p-table [value]="allRisks" [resizableColumns]="true" [(selection)]="selectedAll"
              [paginator]="allRisks?.length > 10" [rowsPerPageOptions]="[10, 20, 100]" [rows]="10"
              (selectionChange)="onRiskSelectionChange($event)">
              <ng-template pTemplate="header">
                <tr>
                  <th>
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                  </th>
                  <th>Insured </th>
                  <th>Risk ID</th>
                  <th>Risk description</th>
                  <th>Cover type</th>
                  <th>Premium Band</th>
                  <th>Cover from</th>
                  <th>Cover to</th>
                  <th style="width:120px; text-align:center;">Actions</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row>
                <tr>
                  <td><p-tableCheckbox [value]="row"></p-tableCheckbox></td>
                  <td>{{ row.insuredName | sentenceCase }}</td>
                  <td>{{ row.propertyId | sentenceCase }}</td>
                  <td>{{ row.riskDescription | sentenceCase }}</td>
                  <td>{{ row.coverType | sentenceCase}}</td>
                  <td>{{ row.binderCode }}</td>
                  <td>{{ row.withEffectFrom }}</td>
                  <td>{{ row.withEffectTo }}</td>
        <!-- ACTION BUTTONS -->
<td style="text-align:center;">
  <!-- Edit button -->
  <button 
    class="text-button" 
    >
    Edit
  </button>

  <!-- Delete button -->
  <button 
    class="text-button" 
    [disabled]="isSingleDeleting"
    (click)="deleteSingleRisk(row)">
    Delete
  </button>
</td>

        

                </tr>
              </ng-template>
            </p-table>
          </div>


          <!-- VALID TAB -->
          <div class="tab-pane fade" id="validTab" role="tabpanel">
            <p-table [value]="validRisks" [resizableColumns]="true" [(selection)]="selectedValid"
              (selectionChange)="onRiskSelectionChange($event)">
              <ng-template pTemplate="header">
                <tr>
                  <th><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
                  <th>Insured</th>
                  <th>Risk ID</th>
                  <th>Risk Description</th>
                  <th>Cover Type</th>
                  <th>Premium Band</th>
                  <th>Cover From</th>
                  <th>Cover To</th>
                  <th style="width:120px; text-align:center;">Actions</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row>
                <tr>
                  <td><p-tableCheckbox [value]="row"></p-tableCheckbox></td>
                  <td>{{ row.ClientCode }}</td>
                  <td>{{ row.ClientName }}</td>
                  <td>{{ row.WEF }}</td>
                  <td>{{ row.WET }}</td>
                  <td>{{ row.PremiumBind }}</td>
                  <td>{{ row.PropertyId }}</td>
                  <td>{{ row.ItemDesc }}</td>
                  <td>{{ row.CoverTypeShortDesc }}</td>

               <td style="text-align:center;">
  <!-- Edit button -->
  <button 
    class="text-button" 
    >
    Edit
  </button>

  <!-- Delete button -->
  <button 
    class="text-button" 
    [disabled]="isSingleDeleting"
    (click)="deleteSingleRisk(row)">
    Delete
  </button>
</td>
                </tr>
              </ng-template>
            </p-table>

          </div>


          <!-- NEEDS REVIEW TAB -->
          <div class="tab-pane fade" id="reviewTab" role="tabpanel">
            <p-table [value]="needsReviewRisks" [resizableColumns]="true" [(selection)]="selectedReview"
              (selectionChange)="onRiskSelectionChange($event)">
              <ng-template pTemplate="header">
                <tr>
                  <th><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
                  <th>Insured</th>
                  <th>Risk ID</th>
                  <th>Risk Description</th>
                  <th>Cover Type</th>
                  <th>Premium Band</th>
                  <th>Cover From</th>
                  <th>Cover To</th>
                  <th style="width:120px; text-align:center;">Actions</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-row>
                <tr>
                  <td><p-tableCheckbox [value]="row"></p-tableCheckbox></td>

                  <td>{{ row.ClientCode }}</td>
                  <td>{{ row.ClientName }}</td>
                  <td>{{ row.WEF }}</td>
                  <td>{{ row.WET }}</td>
                  <td>{{ row.PremiumBind }}</td>
                  <td>{{ row.PropertyId }}</td>
                  <td>{{ row.ItemDesc }}</td>
                  <td>{{ row.CoverTypeShortDesc }}</td>

              <td style="text-align:center;">
  <!-- Edit button -->
  <button 
    class="text-button" 
    >
    Edit
  </button>

  <!-- Delete button -->
  <button 
    class="text-button" 
    [disabled]="isSingleDeleting"
    (click)="deleteSingleRisk(row)">
    Delete
  </button>
</td>
                </tr>
              </ng-template>
            </p-table>

          </div>

        </div>

      </div>

      <!-- Mapping Modal -->
      <div *ngIf="showMappingModal" class="modal-overlay">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Map Your Columns</h3>
            <p>Please match your file columns to the system fields.</p>
          </div>

          <div class="modal-body">
            <table class="mapping-table">
              <thead>
                <tr>
                  <th>System Field</th>
                  <th>Your File Column</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let field of systemFields">
                  <td>
                    {{ field.label }}
                    <span class="required-asterisk" *ngIf="field.required">*</span>
                  </td>
                  <td>
                    <select [value]="mapping[field.key]" #selectEl (change)="updateMapping(field.key, selectEl.value)">
                      <option [value]="''">-- Don't Map --</option>
                      <option *ngFor="let header of userFileHeaders" [value]="header">
                        {{ header }}
                      </option>
                    </select>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Data Preview -->
            <div *ngIf="userFileData.length > 0" class="data-preview">
              <h4>Data Preview (First 3 rows):</h4>
              <table>
                <thead>
                  <tr>
                    <th *ngFor="let header of userFileHeaders">{{ header }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of userFileData.slice(0, 3)">
                    <td *ngFor="let header of userFileHeaders">{{ row[header] }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="onMappingCancelled()">
              Cancel
            </button>
            <button type="button" class="btn btn-primary" (click)="onMappingConfirmed()">
              Confirm Mapping
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
  <button *ngIf="activeTab === 'VALID'" class="btn btn-primary float-end mt-4">Save</button>
</div>