<div class="container">
  <div class="breadcrumb-custom">
    {{ "fms.receipting.finance" | translate }} > CB-Receipting >
    {{ "base.Receipting" | translate }} >
    <span class="breadcrumb-text">{{
      "fms.receipting.receiptCapture" | translate
    }}</span>
  </div>
  <!-- Main Form -->
  <div class="main-form">
    <!-- <div class="scroll-container bg-white" > -->
    <form [formGroup]="receiptingDetailsForm">
      <h5 class="form-title">
        {{ "fms.receipting.capture_receipt" | translate }}
      </h5>

      <div class="row">
        <div class="col-md-4 mb-2">
          <label for="currency" class="form-label required">
            {{ "fms.receipting.currency" | translate }}
          </label>

          <select
            class="form-select"
            id="currency"
            formControlName="currency"
            (change)="onCurrencyChanged($event)"
          >
            <option *ngFor="let currency of currencies" [value]="currency.id">
              {{ currency?.symbol }}
            </option>
          </select>

          <!-- Display exchange rate if available -->
          <div
            *ngIf="exchangeRateText && isdefaultCurrencySelected"
            class="exchange-rate-text mt-2"
          >
            {{ exchangeRate }} {{ defaultCurrencyName }} = 1{{
              selectedCurrencySymbol
            }}
            <span
              class="text-primary edit-link"
              (click)="showExchangeRateModal2()"
              >edit</span
            >
          </div>
        </div>

        <div class="col-md-4 mb-2">
          <label for="paymentMode" class="form-label required">{{
            "fms.receipting.payment_mode" | translate
          }}</label>
          <!-- <div class="dropdown-container" (mouseleave)="onLeavePaymentMode()"> -->
          <!-- Only hides if no selection is made -->
          <select
            id="paymentMode"
            class="form-select"
            formControlName="paymentMode"
            (change)="onPaymentModeSelected($event)"
            (mouseover)="onHoverPaymentMode($event)"
          >
            <option
              *ngFor="let paymentMode of paymentModes"
              [value]="paymentMode.code"
            >
              {{ paymentMode.code }}
            </option>
          </select>

          <div
            *ngIf="showChequeOptions"
            class="cheque-options"
            (mouseleave)="onLeaveChequeOptions()"
          >
            <div (click)="setChequeType('open_cheque')">
              <span class="chequeTypeText">Normal Cheque</span>
            </div>
            <div (click)="setChequeType('post_dated_cheque')">
              <span class="chequeTypeText">Pd Cheque</span>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-2">
          <label for="bankAccount" class="form-label required"
            >{{ "fms.receipting.bank_account" | translate }}
          </label>

          <select
            id="bankAccount"
            class="form-select"
            formControlName="bankAccount"
            (change)="onBank($event)"
          >
            <option value="" [disabled]="">
              {{ "fms.receipting.select" | translate }}
            </option>
            <option *ngFor="let bank of bankAccounts" [value]="bank.code">
              {{ bank.name }}
            </option>
          </select>
        </div>
      </div>
      <!-- Second Row -->

      <div class="row mt-1">
        <div class="col-md-4 mb-2">
          <label for="receiptingPoint" class="form-label">{{
            "fms.receipting.receipting_point" | translate
          }}</label>
          <input
            type="text"
            class="form-control"
            id="receiptingPoint"
            formControlName="receiptingPoint"
            readonly
          />
        </div>
        <div class="col-md-4 mb-2">
          <label for="drawersBank" class="form-label"
            >{{ "fms.receipting.drawers_bank" | translate }}
          </label>

          <select
            id="drawersBank"
            class="form-select"
            formControlName="drawersBank"
          >
            <option *ngFor="let bank of drawersBanks" [value]="bank.name">
              {{ bank.name }}
            </option>
          </select>
        </div>
        <div class="col-md-4 mb-2">
          <label for="amountIssued" class="form-label required">{{
            "fms.receipting.amount_issued" | translate
          }}</label>

          <input
            type="number"
            class="form-control"
            id="amountIssued"
            formControlName="amountIssued"
          />
        </div>
      </div>

      <!-- Third Row -->
      <div class="row mt-1">
        <div class="col-md-4 mb-2">
          <label for="receiptDate" class="form-label required">{{
            "fms.receipting.receipt_date" | translate
          }}</label>
          <div class="date-input">
            <input
              type="date"
              class="form-control"
              id="receiptDate"
              formControlName="receiptDate"
              [min]="minDate"
              [max]="maxDate"
              [disabled]="!backdatingEnabled && minDate === ''"
            />
          </div>
        </div>
        <div class="col-md-4 mb-2">
          <label for="documentDate" class="form-label">{{
            "fms.receipting.document_date" | translate
          }}</label>
          <div class="date-input">
            <input
              type="date"
              class="form-control"
              id="documentDate"
              formControlName="documentDate"
            />
          </div>
        </div>
        <div class="col-md-4 mb-2">
          <label for="receivedFrom" class="form-label required">{{
            "fms.receipting.received_from" | translate
          }}</label>
          <input
            type="text"
            class="form-control"
            id="receivedFrom"
            formControlName="receivedFrom"
          />
        </div>
      </div>
      <!-- </div> -->
      <!-- Fourth Row -->

      <div class="row mt-1">
        <div class="col-md-4 mb-2">
          <label for="manualRef" class="form-label">{{
            "fms.receipting.manual_ref" | translate
          }}</label>
          <input
            type="text"
            class="form-control"
            id="manualRef"
            formControlName="manualRef"
          />
        </div>
        <div class="col-md-4 mb-2">
          <label for="paymentRef" class="form-label">{{
            "fms.receipting.payment_ref" | translate
          }}</label>
          <input
            type="text"
            class="form-control"
            id="paymentRef"
            formControlName="paymentRef"
            placeholder="{{ 'fms.receipting.mpesaCode' | translate }},{{
              'fms.receipting.eftNo' | translate
            }},{{ 'fms.receipting.cheque' | translate }}"
          />
        </div>
        <!-- <div class="col-md-4">
                      <label for="otherRef" class="form-label">{{'fms.receipting.other_ref' | translate }}</label>
                      <input type="text" class="form-control" id="otherRef" formControlName="otherRef">
                       
                    </div> -->
        <!-- 5th row -->
        <div class="col-md-4 mb-2">
          <div class="form-group">
            <label for="narration" class="text-dark form-label w-100">
              {{ "fms.receipting.narration" | translate }}
              <span class="required"></span>
            </label>
            <div class="row g-2 align-items-start">
              <div class="col-3">
                <!-- Reduce width of select -->
                <select
                  id="narrationDropdown"
                  class="form-select"
                  (change)="onNarrationDropdownChange($event)"
                >
                  <option value="" disabled selected hidden></option>
                  <option
                    *ngFor="let narrate of narrations"
                    [value]="narrate?.narration"
                  >
                    {{ narrate?.narration }}
                  </option>
                </select>
              </div>
              <div class="col-9">
                <!-- Increase width of textarea -->
                <textarea
                  class="form-control"
                  rows="1"
                  id="narrationTextarea"
                  formControlName="narration"
                  placeholder="{{
                    'fms.receipting.editDescription' | translate
                  }}"
                  (input)="onNarrationTextChange()"
                ></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-1">
        <div class="col-md-4 mb-2">
          <div class="form-group">
            <label for="charges" class="form-label">{{
              "fms.receipting.charges" | translate
            }}</label
            ><br />
            <div class="m-3 me-5">
              <div class="d-flex">
                <div class="form-check">
                  <input
                    class="form-check-input ms-1"
                    type="radio"
                    name="charges"
                    id="chargesYes"
                    value="yes"
                    formControlName="charges"
                    (change)="onChargesChange('yes')"
                    (click)="showChargesModal()"
                  />
                  <label class="radio-label" for="chargesYes">{{
                    "fms.receipting.yes" | translate
                  }}</label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input ms-1"
                    type="radio"
                    name="charges"
                    id="chargesNo"
                    value="no"
                    formControlName="charges"
                    (change)="onChargesChange('no')"
                  />
                  <label class="radio-label" for="chargesNo">{{
                    "fms.receipting.no" | translate
                  }}</label>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-2">
          <label for="chargeAmount" class="form-label">{{
            "fms.receipting.chargeAmount" | translate
          }}</label>
          <input
            type="number"
            class="form-control"
            id="chargeAmount"
            formControlName="chargeAmount"
            readonly
          />
        </div>
        <!-- </div> -->
        <!-- Charges Modal -->
        <div
          class="modal fade"
          id="chargesModal"
          tabindex="-1"
          aria-labelledby="chargesModalLabel"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="chargesModalLabel">
                  Charges Details
                </h5>
                <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
              </div>

              <div class="modal-body">
                <form [formGroup]="receiptingDetailsForm">
                  <!-- Charge Type -->
                  <div class="form-group mb-3">
                    <label for="chargeType">Type</label>

                    <select
                      class="form-select"
                      id="chargeType"
                      formControlName="selectedChargeType"
                    >
                      <option
                        *ngFor="let charge of charges"
                        [value]="charge.name"
                      >
                        {{ charge.name }}
                      </option>
                    </select>
                  </div>

                  <!-- Charge Amount -->
                  <div class="form-group mb-2">
                    <label for="modalChargeAmount">Amount</label>
                    <input
                      type="number"
                      class="form-control"
                      id="chargeAmount"
                      formControlName="chargeAmount"
                    />
                  </div>
                </form>

                <!-- List of Existing Charges -->

                <div class="mt-4">
                  <h6>Existing Charges</h6>
                  <ul class="list-group">
                    <li
                      class="list-group-item d-flex justify-content-between align-items-center"
                      *ngFor="let charge of chargeList; let i = index"
                    >
                      <span
                        >{{ charge.receiptChargeName }} -
                        {{ charge.amount }}</span
                      >

                      <div>
                        <button
                          class="btn btn-sm btn-warning me-2"
                          (click)="editCharge(i)"
                        >
                          Edit
                        </button>
                        <button
                          class="btn btn-sm btn-danger"
                          (click)="deleteCharge(i)"
                        >
                          Delete
                        </button>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>

              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="saveCharges()"
                  *ngIf="isSaveBtnActive"
                >
                  Save
                </button>

                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="onEditSubmit()"
                  *ngIf="isSubmitButtonVisible"
                >
                  Submit
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Sixth Row -->

        <div class="col-md-4 mb-2">
          <label for="grossReceiptAmount" class="form-label">{{
            "fms.receipting.gross_receipt_amount" | translate
          }}</label>

          <input
            type="number"
            class="form-control"
            id="grossReceiptAmount"
            formControlName="grossReceiptAmount"
          />
        </div>
      </div>
      <div
        class="modal fade"
        id="exchangeRateModal2"
        tabindex="-1"
        role="dialog"
        aria-labelledby="exchangeRateLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog" role="document">
          <div class="modal-content p-3">
            <!-- Modal Header -->
            <div class="modal-header border-0">
              <h5
                class="modal-title fw-bold text-primary"
                id="exchangeRateLabel"
              >
                Exchange Rate
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
              <!-- Current Exchange Rate Display -->
              <p class="mb-3 text-muted">
                The current exchange rate:
                <strong
                  >1 {{ defaultCurrencyName }} = {{ exchangeRate }}
                  {{ selectedCurrencySymbol }}</strong
                >
                <span class="edit-icon">
                  <i
                    class="bi bi-pencil-square ms-2 text-primary"
                    role="button"
                  ></i>
                </span>
              </p>

              <!-- Input Field -->
              <div class="mb-3">
                <label for="exchangeRateInput" class="form-label fw-semibold"
                  >New rate</label
                >
                <input
                  type="number"
                  id="exchangeRateInput"
                  placeholder="Enter new exchange rate"
                  class="form-control"
                  min="0"
                  step="0.01"
                  formControlName="manualExchangeRate"
                />
              </div>

              <!-- Save Button -->
              <button
                type="button"
                class="btn btn-primary btn-sm"
                (click)="confirmExchangeRateValue()"
              >
                Save
              </button>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer border-0">
              <button
                type="button"
                class="btn btn-primary"
                (click)="closeModal2()"
              >
                Okay
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
    <!-- </div> -->
  </div>

  <!-- Action Buttons -->
  <div class="main-btn-div">
    <div class="btn-back">
      <button type="button" class="btn btn-link" (click)="onBack()">
        {{ "fms.receipting.back" | translate }}
      </button>
    </div>
    <div class="btn-actions">
      <button
        type="button"
        class="btn btn-primary-outline"
        (click)="clearForm()"
      >
        {{ "fms.receipting.clear" | translate }}
      </button>
      <button type="button" class="btn btn-primary" (click)="validateForm()">
        {{ "fms.receipting.next" | translate }}
      </button>
    </div>
  </div>
</div>
