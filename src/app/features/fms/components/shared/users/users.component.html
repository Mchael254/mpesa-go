<!-- start of p dialog>Main assignment dialog -->
<p-dialog
  header="Assign Task"
  [modal]="true"
  [(visible)]="assignDialogVisible"
  [style]="{ width: '420px' }"
>
  <form [formGroup]="usersForm">
    <!-- user selection input field -->
    <input type="hidden" formControlName="user" />
    <div class="form-group mb-3">
      <label for="userselect"
        >{{ "entities.user" | translate }}<span class="required"></span
      ></label>
      <div class="input-group" style="position: relative">
        <!-- This input is for display only. It shows the selected user's name. -->
        <input
          id="userselect"
          type="text"
          class="form-control"
          placeholder="Click to select a user"
          [value]="selectedUserForAssignment?.username"
          readonly
          (click)="openUserSelectDialog()"
        />
        <button type="button" (click)="openUserSelectDialog()" class="btn-icon">
          <i
            class="pi pi-angle-double-down"
            style="font-size: 1rem; color: #00529b"
          ></i>
        </button>
      </div>
    </div>

    <!-- Comments Textarea -->
    <div class="form-group mb-3">
      <label for="textarea" class="form-label">{{
        "entities.comment" | translate
      }}</label>
      <textarea
        id="textarea"
        class="form-control"
        rows="3"
        formControlName="comment"
      ></textarea>
    </div>
    <div class="modal-footer">
      <div class="d-flex flex-row gap-3">
        <button
          type="button"
          class="btn btn-outline-primary"
          (click)="closeAssignModal()"
        >
          {{ "fms.receipt-management.cancel" | translate }}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="reAssignBatch()"
          [disabled]="!selectedUserForAssignment"
          *ngIf="reAssign && !assign"
        >
          {{ "fms.banking.reAssign" | translate }}
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="assignReceipts()"
          [disabled]="!selectedUserForAssignment"
          *ngIf="assign && !reAssign"
        >
          {{ "fms.banking.assign" | translate }}
        </button>
      </div>
    </div>
  </form>
</p-dialog>

<!-- DIALOG 2: USER SELECTION TABLE DIALOG -->
<!-- baseZIndex ensures this dialog appears on top of the first one -->
<p-dialog
  header="Assign Task"
  [(visible)]="userSelectDialogVisible"
  [modal]="true"
  [style]="{ width: '700px' }"
  [baseZIndex]="10001"
>
  <p-table
    [value]="filteredUsers"
    [(selection)]="tempSelectedUser"
    selectionMode="single"
    dataKey="id"
    [paginator]="true"
    [rows]="5"
    sortMode="single"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    [currentPageReportTemplate]="currentReportTemplate"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="username">
          {{ "entities.username" | translate }}
          <p-sortIcon field="username"></p-sortIcon>
        </th>
        <th pSortableColumn="user">
          {{ "entities.user" | translate }}
          <p-sortIcon field="user"></p-sortIcon>
        </th>
      </tr>
      <!-- filter row -->
      <tr>
        <th>
          <input
            type="text"
            class="form-control"
            (input)="filterUsers($event, 'username')"
            (keyup.enter)="filterUsers($event, 'username')"
          />
        </th>
        <th>
          <input
            type="text"
            class="form-control"
            (input)="filterUsers($event, 'name')"
            (keyup.enter)="filterUsers($event, 'name')"
          />
        </th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-user>
      <tr [pSelectableRow]="user">
        <td>{{ user.username }}</td>
        <td>{{ user.name }}</td>
      </tr>
    </ng-template>
  </p-table>
  <div class="modal-footer mt-3">
    <div class="d-flex flex-row gap-3">
      <button
        type="button"
        class="btn btn-outline-primary"
        (click)="closeUserSelectDialog()"
      >
        {{ "crm.cancel" | translate }}
      </button>
      <!-- This button confirms the selection and closes this dialog -->
      <button
        type="button"
        class="btn btn-primary"
        (click)="confirmUserSelection()"
        [disabled]="!tempSelectedUser"
      >
        {{ "auth.save" | translate }}
      </button>
    </div>
  </div>
</p-dialog>
<!-- end of user selection modal -->
