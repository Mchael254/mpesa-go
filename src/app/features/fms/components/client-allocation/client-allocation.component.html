<div class="container-fluid">
  <div class="row me-4">
    <div class="col-8">
      <app-dynamic-breadcrumb
        [breadCrumbItems]="[
      {
        label: 'FMS',
        url: '/home/fms',
      },
      {
        label: this.translate.instant('fms.receipting.cbReceipting'),
        url: '/home/fms/',
      },
      {
        label: this.translate.instant('fms.receipting.receipting'),
        url: '/home/fms/',
      },
      {
        label: this.translate.instant('fms.receipting.allocateReceipt'),
        url: ''
      }
    ]"
      >
      </app-dynamic-breadcrumb>
    </div>
  </div>
  <app-steper
    [currentStep]="3"
    [stepperData]="steps"
    (stepChange)="handleStepNavigation($event)"
  ></app-steper>
  <div class="main-form">
    <div class="allocation-div">
      <!-- Receipt Allocations Section -->
      <div class="row">
        <h5 class="text-primary text-start mb-3">
          {{ "fms.receipting.receiptAllocations" | translate }}
        </h5>

        <!-- Amount Summary Row -->
        <div class="row mb-3">
          <div class="col-md-3">
            <label for="receiptAmount" class="form-label">{{
              "fms.receipting.receiptAmount" | translate
            }}</label>
            <input
              type="text"
              id="receiptAmount"
              class="form-control"
              [ngModel]="amountIssued | number : '1.2-2'"
              readonly
            />
            <!-- [value]="amountIssued" -->
          </div>
          <div class="col-md-3">
            <label for="allocatedAmount" class="form-label">{{
              "fms.receipting.allocatedAmount" | translate
            }}</label>
            <input
              type="text"
              id="allocatedAmount"
              class="form-control"
              [ngModel]="totalAllocatedAmount | number : '1.2-2'"
              readonly
            />
            <!-- [value]="totalAllocatedAmount" -->
          </div>
          <div class="col-md-3">
            <label for="unallocatedAmount" class="form-label">{{
              "fms.receipting.unallocatedAmount" | translate
            }}</label>
            <input
              type="text"
              id="unallocatedAmount"
              class="form-control"
              [ngModel]="getRemainingAmount() | number : '1.2-2'"
              readonly
            />
            <!-- [value]="getRemainingAmount()" -->
          </div>
        </div>
      </div>

      <!-- Transactions Table currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"-->
      <div class="row" id="allocationTable" *ngIf="allocation">
        <div class="col-md-12">
          <p-table
            *ngIf="allocatedAmountControls.length > 0 && allocation"
            [value]="filteredTransactions"
            responsiveLayout="scroll"
            class="table-striped"
            [paginator]="true"
            [rows]="5"
            [rowsPerPageOptions]="[5, 10, 20]"
            [showCurrentPageReport]="true"
            [currentPageReportTemplate]="currentPageReportTemplate"
          >
            <!-- Table Header -->
            <ng-template pTemplate="header">
              <tr style="background-color: #89a8b2; color: white">
                <th class="header-bg">
                  {{ "fms.receipting.client_name" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.policyNumber" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.Debit Note" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.amount" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.balance" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.allocatedAmount" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.commission" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.comm?" | translate }}
                </th>
              </tr>
              <tr>
                <th>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    (keyup.enter)="applyFilter($event, 'clientName')"
                    (input)="applyFilter($event, 'clientName')"
                    placeholder="{{ 'fms.receipting.filter' | translate }}"
                  />
                </th>
                <th>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    (keyup.enter)="applyFilter($event, 'policyNumber')"
                    (input)="applyFilter($event, 'policyNumber')"
                    placeholder="{{ 'fms.receipting.filter' | translate }}"
                  />
                </th>
                <th>
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    (keyup.enter)="applyFilter($event, 'debitNote')"
                    (input)="applyFilter($event, 'debitNote')"
                    placeholder="{{ 'fms.receipting.filter' | translate }}"
                  />
                </th>
                <th>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    (keyup.enter)="applyFilter($event, 'amount')"
                    (input)="applyFilter($event, 'amount')"
                    placeholder="{{ 'fms.receipting.filter' | translate }}"
                  />
                </th>
                <th>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    (keyup.enter)="applyFilter($event, 'balance')"
                    (input)="applyFilter($event, 'balance')"
                    placeholder="{{ 'fms.receipting.filter' | translate }}"
                  />
                </th>
                <th>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    disabled
                  />
                </th>
                <th>
                  <input
                    type="number"
                    class="form-control form-control-sm commission-input"
                    (keyup.enter)="applyFilter($event, 'commission')"
                    (input)="applyFilter($event, 'commission')"
                    placeholder="{{ 'fms.receipting.filter' | translate }}"
                  />
                </th>
                <th>
                  <input
                    type="checkbox"
                    class="form-control form-control-sm comm-checkbox"
                    disabled
                  />
                </th>
              </tr>
            </ng-template>

            <!-- Table Body -->
            <ng-template pTemplate="body" let-transaction let-i="rowIndex">
              <tr [pSelectableRow]="transaction">
                <td>{{ transaction.clientName }}</td>
                <td>{{ transaction.clientPolicyNumber }}</td>
                <td>{{ transaction.referenceNumber }}</td>
                <td>{{ transaction.amount }}</td>
                <td>{{ transaction.balance }}</td>
                <td>
                  <ng-container
                    *ngIf="getFormControl(i, 'allocatedAmount') as control"
                  >
                    <input
                      type="number"
                      [formControl]="control"
                      class="form-control form-control-sm"
                      placeholder="{{
                        'fms.receipting.enterAmount' | translate
                      }}"
                      (change)="calculateTotalAllocatedAmount()"
                      (input)="calculateTotalAllocatedAmount()"
                    />
                  </ng-container>
                </td>
                <td>{{ transaction.commission }}</td>

                <td>
                  <div class="d-flex">
                    <div class="form-check form-check-inline">
                      <input
                        type="radio"
                        class="form-check-input"
                        [checked]="
                          getFormControl(i, 'commissionChecked')?.value === 'Y'
                        "
                        (change)="onCommissionCheckedChange(i, 'Y')"
                        name="commission_{{ i }}"
                        id="commissionYes_{{ i }}"
                      />
                      <label
                        class="form-check-label"
                        for="commissionYes_{{ i }}"
                        >Yes</label
                      >
                    </div>
                    <div class="form-check form-check-inline">
                      <input
                        type="radio"
                        class="form-check-input"
                        [checked]="
                          getFormControl(i, 'commissionChecked')?.value === 'N'
                        "
                        (change)="onCommissionCheckedChange(i, 'N')"
                        name="commission_{{ i }}"
                        id="commissionNo_{{ i }}"
                      />
                      <label class="form-check-label" for="commissionNo_{{ i }}"
                        >No</label
                      >
                    </div>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      <div class="btn-actions" *ngIf="allocation || showSaveButton">
        <button
          type="button"
          class="btn btn-primary"
          (click)="confirmtotalAllocatedAmount()"
        >
          {{ "fms.receipting.saveAllocation" | translate }}
        </button>
      </div>

      <!-- Allocations transactions Table -->
      <div
        *ngIf="
          isAllocationCompleted && getAllocation && getAllocation.length > 0
        "
        class="allocations-section"
      >
        <h5 class="text-primary text-start mb-3">
          {{ "fms.receipting.allocations" | translate }}
        </h5>
        <!-- <div *ngIf="isAllocationCompleted && getAllocation && getAllocation.length > 0" class="row mt-4"> -->
        <!-- <h3 class="text-primary text-start fs-4">Allocations</h3> -->
        <!-- [value]="getAllocation" currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"-->
        <div class="col-md-12">
          <p-table
            [value]="flattenedAllocationDetails"
            responsiveLayout="scroll"
            class="table-striped"
            [paginator]="true"
            [rows]="5"
            [rowsPerPageOptions]="[5, 10, 20]"
            [showCurrentPageReport]="true"
            [currentPageReportTemplate]="currentPageReportTemplate"
          >
            <!-- Table Header -->
            <ng-template pTemplate="header">
              <tr style="background-color: #89a8b2; color: white">
                <th class="header-bg">
                  {{ "fms.receipting.policyNumber" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.Debit Note" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.batchNumber" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.allocatedAmount" | translate }}
                </th>
                <th class="header-bg commission-header">
                  {{ "fms.receipting.commissionAmount" | translate }}
                </th>
                <th class="header-bg commission-header">
                  {{ "fms.receipting.includeCommission" | translate }}
                </th>
                <th class="header-bg">
                  {{ "fms.receipting.actions" | translate }}
                </th>
              </tr>
            </ng-template>

            <!-- Table Body -->
            <ng-template pTemplate="body" let-detail>
              <!-- <tr *ngFor="let detail of allocation.receiptParticularDetails" allocation> -->
              <tr>
                <td>{{ detail.policyNumber }}</td>
                <td>{{ detail.referenceNumber }}</td>
                <td>{{ detail.batchNumber }}</td>
                <td>{{ detail.premiumAmount | number : "1.2-2" }}</td>
                <td>{{ detail.commissionAmount | number : "1.2-2" }}</td>
                <td>{{ detail.includeCommission }}</td>
                <td>
                  <button
                    class="btn btn-danger btn-sm"
                    (click)="deleteAllocation(detail.code)"
                    title="Delete Allocation"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>
      <!-- upload file logic -->
      <!-- Upload Button and Hidden File Input -->
      <form [formGroup]="receiptingDetailsForm">
        <div
          class="row mt-3"
          *ngIf="canShowUploadFileBtn && getAllocation.length > 0"
        >
          <!-- divided the row into 4 columns inorder to fit post file column -->
          <div class="col-md-3">
            <!-- Upload Button -->
            <input
              type="file"
              #fileInput
              (change)="onFileSelected($event)"
              (click)="clearFileInput($event)"
              style="display: none"
            />
            <!-- [disabled]="!isFileUploadButtonDisabled" -->
            <button
              type="button"
              class="btn btn-primary"
              (click)="fileInput.click()"
              [disabled]="isFileUploadButtonDisabled"
            >
              {{ "fms.receipting.uploadFiles" | translate }}
            </button>
          </div>
          <div class="col-md-3 mt-2">
            <div *ngFor="let fileDesc of fileDescriptions; let i = index">
              <span>{{ fileDesc.file.name }}</span> -

              <button
                type="button"
                class="btn btn-danger"
                (click)="onRemoveFile(i)"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>

          <!-- Display Uploaded Files in Vertical List -->
          <div class="col-md-3 mt-4">
            <div class="uploaded-files-container">
              <div
                *ngFor="let file of uploadedFiles; let i = index"
                class="file-item"
              >
                <p class="file-name">
                  <strong>{{ "fms.receipting.filename" | translate }}</strong>
                  {{ file.docName }}
                </p>

                <div class="file-actions">
                  <button
                    class="btn btn-primary me-2 d-flex align-items-center"
                    (click)="openFile(file)"
                  >
                    <i class="fas fa-eye"></i>
                    {{ "fms.receipting.open" | translate }}
                  </button>

                  <button
                    class="btn btn-danger d-flex align-items-center"
                    (click)="deleteFile(file, i)"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div
            class="col-md-3 mt-2"
            *ngIf="
              fileDescriptions.length > 0 &&
              canShowUploadFileBtn &&
              getAllocation.length > 0
            "
          >
            <button
              type="button"
              class="btn btn-primary"
              (click)="uploadFile()"
            >
              {{ "fms.receipting.postFile" | translate }}
            </button>
          </div>
        </div>

        <!-- Modal for File Description -->
        <div
          id="fileDescriptionModal"
          class="modal fade"
          tabindex="-1"
          role="dialog"
          aria-hidden="true"
        >
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  {{ "fms.receipting.fileDescription" | translate }}
                </h5>
              </div>
              <div class="modal-body">
                <form [formGroup]="receiptingDetailsForm">
                  <div class="form-group">
                    <label for="description"
                      >{{ "fms.receipting.enterFileDescription" | translate
                      }}<span class="required"></span
                    ></label>
                    <input
                      id="description"
                      placeholder="enter desc"
                      type="text"
                      class="form-control"
                      formControlName="description"
                    />

                    <div
                      *ngIf="
                        receiptingDetailsForm.get('description')?.invalid &&
                        receiptingDetailsForm.get('description')?.touched
                      "
                      class="text-danger"
                    >
                      {{ "fms.receipting.descriptionIsRequired" | translate }}
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-primary"
                  (click)="saveFileDescription()"
                >
                  {{ "fms.receipting.save" | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <!-- commented this div class as it has been included in the row above -->
    <!-- <div class="postbtn">
      <div
        class="sub_postbtn"
        *ngIf="
          fileDescriptions.length > 0 &&
          canShowUploadFileBtn &&
          getAllocation.length > 0
        "
      >
        <button type="button" class="btn btn-primary" (click)="uploadFile()">
          {{ "fms.receipting.postFile" | translate }}
        </button>
      </div>
    </div> -->
  </div>
  <div class="nav-btn">
    <div class="back-btn">
      <button type="button" class="btn btn-link" (click)="onBack()">
        {{ "fms.receipting.back" | translate }}
      </button>
    </div>
    <div class="save-btns">
      <!-- these buttons will be visible for normal receipting but disappers if receipt on account is on -->
      <!-- The generateAcknowledgement btn will only be shown if the showAcknowledgeBtn is true -->
      <button
        type="button"
        *ngIf="
          showAcknowledgeBtn &&
          isAllocationCompleted &&
          !isreceiptingOnAccountExist &&
          getRemainingAmount() === 0
        "
        [disabled]="!isAllocationCompleted"
        (click)="handleSaveAndPrint()"
        class="btn btn-outline-primary"
      >
        {{ "fms.receipting.generateAcknowledgement" | translate }}
      </button>
      <button
        *ngIf="
          !showAcknowledgeBtn &&
          isAllocationCompleted &&
          !isreceiptingOnAccountExist &&
          getRemainingAmount() === 0
        "
        type="button"
        [disabled]="!isAllocationCompleted"
        class="btn btn-outline-primary"
        (click)="saveAndPrint()"
      >
        {{ "fms.receipting.save&print" | translate }}
      </button>

      <button
        *ngIf="
          isAllocationCompleted &&
          !isreceiptingOnAccountExist &&
          getRemainingAmount() === 0
        "
        type="button"
        [disabled]="!isAllocationCompleted"
        class="btn btn-primary"
        (click)="submitReceipt()"
      >
        {{ "fms.receipting.save_receipt" | translate }}
      </button>
      <!-- save empty allocations -->
      <!-- these buttons will only appear if the receipting on account is on and replace their duplicate couterparts dynamically -->
      <div class="save-btns">
        <button
          *ngIf="isEmptyAllocationPosted || isreceiptingOnAccountExist"
          type="button"
          class="btn btn-primary"
          (click)="submitReceipt()"
        >
          {{ "fms.receipting.save_receipt" | translate }}
        </button>
        <!-- generateAcknowledgement -->
        <button
          type="button"
          *ngIf="
            (isEmptyAllocationPosted || isreceiptingOnAccountExist) &&
            showAcknowledgeBtn
          "
          (click)="handleSaveAndPrint()"
          class="btn btn-outline-primary"
        >
          {{ "fms.receipting.save&print" | translate }}
        </button>
        <button
          *ngIf="
            (isEmptyAllocationPosted || isreceiptingOnAccountExist) &&
            !showAcknowledgeBtn
          "
          type="button"
          class="btn btn-outline-primary"
          (click)="saveAndPrint()"
        >
          {{ "fms.receipting.save&print" | translate }}
        </button>
      </div>
      <!-- end -->
    </div>
    <!-- receipt sharing  Modal -->
    <div
      class="modal fade"
      id="shareReceiptModal"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form [formGroup]="rctShareForm">
            <div class="modal-header">
              <h5 class="modal-title" id="staticBackdropLabel">
                {{ "fms.receipt-management.shareReceipt" | translate }}
              </h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
                (click)="navigateToReceiptCapture()"
              ></button>
            </div>
            <div class="modal-body">
              <div class="d-flex">
                <div class="form-check customcss me-4">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="shareMethod"
                    id="emailbtn"
                    formControlName="shareMethod"
                    value="email"
                  />

                  <label
                    class="form-check-label"
                    for="emailbtn"
                    style="color: #000"
                  >
                    {{ "fms.receipt-management.email" | translate }}
                  </label>
                </div>

                <div class="form-check customcss">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="shareMethod"
                    id="whatsappbtn"
                    formControlName="shareMethod"
                    value="whatsapp"
                  />
                  <label
                    class="form-check-label"
                    for="whatsappbtn"
                    style="color: #000"
                  >
                    {{ "fms.receipt-management.whatsapp" | translate }}
                  </label>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col clientcss">
                  <label for="clientName" style="color: #000">{{
                    "fms.receipt-management.clientName" | translate
                  }}</label>
                  <input
                    type="text"
                    class="form-control"
                    id="clientName"
                    formControlName="name"
                  />
                </div>
              </div>
              <div
                class="row mb-3"
                *ngIf="rctShareForm.get('shareMethod')?.value === 'whatsapp'"
              >
                <div class="col">
                  <label for="phone" style="color: #000">{{
                    "fms.receipt-management.phoneNumber" | translate
                  }}</label>
                  <input
                    type="text"
                    class="form-control"
                    id="phone"
                    formControlName="phone"
                    placeholder="e.g., 254712345678"
                  />
                  <!-- START: Add this error message block -->
                  <div
                    *ngIf="
                      rctShareForm.get('phone')?.invalid &&
                      (rctShareForm.get('phone')?.dirty ||
                        rctShareForm.get('phone')?.touched)
                    "
                    class="text-danger mt-1"
                    style="font-size: 0.8rem"
                  >
                    <div
                      *ngIf="rctShareForm.get('phone')?.errors?.['required']"
                    >
                      Phone number is required.
                    </div>
                    <div *ngIf="rctShareForm.get('phone')?.errors?.['pattern']">
                      Invalid format. Must be 254 followed by 9 digits (e.g.,
                      254712345678).
                    </div>
                  </div>
                  <!-- END: Add this error message block -->
                </div>
              </div>
              <div
                class="row mb-3"
                *ngIf="rctShareForm.get('shareMethod')?.value === 'email'"
              >
                <div class="col">
                  <label for="email" style="color: #000">{{
                    "fms.receipt-management.email" | translate
                  }}</label>
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    formControlName="email"
                  />
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                class="btn btn-outline-primary"
                (click)="onClickPreview()"
              >
                {{ "fms.receipt-management.preview" | translate }}
              </button>
              <button
                type="button"
                class="btn btn-primary"
                (click)="postClientDetails()"
              >
                {{ "fms.receipt-management.send" | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- </div> -->
  </div>
</div>
