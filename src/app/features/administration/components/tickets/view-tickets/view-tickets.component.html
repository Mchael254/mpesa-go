<div class="row">

</div>


<div class="d-flex my-4 mx-4">
  <!--  <button class="btn btn-success" (click)="generateAuthorizeOtp()" style="margin-right: 1rem;">Authorize</button>-->
  <button class="btn btn-primary border-radius-none" 
    (click)="processReassignTask()" 
    id="btn-reassign-task"
    [disabled]="selectedSpringTickets.length === 0"
    style="margin-right: 1rem;">
    {{'mngt_wrkflw.tickets.reassign' | translate }}
  </button>
  <button class="btn btn-success" 
    (click)="authorizePolicy()"
    [disabled]="selectedSpringTickets.length === 0"
    style="margin-right: 1rem;">{{'mngt_wrkflw.tickets.authorize' | translate }}</button>
  <button class="btn btn-outline-primary" (click)="goToDispatch()">{{'base.dispatch' | translate | titlecase }}</button>
</div>

<div class="d-flex my-4 mx-4">
  <form [formGroup]="sortingForm" style="background: none; display: contents">
    <div class="row">
      <div class="col-lg-3 col-sm-6 col-6">
        <label>{{'mngt_wrkflw.tickets.from' | translate }}</label><br>
        <input type="date" class="form-control" formControlName="fromDate" (change)="sortTickets()">
      </div>
      <div class="col-lg-3 col-sm-6 col-6">
        <label>{{'mngt_wrkflw.tickets.to' | translate }}</label><br>
        <input type="date" class="form-control" formControlName="toDate" (change)="sortTickets()">
      </div>
      <div class="col-lg-3 col-sm-6 col-6">
        <label>{{'mngt_wrkflw.tickets.type' | translate }}</label><br>
        <select class="form-control form-select" formControlName="ticketTypes" id="type" (change)="sortTickets()">
          <option value="" disabled selected>Select option</option>
          <option value="">All</option>
          <option *ngFor="let ticketTypes of ticketTypesData" value="{{ ticketTypes.shortDescription }}">{{
            ticketTypes.description }}
          </option>
        </select>
      </div>
      <div class="col-lg-3 col-sm-6 col-6">
        <label>{{'mngt_wrkflw.tickets.module' | translate }}</label><br>
        <!--          <select formControlName="ticketModules" id="module" [(ngModel)]="selectedModule" (change)="searchModule($event)">-->
        <select class="form-control form-select" formControlName="ticketModules" id="module" (change)="sortTickets()">
          <option value="" selected>Select option</option>
          <option value="">All</option>
          <option *ngFor="let ticketModule of ticketModules" [ngValue]="ticketModule.shortDescription">
            {{ ticketModule.description }}
          </option>
        </select>
      </div>
    </div>
  </form>
</div>

<div class="my-4 mx-4">

  <div class="card">
    <div class="card-body" style="position: relative;">

      <ngx-spinner type="ball-clip-rotate-multiple" [fullScreen]="false" color="#00529B" size="medium"
        bdColor="rgba(255, 255, 255, 0.966)"></ngx-spinner>

      <p-table #dt (onLazyLoad)="lazyLoadTickets($event)" [lazy]="true" [value]="springTickets.content"
        [(selection)]="selectedSpringTickets" [tableStyle]="{ 'min-width': '50rem' }" [paginator]="true" [rows]="10"
        [rowHover]="true" [autoLayout]="true" [totalRecords]="springTickets.totalElements"
        [rowsPerPageOptions]="[5, 10, 20, 30, 50, 100]" currentPageReportTemplate="{first} - {last} of {totalRecords}"
        [scrollable]="true" scrollHeight="400px" responsiveLayout="scroll" [resizableColumns]="true"
        [globalFilterFields]="globalFilterFields">
        <ng-template pTemplate="header">
          <tr>
            <th class="head">
              {{'mngt_wrkflw.tickets.selectAll' | translate }}
            </th>
            <th class="head" pSortableColumn="date">
              {{'mngt_wrkflw.tickets.createdOn'| translate }} <p-sortIcon field="date"></p-sortIcon>
            </th>
            <th class="head" pSortableColumn="task.activityName">
              {{'mngt_wrkflw.tickets.ticketName' | translate }} <p-sortIcon field="task.activityName"></p-sortIcon>
            </th>
            <th class="head" pSortableColumn="sysModule">
              {{'mngt_wrkflw.tickets.refNo' | translate }}. <p-sortIcon field="sysModule"></p-sortIcon>
            </th>
            <th class="head" pSortableColumn="clientName">
              {{'mngt_wrkflw.tickets.client' | translate }} <p-sortIcon field="clientName"></p-sortIcon>
            </th>
            <th class="head" pSortableColumn="agentName">
              {{'mngt_wrkflw.tickets.intermediary' | translate }} <p-sortIcon field="agentName"></p-sortIcon>
            </th>
            <th class="head" pSortableColumn="reporter">
              {{'mngt_wrkflw.tickets.ticketFrom' | translate }} <p-sortIcon field="reporter"></p-sortIcon>
            </th>
            <th class="head" pSortableColumn="assignee">
              {{'mngt_wrkflw.tickets.ticketAssignee' | translate }} <p-sortIcon field="assignee"></p-sortIcon>
            </th>
            <th class="head">
              Actions
            </th>
          </tr>
          <tr>
            <th class="head">
              <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('createdOn');"
                (input)="getInputs($event, 'createdOn')">
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('activityName');"
                (input)="getInputs($event, 'activityName')">
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('referenceNo');"
                (input)="getInputs($event, 'referenceNo')">
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('clientName');"
                (input)="getInputs($event, 'clientName')">
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('agentName');"
                (input)="getInputs($event, 'agentName')">
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('reporter');"
                (input)="getInputs($event, 'reporter')">
            </th>
            <th>
              <input type="text" class="form-control w-75" (keyup.enter)="searchTickets('assignee');"
                (input)="getInputs($event, 'assignee')">
            </th>
            <th></th>


          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-ticket>
          <tr>
            <td class="body">
              <p-tableCheckbox [value]="ticket"></p-tableCheckbox>
            </td>
            <td class="body">{{ ticket.createdDate | date: 'yyyy-MM-dd' }}</td>
            <td class="body" style="cursor:pointer;">{{ ticket.ticketName }}</td>
            <td class="body">
              {{
              ticket.systemModule === 'Q' ? ticket.quotationNumber :
              ticket.systemModule === 'C' ? ticket.claimNumber :
              ticket.systemModule === 'P' ? ticket.policyNumber : ''
              }}
            </td>
            <td class="body">{{ ticket.clientName }}</td>
            <td class="body">{{ ticket.agentName }}</td>
            <td class="body">
              PMUTUA
            </td>
            <td class="body">
              {{ ticket.ticketTo === 'JMMUSYOKI' ? 'WADUVAGA' : ticket.ticketTo }}
            </td>
            <!-- <td class="body ticket-button" (click)="goToTicketDetails(ticket)">
              <i class="fa-regular fa-eye" style="font-size: 17px;"></i>
            </td> -->
            <td class="text-end" style="padding-top: 0; padding-bottom: 0;">
              <!-- DEBUG: Direct test button (remove after testing) -->
              <!-- <button class="btn btn-xs btn-outline-success me-2" (click)="viewQuote(quotation)" style="font-size: 10px; padding: 2px 4px;">DEBUG VIEW</button> -->

              <div class="action-buttons-container d-flex align-items-center justify-content-end gap-1">
                <!-- Display first 3 actions as text links -->
                <!-- Process Action -->
                <button type="button"
                  class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1">
                  Process
                </button>

                <!-- Reassign Action -->
                <button type="button" (click)="reassignSingleTicket(ticket)"
                  class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1">
                  Reassign
                </button>


              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="9">No tickets found.</td>
          </tr>
        </ng-template>
      </p-table>

    </div>
  </div>

</div>

<!-- Reassign ticket Modal 1 -->
<div class="modal fade " id="reassignTicket" #reassignTicketModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
    <div class="modal-content ps-4 pt-2 pb-5 pe-4">
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
        <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
          Reassign tasks
        </p>
        <button type="button" (click)="closeReassignTicketModal()" class="btn p-0 text-danger fw-bold"
          style="border: none;">X</button>
      </div>

      <div *ngIf="departmentSelected" class="w-75 mb-2 mt-2">
        <p class="quote-label">Group User</p>
        <input pInputText type="select" class="form-control form-control-sm" id="quote-input"
          [(ngModel)]="userToReassignTicket">
      </div>

      <div class="w-75 mb-2 mt-2">
        <p class="quote-label">{{ userToReassignTicket ? 'Default User' : 'User' }}</p>


        <div *ngIf="!departmentSelected"
          class="form-control form-control-sm d-flex align-items-center justify-content-between" id="quote-input"
          style="cursor: pointer;" (click)="openChooseClientReassignModal()">
          <span cl>{{ userToReassignTicket}}</span>
          <i class="pi pi-chevron-down me-2" style="color: #00529B;font-size: 14px;"></i>
        </div>

        <p-dropdown *ngIf="departmentSelected" [options]="groupUsers" optionLabel="userDetails.name" optionValue="id"
          [(ngModel)]="selectedGroupUserId" placeholder="" class=" form-control-sm ">
        </p-dropdown>


      </div>

      <div class="w-75 mb-3">
        <p class="quote-label">Comments</p>
        <textarea name="reassignProduct" class="form-control" style="height: 70px"
          [(ngModel)]="reassignTicketComment"></textarea>
      </div>

      <small class="text-danger block" [class.invisible]="!noCommentleft">
        Please leave a comment before reassigning
      </small>

      <small class="text-danger block" [class.invisible]="!noUserChosen">
        Please select a person to reassign before continuing
      </small>

      <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
        <button type="button" class="btn" 
          [disabled]="!userToReassignTicket || !reassignTicketComment"
          [style.background-color]="(!userToReassignTicket || !reassignTicketComment) ? '#cccccc' : '#00529B'"
          style="color:white;text-decoration: none;"
          (click)="reassignTicket()">{{
          'gis.quotation.reassign' | translate }}
        </button>
        <button type="button" (click)="closeReassignTicketModal()" class="btn btn-outline-primary"
          style="text-decoration: none;">{{'gis.quotation.cancel' | translate}}
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Reassign ticket Modal 2 -->
<div class="modal fade " id="chooseClientReassingModal" #chooseClientReassignModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
    <div class="modal-content ps-4 pt-2 pb-5 pe-4">

      <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
        <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
          Reassign task
        </p>
        <button type="button" (click)="closeChooseClientReassignModal()" class="btn p-0 text-danger fw-bold"
          style="border: none;">X</button>
      </div>

      <div class="row mt-2">
        <p-table #reassignTable [value]="users" [rows]="3" [paginator]="true" [rowsPerPageOptions]="[5, 10, 20, 50]"
          [globalFilterFields]="['id', 'name']" selectionMode="single" [(selection)]="selectedUser"
          styleClass="p-datatable-striped" (onRowSelect)="onUserSelect()" (onRowUnselect)="onUserUnselect()">
          <ng-template pTemplate="header">
            <tr>
              <th>User ID</th>
              <th>Full Name</th>
            </tr>
            <tr styleClass="p-striped">
              <th>
                <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)" 
                       class="form-control form-control-sm" 
                       style="border-radius: 4px; border: 1px solid #ced4da; padding: 0.375rem 0.75rem;">
              </th>
              <th>
                <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)" 
                       class="form-control form-control-sm" 
                       style="border-radius: 4px; border: 1px solid #ced4da; padding: 0.375rem 0.75rem;">
              </th>
            </tr>

          </ng-template>
          <ng-template pTemplate="body" let-user>
            <tr [pSelectableRow]="user">
              <td>{{ user.id }}</td>
              <td>{{ user.name }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <small class="text-danger block" [class.invisible]="!noUserChosen">
        Please select a person to reassign before continuing
      </small>

      <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
        <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
          (click)="selectClient()">{{
          'gis.quotation.save' | translate }}
        </button>
        <button type="button" (click)="closeChooseClientReassignModal()" class="btn btn-outline-primary"
          style="text-decoration: none;">{{
          'gis.quotation.cancel' | translate
          }}
        </button>
      </div>

    </div>
  </div>
</div>

<app-reassign-ticket-modal [reassignModalVisible]="showReassignTicketsModal" [selectedTickets]="selectedSpringTickets"
  (actionReassignEmitter)="handleAction($event)" (reassignedTickets)="reassignSubmitted($event)">
</app-reassign-ticket-modal>

<app-authorize-policy-modal [policyDetails]="policyDetails">
</app-authorize-policy-modal>
<div class="mobile-bottom"></div>