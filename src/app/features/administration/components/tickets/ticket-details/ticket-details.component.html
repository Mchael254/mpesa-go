<div class="base-content-section">

  <div class="row me-4">
    <div class="col-8">
      <app-dynamic-breadcrumb [breadCrumbItems]="[
      {
        label: 'Home',
        url: '/home/dashboard'
      },
      {
        label: 'Tickets',
        url: '/home/administration/tickets',
      },
      {
        label: selectedSpringTickets?.task?.activityName,
        url: ''
      }
    ]">
      </app-dynamic-breadcrumb>
    </div>
  </div>

  <p-tabView [(activeIndex)]="activeIndex">
    <label class="mb-3 float-end fw-medium">Current ticket:
      <span class="text-primary">{{selectedSpringTickets?.task?.activityName}}</span>
    </label>

    <ng-container
      *ngIf="selectedSpringTickets?.ticket?.sysModule === 'P' || selectedSpringTickets?.ticket?.sysModule === 'RT'
      || selectedSpringTickets?.ticket?.sysModule === 'E'">
      <p-tabPanel header="Policy details">

        <label class="text-primary mb-3 fw-medium">{{'mngt_wrkflw.policyDetails.policyDetails' | translate | titlecase }}</label>
        <div class="row">
          <div class="col-sm-3">
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.client' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ selectedSpringTickets?.clientName }}</span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.currency' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.currency }}</span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.agency' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ selectedSpringTickets?.agentName }}</span>
            </p>
          </div>

          <div class="col-sm-3">
            <p *ngIf="selectedSpringTickets?.ticket.policyCode">
              <label class="ticketLabel">{{'mngt_wrkflw.tickets.policyNo' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.policyNo }}</span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.totalSI' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.totalSumInsured | number: '1.2-2' }}</span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.tickets.transactionType' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.policyStatus }}</span>
            </p>
          </div>
          <div class="col-sm-4">
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.endorseNo' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.endorsementNo }}</span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.premium' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.premium }}</span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.ticketRemarks' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ selectedSpringTickets?.ticket?.remarks }}</span>
            </p>
          </div>
          <div class="col-sm-2">
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.coverFrom' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.wefDt | date: 'shortDate' }} </span>
            </p>
            <p>
              <label class="ticketLabel">{{'mngt_wrkflw.policyDetails.coverTo' | translate | titlecase }}:</label>
              <span class="ticketDesc">{{ policyDetails?.wetDt | date: 'shortDate' }}</span>
            </p>
          </div>

        </div>

        <div class="risks mt-5" >
          <ng-container>
            <!--preloader goes here-->
          </ng-container>
          <app-risk-details
            [risk]="policyDetails?.riskInformation"
            [sectionDetails]="[]"
          ></app-risk-details>
          <!--<div class="view-more">
            <button class="btn btn-link fw-bold text-primary" (click)="showViewMoreDialog()" >View more</button>
          </div>-->
        </div>

        <div class="total-premium">
          <table class="table table-borderless">
            <thead>
            <tr *ngIf="policyDetails?.premium">
              <td>Total premium on {{ policyDetails?.riskInformation.length }} risk(s)</td>
              <td style="text-align: right">{{ policyDetails?.premium | number: '1.2-2' }}</td>
            </tr>
            </thead>
          </table>
        </div>

        <div class="taxes" *ngIf="policyDetails?.taxInformation">
          <ng-container>
            <!--preloader goes here-->
          </ng-container>
          <app-tax-details
            [taxInformation]="policyDetails?.taxInformation"
            [totalPremium]="policyDetails?.totalPremium"
          ></app-tax-details>
        </div>

      </p-tabPanel>

      <p-tabPanel header="Reinsurance allocations" >
        <app-reinsurance-allocations *ngIf="policyDetails?.riskInformation"
                                     [policyDetails]="policyDetails"
        ></app-reinsurance-allocations>
      </p-tabPanel>
      <p-tabPanel header="Authorization" [selected]="true">
        <app-authorization-tab
          *ngIf="policyDetails"
          [policyDetails]="policyDetails"
          (undoOrMakeReady)="fetchPolicyDetails(policyDetails?.batchNo)">
        </app-authorization-tab>
      </p-tabPanel>
      <p-tabPanel header="Documents and reports">
        <label class="text-primary mb-2 fw-medium">Reports</label>
        <app-ticket-reports></app-ticket-reports>


        <app-ticket-documents [currentTicket]="currentTicket">
        </app-ticket-documents>
      </p-tabPanel>
    </ng-container>

    <ng-container *ngIf="selectedSpringTickets?.ticket?.sysModule === 'C'">
      <p-tabPanel header="Claim details">
        <app-claim-details
          [selectedSpringTickets]="selectedSpringTickets"
          [claim]="claim"
        ></app-claim-details>
      </p-tabPanel>
      <p-tabPanel header="Documents and reports">
        <label class="text-primary mb-2 fw-medium">Reports</label>
        <app-ticket-reports></app-ticket-reports>

        <app-ticket-documents></app-ticket-documents>

      </p-tabPanel>
      <p-tabPanel header="Transaction history">
        <app-transaction-history
          [selectedSpringTickets]="selectedSpringTickets"
        ></app-transaction-history>
      </p-tabPanel>
    </ng-container>

  </p-tabView>
  <div class="row action-buttons my-2 p-1">
    <div class="col-sm-5">
      <button class="btn btn-outline-secondary" (click)="backToPrevious()">{{'mngt_wrkflw.tickets.back' | translate }}</button>
    </div>
    <div class="col-sm-7">
      <button
        class="btn btn-outline-primary reassign-btn"
        (click)="openReassignModal()"
        *ngIf="activeIndex !== 2 && selectedSpringTickets?.ticket?.sysModule === 'C' "
      >
        {{'mngt_wrkflw.tickets.reassign' | translate | titlecase }}
      </button>

      <button
        class="btn btn-success ms-2"
        (click)="onClickAuthorize()"
        *ngIf="activeIndex === 2 && (selectedSpringTickets?.ticket?.sysModule === 'P'
        || selectedSpringTickets?.ticket?.sysModule === 'RT' || selectedSpringTickets?.ticket?.sysModule === 'E')"
      >
        {{'mngt_wrkflw.tickets.authorize' | translate | titlecase }}
      </button>

      <button
        class="btn btn-primary ms-2 reinsure-btn"
        (click)="onClickReinsure()"
        *ngIf="activeIndex === 1 && (selectedSpringTickets?.ticket?.sysModule === 'P'
        || selectedSpringTickets?.ticket?.sysModule === 'RT' || selectedSpringTickets?.ticket?.sysModule === 'E')"
      >
        {{'mngt_wrkflw.policyDetails.reinsure' | translate | titlecase }}
      </button>

      <button
        class="btn btn-primary ms-2 reinsure-btn" (click)="onAuthorizeClaim()"
        *ngIf="selectedSpringTickets?.ticket?.sysModule === 'C' && activeIndex === 0"
      >
        {{'mngt_wrkflw.policyDetails.authorizeClaim' | translate | titlecase }}
      </button>
    </div>
  </div>
</div>

<div *ngIf ="policyDetails">
<app-authorize-policy-modal>
</app-authorize-policy-modal>
</div>

<app-reassign-ticket-modal
  [selectedTickets]="[selectedSpringTickets]"
  [reassignModalVisible]="showReassignTicketsModal"
  (actionReassignEmitter)="handleAction($event)"
  (reassignedTickets)="reassignSubmitted($event)">
</app-reassign-ticket-modal>
