<p-tabView *ngIf="showTabs" [activeIndex]='activeIndex' (onChange)="onTabChange($event)">
  <p-tabPanel header="IND Life" *ngIf="visibleTabs.LMS">
    <div>
      <div>
        <div>
          <div class="row">
            <div class="col-7">
              <div>
                <div class="row">
                  <div class="col-8">
                    <div class="input-group mb-3" style="font-size: 15px">
                      <span class="input-group-text" id="basic-addon1">
                        <i class="fa-solid fa-magnifying-glass"></i>
                      </span>
                      <input style="font-size: 12px !important" type="text" class="form-control"
                        placeholder="Search by client's name or quotation no" aria-label="Username"
                        aria-describedby="basic-addon1" />
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="input-group mb-3">
                      <label class="input-group-text" for="inputGroupSelect01" style="font-size: 11px !important">Sort
                        by:</label>
                      <select style="font-size: 11px;" class="form-select" id="inputGroupSelect01">
                        <option selected>
                          Status
                        </option>
                        <option></option>
                        <option value="1">One</option>
                        <option value="2">Two</option>
                        <option value="3">Three</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-5">
              <div class="d-flex justify-content-end">
                <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
                  [routerLink]="'/home/lms/ind/quotation/quick'">Quick Quotation</button>
                <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
                  (click)="selectNormalQuotation()"> Normal Quotation </button>
                <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
                  (click)="selectNormalQuotation()"> Proposal </button>

              </div>
            </div>
          </div>
        </div>
      </div>
      <div>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Quotation No.</th>
                <th>Client Name</th>
                <th>Sum Assured</th>
                <th>Premium</th>
                <th>Intermediary</th>
                <th>Date Created</th>
                <th>Cover From</th>
                <th>Cover To</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody *ngIf="LMS_IND.length > 0">
              <tr *ngFor="let lms of LMS_IND" style="cursor:pointer" (click)="selectLmsIndRow(lms)">
                <td>{{ lms?.quote_no || "" }}</td>
                <td>{{ lms?.quote_no || "" }}</td>
                <td>{{ lms?.sum_insured || "" | number }}</td>
                <td>{{ lms?.premium || 0 | number }}</td>
                <td>{{ lms?.quote_no || "" }}</td>
                <td>{{ lms?.created_at || "" | date:'short' }}</td>
                <td>{{ lms?.quote_no || "" }}</td>
                <td>{{ lms?.quote_no || "" }}</td>
                <td>{{ lms?.quote_status || "" }}</td>
                <td (click)="selectLmsIndRow(lms)">{{ "Process" }}</td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="LMS_IND.length === 0" class="text-danger d-flex justify-content-center">
            No List of Quotation Available
          </div>
        </div>
      </div>
    </div>
  </p-tabPanel>
  <p-tabPanel header="Group Life" *ngIf="visibleTabs.LMS_ORD">
    <div>
      <div class="row grp-quote-filter-row">
        <div class="d-flex justify-content-end grp-quote-filter-button-wrapper">
          <button style="font-size: 12px; padding: 0.5em 1em;" type="button"
            class="btn btn-sm btn-primary grp-quote-filter-new-quote-btn"
            [routerLink]="'/home/lms/grp/quotation/client'">{{ "shared.quotation_landing_screen.new_quote" | translate
            }}</button>
        </div>
      </div>
      <div class="grp-quote-filter-options d-flex justify-content-between align-items-center">
        <div class="grp-quote-filter-controls">
          <label for="filterBy" class="grp-quote-filter-label">{{ "shared.quotation_landing_screen.filter_by" |
            translate }}</label>
          <select class="form-select grp-quote-filter-select" (change)="onColumnChange($event)">
            <option value="" disabled selected>{{ "shared.quotation_landing_screen.select_option" | translate }}
            </option>
            <option *ngFor="let column of grpQuotationsColumns" [value]="column.field">
              {{ column.label | titlecase }}
            </option>
          </select>
          <ng-container *ngIf="isNumericField(selectedColumn)">
            <select class="form-select grp-quote-filter-select" (change)="onConditionChange($event)">
              <option value="" disabled selected>{{ "shared.quotation_landing_screen.select_condition" | translate }}
              </option>
              <option [value]="'greater'">{{ "shared.quotation_landing_screen.greater_than" | translate }}</option>
              <option [value]="'less'">{{ "shared.quotation_landing_screen.less_than" | translate }}</option>
              <option [value]="'equals'">{{ "shared.quotation_landing_screen.equals" | translate }}</option>
            </select>
          </ng-container>
          <ng-container
            *ngIf="selectedColumn === 'cover_from_date' || selectedColumn === 'cover_to_date' || selectedColumn === 'quotation_date'">
            <p-calendar class="grp-quote-filter-input" [showIcon]="true" [dateFormat]="'dd-MM-yy'"
              placeholder='{{ "shared.quotation_landing_screen.range_from" | translate }}'
              (onSelect)="handleDateSelection($event, 'from')" (onChange)="applyFilter()">
            </p-calendar>
            <p-calendar class="grp-quote-filter-input" [showIcon]="true" [dateFormat]="'dd-MM-yy'" [minDate]="minToDate"
              placeholder='{{ "shared.quotation_landing_screen.range_to" | translate }}'
              (onSelect)="handleDateSelection($event, 'to')" (onChange)="applyFilter()">
            </p-calendar>
          </ng-container>
          <ng-container
            *ngIf="selectedColumn !== 'cover_from_date' && selectedColumn !== 'cover_to_date' && selectedColumn !== 'quotation_date'">
            <input type="text" pInputText class="form-control grp-quote-filter-input" id="otherNames"
              (input)="onFilterInput($event)"
              placeholder='{{ "shared.quotation_landing_screen.enter_value" | translate }}'>
          </ng-container>
        </div>
        <div class="d-flex justify-content-end grp-quote-filter-search-wrapper">
          <div class="position-relative grp-quote-filter-search-container">
            <input type="text" class="form-control grp-quote-filter-search-input"
              placeholder='{{ "shared.quotation_landing_screen.search" | translate }}' (input)="onSearch($event)">
            <i class="pi pi-search grp-quote-filter-search-icon"></i>
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <p-table [value]="filteredLMS_GRP" [paginator]="filteredLMS_GRP?.length > 0" [rows]="5"
          [rowsPerPageOptions]="[10, 20, 50]" [showCurrentPageReport]="filteredLMS_GRP?.length > 0"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} quotes"
          styleClass="p-datatable-striped">
          <ng-template pTemplate="header">
            <tr>
              <th pSortableColumn="quotation_number">{{ "shared.quotation_landing_screen.quotation_number" | translate
                }}<p-sortIcon field="quotation_number"></p-sortIcon></th>
              <th pSortableColumn="product">{{ "shared.quotation_landing_screen.product" | translate }}<p-sortIcon
                  field="product"></p-sortIcon></th>
              <th pSortableColumn="client_name">{{ "shared.quotation_landing_screen.client" | translate }}<p-sortIcon
                  field="client_name"></p-sortIcon></th>
              <th pSortableColumn="agency_name">{{ "shared.quotation_landing_screen.intermediary" | translate
                }}<p-sortIcon field="agency_name"></p-sortIcon></th>
              <th pSortableColumn="sum_assured">{{ "shared.quotation_landing_screen.sum_assured" | translate
                }}<p-sortIcon field="sum_assured"></p-sortIcon></th>
              <th pSortableColumn="total_premium">{{ "shared.quotation_landing_screen.premium" | translate }}<p-sortIcon
                  field="total_premium"></p-sortIcon></th>
              <th pSortableColumn="cover_from_date">{{ "shared.quotation_landing_screen.cover_from" | translate
                }}<p-sortIcon field="cover_from_date"></p-sortIcon></th>
              <th pSortableColumn="cover_to_date">{{ "shared.quotation_landing_screen.cover_to" | translate
                }}<p-sortIcon field="cover_to_date"></p-sortIcon></th>
              <th pSortableColumn="quotation_date">{{ "shared.quotation_landing_screen.date_created" | translate
                }}<p-sortIcon field="quotation_date"></p-sortIcon></th>
              <th pSortableColumn="quotation_status">{{ "shared.quotation_landing_screen.status" | translate
                }}<p-sortIcon field="quotation_status"></p-sortIcon></th>
              <th>{{ "shared.quotation_landing_screen.action" | translate }}</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-quoteData let-rowIndex="rowIndex">
            <tr (click)="onQuotationTableRowClick(quoteData, rowIndex)"
              [ngClass]="{'selected-row': rowIndex === selectedRowIndex}" style="cursor: pointer">
              <td>{{ quoteData?.quotation_number || "-" }}</td>
              <td>{{ quoteData?.product || "-" | titlecase }}</td>
              <td>{{ quoteData?.client_name || "-" | titlecase }}</td>
              <td>{{ quoteData?.agency_name || "-" | titlecase }}</td>
              <td class="align-currency">{{ quoteData?.sum_assured !== null ? (quoteData?.sum_assured | number) : "-" }}
              </td>
              <td class="align-currency">{{ quoteData?.total_premium !== null ? (quoteData?.total_premium | number) :
                "-"
                }}</td>
              <td>{{ quoteData?.cover_from_date | date: 'dd-MM-yyyy' }}</td>
              <td>{{ quoteData?.cover_to_date | date: 'dd-MM-yyyy' }}</td>
              <td>{{ quoteData?.quotation_date | date: 'dd-MM-yyyy' }}</td>
              <td>{{ quoteData?.quotation_status || "-" | titlecase }}</td>
              <td>
                <div class="dropdown">
                  <i class="pi pi-ellipsis-v" id="actionDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                    style="cursor: pointer;">
                  </i>
                  <ul class="dropdown-menu" aria-labelledby="actionDropdown">
                    <li>
                      <button class="dropdown-item" (click)="onProcess()">Process</button>
                    </li>
                    <li>
                      <button class="dropdown-item" (click)="onReassign()">Reassign</button>
                    </li>
                    <li>
                      <button class="dropdown-item" (click)="onRevise()">Revise</button>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>

        <div *ngIf="filteredLMS_GRP?.length === 0" class="text-danger d-flex justify-content-center mt-3">
          No Available List of Group Quotations
        </div>
      </div>
    </div>
  </p-tabPanel>
  <p-tabPanel header="General" *ngIf="visibleTabs.GIS">
    <div class="row">
      <div class="col-7">

      </div>

      <div class="col-5">
        <div class="d-flex justify-content-end">
          <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
            (click)="createQuote('QUICK')">Quick Quotation</button>
          <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
            (click)="createQuote('NORMAL')"> Normal Quotation </button>

        </div>
      </div>
    </div>
    <div (click)="immediateHideTooltip()">
      <div style=" position: relative;">
        <div>

          <p-table #quotationTable [value]="gisQuotationList" [paginator]="true" [rows]="10" [scrollable]="true"
            scrollDirection="horizontal" [showCurrentPageReport]="true"
            currentPageReportTemplate=" {first} - {last} of {totalRecords}" [responsiveLayout]="'scroll'"
            [reorderableColumns]="true" [rowsPerPageOptions]="[5, 10, 20]"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            [globalFilterFields]="['quotationNumber','clientName', 'premium','agentShortDescription']">
            <ng-template pTemplate="header">
              <tr>
                <th style="background-color: #f0f0f0;" pSortableColumn="quotationNumber" class="flexible-header">
                  {{ 'gis.quotation.quotation_number' | translate }}
                  <p-sortIcon field="quotationNumber"></p-sortIcon>
                </th>
                <th style="background-color: #f0f0f0;" pSortableColumn="client" class="flexible-header">
                  {{ 'gis.quotation.client' | translate }}
                  <p-sortIcon field="client"></p-sortIcon>
                </th>
                <th style="background-color: #f0f0f0;" pSortableColumn="agent" class="flexible-header">
                  {{ 'gis.quotation.agent' | translate }}
                  <p-sortIcon field="agent"></p-sortIcon>
                </th>
                <th style="background-color: #f0f0f0;" pSortableColumn="premium" class="flexible-header text-end">
                  {{ 'gis.quotation.premium' | translate }}
                  <p-sortIcon field="premium"></p-sortIcon>
                </th>
                <th style="background-color: #f0f0f0;" pSortableColumn="fromDate" class="flexible-header">
                  {{ 'gis.quotation.cover_from' | translate }}
                  <p-sortIcon field="fromDate"></p-sortIcon>
                </th>
                <th style="background-color: #f0f0f0;" pSortableColumn="toDate" class="flexible-header">
                  {{ 'gis.quotation.cover_to' | translate }}
                  <p-sortIcon field="toDate"></p-sortIcon>
                </th>
                <th style="background-color: #f0f0f0;" class="flexible-header text-end">
                  Actions
                </th>
              </tr>

              <tr class=" filter-row mb-5 mt-5">
                <td class="me-1" style="background-color: #ffffff;">
                  <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                    #quotationNumberTypeFilter (input)="inputQuotationNo($event)"
                    (input)="quotationTable.filterGlobal(quotationNumberTypeFilter.value, 'contains')">
                </td>

                <!-- client search -->
                <td class="me-1" style="background-color: #ffffff;">
                  <div class="position-relative">
                    <input type="text" id="quote-input" class="form-select form-control custom-select"
                      style="width: 100%;" [value]="displayClientName" (click)="openClientSearchModal()" readonly
                      (keyup.enter)="fetchGISQuotations();" />

                    <!-- Clear button with X icon - only shows when there's a value -->
                    <button *ngIf="displayClientName" class="btn btn-sm position-absolute clear-btn"
                      style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                      (click)="clearClientName()">
                      <i class="pi pi-times"></i>
                    </button>

                    <!-- Client Search Modal Component -->
                    <!-- <app-client-search-modal (onClickSaveClient)="onClientSelected($event)"
                    *ngIf="isClientSearchModalVisible"></app-client-search-modal> -->
                    <app-client-search-modal *ngIf="isClientSearchModalVisible"
                      (onClickSaveClient)="onClientSelected($event)" (modalClosed)="isClientSearchModalVisible = false">
                    </app-client-search-modal>
                  </div>
                </td>

                <!-- agent filter -->
                <td style="background-color: #ffffff;">
                  <div class="position-relative">
                    <input type="text" id="quote-input" class="form-select form-control custom-select"
                      style="width: 100%;" [value]="displayAgentName" data-bs-toggle="modal"
                      data-bs-target="#agentSearchModal" readonly (keyup.enter)="fetchGISQuotations();"
                      (click)="openAgentSearchModal()" />

                    <!-- Clear button with X icon - only shows when there's a value -->
                    <button *ngIf="displayAgentName" class="btn btn-sm position-absolute clear-btn"
                      style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                      (click)="clearAgentName()">
                      <i class="pi pi-times"></i>
                    </button>

                    <!-- Agent Search Modal Component -->
                    <app-agent-search-modal (agentSelected)="onAgentSelected($event)"></app-agent-search-modal>
                  </div>
                </td>

                <!-- premium filter -->
                <td class="me-1" style="background-color: #ffffff;">
                  <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                    #premiumTypeFilter (input)="inputQuotationNo($event)"
                    (input)="quotationTable.filterGlobal(premiumTypeFilter.value, 'contains')">
                </td>

                <!-- date filters -->
                <td style="background-color: #ffffff;">
                  <p-calendar name="withEffectiveFromDate" [(ngModel)]="fromDate" [dateFormat]="dateFormat"
                    [showIcon]="true" [showButtonBar]="true" [minDate]="minDate"
                    (onSelect)="onDateFromInputChange($event)" (onClear)="onDateFromInputChange(null)" appendTo="body"
                    (keyup.enter)="fetchGISQuotations()" styleClass="calendar-input w-100">
                  </p-calendar>

                </td>
                <td style="background-color: #ffffff;">
                  <p-calendar name="withEffectiveToDate" [(ngModel)]="toDate" [dateFormat]="dateFormat"
                    [showIcon]="true" [showButtonBar]="true" [minDate]="minToDate"
                    (onSelect)="onDateToInputChange($event)" (onClear)="onDateToInputChange(null)" appendTo="body"
                    (keyup.enter)="fetchGISQuotations()" styleClass="calendar-input w-100">
                  </p-calendar>
                </td>

                <!-- clear -->
                <td style="background-color: #ffffff;" class="text-end">
                  <button type="button" class="btn btn-sm  btn-outline-primary" (click)="clearFilters();">{{
                    'gis.quotation.clear' | translate }}</button>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-quotation>
              <tr>
                <td>{{quotation.quotationNumber}}</td>
                <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
                  {{quotation.clientName |sentenceCase}}</td>
                <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
                  {{quotation.agentShortDescription |sentenceCase}}</td>
                <td class="text-end">{{quotation.currency}} {{quotation.premium || 0}}</td>
                <td>{{quotation.fromDate}}</td>
                <td>{{quotation.toDate}}</td>

                <td class="text-end" style="padding-top: 0; padding-bottom: 0;">
                  <!-- DEBUG: Direct test button (remove after testing) -->
                  <!-- <button class="btn btn-xs btn-outline-success me-2" (click)="viewQuote(quotation)" style="font-size: 10px; padding: 2px 4px;">DEBUG VIEW</button> -->

                  <div class="action-buttons-container d-flex align-items-center justify-content-end gap-1"
                    (mouseleave)="hideTooltip()">
                    <!-- Display first 3 actions as text links -->
                    <!-- View Action -->
                    <button type="button"
                      class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                      (click)="immediateHideTooltip(); viewQuote(quotation)" (mouseenter)="showTooltip('View', $event)"
                      (mouseleave)="hideTooltip()" (mousemove)="updateTooltipPosition($event)">
                      View
                    </button>

                    <!-- Revise Action -->
                    <button type="button"
                      class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                      (click)="immediateHideTooltip(); reviseQuotation(quotation)"
                      (mouseenter)="showTooltip('Revise', $event)" (mouseleave)="hideTooltip()"
                      (mousemove)="updateTooltipPosition($event)">
                      Revise
                    </button>

                    <!-- Reuse Action -->
                    <button type="button"
                      class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                      (click)="immediateHideTooltip(); reuseQuotation(quotation)"
                      (mouseenter)="showTooltip('Reuse', $event)" (mouseleave)="hideTooltip()"
                      (mousemove)="updateTooltipPosition($event)">
                      Reuse
                    </button>

                    <!-- Show ellipsis for more actions -->
                    <span class="text-muted mx-2" style="font-size: 0.75rem;"></span>
                    <a href="javascript:void(0)" class="text-primary action-link"
                      (click)="showMoreActions($event, quotation)"
                      style="font-size: 0.875rem; text-decoration: none; padding: 2px 4px;">
                      <i class="pi pi-ellipsis-h"></i>
                    </a>

                    <!-- Popup menu for additional actions -->
                    <p-menu #moreActionsMenu [popup]="true" [model]="remainingMenuItems" appendTo="body"
                      styleClass="additional-actions-menu">
                      <ng-template pTemplate="item" let-item>
                        <a class="p-menuitem-link d-flex align-items-center text-decoration-none"
                          (click)="immediateHideTooltip(); item.command(); moreActionsMenu.hide()"
                          (mouseenter)="showMenuTooltip(item.label, $event)" (mouseleave)="hideMenuTooltip()"
                          (mousemove)="updateTooltipPosition($event)" style="padding: 0.5rem 1rem; color: #495057;">
                          <span>{{ item.label }}</span>
                        </a>
                      </ng-template>
                    </p-menu>
                  </div>
                </td>
              </tr>
            </ng-template>
            <!-- Empty Message -->
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="8" class="text-center p-4 text-muted">
                  <ng-container>
                    {{'gis.quotation.no_matching_quotation' | translate}}
                  </ng-container>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </div>

      <!-- Custom Tooltip -->
      <div *ngIf="hoveredAction" class="custom-tooltip" [class.show]="hoveredAction" [style.left.px]="tooltipPosition.x"
        [style.top.px]="tooltipPosition.y">
        <i [class]="getActionIcon(hoveredAction)" class="tooltip-icon"></i>
        <span class="tooltip-text">{{ getTooltipDescription(hoveredAction) }}</span>
      </div>
    </div>


  </p-tabPanel>
  <!-- <p-tabPanel header="Pension">
    <p>Pension</p>
  </p-tabPanel> -->
</p-tabView>
<ng-container *ngIf="!showTabs && visibleTabs.GIS">
  <div class="row">
    <div class="col-7"></div>
    <div class="col-5">
      <div class="d-flex justify-content-end">
        <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
          (click)="createQuote('QUICK')">Quick Quotation</button>
        <button style="padding: 0.5em; font-size: 12px !important" type="button" class="btn btn-sm btn-primary"
          (click)="createQuote('NORMAL')"> Normal Quotation </button>
      </div>
    </div>
  </div>

  <div (click)="immediateHideTooltip()">
    <div style=" position: relative;">
      <div>

        <p-table #quotationTable [value]="gisQuotationList" [paginator]="true" [rows]="10" [scrollable]="true"
          scrollDirection="horizontal" [showCurrentPageReport]="true"
          currentPageReportTemplate=" {first} - {last} of {totalRecords}" [responsiveLayout]="'scroll'"
          [reorderableColumns]="true" [rowsPerPageOptions]="[5, 10, 20]"
          currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
          [globalFilterFields]="['quotationNumber','clientName', 'premium','agentShortDescription']">
          <ng-template pTemplate="header">
            <tr>
              <th style="background-color: #f0f0f0;" pSortableColumn="quotationNumber" class="flexible-header">
                {{ 'gis.quotation.quotation_number' | translate }}
                <p-sortIcon field="quotationNumber"></p-sortIcon>
              </th>
              <th style="background-color: #f0f0f0;" pSortableColumn="client" class="flexible-header">
                {{ 'gis.quotation.client' | translate }}
                <p-sortIcon field="client"></p-sortIcon>
              </th>
              <th style="background-color: #f0f0f0;" pSortableColumn="agent" class="flexible-header">
                {{ 'gis.quotation.agent' | translate }}
                <p-sortIcon field="agent"></p-sortIcon>
              </th>
              <th style="background-color: #f0f0f0;" pSortableColumn="premium" class="flexible-header text-end">
                {{ 'gis.quotation.premium' | translate }}
                <p-sortIcon field="premium"></p-sortIcon>
              </th>
              <th style="background-color: #f0f0f0;" pSortableColumn="fromDate" class="flexible-header">
                {{ 'gis.quotation.cover_from' | translate }}
                <p-sortIcon field="fromDate"></p-sortIcon>
              </th>
              <th style="background-color: #f0f0f0;" pSortableColumn="toDate" class="flexible-header">
                {{ 'gis.quotation.cover_to' | translate }}
                <p-sortIcon field="toDate"></p-sortIcon>
              </th>
              <th style="background-color: #f0f0f0;" class="flexible-header text-end">
                Actions
              </th>
            </tr>

            <tr class=" filter-row mb-5 mt-5">
              <td class="me-1" style="background-color: #ffffff;">
                <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                  #quotationNumberTypeFilter (input)="inputQuotationNo($event)"
                  (input)="quotationTable.filterGlobal(quotationNumberTypeFilter.value, 'contains')">
              </td>

              <!-- client search -->
              <td class="me-1" style="background-color: #ffffff;">
                <div class="position-relative">
                  <input type="text" id="quote-input" class="form-select form-control custom-select"
                    style="width: 100%;" [value]="displayClientName" (click)="openClientSearchModal()" readonly
                    (keyup.enter)="fetchGISQuotations();" />

                  <!-- Clear button with X icon - only shows when there's a value -->
                  <button *ngIf="displayClientName" class="btn btn-sm position-absolute clear-btn"
                    style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                    (click)="clearClientName()">
                    <i class="pi pi-times"></i>
                  </button>

                  <!-- Client Search Modal Component -->
                  <!-- <app-client-search-modal (onClickSaveClient)="onClientSelected($event)"
                      *ngIf="isClientSearchModalVisible"></app-client-search-modal> -->
                  <app-client-search-modal *ngIf="isClientSearchModalVisible"
                    (onClickSaveClient)="onClientSelected($event)" (modalClosed)="isClientSearchModalVisible = false">
                  </app-client-search-modal>
                </div>
              </td>

              <!-- agent filter -->
              <td style="background-color: #ffffff;">
                <div class="position-relative">
                  <input type="text" id="quote-input" class="form-select form-control custom-select"
                    style="width: 100%;" [value]="displayAgentName" data-bs-toggle="modal"
                    data-bs-target="#agentSearchModal" readonly (keyup.enter)="fetchGISQuotations();"
                    (click)="openAgentSearchModal()" />

                  <!-- Clear button with X icon - only shows when there's a value -->
                  <button *ngIf="displayAgentName" class="btn btn-sm position-absolute clear-btn"
                    style="right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; z-index: 5;"
                    (click)="clearAgentName()">
                    <i class="pi pi-times"></i>
                  </button>

                  <!-- Agent Search Modal Component -->
                  <app-agent-search-modal (agentSelected)="onAgentSelected($event)"></app-agent-search-modal>
                </div>
              </td>

              <!-- premium filter -->
              <td class="me-1" style="background-color: #ffffff;">
                <input type="text" class="form-control" style="width: 100%;" (keyup.enter)="fetchGISQuotations();"
                  #premiumTypeFilter (input)="inputQuotationNo($event)"
                  (input)="quotationTable.filterGlobal(premiumTypeFilter.value, 'contains')">
              </td>

              <!-- date filters -->
              <td style="background-color: #ffffff;">
                <p-calendar name="withEffectiveFromDate" [(ngModel)]="fromDate" [dateFormat]="dateFormat"
                  [showIcon]="true" [showButtonBar]="true" [minDate]="minDate"
                  (onSelect)="onDateFromInputChange($event)" (onClear)="onDateFromInputChange(null)" appendTo="body"
                  (keyup.enter)="fetchGISQuotations()" styleClass="calendar-input w-100">
                </p-calendar>

              </td>
              <td style="background-color: #ffffff;">
                <p-calendar name="withEffectiveToDate" [(ngModel)]="toDate" [dateFormat]="dateFormat" [showIcon]="true"
                  [showButtonBar]="true" [minDate]="minToDate" (onSelect)="onDateToInputChange($event)"
                  (onClear)="onDateToInputChange(null)" appendTo="body" (keyup.enter)="fetchGISQuotations()"
                  styleClass="calendar-input w-100">
                </p-calendar>
              </td>

              <!-- clear -->
              <td style="background-color: #ffffff;" class="text-end">
                <button type="button" class="btn btn-sm  btn-outline-primary" (click)="clearFilters();">{{
                  'gis.quotation.clear' | translate }}</button>
              </td>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-quotation>
            <tr>
              <td>{{quotation.quotationNumber}}</td>
              <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
                {{quotation.clientName |sentenceCase}}</td>
              <td style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;">
                {{quotation.agentShortDescription |sentenceCase}}</td>
              <td class="text-end">{{quotation.currency}} {{quotation.premium || 0}}</td>
              <td>{{quotation.fromDate}}</td>
              <td>{{quotation.toDate}}</td>

              <td class="text-end" style="padding-top: 0; padding-bottom: 0;">
                <!-- DEBUG: Direct test button (remove after testing) -->
                <!-- <button class="btn btn-xs btn-outline-success me-2" (click)="viewQuote(quotation)" style="font-size: 10px; padding: 2px 4px;">DEBUG VIEW</button> -->

                <div class="action-buttons-container d-flex align-items-center justify-content-end gap-1"
                  (mouseleave)="hideTooltip()">
                  <!-- Display first 3 actions as text links -->
                  <!-- View Action -->
                  <button type="button"
                    class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                    (click)="immediateHideTooltip(); viewQuote(quotation)" (mouseenter)="showTooltip('View', $event)"
                    (mouseleave)="hideTooltip()" (mousemove)="updateTooltipPosition($event)">
                    View
                  </button>

                  <!-- Revise Action -->
                  <button type="button"
                    class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                    (click)="immediateHideTooltip(); reviseQuotation(quotation)"
                    (mouseenter)="showTooltip('Revise', $event)" (mouseleave)="hideTooltip()"
                    (mousemove)="updateTooltipPosition($event)">
                    Revise
                  </button>

                  <!-- Reuse Action -->
                  <button type="button"
                    class="text-decoration-none text-primary small fw-medium action-link border-0 bg-transparent p-1"
                    (click)="immediateHideTooltip(); reuseQuotation(quotation)"
                    (mouseenter)="showTooltip('Reuse', $event)" (mouseleave)="hideTooltip()"
                    (mousemove)="updateTooltipPosition($event)">
                    Reuse
                  </button>

                  <!-- Show ellipsis for more actions -->
                  <span class="text-muted mx-2" style="font-size: 0.75rem;"></span>
                  <a href="javascript:void(0)" class="text-primary action-link"
                    (click)="showMoreActions($event, quotation)"
                    style="font-size: 0.875rem; text-decoration: none; padding: 2px 4px;">
                    <i class="pi pi-ellipsis-h"></i>
                  </a>

                  <!-- Popup menu for additional actions -->
                  <p-menu #moreActionsMenu [popup]="true" [model]="remainingMenuItems" appendTo="body"
                    styleClass="additional-actions-menu">
                    <ng-template pTemplate="item" let-item>
                      <a class="p-menuitem-link d-flex align-items-center text-decoration-none"
                        (click)="immediateHideTooltip(); item.command(); moreActionsMenu.hide()"
                        (mouseenter)="showMenuTooltip(item.label, $event)" (mouseleave)="hideMenuTooltip()"
                        (mousemove)="updateTooltipPosition($event)" style="padding: 0.5rem 1rem; color: #495057;">
                        <span>{{ item.label }}</span>
                      </a>
                    </ng-template>
                  </p-menu>
                </div>
              </td>
            </tr>
          </ng-template>
          <!-- Empty Message -->
          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="8" class="text-center p-4 text-muted">
                <ng-container>
                  {{'gis.quotation.no_matching_quotation' | translate}}
                </ng-container>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>

    <!-- Custom Tooltip -->
    <div *ngIf="hoveredAction" class="custom-tooltip" [class.show]="hoveredAction" [style.left.px]="tooltipPosition.x"
      [style.top.px]="tooltipPosition.y">
      <i [class]="getActionIcon(hoveredAction)" class="tooltip-icon"></i>
      <span class="tooltip-text">{{ getTooltipDescription(hoveredAction) }}</span>
    </div>
  </div>
</ng-container>

<!-- Reassign Quotation Modal 1 -->
<div class="modal fade" id="reassignQuotation" #reassignQuotationModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
    <div class="modal-content ps-4 pt-2 pb-5 pe-4">
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
        <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
          {{ 'gis.quotation.reassign_quote' | translate }}
        </p>
        <button type="button" (click)="closeReassignQuotationModal()" class="btn p-0 text-danger fw-bold"
          style="border: none;">X</button>
      </div>

      <div *ngIf="departmentSelected" class="w-75 mb-2 mt-2">
        <p class="quote-label">Group User</p>
        <input pInputText type="select" class="form-control form-control-sm" id="quote-input"
          [(ngModel)]="userToReassignQuotation">
      </div>

      <div class="w-75 mb-2 mt-2">
        <p class="quote-label">{{ userToReassignQuotation ? 'Default User' : 'User' }}</p>

        <div *ngIf="!departmentSelected"
          class="form-control form-control-sm d-flex align-items-center justify-content-between" id="quote-input"
          style="cursor: pointer;" (click)="openChooseUserReassignModal()">
          <span>{{ userToReassignQuotation }}</span>
          <i class="pi pi-chevron-down me-2" style="color: #00529B;font-size: 14px;"></i>
        </div>

        <p-dropdown *ngIf="departmentSelected" [options]="groupUsers" optionLabel="userDetails.name" optionValue="id"
          [(ngModel)]="selectedGroupUserId" placeholder="" class="form-control-sm">
        </p-dropdown>
      </div>

      <div class="w-75 mb-3">
        <p class="quote-label">Comments</p>
        <textarea name="reassignProduct" class="form-control" style="height: 70px"
          [(ngModel)]="reassignQuotationComment"></textarea>
      </div>

      <small class="text-danger block" [class.invisible]="!noCommentLeft">
        Please leave a comment before reassigning
      </small>

      <small class="text-danger block" [class.invisible]="!noUserChosen">
        Please select a person to reassign before continuing
      </small>

      <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
        <button type="button" class="btn" 
          [disabled]="!userToReassignQuotation || !reassignQuotationComment"
          [style.background-color]="(!userToReassignQuotation || !reassignQuotationComment) ? '#cccccc' : '#00529B'"
          style="color:white;text-decoration: none;"
          (click)="reassignQuotation()">{{
          'gis.quotation.reassign' | translate }}
        </button>
        <button type="button" (click)="closeReassignQuotationModal()" class="btn btn-outline-primary"
          style="text-decoration: none;">{{'gis.quotation.cancel' | translate}}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reassign Quotation Modal 2 - User Selection -->
<div class="modal fade" id="chooseUserReassignModal" #chooseUserReassignModal tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="min-width:200px">
    <div class="modal-content ps-4 pt-2 pb-5 pe-4">
      <div class="d-flex justify-content-between align-items-center rounded-3 mb-2 p-0">
        <p class="modal-title" style="color: #00529B; font-weight:600; font-size:20px;">
          {{ 'gis.quotation.reassign_quote' | translate }}
        </p>
        <button type="button" (click)="closeChooseUserReassignModal()" class="btn p-0 text-danger fw-bold"
          style="border: none;">X</button>
      </div>

      <div class="row mt-2">
        <p-table #reassignTable [value]="users" [rows]="3" [paginator]="true" [rowsPerPageOptions]="[5, 10, 20, 50]"
          [globalFilterFields]="['id', 'name']" selectionMode="single" [(selection)]="selectedUser"
          styleClass="p-datatable-striped" (onRowSelect)="onUserSelect()" (onRowUnselect)="onUserUnselect()">
          <ng-template pTemplate="header">
            <tr>
              <th>User ID</th>
              <th>Full Name</th>
            </tr>
            <tr styleClass="p-striped">
              <th>
                <input type="text" [(ngModel)]="globalSearch" (input)="filterGlobal($event)" 
                       class="form-control form-control-sm" 
                       style="border-radius: 4px; border: 1px solid #ced4da; padding: 0.375rem 0.75rem;">
              </th>
              <th>
                <input type="text" [(ngModel)]="fullNameSearch" (input)="filterByFullName($event)" 
                       class="form-control form-control-sm" 
                       style="border-radius: 4px; border: 1px solid #ced4da; padding: 0.375rem 0.75rem;">
              </th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-user>
            <tr [pSelectableRow]="user">
              <td>{{ user.id }}</td>
              <td>{{ user.name }}</td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <small class="text-danger block" [class.invisible]="!noUserChosen">
        Please select a person to reassign before continuing
      </small>

      <div class="w-full d-flex flex-row-reverse gap-4 mt-5">
        <button type="button" class="btn" style="background-color: #00529B;color:white;text-decoration: none;"
          (click)="selectUser()">{{
          'gis.quotation.save' | translate }}
        </button>
        <button type="button" (click)="closeChooseUserReassignModal()" class="btn btn-outline-primary"
          style="text-decoration: none;">{{
          'gis.quotation.cancel' | translate
          }}
        </button>
      </div>
    </div>
  </div>
</div>